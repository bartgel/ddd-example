function sr(e){return e&&e.__esModule&&Object.prototype.hasOwnProperty.call(e,"default")?e.default:e}var br,ma,ga,wr,ya,_a,lt={exports:{}},_r={};function so(){if(ma)return br;function e(e,t){"boolean"==typeof t&&(t={forever:t}),this._originalTimeouts=JSON.parse(JSON.stringify(e)),this._timeouts=e,this._options=t||{},this._maxRetryTime=t&&t.maxRetryTime||1/0,this._fn=null,this._errors=[],this._attempts=1,this._operationTimeout=null,this._operationTimeoutCb=null,this._timeout=null,this._operationStart=null,this._timer=null,this._options.forever&&(this._cachedTimeouts=this._timeouts.slice(0))}return ma=1,br=e,e.prototype.reset=function(){this._attempts=1,this._timeouts=this._originalTimeouts.slice(0)},e.prototype.stop=function(){this._timeout&&clearTimeout(this._timeout),this._timer&&clearTimeout(this._timer),this._timeouts=[],this._cachedTimeouts=null},e.prototype.retry=function(e){if(this._timeout&&clearTimeout(this._timeout),!e)return!1;var t=(new Date).getTime();if(e&&t-this._operationStart>=this._maxRetryTime)return this._errors.push(e),this._errors.unshift(new Error("RetryOperation timeout occurred")),!1;this._errors.push(e);var r=this._timeouts.shift();if(void 0===r){if(!this._cachedTimeouts)return!1;this._errors.splice(0,this._errors.length-1),r=this._cachedTimeouts.slice(-1)}var a=this;return this._timer=setTimeout((function(){a._attempts++,a._operationTimeoutCb&&(a._timeout=setTimeout((function(){a._operationTimeoutCb(a._attempts)}),a._operationTimeout),a._options.unref&&a._timeout.unref()),a._fn(a._attempts)}),r),this._options.unref&&this._timer.unref(),!0},e.prototype.attempt=function(e,t){this._fn=e,t&&(t.timeout&&(this._operationTimeout=t.timeout),t.cb&&(this._operationTimeoutCb=t.cb));var r=this;this._operationTimeoutCb&&(this._timeout=setTimeout((function(){r._operationTimeoutCb()}),r._operationTimeout)),this._operationStart=(new Date).getTime(),this._fn(this._attempts)},e.prototype.try=function(e){console.log("Using RetryOperation.try() is deprecated"),this.attempt(e)},e.prototype.start=function(e){console.log("Using RetryOperation.start() is deprecated"),this.attempt(e)},e.prototype.start=e.prototype.try,e.prototype.errors=function(){return this._errors},e.prototype.attempts=function(){return this._attempts},e.prototype.mainError=function(){if(0===this._errors.length)return null;for(var e={},t=null,r=0,a=0;a<this._errors.length;a++){var n=this._errors[a],i=n.message,s=(e[i]||0)+1;e[i]=s,s>=r&&(t=n,r=s)}return t},br}function oo(){return ga||(ga=1,e=_r,t=so(),e.operation=function(r){var a=e.timeouts(r);return new t(a,{forever:r&&(r.forever||r.retries===1/0),unref:r&&r.unref,maxRetryTime:r&&r.maxRetryTime})},e.timeouts=function(e){if(e instanceof Array)return[].concat(e);var t={retries:10,factor:2,minTimeout:1e3,maxTimeout:1/0,randomize:!1};for(var r in e)t[r]=e[r];if(t.minTimeout>t.maxTimeout)throw new Error("minTimeout is greater than maxTimeout");for(var a=[],n=0;n<t.retries;n++)a.push(this.createTimeout(n,t));return e&&e.forever&&!a.length&&a.push(this.createTimeout(n,t)),a.sort((function(e,t){return e-t})),a},e.createTimeout=function(e,t){var r=t.randomize?Math.random()+1:1,a=Math.round(r*Math.max(t.minTimeout,1)*Math.pow(t.factor,e));return a=Math.min(a,t.maxTimeout)},e.wrap=function(t,r,a){if(r instanceof Array&&(a=r,r=null),!a)for(var n in a=[],t)"function"==typeof t[n]&&a.push(n);for(var i=0;i<a.length;i++){var s=a[i],o=t[s];t[s]=function(a){var n=e.operation(r),i=Array.prototype.slice.call(arguments,1),s=i.pop();i.push((function(e){n.retry(e)||(e&&(arguments[0]=n.mainError()),s.apply(this,arguments))})),n.attempt((function(){a.apply(t,i)}))}.bind(t,o),t[s].options=r}}),_r;var e,t}function uo(){return ya||(ya=1,wr=oo()),wr}function co(){if(_a)return lt.exports;_a=1;const e=uo(),t=["Failed to fetch","NetworkError when attempting to fetch resource.","The Internet connection appears to be offline.","Network request failed"];class r extends Error{constructor(e){super(),e instanceof Error?(this.originalError=e,({message:e}=e)):(this.originalError=new Error(e),this.originalError.stack=this.stack),this.name="AbortError",this.message=e}}const a=(a,n)=>new Promise(((i,s)=>{n={onFailedAttempt:()=>{},retries:10,...n};const o=e.operation(n);o.attempt((async e=>{try{i(await a(e))}catch(a){if(!(a instanceof Error))return void s(new TypeError(`Non-error was thrown: "${a}". You should only throw errors.`));if(a instanceof r)o.stop(),s(a.originalError);else if(a instanceof TypeError&&!(e=>t.includes(e))(a.message))o.stop(),s(a);else{((e,t,r)=>{const a=r.retries-(t-1);e.attemptNumber=t,e.retriesLeft=a})(a,e,n);try{await n.onFailedAttempt(a)}catch(e){return void s(e)}o.retry(a)||s(o.mainError())}}}))}));return lt.exports=a,lt.exports.default=a,lt.exports.AbortError=r,lt.exports}var ba,lo=co(),qt=sr(lo),kt={},vr={exports:{}};function ho(){return ba||(ba=1,function(e){var t=Object.prototype.hasOwnProperty,r="~";function a(){}function n(e,t,r){this.fn=e,this.context=t,this.once=r||!1}function i(e,t,a,i,s){if("function"!=typeof a)throw new TypeError("The listener must be a function");var o=new n(a,i||e,s),c=r?r+t:t;return e._events[c]?e._events[c].fn?e._events[c]=[e._events[c],o]:e._events[c].push(o):(e._events[c]=o,e._eventsCount++),e}function s(e,t){0==--e._eventsCount?e._events=new a:delete e._events[t]}function o(){this._events=new a,this._eventsCount=0}Object.create&&(a.prototype=Object.create(null),(new a).__proto__||(r=!1)),o.prototype.eventNames=function(){var e,a,n=[];if(0===this._eventsCount)return n;for(a in e=this._events)t.call(e,a)&&n.push(r?a.slice(1):a);return Object.getOwnPropertySymbols?n.concat(Object.getOwnPropertySymbols(e)):n},o.prototype.listeners=function(e){var t=r?r+e:e,a=this._events[t];if(!a)return[];if(a.fn)return[a.fn];for(var n=0,i=a.length,s=new Array(i);n<i;n++)s[n]=a[n].fn;return s},o.prototype.listenerCount=function(e){var t=r?r+e:e,a=this._events[t];return a?a.fn?1:a.length:0},o.prototype.emit=function(e,t,a,n,i,s){var o=r?r+e:e;if(!this._events[o])return!1;var c,u,l=this._events[o],d=arguments.length;if(l.fn){switch(l.once&&this.removeListener(e,l.fn,void 0,!0),d){case 1:return l.fn.call(l.context),!0;case 2:return l.fn.call(l.context,t),!0;case 3:return l.fn.call(l.context,t,a),!0;case 4:return l.fn.call(l.context,t,a,n),!0;case 5:return l.fn.call(l.context,t,a,n,i),!0;case 6:return l.fn.call(l.context,t,a,n,i,s),!0}for(u=1,c=new Array(d-1);u<d;u++)c[u-1]=arguments[u];l.fn.apply(l.context,c)}else{var h,p=l.length;for(u=0;u<p;u++)switch(l[u].once&&this.removeListener(e,l[u].fn,void 0,!0),d){case 1:l[u].fn.call(l[u].context);break;case 2:l[u].fn.call(l[u].context,t);break;case 3:l[u].fn.call(l[u].context,t,a);break;case 4:l[u].fn.call(l[u].context,t,a,n);break;default:if(!c)for(h=1,c=new Array(d-1);h<d;h++)c[h-1]=arguments[h];l[u].fn.apply(l[u].context,c)}}return!0},o.prototype.on=function(e,t,r){return i(this,e,t,r,!1)},o.prototype.once=function(e,t,r){return i(this,e,t,r,!0)},o.prototype.removeListener=function(e,t,a,n){var i=r?r+e:e;if(!this._events[i])return this;if(!t)return s(this,i),this;var o=this._events[i];if(o.fn)o.fn===t&&(!n||o.once)&&(!a||o.context===a)&&s(this,i);else{for(var c=0,u=[],l=o.length;c<l;c++)(o[c].fn!==t||n&&!o[c].once||a&&o[c].context!==a)&&u.push(o[c]);u.length?this._events[i]=1===u.length?u[0]:u:s(this,i)}return this},o.prototype.removeAllListeners=function(e){var t;return e?(t=r?r+e:e,this._events[t]&&s(this,t)):(this._events=new a,this._eventsCount=0),this},o.prototype.off=o.prototype.removeListener,o.prototype.addListener=o.prototype.on,o.prefixed=r,o.EventEmitter=o,e.exports=o}(vr)),vr.exports}var Er,wa,va,dt={exports:{}};function fo(){return wa||(wa=1,Er=(e,t)=>(t=t||(()=>{}),e.then((e=>new Promise((e=>{e(t())})).then((()=>e))),(e=>new Promise((e=>{e(t())})).then((()=>{throw e})))))),Er}function po(){if(va)return dt.exports;va=1;const e=fo();class t extends Error{constructor(e){super(e),this.name="TimeoutError"}}const r=(r,a,n)=>new Promise(((i,s)=>{if("number"!=typeof a||a<0)throw new TypeError("Expected `milliseconds` to be a positive number");if(a===1/0)return void i(r);const o=setTimeout((()=>{if("function"==typeof n){try{i(n())}catch(e){s(e)}return}const e=n instanceof Error?n:new t("string"==typeof n?n:`Promise timed out after ${a} milliseconds`);"function"==typeof r.cancel&&r.cancel(),s(e)}),a);e(r.then(i,s),(()=>{clearTimeout(o)}))}));return dt.exports=r,dt.exports.default=r,dt.exports.TimeoutError=t,dt.exports}var Ea,Sa,Oa,Pt={},Nt={};function mo(){if(Ea)return Nt;return Ea=1,Object.defineProperty(Nt,"__esModule",{value:!0}),Nt.default=function(e,t,r){let a=0,n=e.length;for(;n>0;){const i=n/2|0;let s=a+i;r(e[s],t)<=0?(a=++s,n-=i+1):n=i}return a},Nt}function go(){if(Sa)return Pt;Sa=1,Object.defineProperty(Pt,"__esModule",{value:!0});const e=mo();return Pt.default=class{constructor(){this._queue=[]}enqueue(t,r){const a={priority:(r=Object.assign({priority:0},r)).priority,run:t};if(this.size&&this._queue[this.size-1].priority>=r.priority)return void this._queue.push(a);const n=e.default(this._queue,a,((e,t)=>t.priority-e.priority));this._queue.splice(n,0,a)}dequeue(){const e=this._queue.shift();return e?.run}filter(e){return this._queue.filter((t=>t.priority===e.priority)).map((e=>e.run))}get size(){return this._queue.length}},Pt}function yo(){if(Oa)return kt;Oa=1,Object.defineProperty(kt,"__esModule",{value:!0});const e=ho(),t=po(),r=go(),a=()=>{},n=new t.TimeoutError;return kt.default=class extends e{constructor(e){var t,n,i,s;if(super(),this._intervalCount=0,this._intervalEnd=0,this._pendingCount=0,this._resolveEmpty=a,this._resolveIdle=a,!("number"==typeof(e=Object.assign({carryoverConcurrencyCount:!1,intervalCap:1/0,interval:0,concurrency:1/0,autoStart:!0,queueClass:r.default},e)).intervalCap&&e.intervalCap>=1))throw new TypeError(`Expected \`intervalCap\` to be a number from 1 and up, got \`${null!==(n=null===(t=e.intervalCap)||void 0===t?void 0:t.toString())&&void 0!==n?n:""}\` (${typeof e.intervalCap})`);if(void 0===e.interval||!(Number.isFinite(e.interval)&&e.interval>=0))throw new TypeError(`Expected \`interval\` to be a finite number >= 0, got \`${null!==(s=null===(i=e.interval)||void 0===i?void 0:i.toString())&&void 0!==s?s:""}\` (${typeof e.interval})`);this._carryoverConcurrencyCount=e.carryoverConcurrencyCount,this._isIntervalIgnored=e.intervalCap===1/0||0===e.interval,this._intervalCap=e.intervalCap,this._interval=e.interval,this._queue=new e.queueClass,this._queueClass=e.queueClass,this.concurrency=e.concurrency,this._timeout=e.timeout,this._throwOnTimeout=!0===e.throwOnTimeout,this._isPaused=!1===e.autoStart}get _doesIntervalAllowAnother(){return this._isIntervalIgnored||this._intervalCount<this._intervalCap}get _doesConcurrentAllowAnother(){return this._pendingCount<this._concurrency}_next(){this._pendingCount--,this._tryToStartAnother(),this.emit("next")}_resolvePromises(){this._resolveEmpty(),this._resolveEmpty=a,0===this._pendingCount&&(this._resolveIdle(),this._resolveIdle=a,this.emit("idle"))}_onResumeInterval(){this._onInterval(),this._initializeIntervalIfNeeded(),this._timeoutId=void 0}_isIntervalPaused(){const e=Date.now();if(void 0===this._intervalId){const t=this._intervalEnd-e;if(!(t<0))return void 0===this._timeoutId&&(this._timeoutId=setTimeout((()=>{this._onResumeInterval()}),t)),!0;this._intervalCount=this._carryoverConcurrencyCount?this._pendingCount:0}return!1}_tryToStartAnother(){if(0===this._queue.size)return this._intervalId&&clearInterval(this._intervalId),this._intervalId=void 0,this._resolvePromises(),!1;if(!this._isPaused){const e=!this._isIntervalPaused();if(this._doesIntervalAllowAnother&&this._doesConcurrentAllowAnother){const t=this._queue.dequeue();return!!t&&(this.emit("active"),t(),e&&this._initializeIntervalIfNeeded(),!0)}}return!1}_initializeIntervalIfNeeded(){this._isIntervalIgnored||void 0!==this._intervalId||(this._intervalId=setInterval((()=>{this._onInterval()}),this._interval),this._intervalEnd=Date.now()+this._interval)}_onInterval(){0===this._intervalCount&&0===this._pendingCount&&this._intervalId&&(clearInterval(this._intervalId),this._intervalId=void 0),this._intervalCount=this._carryoverConcurrencyCount?this._pendingCount:0,this._processQueue()}_processQueue(){for(;this._tryToStartAnother(););}get concurrency(){return this._concurrency}set concurrency(e){if(!("number"==typeof e&&e>=1))throw new TypeError(`Expected \`concurrency\` to be a number from 1 and up, got \`${e}\` (${typeof e})`);this._concurrency=e,this._processQueue()}async add(e,r={}){return new Promise(((a,i)=>{this._queue.enqueue((async()=>{this._pendingCount++,this._intervalCount++;try{const s=void 0===this._timeout&&void 0===r.timeout?e():t.default(Promise.resolve(e()),void 0===r.timeout?this._timeout:r.timeout,(()=>{(void 0===r.throwOnTimeout?this._throwOnTimeout:r.throwOnTimeout)&&i(n)}));a(await s)}catch(e){i(e)}this._next()}),r),this._tryToStartAnother(),this.emit("add")}))}async addAll(e,t){return Promise.all(e.map((async e=>this.add(e,t))))}start(){return this._isPaused?(this._isPaused=!1,this._processQueue(),this):this}pause(){this._isPaused=!0}clear(){this._queue=new this._queueClass}async onEmpty(){if(0!==this._queue.size)return new Promise((e=>{const t=this._resolveEmpty;this._resolveEmpty=()=>{t(),e()}}))}async onIdle(){if(0!==this._pendingCount||0!==this._queue.size)return new Promise((e=>{const t=this._resolveIdle;this._resolveIdle=()=>{t(),e()}}))}get size(){return this._queue.size}sizeBy(e){return this._queue.filter(e).length}get pending(){return this._pendingCount}get isPaused(){return this._isPaused}get timeout(){return this._timeout}set timeout(e){this._timeout=e}},kt}var _o=yo(),ke=sr(_o);const bo=[400,401,402,403,404,405,406,407,409],wo=e=>{if(e.message.startsWith("Cancel")||e.message.startsWith("AbortError")||"AbortError"===e.name||"ECONNABORTED"===e?.code)throw e;const t=e?.response?.status??e?.status;if(t&&bo.includes(+t))throw e;if("insufficient_quota"===e?.error?.code){const t=new Error(e?.message);throw t.name="InsufficientQuotaError",t}};let vs=class{constructor(e){Object.defineProperty(this,"maxConcurrency",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"maxRetries",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"onFailedAttempt",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"queue",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.maxConcurrency=e.maxConcurrency??1/0,this.maxRetries=e.maxRetries??6,this.onFailedAttempt=e.onFailedAttempt??wo;const t="default"in ke?ke.default:ke;this.queue=new t({concurrency:this.maxConcurrency})}call(e,...t){return this.queue.add((()=>qt((()=>e(...t).catch((e=>{throw e instanceof Error?e:new Error(e)}))),{onFailedAttempt:this.onFailedAttempt,retries:this.maxRetries,randomize:!0})),{throwOnTimeout:!0})}callWithOptions(e,t,...r){return e.signal?Promise.race([this.call(t,...r),new Promise(((t,r)=>{e.signal?.addEventListener("abort",(()=>{r(new Error("AbortError"))}))}))]):this.call(t,...r)}fetch(...e){return this.call((()=>fetch(...e).then((e=>e.ok?e:Promise.reject(e)))))}};class vo{constructor(e){Object.defineProperty(this,"caller",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.caller=new vs(e??{})}}const Eo=(e,t)=>e.reduce(((e,r,a)=>{const n=Math.floor(a/t),i=e[n]||[];return e[n]=i.concat([r]),e}),[]);class So extends vo{constructor(e){super(e??{}),Object.defineProperty(this,"model",{enumerable:!0,configurable:!0,writable:!0,value:"Xenova/all-MiniLM-L6-v2"}),Object.defineProperty(this,"batchSize",{enumerable:!0,configurable:!0,writable:!0,value:512}),Object.defineProperty(this,"stripNewLines",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"timeout",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"pretrainedOptions",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"pipelineOptions",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"pipelinePromise",{enumerable:!0,configurable:!0,writable:!0,value:null}),this.model=e?.model??this.model,this.stripNewLines=e?.stripNewLines??this.stripNewLines,this.timeout=e?.timeout,this.pretrainedOptions=e?.pretrainedOptions??{},this.pipelineOptions={pooling:"mean",normalize:!0,...e?.pipelineOptions}}async embedDocuments(e){const t=Eo(this.stripNewLines?e.map((e=>e.replace(/\n/g," "))):e,this.batchSize).map((e=>this.runEmbedding(e))),r=await Promise.all(t),a=[];for(let e=0;e<r.length;e+=1){const t=r[e];for(let e=0;e<t.length;e+=1)a.push(t[e])}return a}async embedQuery(e){return(await this.runEmbedding([this.stripNewLines?e.replace(/\n/g," "):e]))[0]}async runEmbedding(e){this.pipelinePromise||(this.pipelinePromise=(async()=>{const e=(await import("./transformers.web-Bp6rZqg6.js")).pipeline;return await e("feature-extraction",this.model,this.pretrainedOptions)})());const t=await this.pipelinePromise;return this.caller.call((async()=>(await t(e,this.pipelineOptions)).tolist()))}}var Oo=/^(?:[0-9a-f]{8}-[0-9a-f]{4}-[1-8][0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}|00000000-0000-0000-0000-000000000000|ffffffff-ffff-ffff-ffff-ffffffffffff)$/i;function mt(e){return"string"==typeof e&&Oo.test(e)}function To(e){if(!mt(e))throw TypeError("Invalid UUID");var t,r=new Uint8Array(16);return r[0]=(t=parseInt(e.slice(0,8),16))>>>24,r[1]=t>>>16&255,r[2]=t>>>8&255,r[3]=255&t,r[4]=(t=parseInt(e.slice(9,13),16))>>>8,r[5]=255&t,r[6]=(t=parseInt(e.slice(14,18),16))>>>8,r[7]=255&t,r[8]=(t=parseInt(e.slice(19,23),16))>>>8,r[9]=255&t,r[10]=(t=parseInt(e.slice(24,36),16))/1099511627776&255,r[11]=t/4294967296&255,r[12]=t>>>24&255,r[13]=t>>>16&255,r[14]=t>>>8&255,r[15]=255&t,r}for(var re=[],Sr=0;Sr<256;++Sr)re.push((Sr+256).toString(16).slice(1));function Es(e,t=0){return(re[e[t+0]]+re[e[t+1]]+re[e[t+2]]+re[e[t+3]]+"-"+re[e[t+4]]+re[e[t+5]]+"-"+re[e[t+6]]+re[e[t+7]]+"-"+re[e[t+8]]+re[e[t+9]]+"-"+re[e[t+10]]+re[e[t+11]]+re[e[t+12]]+re[e[t+13]]+re[e[t+14]]+re[e[t+15]]).toLowerCase()}var $t,Ro=new Uint8Array(16);function Io(){if(!$t&&!($t=typeof crypto<"u"&&crypto.getRandomValues&&crypto.getRandomValues.bind(crypto)))throw new Error("crypto.getRandomValues() not supported. See https://github.com/uuidjs/uuid#getrandomvalues-not-supported");return $t(Ro)}function Ao(e){e=unescape(encodeURIComponent(e));for(var t=[],r=0;r<e.length;++r)t.push(e.charCodeAt(r));return t}var xo="6ba7b810-9dad-11d1-80b4-00c04fd430c8",ko="6ba7b811-9dad-11d1-80b4-00c04fd430c8";function Po(e,t,r){function a(e,a,n,i){var s;if("string"==typeof e&&(e=Ao(e)),"string"==typeof a&&(a=To(a)),16!==(null===(s=a)||void 0===s?void 0:s.length))throw TypeError("Namespace must be array-like (16 iterable integer values, 0-255)");var o=new Uint8Array(16+e.length);if(o.set(a),o.set(e,a.length),(o=r(o))[6]=15&o[6]|t,o[8]=63&o[8]|128,n){i=i||0;for(var c=0;c<16;++c)n[i+c]=o[c];return n}return Es(o)}try{a.name=e}catch{}return a.DNS=xo,a.URL=ko,a}var No=typeof crypto<"u"&&crypto.randomUUID&&crypto.randomUUID.bind(crypto),Ta={randomUUID:No};function oe(e,t,r){if(Ta.randomUUID&&!e)return Ta.randomUUID();var a=(e=e||{}).random||(e.rng||Io)();return a[6]=15&a[6]|64,a[8]=63&a[8]|128,Es(a)}function $o(e,t,r,a){switch(e){case 0:return t&r^~t&a;case 1:case 3:return t^r^a;case 2:return t&r^t&a^r&a}}function Or(e,t){return e<<t|e>>>32-t}function Co(e){var t=[1518500249,1859775393,2400959708,3395469782],r=[1732584193,4023233417,2562383102,271733878,3285377520];if("string"==typeof e){var a=unescape(encodeURIComponent(e));e=[];for(var n=0;n<a.length;++n)e.push(a.charCodeAt(n))}else Array.isArray(e)||(e=Array.prototype.slice.call(e));e.push(128);for(var i=e.length/4+2,s=Math.ceil(i/16),o=new Array(s),c=0;c<s;++c){for(var u=new Uint32Array(16),l=0;l<16;++l)u[l]=e[64*c+4*l]<<24|e[64*c+4*l+1]<<16|e[64*c+4*l+2]<<8|e[64*c+4*l+3];o[c]=u}o[s-1][14]=8*(e.length-1)/Math.pow(2,32),o[s-1][14]=Math.floor(o[s-1][14]),o[s-1][15]=8*(e.length-1)&4294967295;for(var d=0;d<s;++d){for(var h=new Uint32Array(80),p=0;p<16;++p)h[p]=o[d][p];for(var m=16;m<80;++m)h[m]=Or(h[m-3]^h[m-8]^h[m-14]^h[m-16],1);for(var f=r[0],g=r[1],y=r[2],_=r[3],b=r[4],v=0;v<80;++v){var w=Math.floor(v/20),O=Or(f,5)+$o(w,g,y,_)+b+t[w]+h[v]>>>0;b=_,_=y,y=Or(g,30)>>>0,g=f,f=O}r[0]=r[0]+f>>>0,r[1]=r[1]+g>>>0,r[2]=r[2]+y>>>0,r[3]=r[3]+_>>>0,r[4]=r[4]+b>>>0}return[r[0]>>24&255,r[0]>>16&255,r[0]>>8&255,255&r[0],r[1]>>24&255,r[1]>>16&255,r[1]>>8&255,255&r[1],r[2]>>24&255,r[2]>>16&255,r[2]>>8&255,255&r[2],r[3]>>24&255,r[3]>>16&255,r[3]>>8&255,255&r[3],r[4]>>24&255,r[4]>>16&255,r[4]>>8&255,255&r[4]]}var Tr,Ia,Ra=Po("v5",80,Co);function jo(){return Ia||(Ia=1,Tr=function(e,t){if("string"!=typeof e)throw new TypeError("Expected a string");return t=typeof t>"u"?"_":t,e.replace(/([a-z\d])([A-Z])/g,"$1"+t+"$2").replace(/([A-Z]+)([A-Z][a-z\d]+)/g,"$1"+t+"$2").toLowerCase()}),Tr}var Aa,Lo=jo(),Mo=sr(Lo),Ct={exports:{}};function Do(){if(Aa)return Ct.exports;Aa=1;const e=/[\p{Lu}]/u,t=/[\p{Ll}]/u,r=/^[\p{Lu}](?![\p{Lu}])/gu,a=/([\p{Alpha}\p{N}_]|$)/u,n=/[_.\- ]+/,i=new RegExp("^"+n.source),s=new RegExp(n.source+a.source,"gu"),o=new RegExp("\\d+"+a.source,"gu"),c=(a,n)=>{if("string"!=typeof a&&!Array.isArray(a))throw new TypeError("Expected the input to be `string | string[]`");if(n={pascalCase:!1,preserveConsecutiveUppercase:!1,...n},0===(a=Array.isArray(a)?a.map((e=>e.trim())).filter((e=>e.length)).join("-"):a.trim()).length)return"";const c=!1===n.locale?e=>e.toLowerCase():e=>e.toLocaleLowerCase(n.locale),u=!1===n.locale?e=>e.toUpperCase():e=>e.toLocaleUpperCase(n.locale);return 1===a.length?n.pascalCase?u(a):c(a):(a!==c(a)&&(a=((r,a,n)=>{let i=!1,s=!1,o=!1;for(let c=0;c<r.length;c++){const u=r[c];i&&e.test(u)?(r=r.slice(0,c)+"-"+r.slice(c),i=!1,o=s,s=!0,c++):s&&o&&t.test(u)?(r=r.slice(0,c-1)+"-"+r.slice(c-1),o=s,s=!1,i=!0):(i=a(u)===u&&n(u)!==u,o=s,s=n(u)===u&&a(u)!==u)}return r})(a,c,u)),a=a.replace(i,""),a=n.preserveConsecutiveUppercase?((e,t)=>(r.lastIndex=0,e.replace(r,(e=>t(e)))))(a,c):c(a),n.pascalCase&&(a=u(a.charAt(0))+a.slice(1)),((e,t)=>(s.lastIndex=0,o.lastIndex=0,e.replace(s,((e,r)=>t(r))).replace(o,(e=>t(e)))))(a,u))};return Ct.exports=c,Ct.exports.default=c,Ct.exports}function Uo(e,t){return t?.[e]||Mo(e)}function Fo(e,t,r){const a={};for(const n in e)Object.hasOwn(e,n)&&(a[t(n,r)]=e[n]);return a}function xa(e){return Array.isArray(e)?[...e]:{...e}}function zo(e,t){const r=xa(e);for(const[e,a]of Object.entries(t)){const[t,...n]=e.split(".").reverse();let i=r;for(const e of n.reverse()){if(void 0===i[e])break;i[e]=xa(i[e]),i=i[e]}void 0!==i[t]&&(i[t]={lc:1,type:"secret",id:[a]})}return r}function Ss(e){const t=Object.getPrototypeOf(e);return"function"!=typeof e.lc_name||"function"==typeof t.lc_name&&e.lc_name()===t.lc_name()?e.name:e.lc_name()}Do();class We{static lc_name(){return this.name}get lc_id(){return[...this.lc_namespace,Ss(this.constructor)]}get lc_secrets(){}get lc_attributes(){}get lc_aliases(){}get lc_serializable_keys(){}constructor(e,...t){Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"lc_kwargs",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),void 0!==this.lc_serializable_keys?this.lc_kwargs=Object.fromEntries(Object.entries(e||{}).filter((([e])=>this.lc_serializable_keys?.includes(e)))):this.lc_kwargs=e??{}}toJSON(){if(!this.lc_serializable)return this.toJSONNotImplemented();if(this.lc_kwargs instanceof We||"object"!=typeof this.lc_kwargs||Array.isArray(this.lc_kwargs))return this.toJSONNotImplemented();const e={},t={},r=Object.keys(this.lc_kwargs).reduce(((e,t)=>(e[t]=t in this?this[t]:this.lc_kwargs[t],e)),{});for(let a=Object.getPrototypeOf(this);a;a=Object.getPrototypeOf(a))Object.assign(e,Reflect.get(a,"lc_aliases",this)),Object.assign(t,Reflect.get(a,"lc_secrets",this)),Object.assign(r,Reflect.get(a,"lc_attributes",this));return Object.keys(t).forEach((e=>{let t=this,a=r;const[n,...i]=e.split(".").reverse();for(const e of i.reverse()){if(!(e in t)||void 0===t[e])return;(!(e in a)||void 0===a[e])&&("object"==typeof t[e]&&null!=t[e]?a[e]={}:Array.isArray(t[e])&&(a[e]=[])),t=t[e],a=a[e]}n in t&&void 0!==t[n]&&(a[n]=a[n]||t[n])})),{lc:1,type:"constructor",id:this.lc_id,kwargs:Fo(Object.keys(t).length?zo(r,t):r,Uo,e)}}toJSONNotImplemented(){return{lc:1,type:"not_implemented",id:this.lc_id}}}var Bo={};const qo=()=>typeof window<"u"&&typeof window.document<"u",Go=()=>"object"==typeof globalThis&&globalThis.constructor&&"DedicatedWorkerGlobalScope"===globalThis.constructor.name,Ho=()=>typeof window<"u"&&"nodejs"===window.name||typeof navigator<"u"&&navigator.userAgent.includes("jsdom"),Xn=()=>typeof Deno<"u",Zo=()=>typeof process<"u"&&typeof process.versions<"u"&&typeof process.versions.node<"u"&&!Xn(),Vo=()=>{let e;return e=qo()?"browser":Zo()?"node":Go()?"webworker":Ho()?"jsdom":Xn()?"deno":"other",e};let Rr;function Jo(){return void 0===Rr&&(Rr={library:"langchain-js",runtime:Vo()}),Rr}function et(e){try{return typeof process<"u"?Bo?.[e]:Xn()?Deno?.env.get(e):void 0}catch{return}}class Wo{}class Rt extends Wo{get lc_namespace(){return["langchain_core","callbacks",this.name]}get lc_secrets(){}get lc_attributes(){}get lc_aliases(){}get lc_serializable_keys(){}static lc_name(){return this.name}get lc_id(){return[...this.lc_namespace,Ss(this.constructor)]}constructor(e){super(),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"lc_kwargs",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"ignoreLLM",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"ignoreChain",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"ignoreAgent",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"ignoreRetriever",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"ignoreCustomEvent",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"raiseError",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"awaitHandlers",{enumerable:!0,configurable:!0,writable:!0,value:"false"===et("LANGCHAIN_CALLBACKS_BACKGROUND")}),this.lc_kwargs=e||{},e&&(this.ignoreLLM=e.ignoreLLM??this.ignoreLLM,this.ignoreChain=e.ignoreChain??this.ignoreChain,this.ignoreAgent=e.ignoreAgent??this.ignoreAgent,this.ignoreRetriever=e.ignoreRetriever??this.ignoreRetriever,this.ignoreCustomEvent=e.ignoreCustomEvent??this.ignoreCustomEvent,this.raiseError=e.raiseError??this.raiseError,this.awaitHandlers=this.raiseError||(e._awaitHandler??this.awaitHandlers))}copy(){return new this.constructor(this)}toJSON(){return We.prototype.toJSON.call(this)}toJSONNotImplemented(){return We.prototype.toJSONNotImplemented.call(this)}static fromMethods(e){return new class extends Rt{constructor(){super(),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:oe()}),Object.assign(this,e)}}}}const Ko=e=>{const t=e;return void 0!==t&&"function"==typeof t.copy&&"string"==typeof t.name&&"boolean"==typeof t.awaitHandlers};var ka,zt={exports:{}};function Qo(){return ka||(ka=1,function(e){const t=(e=0)=>t=>`[${38+e};5;${t}m`,r=(e=0)=>(t,r,a)=>`[${38+e};2;${t};${r};${a}m`;Object.defineProperty(e,"exports",{enumerable:!0,get:function(){const e=new Map,a={modifier:{reset:[0,0],bold:[1,22],dim:[2,22],italic:[3,23],underline:[4,24],overline:[53,55],inverse:[7,27],hidden:[8,28],strikethrough:[9,29]},color:{black:[30,39],red:[31,39],green:[32,39],yellow:[33,39],blue:[34,39],magenta:[35,39],cyan:[36,39],white:[37,39],blackBright:[90,39],redBright:[91,39],greenBright:[92,39],yellowBright:[93,39],blueBright:[94,39],magentaBright:[95,39],cyanBright:[96,39],whiteBright:[97,39]},bgColor:{bgBlack:[40,49],bgRed:[41,49],bgGreen:[42,49],bgYellow:[43,49],bgBlue:[44,49],bgMagenta:[45,49],bgCyan:[46,49],bgWhite:[47,49],bgBlackBright:[100,49],bgRedBright:[101,49],bgGreenBright:[102,49],bgYellowBright:[103,49],bgBlueBright:[104,49],bgMagentaBright:[105,49],bgCyanBright:[106,49],bgWhiteBright:[107,49]}};a.color.gray=a.color.blackBright,a.bgColor.bgGray=a.bgColor.bgBlackBright,a.color.grey=a.color.blackBright,a.bgColor.bgGrey=a.bgColor.bgBlackBright;for(const[t,r]of Object.entries(a)){for(const[t,n]of Object.entries(r))a[t]={open:`[${n[0]}m`,close:`[${n[1]}m`},r[t]=a[t],e.set(n[0],n[1]);Object.defineProperty(a,t,{value:r,enumerable:!1})}return Object.defineProperty(a,"codes",{value:e,enumerable:!1}),a.color.close="[39m",a.bgColor.close="[49m",a.color.ansi256=t(),a.color.ansi16m=r(),a.bgColor.ansi256=t(10),a.bgColor.ansi16m=r(10),Object.defineProperties(a,{rgbToAnsi256:{value:(e,t,r)=>e===t&&t===r?e<8?16:e>248?231:Math.round((e-8)/247*24)+232:16+36*Math.round(e/255*5)+6*Math.round(t/255*5)+Math.round(r/255*5),enumerable:!1},hexToRgb:{value:e=>{const t=/(?<colorString>[a-f\d]{6}|[a-f\d]{3})/i.exec(e.toString(16));if(!t)return[0,0,0];let{colorString:r}=t.groups;3===r.length&&(r=r.split("").map((e=>e+e)).join(""));const a=Number.parseInt(r,16);return[a>>16&255,a>>8&255,255&a]},enumerable:!1},hexToAnsi256:{value:e=>a.rgbToAnsi256(...a.hexToRgb(e)),enumerable:!1}}),a}})}(zt)),zt.exports}zt.exports;var Xo=Qo(),Os=sr(Xo);const Yo="gen_ai.operation.name",eu="gen_ai.system",Pa="gen_ai.request.model",tu="gen_ai.response.model",Na="gen_ai.usage.input_tokens",$a="gen_ai.usage.output_tokens",Ca="gen_ai.usage.total_tokens",ru="gen_ai.request.max_tokens",nu="gen_ai.request.temperature",au="gen_ai.request.top_p",iu="gen_ai.request.frequency_penalty",su="gen_ai.request.presence_penalty",ou="gen_ai.response.finish_reasons",uu="gen_ai.prompt",cu="gen_ai.completion",lu="gen_ai.request.extra_query",du="gen_ai.request.extra_body",hu="gen_ai.serialized.name",fu="gen_ai.serialized.signature",pu="gen_ai.serialized.doc",mu="gen_ai.response.id",gu="gen_ai.response.service_tier",yu="gen_ai.response.system_fingerprint",_u="gen_ai.usage.input_token_details",bu="gen_ai.usage.output_token_details",wu="langsmith.trace.session_id",vu="langsmith.trace.session_name",Eu="langsmith.span.kind",Su="langsmith.trace.name",Ou="langsmith.metadata",ja="langsmith.span.tags",Tu="langsmith.request.streaming",Ru="langsmith.request.headers",Iu=(...e)=>fetch(...e),Ts=Symbol.for("ls:fetch_implementation"),Au=()=>{const e=globalThis[Ts];return!!e&&("function"==typeof e&&"Headers"in e&&"Request"in e&&"Response"in e)},xu=e=>async(...t)=>{if(e||"true"===he("DEBUG")){const[e,r]=t;console.log(`→ ${r?.method||"GET"} ${e}`)}const r=await(globalThis[Ts]??Iu)(...t);return(e||"true"===he("DEBUG"))&&console.log(`← ${r.status} ${r.statusText} ${r.url}`),r},Rs=()=>he("PROJECT")??Ae("LANGCHAIN_SESSION")??"default",Is="0.3.68";var Ln={};let Re;const ku=()=>typeof window<"u"&&typeof window.document<"u",Pu=()=>"object"==typeof globalThis&&globalThis.constructor&&"DedicatedWorkerGlobalScope"===globalThis.constructor.name,Nu=()=>typeof window<"u"&&"nodejs"===window.name||typeof navigator<"u"&&navigator.userAgent.includes("jsdom"),As=()=>typeof Deno<"u",$u=()=>typeof process<"u"&&typeof process.versions<"u"&&typeof process.versions.node<"u"&&!As(),xs=()=>Re||(Re=typeof Bun<"u"?"bun":ku()?"browser":$u()?"node":Pu()?"webworker":Nu()?"jsdom":As()?"deno":"other",Re);let Ir,Ar;function ks(){if(void 0===Ir){const e=xs(),t=Lu();Ir={library:"langsmith",runtime:e,sdk:"langsmith-js",sdk_version:Is,...t}}return Ir}function Cu(){const e=ju()||{},t={},r=["LANGCHAIN_API_KEY","LANGCHAIN_ENDPOINT","LANGCHAIN_TRACING_V2","LANGCHAIN_PROJECT","LANGCHAIN_SESSION","LANGSMITH_API_KEY","LANGSMITH_ENDPOINT","LANGSMITH_TRACING_V2","LANGSMITH_PROJECT","LANGSMITH_SESSION"];for(const[a,n]of Object.entries(e))(a.startsWith("LANGCHAIN_")||a.startsWith("LANGSMITH_"))&&"string"==typeof n&&!r.includes(a)&&!a.toLowerCase().includes("key")&&!a.toLowerCase().includes("secret")&&!a.toLowerCase().includes("token")&&("LANGCHAIN_REVISION_ID"===a?t.revision_id=n:t[a]=n);return t}function ju(){try{return typeof process<"u"&&Ln?Object.entries(Ln).reduce(((e,[t,r])=>(e[t]=String(r),e)),{}):void 0}catch{return}}function Ae(e){try{return typeof process<"u"?Ln?.[e]:void 0}catch{return}}function he(e){return Ae(`LANGSMITH_${e}`)||Ae(`LANGCHAIN_${e}`)}function Lu(){if(void 0!==Ar)return Ar;const e=["VERCEL_GIT_COMMIT_SHA","NEXT_PUBLIC_VERCEL_GIT_COMMIT_SHA","COMMIT_REF","RENDER_GIT_COMMIT","CI_COMMIT_SHA","CIRCLE_SHA1","CF_PAGES_COMMIT_SHA","REACT_APP_GIT_SHA","SOURCE_VERSION","GITHUB_SHA","TRAVIS_COMMIT","GIT_COMMIT","BUILD_VCS_NUMBER","bamboo_planRepository_revision","Build.SourceVersion","BITBUCKET_COMMIT","DRONE_COMMIT_SHA","SEMAPHORE_GIT_SHA","BUILDKITE_COMMIT"],t={};for(const r of e){const e=Ae(r);void 0!==e&&(t[r]=e)}return Ar=t,t}function Ps(){return"true"===Ae("OTEL_ENABLED")||"true"===he("OTEL_ENABLED")}class Mu{constructor(){Object.defineProperty(this,"hasWarned",{enumerable:!0,configurable:!0,writable:!0,value:!1})}startActiveSpan(e,...t){let r;if(!this.hasWarned&&Ps()&&(console.warn('You have enabled OTEL export via the `OTEL_ENABLED` or `LANGSMITH_OTEL_ENABLED` environment variable, but have not initialized the required OTEL instances. Please add:\n```\nimport { initializeOTEL } from "langsmith/experimental/otel/setup";\ninitializeOTEL();\n```\nat the beginning of your code.'),this.hasWarned=!0),1===t.length&&"function"==typeof t[0]?r=t[0]:2===t.length&&"function"==typeof t[1]?r=t[1]:3===t.length&&"function"==typeof t[2]&&(r=t[2]),"function"==typeof r)return r()}}class Du{constructor(){Object.defineProperty(this,"mockTracer",{enumerable:!0,configurable:!0,writable:!0,value:new Mu})}getTracer(e,t){return this.mockTracer}getActiveSpan(){}setSpan(e,t){return e}getSpan(e){}setSpanContext(e,t){return e}getTracerProvider(){}setGlobalTracerProvider(e){return!1}}class Uu{active(){return{}}with(e,t){return t()}}const xr=Symbol.for("ls:otel_trace"),kr=Symbol.for("ls:otel_context"),La=Symbol.for("ls:otel_get_default_otlp_tracer_provider"),Fu=new Du,zu=new Uu;class Bu{getTraceInstance(){return globalThis[xr]??Fu}getContextInstance(){return globalThis[kr]??zu}initializeGlobalInstances(e){void 0===globalThis[xr]&&(globalThis[xr]=e.trace),void 0===globalThis[kr]&&(globalThis[kr]=e.context)}setDefaultOTLPTracerComponents(e){globalThis[La]=e}getDefaultOTLPTracerComponents(){return globalThis[La]??void 0}}const Yn=new Bu;function Ns(){return Yn.getTraceInstance()}function qu(){return Yn.getContextInstance()}function Gu(){return Yn.getDefaultOTLPTracerComponents()}const Hu={llm:"chat",tool:"execute_tool",retriever:"embeddings",embedding:"embeddings",prompt:"chat"};function Zu(e){return Hu[e]||e}class Vu{constructor(){Object.defineProperty(this,"spans",{enumerable:!0,configurable:!0,writable:!0,value:new Map})}exportBatch(e,t){for(const r of e)try{if(!r.run)continue;if("post"===r.operation){const e=this.createSpanForRun(r,r.run,t.get(r.id));e&&!r.run.end_time&&this.spans.set(r.id,e)}else this.updateSpanForRun(r,r.run)}catch(e){console.error(`Error processing operation ${r.id}:`,e)}}createSpanForRun(e,t,r){const a=r&&Ns().getSpan(r);if(a)try{return this.finishSpanSetup(a,t,e)}catch(t){return void console.error(`Failed to create span for run ${e.id}:`,t)}}finishSpanSetup(e,t,r){return this.setSpanAttributes(e,t,r),t.error?(e.setStatus({code:2}),e.recordException(new Error(t.error))):e.setStatus({code:1}),t.end_time&&e.end(new Date(t.end_time)),e}updateSpanForRun(e,t){try{const r=this.spans.get(e.id);if(!r)return void console.debug(`No span found for run ${e.id} during update`);this.setSpanAttributes(r,t,e),t.error?(r.setStatus({code:2}),r.recordException(new Error(t.error))):r.setStatus({code:1});const a=t.end_time;a&&(r.end(new Date(a)),this.spans.delete(e.id))}catch(t){console.error(`Failed to update span for run ${e.id}:`,t)}}extractModelName(e){if(e.extra?.metadata){const t=e.extra.metadata;if(t.ls_model_name)return t.ls_model_name;if(t.invocation_params){const e=t.invocation_params;if(e.model)return e.model;if(e.model_name)return e.model_name}}}setSpanAttributes(e,t,r){if("run_type"in t&&t.run_type){e.setAttribute(Eu,t.run_type);const r=Zu(t.run_type||"chain");e.setAttribute(Yo,r)}"name"in t&&t.name&&e.setAttribute(Su,t.name),"session_id"in t&&t.session_id&&e.setAttribute(wu,t.session_id),"session_name"in t&&t.session_name&&e.setAttribute(vu,t.session_name),this.setGenAiSystem(e,t);const a=this.extractModelName(t);a&&e.setAttribute(Pa,a),"prompt_tokens"in t&&"number"==typeof t.prompt_tokens&&e.setAttribute(Na,t.prompt_tokens),"completion_tokens"in t&&"number"==typeof t.completion_tokens&&e.setAttribute($a,t.completion_tokens),"total_tokens"in t&&"number"==typeof t.total_tokens&&e.setAttribute(Ca,t.total_tokens),this.setInvocationParameters(e,t);const n=t.extra?.metadata||{};for(const[t,r]of Object.entries(n))null!=r&&e.setAttribute(`${Ou}.${t}`,String(r));const i=t.tags;if(i&&Array.isArray(i)?e.setAttribute(ja,i.join(", ")):i&&e.setAttribute(ja,String(i)),"serialized"in t&&"object"==typeof t.serialized){const r=t.serialized;r.name&&e.setAttribute(hu,String(r.name)),r.signature&&e.setAttribute(fu,String(r.signature)),r.doc&&e.setAttribute(pu,String(r.doc))}this.setIOAttributes(e,r)}setGenAiSystem(e,t){let r="langchain";const a=this.extractModelName(t);if(a){const e=a.toLowerCase();e.includes("anthropic")||e.startsWith("claude")?r="anthropic":e.includes("bedrock")?r="aws.bedrock":e.includes("azure")&&e.includes("openai")?r="az.ai.openai":e.includes("azure")&&e.includes("inference")?r="az.ai.inference":e.includes("cohere")?r="cohere":e.includes("deepseek")?r="deepseek":e.includes("gemini")?r="gemini":e.includes("groq")?r="groq":e.includes("watson")||e.includes("ibm")?r="ibm.watsonx.ai":e.includes("mistral")?r="mistral_ai":e.includes("gpt")||e.includes("openai")?r="openai":e.includes("perplexity")||e.includes("sonar")?r="perplexity":e.includes("vertex")?r="vertex_ai":(e.includes("xai")||e.includes("grok"))&&(r="xai")}e.setAttribute(eu,r)}setInvocationParameters(e,t){if(!t.extra?.metadata?.invocation_params)return;const r=t.extra.metadata.invocation_params;void 0!==r.max_tokens&&e.setAttribute(ru,r.max_tokens),void 0!==r.temperature&&e.setAttribute(nu,r.temperature),void 0!==r.top_p&&e.setAttribute(au,r.top_p),void 0!==r.frequency_penalty&&e.setAttribute(iu,r.frequency_penalty),void 0!==r.presence_penalty&&e.setAttribute(su,r.presence_penalty)}setIOAttributes(e,t){if(t.run.inputs)try{const r=t.run.inputs;"object"==typeof r&&null!==r&&(r.model&&Array.isArray(r.messages)&&e.setAttribute(Pa,r.model),void 0!==r.stream&&e.setAttribute(Tu,r.stream),r.extra_headers&&e.setAttribute(Ru,JSON.stringify(r.extra_headers)),r.extra_query&&e.setAttribute(lu,JSON.stringify(r.extra_query)),r.extra_body&&e.setAttribute(du,JSON.stringify(r.extra_body))),e.setAttribute(uu,JSON.stringify(r))}catch(e){console.debug(`Failed to process inputs for run ${t.id}`,e)}if(t.run.outputs)try{const r=t.run.outputs,a=this.getUnifiedRunTokens(r);if(a&&(e.setAttribute(Na,a[0]),e.setAttribute($a,a[1]),e.setAttribute(Ca,a[0]+a[1])),r&&"object"==typeof r){if(r.model&&e.setAttribute(tu,String(r.model)),r.id&&e.setAttribute(mu,r.id),r.choices&&Array.isArray(r.choices)){const t=r.choices.map((e=>e.finish_reason)).filter((e=>e)).map(String);t.length>0&&e.setAttribute(ou,t.join(", "))}if(r.service_tier&&e.setAttribute(gu,r.service_tier),r.system_fingerprint&&e.setAttribute(yu,r.system_fingerprint),r.usage_metadata&&"object"==typeof r.usage_metadata){const t=r.usage_metadata;t.input_token_details&&e.setAttribute(_u,JSON.stringify(t.input_token_details)),t.output_token_details&&e.setAttribute(bu,JSON.stringify(t.output_token_details))}}e.setAttribute(cu,JSON.stringify(r))}catch(e){console.debug(`Failed to process outputs for run ${t.id}`,e)}}getUnifiedRunTokens(e){if(!e)return null;let t=this.extractUnifiedRunTokens(e.usage_metadata);if(t)return t;const r=Object.keys(e);for(const a of r){const r=e[a];if(r&&"object"==typeof r&&(t=this.extractUnifiedRunTokens(r.usage_metadata),t||1===r.lc&&r.kwargs&&"object"==typeof r.kwargs&&(t=this.extractUnifiedRunTokens(r.kwargs.usage_metadata),t)))return t}const a=e.generations||[];if(!Array.isArray(a))return null;const n=Array.isArray(a[0])?a.flat():a;for(const e of n)if("object"==typeof e&&e.message&&"object"==typeof e.message&&e.message.kwargs&&"object"==typeof e.message.kwargs&&(t=this.extractUnifiedRunTokens(e.message.kwargs.usage_metadata),t))return t;return null}extractUnifiedRunTokens(e){return e&&"object"==typeof e&&"number"==typeof e.input_tokens&&"number"==typeof e.output_tokens?[e.input_tokens,e.output_tokens]:null}}const Ju=[429,500,502,503,504];class Ma{constructor(e){Object.defineProperty(this,"maxConcurrency",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"maxRetries",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"queue",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"onFailedResponseHook",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.maxConcurrency=e.maxConcurrency??1/0,this.maxRetries=e.maxRetries??6,this.queue="default"in ke?new ke.default({concurrency:this.maxConcurrency}):new ke({concurrency:this.maxConcurrency}),this.onFailedResponseHook=e?.onFailedResponseHook}call(e,...t){const r=this.onFailedResponseHook;return this.queue.add((()=>qt((()=>e(...t).catch((e=>{throw e instanceof Error?e:new Error(e)}))),{async onFailedAttempt(e){if(e.message.startsWith("Cancel")||e.message.startsWith("TimeoutError")||"TimeoutError"===e.name||e.message.startsWith("AbortError")||"ECONNABORTED"===e?.code)throw e;const t=e?.response;if(r&&await r(t))return;const a=t?.status??e?.status;if(a&&!Ju.includes(+a))throw e},retries:this.maxRetries,randomize:!0})),{throwOnTimeout:!0})}callWithOptions(e,t,...r){return e.signal?Promise.race([this.call(t,...r),new Promise(((t,r)=>{e.signal?.addEventListener("abort",(()=>{r(new Error("AbortError"))}))}))]):this.call(t,...r)}}function Da(e){return"function"==typeof e?._getType}function Ua(e){const t={type:e._getType(),data:{content:e.content}};return e?.additional_kwargs&&Object.keys(e.additional_kwargs).length>0&&(t.data.additional_kwargs={...e.additional_kwargs}),t}const Wu=/^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$/i;function D(e,t){if(!Wu.test(e)){throw new Error(void 0!==t?`Invalid UUID for ${t}: ${e}`:`Invalid UUID: ${e}`)}return e}const Fa={};function $s(e){Fa[e]||(console.warn(e),Fa[e]=!0)}var Pr,za,Nr,Ba,qa,$r,Ga,Cr,Ha,jr,Za,Lr,Va,Mr,Ja,Dr,Wa,Ur,Ka,Fr,Qa,zr,Xa,Br,Ya,qr,ei,Gr,ti,Hr,ri,Zr,ni,Vr,ai,Jr,ii,Wr,si,Kr,oi,Qr,ui,Xr,ci,Yr,li,en,di,tn,hi,rn,fi,nn,pi,an,mi,sn,gi,on,yi,un,_i,cn,bi,ln,wi,dn,vi,hn,Ei,fn,Si,pn,Oi,mn,Ti,gn,Ri,yn,Ii,_n,Ai,bn,xi,wn,ki,vn,Pi,jt={exports:{}};function or(){if(za)return Pr;za=1;const e=Number.MAX_SAFE_INTEGER||9007199254740991;return Pr={MAX_LENGTH:256,MAX_SAFE_COMPONENT_LENGTH:16,MAX_SAFE_BUILD_LENGTH:250,MAX_SAFE_INTEGER:e,RELEASE_TYPES:["major","premajor","minor","preminor","patch","prepatch","prerelease"],SEMVER_SPEC_VERSION:"2.0.0",FLAG_INCLUDE_PRERELEASE:1,FLAG_LOOSE:2}}function ur(){if(Ba)return Nr;Ba=1;var e={};return Nr="object"==typeof process&&e&&e.NODE_DEBUG&&/\bsemver\b/i.test(e.NODE_DEBUG)?(...e)=>console.error("SEMVER",...e):()=>{}}function It(){return qa||(qa=1,function(e,t){const{MAX_SAFE_COMPONENT_LENGTH:r,MAX_SAFE_BUILD_LENGTH:a,MAX_LENGTH:n}=or(),i=ur(),s=(t=e.exports={}).re=[],o=t.safeRe=[],c=t.src=[],u=t.t={};let l=0;const d="[a-zA-Z0-9-]",h=[["\\s",1],["\\d",n],[d,a]],p=(e,t,r)=>{const a=(e=>{for(const[t,r]of h)e=e.split(`${t}*`).join(`${t}{0,${r}}`).split(`${t}+`).join(`${t}{1,${r}}`);return e})(t),n=l++;i(e,n,t),u[e]=n,c[n]=t,s[n]=new RegExp(t,r?"g":void 0),o[n]=new RegExp(a,r?"g":void 0)};p("NUMERICIDENTIFIER","0|[1-9]\\d*"),p("NUMERICIDENTIFIERLOOSE","\\d+"),p("NONNUMERICIDENTIFIER",`\\d*[a-zA-Z-]${d}*`),p("MAINVERSION",`(${c[u.NUMERICIDENTIFIER]})\\.(${c[u.NUMERICIDENTIFIER]})\\.(${c[u.NUMERICIDENTIFIER]})`),p("MAINVERSIONLOOSE",`(${c[u.NUMERICIDENTIFIERLOOSE]})\\.(${c[u.NUMERICIDENTIFIERLOOSE]})\\.(${c[u.NUMERICIDENTIFIERLOOSE]})`),p("PRERELEASEIDENTIFIER",`(?:${c[u.NUMERICIDENTIFIER]}|${c[u.NONNUMERICIDENTIFIER]})`),p("PRERELEASEIDENTIFIERLOOSE",`(?:${c[u.NUMERICIDENTIFIERLOOSE]}|${c[u.NONNUMERICIDENTIFIER]})`),p("PRERELEASE",`(?:-(${c[u.PRERELEASEIDENTIFIER]}(?:\\.${c[u.PRERELEASEIDENTIFIER]})*))`),p("PRERELEASELOOSE",`(?:-?(${c[u.PRERELEASEIDENTIFIERLOOSE]}(?:\\.${c[u.PRERELEASEIDENTIFIERLOOSE]})*))`),p("BUILDIDENTIFIER",`${d}+`),p("BUILD",`(?:\\+(${c[u.BUILDIDENTIFIER]}(?:\\.${c[u.BUILDIDENTIFIER]})*))`),p("FULLPLAIN",`v?${c[u.MAINVERSION]}${c[u.PRERELEASE]}?${c[u.BUILD]}?`),p("FULL",`^${c[u.FULLPLAIN]}$`),p("LOOSEPLAIN",`[v=\\s]*${c[u.MAINVERSIONLOOSE]}${c[u.PRERELEASELOOSE]}?${c[u.BUILD]}?`),p("LOOSE",`^${c[u.LOOSEPLAIN]}$`),p("GTLT","((?:<|>)?=?)"),p("XRANGEIDENTIFIERLOOSE",`${c[u.NUMERICIDENTIFIERLOOSE]}|x|X|\\*`),p("XRANGEIDENTIFIER",`${c[u.NUMERICIDENTIFIER]}|x|X|\\*`),p("XRANGEPLAIN",`[v=\\s]*(${c[u.XRANGEIDENTIFIER]})(?:\\.(${c[u.XRANGEIDENTIFIER]})(?:\\.(${c[u.XRANGEIDENTIFIER]})(?:${c[u.PRERELEASE]})?${c[u.BUILD]}?)?)?`),p("XRANGEPLAINLOOSE",`[v=\\s]*(${c[u.XRANGEIDENTIFIERLOOSE]})(?:\\.(${c[u.XRANGEIDENTIFIERLOOSE]})(?:\\.(${c[u.XRANGEIDENTIFIERLOOSE]})(?:${c[u.PRERELEASELOOSE]})?${c[u.BUILD]}?)?)?`),p("XRANGE",`^${c[u.GTLT]}\\s*${c[u.XRANGEPLAIN]}$`),p("XRANGELOOSE",`^${c[u.GTLT]}\\s*${c[u.XRANGEPLAINLOOSE]}$`),p("COERCEPLAIN",`(^|[^\\d])(\\d{1,${r}})(?:\\.(\\d{1,${r}}))?(?:\\.(\\d{1,${r}}))?`),p("COERCE",`${c[u.COERCEPLAIN]}(?:$|[^\\d])`),p("COERCEFULL",c[u.COERCEPLAIN]+`(?:${c[u.PRERELEASE]})?(?:${c[u.BUILD]})?(?:$|[^\\d])`),p("COERCERTL",c[u.COERCE],!0),p("COERCERTLFULL",c[u.COERCEFULL],!0),p("LONETILDE","(?:~>?)"),p("TILDETRIM",`(\\s*)${c[u.LONETILDE]}\\s+`,!0),t.tildeTrimReplace="$1~",p("TILDE",`^${c[u.LONETILDE]}${c[u.XRANGEPLAIN]}$`),p("TILDELOOSE",`^${c[u.LONETILDE]}${c[u.XRANGEPLAINLOOSE]}$`),p("LONECARET","(?:\\^)"),p("CARETTRIM",`(\\s*)${c[u.LONECARET]}\\s+`,!0),t.caretTrimReplace="$1^",p("CARET",`^${c[u.LONECARET]}${c[u.XRANGEPLAIN]}$`),p("CARETLOOSE",`^${c[u.LONECARET]}${c[u.XRANGEPLAINLOOSE]}$`),p("COMPARATORLOOSE",`^${c[u.GTLT]}\\s*(${c[u.LOOSEPLAIN]})$|^$`),p("COMPARATOR",`^${c[u.GTLT]}\\s*(${c[u.FULLPLAIN]})$|^$`),p("COMPARATORTRIM",`(\\s*)${c[u.GTLT]}\\s*(${c[u.LOOSEPLAIN]}|${c[u.XRANGEPLAIN]})`,!0),t.comparatorTrimReplace="$1$2$3",p("HYPHENRANGE",`^\\s*(${c[u.XRANGEPLAIN]})\\s+-\\s+(${c[u.XRANGEPLAIN]})\\s*$`),p("HYPHENRANGELOOSE",`^\\s*(${c[u.XRANGEPLAINLOOSE]})\\s+-\\s+(${c[u.XRANGEPLAINLOOSE]})\\s*$`),p("STAR","(<|>)?=?\\s*\\*"),p("GTE0","^\\s*>=\\s*0\\.0\\.0\\s*$"),p("GTE0PRE","^\\s*>=\\s*0\\.0\\.0-0\\s*$")}(jt,jt.exports)),jt.exports}function ea(){if(Ga)return $r;Ga=1;const e=Object.freeze({loose:!0}),t=Object.freeze({});return $r=r=>r?"object"!=typeof r?e:r:t}function Cs(){if(Ha)return Cr;Ha=1;const e=/^[0-9]+$/,t=(t,r)=>{const a=e.test(t),n=e.test(r);return a&&n&&(t=+t,r=+r),t===r?0:a&&!n?-1:n&&!a?1:t<r?-1:1};return Cr={compareIdentifiers:t,rcompareIdentifiers:(e,r)=>t(r,e)}}function ce(){if(Za)return jr;Za=1;const e=ur(),{MAX_LENGTH:t,MAX_SAFE_INTEGER:r}=or(),{safeRe:a,t:n}=It(),i=ea(),{compareIdentifiers:s}=Cs();class o{constructor(s,c){if(c=i(c),s instanceof o){if(s.loose===!!c.loose&&s.includePrerelease===!!c.includePrerelease)return s;s=s.version}else if("string"!=typeof s)throw new TypeError(`Invalid version. Must be a string. Got type "${typeof s}".`);if(s.length>t)throw new TypeError(`version is longer than ${t} characters`);e("SemVer",s,c),this.options=c,this.loose=!!c.loose,this.includePrerelease=!!c.includePrerelease;const u=s.trim().match(c.loose?a[n.LOOSE]:a[n.FULL]);if(!u)throw new TypeError(`Invalid Version: ${s}`);if(this.raw=s,this.major=+u[1],this.minor=+u[2],this.patch=+u[3],this.major>r||this.major<0)throw new TypeError("Invalid major version");if(this.minor>r||this.minor<0)throw new TypeError("Invalid minor version");if(this.patch>r||this.patch<0)throw new TypeError("Invalid patch version");u[4]?this.prerelease=u[4].split(".").map((e=>{if(/^[0-9]+$/.test(e)){const t=+e;if(t>=0&&t<r)return t}return e})):this.prerelease=[],this.build=u[5]?u[5].split("."):[],this.format()}format(){return this.version=`${this.major}.${this.minor}.${this.patch}`,this.prerelease.length&&(this.version+=`-${this.prerelease.join(".")}`),this.version}toString(){return this.version}compare(t){if(e("SemVer.compare",this.version,this.options,t),!(t instanceof o)){if("string"==typeof t&&t===this.version)return 0;t=new o(t,this.options)}return t.version===this.version?0:this.compareMain(t)||this.comparePre(t)}compareMain(e){return e instanceof o||(e=new o(e,this.options)),s(this.major,e.major)||s(this.minor,e.minor)||s(this.patch,e.patch)}comparePre(t){if(t instanceof o||(t=new o(t,this.options)),this.prerelease.length&&!t.prerelease.length)return-1;if(!this.prerelease.length&&t.prerelease.length)return 1;if(!this.prerelease.length&&!t.prerelease.length)return 0;let r=0;do{const a=this.prerelease[r],n=t.prerelease[r];if(e("prerelease compare",r,a,n),void 0===a&&void 0===n)return 0;if(void 0===n)return 1;if(void 0===a)return-1;if(a!==n)return s(a,n)}while(++r)}compareBuild(t){t instanceof o||(t=new o(t,this.options));let r=0;do{const a=this.build[r],n=t.build[r];if(e("build compare",r,a,n),void 0===a&&void 0===n)return 0;if(void 0===n)return 1;if(void 0===a)return-1;if(a!==n)return s(a,n)}while(++r)}inc(e,t,r){switch(e){case"premajor":this.prerelease.length=0,this.patch=0,this.minor=0,this.major++,this.inc("pre",t,r);break;case"preminor":this.prerelease.length=0,this.patch=0,this.minor++,this.inc("pre",t,r);break;case"prepatch":this.prerelease.length=0,this.inc("patch",t,r),this.inc("pre",t,r);break;case"prerelease":0===this.prerelease.length&&this.inc("patch",t,r),this.inc("pre",t,r);break;case"major":(0!==this.minor||0!==this.patch||0===this.prerelease.length)&&this.major++,this.minor=0,this.patch=0,this.prerelease=[];break;case"minor":(0!==this.patch||0===this.prerelease.length)&&this.minor++,this.patch=0,this.prerelease=[];break;case"patch":0===this.prerelease.length&&this.patch++,this.prerelease=[];break;case"pre":{const e=Number(r)?1:0;if(!t&&!1===r)throw new Error("invalid increment argument: identifier is empty");if(0===this.prerelease.length)this.prerelease=[e];else{let a=this.prerelease.length;for(;--a>=0;)"number"==typeof this.prerelease[a]&&(this.prerelease[a]++,a=-2);if(-1===a){if(t===this.prerelease.join(".")&&!1===r)throw new Error("invalid increment argument: identifier already exists");this.prerelease.push(e)}}if(t){let a=[t,e];!1===r&&(a=[t]),0===s(this.prerelease[0],t)?isNaN(this.prerelease[1])&&(this.prerelease=a):this.prerelease=a}break}default:throw new Error(`invalid increment argument: ${e}`)}return this.raw=this.format(),this.build.length&&(this.raw+=`+${this.build.join(".")}`),this}}return jr=o}function ot(){if(Va)return Lr;Va=1;const e=ce();return Lr=(t,r,a=!1)=>{if(t instanceof e)return t;try{return new e(t,r)}catch(e){if(!a)return null;throw e}}}function Ku(){if(Ja)return Mr;Ja=1;const e=ot();return Mr=(t,r)=>{const a=e(t,r);return a?a.version:null}}function Qu(){if(Wa)return Dr;Wa=1;const e=ot();return Dr=(t,r)=>{const a=e(t.trim().replace(/^[=v]+/,""),r);return a?a.version:null}}function Xu(){if(Ka)return Ur;Ka=1;const e=ce();return Ur=(t,r,a,n,i)=>{"string"==typeof a&&(i=n,n=a,a=void 0);try{return new e(t instanceof e?t.version:t,a).inc(r,n,i).version}catch{return null}}}function Yu(){if(Qa)return Fr;Qa=1;const e=ot();return Fr=(t,r)=>{const a=e(t,null,!0),n=e(r,null,!0),i=a.compare(n);if(0===i)return null;const s=i>0,o=s?a:n,c=s?n:a,u=!!o.prerelease.length;if(c.prerelease.length&&!u)return c.patch||c.minor?o.patch?"patch":o.minor?"minor":"major":"major";const l=u?"pre":"";return a.major!==n.major?l+"major":a.minor!==n.minor?l+"minor":a.patch!==n.patch?l+"patch":"prerelease"}}function ec(){if(Xa)return zr;Xa=1;const e=ce();return zr=(t,r)=>new e(t,r).major}function tc(){if(Ya)return Br;Ya=1;const e=ce();return Br=(t,r)=>new e(t,r).minor}function rc(){if(ei)return qr;ei=1;const e=ce();return qr=(t,r)=>new e(t,r).patch}function nc(){if(ti)return Gr;ti=1;const e=ot();return Gr=(t,r)=>{const a=e(t,r);return a&&a.prerelease.length?a.prerelease:null}}function Oe(){if(ri)return Hr;ri=1;const e=ce();return Hr=(t,r,a)=>new e(t,a).compare(new e(r,a))}function ac(){if(ni)return Zr;ni=1;const e=Oe();return Zr=(t,r,a)=>e(r,t,a)}function ic(){if(ai)return Vr;ai=1;const e=Oe();return Vr=(t,r)=>e(t,r,!0)}function ta(){if(ii)return Jr;ii=1;const e=ce();return Jr=(t,r,a)=>{const n=new e(t,a),i=new e(r,a);return n.compare(i)||n.compareBuild(i)}}function sc(){if(si)return Wr;si=1;const e=ta();return Wr=(t,r)=>t.sort(((t,a)=>e(t,a,r)))}function oc(){if(oi)return Kr;oi=1;const e=ta();return Kr=(t,r)=>t.sort(((t,a)=>e(a,t,r)))}function cr(){if(ui)return Qr;ui=1;const e=Oe();return Qr=(t,r,a)=>e(t,r,a)>0}function ra(){if(ci)return Xr;ci=1;const e=Oe();return Xr=(t,r,a)=>e(t,r,a)<0}function js(){if(li)return Yr;li=1;const e=Oe();return Yr=(t,r,a)=>0===e(t,r,a)}function Ls(){if(di)return en;di=1;const e=Oe();return en=(t,r,a)=>0!==e(t,r,a)}function na(){if(hi)return tn;hi=1;const e=Oe();return tn=(t,r,a)=>e(t,r,a)>=0}function aa(){if(fi)return rn;fi=1;const e=Oe();return rn=(t,r,a)=>e(t,r,a)<=0}function Ms(){if(pi)return nn;pi=1;const e=js(),t=Ls(),r=cr(),a=na(),n=ra(),i=aa();return nn=(s,o,c,u)=>{switch(o){case"===":return"object"==typeof s&&(s=s.version),"object"==typeof c&&(c=c.version),s===c;case"!==":return"object"==typeof s&&(s=s.version),"object"==typeof c&&(c=c.version),s!==c;case"":case"=":case"==":return e(s,c,u);case"!=":return t(s,c,u);case">":return r(s,c,u);case">=":return a(s,c,u);case"<":return n(s,c,u);case"<=":return i(s,c,u);default:throw new TypeError(`Invalid operator: ${o}`)}}}function uc(){if(mi)return an;mi=1;const e=ce(),t=ot(),{safeRe:r,t:a}=It();return an=(n,i)=>{if(n instanceof e)return n;if("number"==typeof n&&(n=String(n)),"string"!=typeof n)return null;let s=null;if((i=i||{}).rtl){const e=i.includePrerelease?r[a.COERCERTLFULL]:r[a.COERCERTL];let t;for(;(t=e.exec(n))&&(!s||s.index+s[0].length!==n.length);)(!s||t.index+t[0].length!==s.index+s[0].length)&&(s=t),e.lastIndex=t.index+t[1].length+t[2].length;e.lastIndex=-1}else s=n.match(i.includePrerelease?r[a.COERCEFULL]:r[a.COERCE]);if(null===s)return null;const o=s[2],c=s[3]||"0",u=s[4]||"0",l=i.includePrerelease&&s[5]?`-${s[5]}`:"",d=i.includePrerelease&&s[6]?`+${s[6]}`:"";return t(`${o}.${c}.${u}${l}${d}`,i)}}function cc(){if(gi)return sn;gi=1;return sn=class{constructor(){this.max=1e3,this.map=new Map}get(e){const t=this.map.get(e);if(void 0!==t)return this.map.delete(e),this.map.set(e,t),t}delete(e){return this.map.delete(e)}set(e,t){if(!this.delete(e)&&void 0!==t){if(this.map.size>=this.max){const e=this.map.keys().next().value;this.delete(e)}this.map.set(e,t)}return this}}}function Te(){if(yi)return on;yi=1;const e=/\s+/g;class t{constructor(r,i){if(i=a(i),r instanceof t)return r.loose===!!i.loose&&r.includePrerelease===!!i.includePrerelease?r:new t(r.raw,i);if(r instanceof n)return this.raw=r.value,this.set=[[r]],this.formatted=void 0,this;if(this.options=i,this.loose=!!i.loose,this.includePrerelease=!!i.includePrerelease,this.raw=r.trim().replace(e," "),this.set=this.raw.split("||").map((e=>this.parseRange(e.trim()))).filter((e=>e.length)),!this.set.length)throw new TypeError(`Invalid SemVer Range: ${this.raw}`);if(this.set.length>1){const e=this.set[0];if(this.set=this.set.filter((e=>!m(e[0]))),0===this.set.length)this.set=[e];else if(this.set.length>1)for(const e of this.set)if(1===e.length&&f(e[0])){this.set=[e];break}}this.formatted=void 0}get range(){if(void 0===this.formatted){this.formatted="";for(let e=0;e<this.set.length;e++){e>0&&(this.formatted+="||");const t=this.set[e];for(let e=0;e<t.length;e++)e>0&&(this.formatted+=" "),this.formatted+=t[e].toString().trim()}}return this.formatted}format(){return this.range}toString(){return this.range}parseRange(e){const t=((this.options.includePrerelease&&h)|(this.options.loose&&p))+":"+e,a=r.get(t);if(a)return a;const s=this.options.loose,f=s?o[c.HYPHENRANGELOOSE]:o[c.HYPHENRANGE];e=e.replace(f,T(this.options.includePrerelease)),i("hyphen replace",e),e=e.replace(o[c.COMPARATORTRIM],u),i("comparator trim",e),e=e.replace(o[c.TILDETRIM],l),i("tilde trim",e),e=e.replace(o[c.CARETTRIM],d),i("caret trim",e);let g=e.split(" ").map((e=>y(e,this.options))).join(" ").split(/\s+/).map((e=>k(e,this.options)));s&&(g=g.filter((e=>(i("loose invalid filter",e,this.options),!!e.match(o[c.COMPARATORLOOSE]))))),i("range list",g);const _=new Map,b=g.map((e=>new n(e,this.options)));for(const e of b){if(m(e))return[e];_.set(e.value,e)}_.size>1&&_.has("")&&_.delete("");const v=[..._.values()];return r.set(t,v),v}intersects(e,r){if(!(e instanceof t))throw new TypeError("a Range is required");return this.set.some((t=>g(t,r)&&e.set.some((e=>g(e,r)&&t.every((t=>e.every((e=>t.intersects(e,r)))))))))}test(e){if(!e)return!1;if("string"==typeof e)try{e=new s(e,this.options)}catch{return!1}for(let t=0;t<this.set.length;t++)if(A(this.set[t],e,this.options))return!0;return!1}}on=t;const r=new(cc()),a=ea(),n=lr(),i=ur(),s=ce(),{safeRe:o,t:c,comparatorTrimReplace:u,tildeTrimReplace:l,caretTrimReplace:d}=It(),{FLAG_INCLUDE_PRERELEASE:h,FLAG_LOOSE:p}=or(),m=e=>"<0.0.0-0"===e.value,f=e=>""===e.value,g=(e,t)=>{let r=!0;const a=e.slice();let n=a.pop();for(;r&&a.length;)r=a.every((e=>n.intersects(e,t))),n=a.pop();return r},y=(e,t)=>(i("comp",e,t),e=w(e,t),i("caret",e),e=b(e,t),i("tildes",e),e=E(e,t),i("xrange",e),e=S(e,t),i("stars",e),e),_=e=>!e||"x"===e.toLowerCase()||"*"===e,b=(e,t)=>e.trim().split(/\s+/).map((e=>v(e,t))).join(" "),v=(e,t)=>{const r=t.loose?o[c.TILDELOOSE]:o[c.TILDE];return e.replace(r,((t,r,a,n,s)=>{let o;return i("tilde",e,t,r,a,n,s),_(r)?o="":_(a)?o=`>=${r}.0.0 <${+r+1}.0.0-0`:_(n)?o=`>=${r}.${a}.0 <${r}.${+a+1}.0-0`:s?(i("replaceTilde pr",s),o=`>=${r}.${a}.${n}-${s} <${r}.${+a+1}.0-0`):o=`>=${r}.${a}.${n} <${r}.${+a+1}.0-0`,i("tilde return",o),o}))},w=(e,t)=>e.trim().split(/\s+/).map((e=>O(e,t))).join(" "),O=(e,t)=>{i("caret",e,t);const r=t.loose?o[c.CARETLOOSE]:o[c.CARET],a=t.includePrerelease?"-0":"";return e.replace(r,((t,r,n,s,o)=>{let c;return i("caret",e,t,r,n,s,o),_(r)?c="":_(n)?c=`>=${r}.0.0${a} <${+r+1}.0.0-0`:_(s)?c="0"===r?`>=${r}.${n}.0${a} <${r}.${+n+1}.0-0`:`>=${r}.${n}.0${a} <${+r+1}.0.0-0`:o?(i("replaceCaret pr",o),c="0"===r?"0"===n?`>=${r}.${n}.${s}-${o} <${r}.${n}.${+s+1}-0`:`>=${r}.${n}.${s}-${o} <${r}.${+n+1}.0-0`:`>=${r}.${n}.${s}-${o} <${+r+1}.0.0-0`):(i("no pr"),c="0"===r?"0"===n?`>=${r}.${n}.${s}${a} <${r}.${n}.${+s+1}-0`:`>=${r}.${n}.${s}${a} <${r}.${+n+1}.0-0`:`>=${r}.${n}.${s} <${+r+1}.0.0-0`),i("caret return",c),c}))},E=(e,t)=>(i("replaceXRanges",e,t),e.split(/\s+/).map((e=>I(e,t))).join(" ")),I=(e,t)=>{e=e.trim();const r=t.loose?o[c.XRANGELOOSE]:o[c.XRANGE];return e.replace(r,((r,a,n,s,o,c)=>{i("xRange",e,r,a,n,s,o,c);const u=_(n),l=u||_(s),d=l||_(o),h=d;return"="===a&&h&&(a=""),c=t.includePrerelease?"-0":"",u?r=">"===a||"<"===a?"<0.0.0-0":"*":a&&h?(l&&(s=0),o=0,">"===a?(a=">=",l?(n=+n+1,s=0,o=0):(s=+s+1,o=0)):"<="===a&&(a="<",l?n=+n+1:s=+s+1),"<"===a&&(c="-0"),r=`${a+n}.${s}.${o}${c}`):l?r=`>=${n}.0.0${c} <${+n+1}.0.0-0`:d&&(r=`>=${n}.${s}.0${c} <${n}.${+s+1}.0-0`),i("xRange return",r),r}))},S=(e,t)=>(i("replaceStars",e,t),e.trim().replace(o[c.STAR],"")),k=(e,t)=>(i("replaceGTE0",e,t),e.trim().replace(o[t.includePrerelease?c.GTE0PRE:c.GTE0],"")),T=e=>(t,r,a,n,i,s,o,c,u,l,d,h)=>`${r=_(a)?"":_(n)?`>=${a}.0.0${e?"-0":""}`:_(i)?`>=${a}.${n}.0${e?"-0":""}`:s?`>=${r}`:`>=${r}${e?"-0":""}`} ${c=_(u)?"":_(l)?`<${+u+1}.0.0-0`:_(d)?`<${u}.${+l+1}.0-0`:h?`<=${u}.${l}.${d}-${h}`:e?`<${u}.${l}.${+d+1}-0`:`<=${c}`}`.trim(),A=(e,t,r)=>{for(let r=0;r<e.length;r++)if(!e[r].test(t))return!1;if(t.prerelease.length&&!r.includePrerelease){for(let r=0;r<e.length;r++)if(i(e[r].semver),e[r].semver!==n.ANY&&e[r].semver.prerelease.length>0){const a=e[r].semver;if(a.major===t.major&&a.minor===t.minor&&a.patch===t.patch)return!0}return!1}return!0};return on}function lr(){if(_i)return un;_i=1;const e=Symbol("SemVer ANY");class t{static get ANY(){return e}constructor(a,n){if(n=r(n),a instanceof t){if(a.loose===!!n.loose)return a;a=a.value}a=a.trim().split(/\s+/).join(" "),s("comparator",a,n),this.options=n,this.loose=!!n.loose,this.parse(a),this.semver===e?this.value="":this.value=this.operator+this.semver.version,s("comp",this)}parse(t){const r=this.options.loose?a[n.COMPARATORLOOSE]:a[n.COMPARATOR],i=t.match(r);if(!i)throw new TypeError(`Invalid comparator: ${t}`);this.operator=void 0!==i[1]?i[1]:"","="===this.operator&&(this.operator=""),i[2]?this.semver=new o(i[2],this.options.loose):this.semver=e}toString(){return this.value}test(t){if(s("Comparator.test",t,this.options.loose),this.semver===e||t===e)return!0;if("string"==typeof t)try{t=new o(t,this.options)}catch{return!1}return i(t,this.operator,this.semver,this.options)}intersects(e,a){if(!(e instanceof t))throw new TypeError("a Comparator is required");return""===this.operator?""===this.value||new c(e.value,a).test(this.value):""===e.operator?""===e.value||new c(this.value,a).test(e.semver):!((a=r(a)).includePrerelease&&("<0.0.0-0"===this.value||"<0.0.0-0"===e.value)||!a.includePrerelease&&(this.value.startsWith("<0.0.0")||e.value.startsWith("<0.0.0")))&&!!(this.operator.startsWith(">")&&e.operator.startsWith(">")||this.operator.startsWith("<")&&e.operator.startsWith("<")||this.semver.version===e.semver.version&&this.operator.includes("=")&&e.operator.includes("=")||i(this.semver,"<",e.semver,a)&&this.operator.startsWith(">")&&e.operator.startsWith("<")||i(this.semver,">",e.semver,a)&&this.operator.startsWith("<")&&e.operator.startsWith(">"))}}un=t;const r=ea(),{safeRe:a,t:n}=It(),i=Ms(),s=ur(),o=ce(),c=Te();return un}function dr(){if(bi)return cn;bi=1;const e=Te();return cn=(t,r,a)=>{try{r=new e(r,a)}catch{return!1}return r.test(t)}}function lc(){if(wi)return ln;wi=1;const e=Te();return ln=(t,r)=>new e(t,r).set.map((e=>e.map((e=>e.value)).join(" ").trim().split(" ")))}function dc(){if(vi)return dn;vi=1;const e=ce(),t=Te();return dn=(r,a,n)=>{let i=null,s=null,o=null;try{o=new t(a,n)}catch{return null}return r.forEach((t=>{o.test(t)&&(!i||-1===s.compare(t))&&(i=t,s=new e(i,n))})),i}}function hc(){if(Ei)return hn;Ei=1;const e=ce(),t=Te();return hn=(r,a,n)=>{let i=null,s=null,o=null;try{o=new t(a,n)}catch{return null}return r.forEach((t=>{o.test(t)&&(!i||1===s.compare(t))&&(i=t,s=new e(i,n))})),i}}function fc(){if(Si)return fn;Si=1;const e=ce(),t=Te(),r=cr();return fn=(a,n)=>{a=new t(a,n);let i=new e("0.0.0");if(a.test(i)||(i=new e("0.0.0-0"),a.test(i)))return i;i=null;for(let t=0;t<a.set.length;++t){const n=a.set[t];let s=null;n.forEach((t=>{const a=new e(t.semver.version);switch(t.operator){case">":0===a.prerelease.length?a.patch++:a.prerelease.push(0),a.raw=a.format();case"":case">=":(!s||r(a,s))&&(s=a);break;case"<":case"<=":break;default:throw new Error(`Unexpected operation: ${t.operator}`)}})),s&&(!i||r(i,s))&&(i=s)}return i&&a.test(i)?i:null}}function pc(){if(Oi)return pn;Oi=1;const e=Te();return pn=(t,r)=>{try{return new e(t,r).range||"*"}catch{return null}}}function ia(){if(Ti)return mn;Ti=1;const e=ce(),t=lr(),{ANY:r}=t,a=Te(),n=dr(),i=cr(),s=ra(),o=aa(),c=na();return mn=(u,l,d,h)=>{let p,m,f,g,y;switch(u=new e(u,h),l=new a(l,h),d){case">":p=i,m=o,f=s,g=">",y=">=";break;case"<":p=s,m=c,f=i,g="<",y="<=";break;default:throw new TypeError('Must provide a hilo val of "<" or ">"')}if(n(u,l,h))return!1;for(let e=0;e<l.set.length;++e){const a=l.set[e];let n=null,i=null;if(a.forEach((e=>{e.semver===r&&(e=new t(">=0.0.0")),n=n||e,i=i||e,p(e.semver,n.semver,h)?n=e:f(e.semver,i.semver,h)&&(i=e)})),n.operator===g||n.operator===y||(!i.operator||i.operator===g)&&m(u,i.semver))return!1;if(i.operator===y&&f(u,i.semver))return!1}return!0}}function mc(){if(Ri)return gn;Ri=1;const e=ia();return gn=(t,r,a)=>e(t,r,">",a)}function gc(){if(Ii)return yn;Ii=1;const e=ia();return yn=(t,r,a)=>e(t,r,"<",a)}function yc(){if(Ai)return _n;Ai=1;const e=Te();return _n=(t,r,a)=>(t=new e(t,a),r=new e(r,a),t.intersects(r,a))}function _c(){if(xi)return bn;xi=1;const e=dr(),t=Oe();return bn=(r,a,n)=>{const i=[];let s=null,o=null;const c=r.sort(((e,r)=>t(e,r,n)));for(const t of c)e(t,a,n)?(o=t,s||(s=t)):(o&&i.push([s,o]),o=null,s=null);s&&i.push([s,null]);const u=[];for(const[e,t]of i)e===t?u.push(e):t||e!==c[0]?t?e===c[0]?u.push(`<=${t}`):u.push(`${e} - ${t}`):u.push(`>=${e}`):u.push("*");const l=u.join(" || "),d="string"==typeof a.raw?a.raw:String(a);return l.length<d.length?l:a}}function bc(){if(ki)return wn;ki=1;const e=Te(),t=lr(),{ANY:r}=t,a=dr(),n=Oe(),i=[new t(">=0.0.0-0")],s=[new t(">=0.0.0")],o=(e,t,o)=>{if(e===t)return!0;if(1===e.length&&e[0].semver===r){if(1===t.length&&t[0].semver===r)return!0;e=o.includePrerelease?i:s}if(1===t.length&&t[0].semver===r){if(o.includePrerelease)return!0;t=s}const l=new Set;let d,h,p;for(const t of e)">"===t.operator||">="===t.operator?d=c(d,t,o):"<"===t.operator||"<="===t.operator?h=u(h,t,o):l.add(t.semver);if(l.size>1)return null;if(d&&h){if(p=n(d.semver,h.semver,o),p>0)return null;if(0===p&&(">="!==d.operator||"<="!==h.operator))return null}for(const e of l){if(d&&!a(e,String(d),o)||h&&!a(e,String(h),o))return null;for(const r of t)if(!a(e,String(r),o))return!1;return!0}let m,f,g,y,_=!(!h||o.includePrerelease||!h.semver.prerelease.length)&&h.semver,b=!(!d||o.includePrerelease||!d.semver.prerelease.length)&&d.semver;_&&1===_.prerelease.length&&"<"===h.operator&&0===_.prerelease[0]&&(_=!1);for(const e of t){if(y=y||">"===e.operator||">="===e.operator,g=g||"<"===e.operator||"<="===e.operator,d)if(b&&e.semver.prerelease&&e.semver.prerelease.length&&e.semver.major===b.major&&e.semver.minor===b.minor&&e.semver.patch===b.patch&&(b=!1),">"===e.operator||">="===e.operator){if(m=c(d,e,o),m===e&&m!==d)return!1}else if(">="===d.operator&&!a(d.semver,String(e),o))return!1;if(h)if(_&&e.semver.prerelease&&e.semver.prerelease.length&&e.semver.major===_.major&&e.semver.minor===_.minor&&e.semver.patch===_.patch&&(_=!1),"<"===e.operator||"<="===e.operator){if(f=u(h,e,o),f===e&&f!==h)return!1}else if("<="===h.operator&&!a(h.semver,String(e),o))return!1;if(!e.operator&&(h||d)&&0!==p)return!1}return!(d&&g&&!h&&0!==p||h&&y&&!d&&0!==p||b||_)},c=(e,t,r)=>{if(!e)return t;const a=n(e.semver,t.semver,r);return a>0?e:a<0||">"===t.operator&&">="===e.operator?t:e},u=(e,t,r)=>{if(!e)return t;const a=n(e.semver,t.semver,r);return a<0?e:a>0||"<"===t.operator&&"<="===e.operator?t:e};return wn=(t,r,a={})=>{if(t===r)return!0;t=new e(t,a),r=new e(r,a);let n=!1;e:for(const e of t.set){for(const t of r.set){const r=o(e,t,a);if(n=n||null!==r,r)continue e}if(n)return!1}return!0}}function wc(){if(Pi)return vn;Pi=1;const e=It(),t=or(),r=ce(),a=Cs(),n=ot(),i=Ku(),s=Qu(),o=Xu(),c=Yu(),u=ec(),l=tc(),d=rc(),h=nc(),p=Oe(),m=ac(),f=ic(),g=ta(),y=sc(),_=oc(),b=cr(),v=ra(),w=js(),O=Ls(),E=na(),I=aa(),S=Ms(),k=uc(),T=lr(),A=Te(),x=dr(),j=lc(),N=dc(),P=hc(),$=fc(),R=pc(),C=ia(),L=mc(),M=gc(),D=yc(),U=_c(),z=bc();return vn={parse:n,valid:i,clean:s,inc:o,diff:c,major:u,minor:l,patch:d,prerelease:h,compare:p,rcompare:m,compareLoose:f,compareBuild:g,sort:y,rsort:_,gt:b,lt:v,eq:w,neq:O,gte:E,lte:I,cmp:S,coerce:k,Comparator:T,Range:A,satisfies:x,toComparators:j,maxSatisfying:N,minSatisfying:P,minVersion:$,validRange:R,outside:C,gtr:L,ltr:M,intersects:D,simplifyRange:U,subset:z,SemVer:r,re:e.re,src:e.src,tokens:e.t,SEMVER_SPEC_VERSION:t.SEMVER_SPEC_VERSION,RELEASE_TYPES:t.RELEASE_TYPES,compareIdentifiers:a.compareIdentifiers,rcompareIdentifiers:a.rcompareIdentifiers}}function Ce(e){if(!e||e.split("/").length>2||e.startsWith("/")||e.endsWith("/")||e.split(":").length>2)throw new Error(`Invalid identifier format: ${e}`);const[t,r]=e.split(":"),a=r||"latest";if(t.includes("/")){const[r,n]=t.split("/",2);if(!r||!n)throw new Error(`Invalid identifier format: ${e}`);return[r,n,a]}if(!t)throw new Error(`Invalid identifier format: ${e}`);return["-",t,a]}wc();class vc extends Error{constructor(e){super(e),Object.defineProperty(this,"status",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.name="LangSmithConflictError",this.status=409}}async function k(e,t,r){let a;if(e.ok)return void(r&&(a=await e.text()));if(403===e.status)try{"org_scoped_key_requires_workspace"===(await e.json())?.error&&(a="This API key is org-scoped and requires workspace specification. Please provide 'workspaceId' parameter, or set LANGSMITH_WORKSPACE_ID environment variable.")}catch{const t=new Error(`${e.status} ${e.statusText}`);throw t.status=e?.status,t}if(void 0===a)try{a=await e.text()}catch{a=""}const n=`Failed to ${t}. Received status [${e.status}]: ${e.statusText}. Message: ${a}`;if(409===e.status)throw new vc(n);const i=new Error(n);throw i.status=e.status,i}const Ds="ERR_CONFLICTING_ENDPOINTS";class Ec extends Error{constructor(){super("You cannot provide both LANGSMITH_ENDPOINT / LANGCHAIN_ENDPOINT and LANGSMITH_RUNS_ENDPOINTS."),Object.defineProperty(this,"code",{enumerable:!0,configurable:!0,writable:!0,value:Ds}),this.name="ConflictingEndpointsError"}}function Sc(e){return"object"==typeof e&&null!==e&&e.code===Ds}var Ni="[...]",Oc={result:"[Circular]"},Gt=[],Xe=[];const Tc=new TextEncoder;function Rc(){return{depthLimit:Number.MAX_SAFE_INTEGER,edgesLimit:Number.MAX_SAFE_INTEGER}}function Lt(e){return Tc.encode(e)}function Us(e){if(e&&"object"==typeof e&&null!==e){if(e instanceof Map)return Object.fromEntries(e);if(e instanceof Set)return Array.from(e);if(e instanceof Date)return e.toISOString();if(e instanceof RegExp)return e.toString();if(e instanceof Error)return{name:e.name,message:e.message}}else if("bigint"==typeof e)return e.toString();return e}function Ic(e){return function(e,t){return Us(t)}}function pe(e,t,r,a,n){try{return Lt(JSON.stringify(e,Ic(r),a))}catch(i){if(!i.message?.includes("Converting circular structure to JSON"))return console.warn("[WARNING]: LangSmith received unserializable value."+(t?`\nContext: ${t}`:"")),Lt("[Unserializable]");let s;"true"!==he("SUPPRESS_CIRCULAR_JSON_WARNINGS")&&console.warn("[WARNING]: LangSmith received circular JSON. This will decrease tracer performance. "+(t?`\nContext: ${t}`:"")),typeof n>"u"&&(n=Rc()),Mn(e,"",0,[],void 0,0,n);try{s=0===Xe.length?JSON.stringify(e,r,a):JSON.stringify(e,Ac(r),a)}catch{return Lt("[unable to serialize, circular reference is too complex to analyze]")}finally{for(;0!==Gt.length;){const e=Gt.pop();4===e.length?Object.defineProperty(e[0],e[1],e[3]):e[0][e[1]]=e[2]}}return Lt(s)}}function En(e,t,r,a){var n=Object.getOwnPropertyDescriptor(a,r);void 0!==n.get?n.configurable?(Object.defineProperty(a,r,{value:e}),Gt.push([a,r,t,n])):Xe.push([t,r,e]):(a[r]=e,Gt.push([a,r,t]))}function Mn(e,t,r,a,n,i,s){var o;if(i+=1,"object"==typeof e&&null!==e){for(o=0;o<a.length;o++)if(a[o]===e)return void En(Oc,e,t,n);if(typeof s.depthLimit<"u"&&i>s.depthLimit)return void En(Ni,e,t,n);if(typeof s.edgesLimit<"u"&&r+1>s.edgesLimit)return void En(Ni,e,t,n);if(a.push(e),Array.isArray(e))for(o=0;o<e.length;o++)Mn(e[o],o,o,a,e,i,s);else{e=Us(e);var c=Object.keys(e);for(o=0;o<c.length;o++){var u=c[o];Mn(e[u],u,o,a,e,i,s)}}a.pop()}}function Ac(e){return e=typeof e<"u"?e:function(e,t){return t},function(t,r){if(Xe.length>0)for(var a=0;a<Xe.length;a++){var n=Xe[a];if(n[1]===t&&n[0]===r){r=n[2],Xe.splice(a,1);break}}return e.call(this,t,r)}}function $i(e){const t=ks(),r=Cu(),a=e.extra??{},n=a.metadata;return e.extra={...a,runtime:{...t,...a?.runtime},metadata:{...r,...r.revision_id||"revision_id"in e&&e.revision_id?{revision_id:("revision_id"in e?e.revision_id:void 0)??r.revision_id}:{},...n}},e}const xc=e=>{const t=e?.toString()??he("TRACING_SAMPLING_RATE");if(void 0===t)return;const r=parseFloat(t);if(r<0||r>1)throw new Error(`LANGSMITH_TRACING_SAMPLING_RATE must be between 0 and 1 if set. Got: ${r}`);return r},kc=e=>{const t=e.replace("http://","").replace("https://","").split("/")[0].split(":")[0];return"localhost"===t||"127.0.0.1"===t||"::1"===t};async function Pc(e){const t=[];for await(const r of e)t.push(r);return t}function Mt(e){if(void 0!==e)return e.trim().replace(/^"(.*)"$/,"$1").replace(/^'(.*)'$/,"$1")}const Nc=async e=>{if(429===e?.status){const t=1e3*parseInt(e.headers.get("retry-after")??"10",10);if(t>0)return await new Promise((e=>setTimeout(e,t))),!0}return!1};function Ci(e){return"number"==typeof e?Number(e.toFixed(4)):e}class $c{constructor(){Object.defineProperty(this,"items",{enumerable:!0,configurable:!0,writable:!0,value:[]}),Object.defineProperty(this,"sizeBytes",{enumerable:!0,configurable:!0,writable:!0,value:0})}peek(){return this.items[0]}push(e){let t;const r=new Promise((e=>{t=e})),a=pe(e.item,`Serializing run with id: ${e.item.id}`).length;return this.items.push({action:e.action,payload:e.item,otelContext:e.otelContext,apiKey:e.apiKey,apiUrl:e.apiUrl,itemPromiseResolve:t,itemPromise:r,size:a}),this.sizeBytes+=a,r}pop(e){if(e<1)throw new Error("Number of bytes to pop off may not be less than 1.");const t=[];let r=0;for(;r+(this.peek()?.size??0)<e&&this.items.length>0;){const e=this.items.shift();e&&(t.push(e),r+=e.size,this.sizeBytes-=e.size)}if(0===t.length&&this.items.length>0){const e=this.items.shift();t.push(e),r+=e.size,this.sizeBytes-=e.size}return[t.map((e=>({action:e.action,item:e.payload,otelContext:e.otelContext,apiKey:e.apiKey,apiUrl:e.apiUrl}))),()=>t.forEach((e=>e.itemPromiseResolve()))]}}const Cc=25165824,jc=1e4,ji="https://api.smith.langchain.com";class wt{get _fetch(){return this.fetchImplementation||xu(this.debug)}constructor(e={}){Object.defineProperty(this,"apiKey",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"apiUrl",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"webUrl",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"workspaceId",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"caller",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"batchIngestCaller",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"timeout_ms",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"_tenantId",{enumerable:!0,configurable:!0,writable:!0,value:null}),Object.defineProperty(this,"hideInputs",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"hideOutputs",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"tracingSampleRate",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"filteredPostUuids",{enumerable:!0,configurable:!0,writable:!0,value:new Set}),Object.defineProperty(this,"autoBatchTracing",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"autoBatchQueue",{enumerable:!0,configurable:!0,writable:!0,value:new $c}),Object.defineProperty(this,"autoBatchTimeout",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"autoBatchAggregationDelayMs",{enumerable:!0,configurable:!0,writable:!0,value:250}),Object.defineProperty(this,"batchSizeBytesLimit",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"fetchOptions",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"settings",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"blockOnRootRunFinalization",{enumerable:!0,configurable:!0,writable:!0,value:"false"===Ae("LANGSMITH_TRACING_BACKGROUND")}),Object.defineProperty(this,"traceBatchConcurrency",{enumerable:!0,configurable:!0,writable:!0,value:5}),Object.defineProperty(this,"_serverInfo",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"_getServerInfoPromise",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"manualFlushMode",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"langSmithToOTELTranslator",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"fetchImplementation",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"multipartStreamingDisabled",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"debug",{enumerable:!0,configurable:!0,writable:!0,value:"true"===Ae("LANGSMITH_DEBUG")});const t=wt.getDefaultClientConfig();if(this.tracingSampleRate=xc(e.tracingSamplingRate),this.apiUrl=Mt(e.apiUrl??t.apiUrl)??"",this.apiUrl.endsWith("/")&&(this.apiUrl=this.apiUrl.slice(0,-1)),this.apiKey=Mt(e.apiKey??t.apiKey),this.webUrl=Mt(e.webUrl??t.webUrl),this.webUrl?.endsWith("/")&&(this.webUrl=this.webUrl.slice(0,-1)),this.workspaceId=Mt(e.workspaceId??he("WORKSPACE_ID")),this.timeout_ms=e.timeout_ms??9e4,this.caller=new Ma({...e.callerOptions??{},maxRetries:4,debug:e.debug??this.debug}),this.traceBatchConcurrency=e.traceBatchConcurrency??this.traceBatchConcurrency,this.traceBatchConcurrency<1)throw new Error("Trace batch concurrency must be positive.");this.debug=e.debug??this.debug,this.fetchImplementation=e.fetchImplementation,this.batchIngestCaller=new Ma({maxRetries:2,maxConcurrency:this.traceBatchConcurrency,...e.callerOptions??{},onFailedResponseHook:Nc,debug:e.debug??this.debug}),this.hideInputs=e.hideInputs??e.anonymizer??t.hideInputs,this.hideOutputs=e.hideOutputs??e.anonymizer??t.hideOutputs,this.autoBatchTracing=e.autoBatchTracing??this.autoBatchTracing,this.blockOnRootRunFinalization=e.blockOnRootRunFinalization??this.blockOnRootRunFinalization,this.batchSizeBytesLimit=e.batchSizeBytesLimit,this.fetchOptions=e.fetchOptions||{},this.manualFlushMode=e.manualFlushMode??this.manualFlushMode,Ps()&&(this.langSmithToOTELTranslator=new Vu)}static getDefaultClientConfig(){const e=he("API_KEY");return{apiUrl:he("ENDPOINT")??ji,apiKey:e,webUrl:void 0,hideInputs:"true"===he("HIDE_INPUTS"),hideOutputs:"true"===he("HIDE_OUTPUTS")}}getHostUrl(){return this.webUrl?this.webUrl:kc(this.apiUrl)?(this.webUrl="http://localhost:3000",this.webUrl):this.apiUrl.endsWith("/api/v1")?(this.webUrl=this.apiUrl.replace("/api/v1",""),this.webUrl):this.apiUrl.includes("/api")&&!this.apiUrl.split(".",1)[0].endsWith("api")?(this.webUrl=this.apiUrl.replace("/api",""),this.webUrl):this.apiUrl.split(".",1)[0].includes("dev")?(this.webUrl="https://dev.smith.langchain.com",this.webUrl):this.apiUrl.split(".",1)[0].includes("eu")?(this.webUrl="https://eu.smith.langchain.com",this.webUrl):this.apiUrl.split(".",1)[0].includes("beta")?(this.webUrl="https://beta.smith.langchain.com",this.webUrl):(this.webUrl="https://smith.langchain.com",this.webUrl)}get headers(){const e={"User-Agent":`langsmith-js/${Is}`};return this.apiKey&&(e["x-api-key"]=`${this.apiKey}`),this.workspaceId&&(e["x-tenant-id"]=this.workspaceId),e}_getPlatformEndpointPath(e){return"/v1"!==this.apiUrl.slice(-3)&&"/v1/"!==this.apiUrl.slice(-4)?`/v1/platform/${e}`:`/platform/${e}`}async processInputs(e){return!1===this.hideInputs?e:!0===this.hideInputs?{}:"function"==typeof this.hideInputs?this.hideInputs(e):e}async processOutputs(e){return!1===this.hideOutputs?e:!0===this.hideOutputs?{}:"function"==typeof this.hideOutputs?this.hideOutputs(e):e}async prepareRunCreateOrUpdateInputs(e){const t={...e};return void 0!==t.inputs&&(t.inputs=await this.processInputs(t.inputs)),void 0!==t.outputs&&(t.outputs=await this.processOutputs(t.outputs)),t}async _getResponse(e,t){const r=t?.toString()??"",a=`${this.apiUrl}${e}?${r}`;return await this.caller.call((async()=>{const t=await this._fetch(a,{method:"GET",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await k(t,`fetch ${e}`),t}))}async _get(e,t){return(await this._getResponse(e,t)).json()}async*_getPaginated(e,t=new URLSearchParams,r){let a=Number(t.get("offset"))||0;const n=Number(t.get("limit"))||100;for(;;){t.set("offset",String(a)),t.set("limit",String(n));const i=`${this.apiUrl}${e}?${t}`,s=await this.caller.call((async()=>{const t=await this._fetch(i,{method:"GET",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await k(t,`fetch ${e}`),t})),o=r?r(await s.json()):await s.json();if(0===o.length||(yield o,o.length<n))break;a+=o.length}}async*_getCursorPaginatedList(e,t=null,r="POST",a="runs"){const n=t?{...t}:{};for(;;){const t=JSON.stringify(n),i=await(await this.caller.call((async()=>{const a=await this._fetch(`${this.apiUrl}${e}`,{method:r,headers:{...this.headers,"Content-Type":"application/json"},signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions,body:t});return await k(a,`fetch ${e}`),a}))).json();if(!i||!i[a])break;yield i[a];const s=i.cursors;if(!s||!s.next)break;n.cursor=s.next}}_shouldSample(){return void 0===this.tracingSampleRate||Math.random()<this.tracingSampleRate}_filterForSampling(e,t=!1){if(void 0===this.tracingSampleRate)return e;if(t){const t=[];for(const r of e)this.filteredPostUuids.has(r.trace_id)?r.id===r.trace_id&&this.filteredPostUuids.delete(r.trace_id):t.push(r);return t}{const t=[];for(const r of e){const e=r.trace_id??r.id;this.filteredPostUuids.has(e)||(r.id===e?this._shouldSample()?t.push(r):this.filteredPostUuids.add(e):t.push(r))}return t}}async _getBatchSizeLimitBytes(){const e=await this._ensureServerInfo();return this.batchSizeBytesLimit??e.batch_ingest_config?.size_limit_bytes??Cc}async _getDatasetExamplesMultiPartSupport(){return(await this._ensureServerInfo()).instance_flags?.dataset_examples_multipart_enabled??!1}drainAutoBatchQueue(e){const t=[];for(;this.autoBatchQueue.items.length>0;){const[r,a]=this.autoBatchQueue.pop(e);if(!r.length){a();break}const n=r.reduce(((e,t)=>{const r=t.apiUrl??this.apiUrl,a=t.apiKey??this.apiKey,n=t.apiKey===this.apiKey&&t.apiUrl===this.apiUrl?"default":`${r}|${a}`;return e[n]||(e[n]=[]),e[n].push(t),e}),{}),i=[];for(const[e,t]of Object.entries(n)){const r=this._processBatch(t,{apiUrl:"default"===e?void 0:e.split("|")[0],apiKey:"default"===e?void 0:e.split("|")[1]});i.push(r)}const s=Promise.all(i).finally(a);t.push(s)}return Promise.all(t)}async _processBatch(e,t){if(e.length)try{if(void 0!==this.langSmithToOTELTranslator)this._sendBatchToOTELTranslator(e);else{const r={runCreates:e.filter((e=>"create"===e.action)).map((e=>e.item)),runUpdates:e.filter((e=>"update"===e.action)).map((e=>e.item))},a=await this._ensureServerInfo();if(a?.batch_ingest_config?.use_multipart_endpoint){const e=a?.instance_flags?.gzip_body_enabled;await this.multipartIngestRuns(r,{...t,useGzip:e})}else await this.batchIngestRuns(r,t)}}catch(e){console.error("Error exporting batch:",e)}}_sendBatchToOTELTranslator(e){if(void 0!==this.langSmithToOTELTranslator){const t=new Map,r=[];for(const a of e)a.item.id&&a.otelContext&&(t.set(a.item.id,a.otelContext),"create"===a.action?r.push({operation:"post",id:a.item.id,trace_id:a.item.trace_id??a.item.id,run:a.item}):r.push({operation:"patch",id:a.item.id,trace_id:a.item.trace_id??a.item.id,run:a.item}));this.langSmithToOTELTranslator.exportBatch(r,t)}}async processRunOperation(e){clearTimeout(this.autoBatchTimeout),this.autoBatchTimeout=void 0,e.item=$i(e.item);const t=this.autoBatchQueue.push(e);if(this.manualFlushMode)return t;const r=await this._getBatchSizeLimitBytes();return this.autoBatchQueue.sizeBytes>r&&this.drainAutoBatchQueue(r),this.autoBatchQueue.items.length>0&&(this.autoBatchTimeout=setTimeout((()=>{this.autoBatchTimeout=void 0,this.drainAutoBatchQueue(r)}),this.autoBatchAggregationDelayMs)),t}async _getServerInfo(){const e=await(await this.caller.call((async()=>{const e=await this._fetch(`${this.apiUrl}/info`,{method:"GET",headers:{Accept:"application/json"},signal:AbortSignal.timeout(jc),...this.fetchOptions});return await k(e,"get server info"),e}))).json();return this.debug&&console.log("\n=== LangSmith Server Configuration ===\n"+JSON.stringify(e,null,2)+"\n"),e}async _ensureServerInfo(){return void 0===this._getServerInfoPromise&&(this._getServerInfoPromise=(async()=>{if(void 0===this._serverInfo)try{this._serverInfo=await this._getServerInfo()}catch(e){console.warn(`[LANGSMITH]: Failed to fetch info on supported operations. Falling back to batch operations and default limits. Info: ${e.status??"Unspecified status code"} ${e.message}`)}return this._serverInfo??{}})()),this._getServerInfoPromise.then((e=>(void 0===this._serverInfo&&(this._getServerInfoPromise=void 0),e)))}async _getSettings(){return this.settings||(this.settings=this._get("/settings")),await this.settings}async flush(){const e=await this._getBatchSizeLimitBytes();await this.drainAutoBatchQueue(e)}_cloneCurrentOTELContext(){const e=Ns(),t=qu();if(void 0!==this.langSmithToOTELTranslator){const r=e.getActiveSpan();if(r)return e.setSpan(t.active(),r)}}async createRun(e,t){if(!this._filterForSampling([e]).length)return;const r={...this.headers,"Content-Type":"application/json"},a=e.project_name;delete e.project_name;const n=await this.prepareRunCreateOrUpdateInputs({session_name:a,...e,start_time:e.start_time??Date.now()});if(this.autoBatchTracing&&void 0!==n.trace_id&&void 0!==n.dotted_order){const e=this._cloneCurrentOTELContext();return void this.processRunOperation({action:"create",item:n,otelContext:e,apiKey:t?.apiKey,apiUrl:t?.apiUrl}).catch(console.error)}const i=$i(n);void 0!==t?.apiKey&&(r["x-api-key"]=t.apiKey),void 0!==t?.workspaceId&&(r["x-tenant-id"]=t.workspaceId);const s=pe(i,`Creating run with id: ${i.id}`);await this.caller.call((async()=>{const e=await this._fetch(`${t?.apiUrl??this.apiUrl}/runs`,{method:"POST",headers:r,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions,body:s});return await k(e,"create run",!0),e}))}async batchIngestRuns({runCreates:e,runUpdates:t},r){if(void 0===e&&void 0===t)return;let a=await Promise.all(e?.map((e=>this.prepareRunCreateOrUpdateInputs(e)))??[]),n=await Promise.all(t?.map((e=>this.prepareRunCreateOrUpdateInputs(e)))??[]);if(a.length>0&&n.length>0){const e=a.reduce(((e,t)=>(t.id&&(e[t.id]=t),e)),{}),t=[];for(const r of n)void 0!==r.id&&e[r.id]?e[r.id]={...e[r.id],...r}:t.push(r);a=Object.values(e),n=t}const i={post:a,patch:n};if(!i.post.length&&!i.patch.length)return;const s={post:[],patch:[]};for(const e of["post","patch"]){const t=e,r=i[t].reverse();let a=r.pop();for(;void 0!==a;)s[t].push(a),a=r.pop()}if(s.post.length>0||s.patch.length>0){const e=s.post.map((e=>e.id)).concat(s.patch.map((e=>e.id))).join(",");await this._postBatchIngestRuns(pe(s,`Ingesting runs with ids: ${e}`),r)}}async _postBatchIngestRuns(e,t){const r={...this.headers,"Content-Type":"application/json",Accept:"application/json"};void 0!==t?.apiKey&&(r["x-api-key"]=t.apiKey),await this.batchIngestCaller.call((async()=>{const a=await this._fetch(`${t?.apiUrl??this.apiUrl}/runs/batch`,{method:"POST",headers:r,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions,body:e});return await k(a,"batch create run",!0),a}))}async multipartIngestRuns({runCreates:e,runUpdates:t},r){if(void 0===e&&void 0===t)return;const a={};let n=[];for(const t of e??[]){const e=await this.prepareRunCreateOrUpdateInputs(t);void 0!==e.id&&void 0!==e.attachments&&(a[e.id]=e.attachments),delete e.attachments,n.push(e)}let i=[];for(const e of t??[])i.push(await this.prepareRunCreateOrUpdateInputs(e));if(void 0!==n.find((e=>void 0===e.trace_id||void 0===e.dotted_order)))throw new Error('Multipart ingest requires "trace_id" and "dotted_order" to be set when creating a run');if(void 0!==i.find((e=>void 0===e.trace_id||void 0===e.dotted_order)))throw new Error('Multipart ingest requires "trace_id" and "dotted_order" to be set when updating a run');if(n.length>0&&i.length>0){const e=n.reduce(((e,t)=>(t.id&&(e[t.id]=t),e)),{}),t=[];for(const r of i)void 0!==r.id&&e[r.id]?e[r.id]={...e[r.id],...r}:t.push(r);n=Object.values(e),i=t}if(0===n.length&&0===i.length)return;const s=[],o=[];for(const[e,t]of[["post",n],["patch",i]])for(const r of t){const{inputs:t,outputs:n,events:i,extra:c,error:u,serialized:l,attachments:d,...h}=r,p={inputs:t,outputs:n,events:i,extra:c,error:u,serialized:l},m=pe(h,`Serializing for multipart ingestion of run with id: ${h.id}`);o.push({name:`${e}.${h.id}`,payload:new Blob([m],{type:`application/json; length=${m.length}`})});for(const[t,r]of Object.entries(p)){if(void 0===r)continue;const a=pe(r,`Serializing ${t} for multipart ingestion of run with id: ${h.id}`);o.push({name:`${e}.${h.id}.${t}`,payload:new Blob([a],{type:`application/json; length=${a.length}`})})}if(void 0!==h.id){const e=a[h.id];if(e){delete a[h.id];for(const[t,r]of Object.entries(e)){let e,a;(Array.isArray(r)?[e,a]=r:(e=r.mimeType,a=r.data),t.includes("."))?console.warn(`Skipping attachment '${t}' for run ${h.id}: Invalid attachment name. Attachment names must not contain periods ('.'). Please rename the attachment and try again.`):o.push({name:`attachment.${h.id}.${t}`,payload:new Blob([a],{type:`${e}; length=${a.byteLength}`})})}}}s.push(`trace=${h.trace_id},id=${h.id}`)}await this._sendMultipartRequest(o,s.join("; "),r)}async _createNodeFetchBody(e,t){const r=[];for(const a of e)r.push(new Blob([`--${t}\r\n`])),r.push(new Blob([`Content-Disposition: form-data; name="${a.name}"\r\n`,`Content-Type: ${a.payload.type}\r\n\r\n`])),r.push(a.payload),r.push(new Blob(["\r\n"]));return r.push(new Blob([`--${t}--\r\n`])),await new Blob(r).arrayBuffer()}async _createMultipartStream(e,t){const r=new TextEncoder;return new ReadableStream({async start(a){const n=async e=>{"string"==typeof e?a.enqueue(r.encode(e)):a.enqueue(e)};for(const r of e){await n(`--${t}\r\n`),await n(`Content-Disposition: form-data; name="${r.name}"\r\n`),await n(`Content-Type: ${r.payload.type}\r\n\r\n`);const e=r.payload.stream().getReader();try{let t;for(;!(t=await e.read()).done;)a.enqueue(t.value)}finally{e.releaseLock()}await n("\r\n")}await n(`--${t}--\r\n`),a.close()}})}async _sendMultipartRequest(e,t,r){const a="----LangSmithFormBoundary"+Math.random().toString(36).slice(2),n=Au(),i=()=>this._createNodeFetchBody(e,a),s=()=>this._createMultipartStream(e,a),o=async e=>this.batchIngestCaller.call((async()=>{const t=await e(),n={...this.headers,"Content-Type":`multipart/form-data; boundary=${a}`};void 0!==r?.apiKey&&(n["x-api-key"]=r.apiKey);let i=t;r?.useGzip&&"object"==typeof t&&"pipeThrough"in t&&(i=t.pipeThrough(new CompressionStream("gzip")),n["Content-Encoding"]="gzip");const s=await this._fetch(`${r?.apiUrl??this.apiUrl}/runs/multipart`,{method:"POST",headers:n,body:i,duplex:"half",signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await k(s,"Failed to send multipart request",!0),s}));try{let e,a=!1;n||this.multipartStreamingDisabled||"bun"===xs()?e=await o(i):(a=!0,e=await o(s)),(!this.multipartStreamingDisabled||a)&&422===e.status&&(r?.apiUrl??this.apiUrl)!==ji&&(console.warn(`Streaming multipart upload to ${r?.apiUrl??this.apiUrl}/runs/multipart failed. This usually means the host does not support chunked uploads. Retrying with a buffered upload for operation "${t}".`),this.multipartStreamingDisabled=!0,e=await o(i))}catch(e){console.warn(`${e.message.trim()}\n\nContext: ${t}`)}}async updateRun(e,t,r){D(e),t.inputs&&(t.inputs=await this.processInputs(t.inputs)),t.outputs&&(t.outputs=await this.processOutputs(t.outputs));const a={...t,id:e};if(!this._filterForSampling([a],!0).length)return;if(this.autoBatchTracing&&void 0!==a.trace_id&&void 0!==a.dotted_order){const e=this._cloneCurrentOTELContext();return void 0!==t.end_time&&void 0===a.parent_run_id&&this.blockOnRootRunFinalization&&!this.manualFlushMode?void await this.processRunOperation({action:"update",item:a,otelContext:e,apiKey:r?.apiKey,apiUrl:r?.apiUrl}).catch(console.error):void this.processRunOperation({action:"update",item:a,otelContext:e,apiKey:r?.apiKey,apiUrl:r?.apiUrl}).catch(console.error)}const n={...this.headers,"Content-Type":"application/json"};void 0!==r?.apiKey&&(n["x-api-key"]=r.apiKey),void 0!==r?.workspaceId&&(n["x-tenant-id"]=r.workspaceId);const i=pe(t,`Serializing payload to update run with id: ${e}`);await this.caller.call((async()=>{const t=await this._fetch(`${r?.apiUrl??this.apiUrl}/runs/${e}`,{method:"PATCH",headers:n,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions,body:i});return await k(t,"update run",!0),t}))}async readRun(e,{loadChildRuns:t}={loadChildRuns:!1}){D(e);let r=await this._get(`/runs/${e}`);return t&&(r=await this._loadChildRuns(r)),r}async getRunUrl({runId:e,run:t,projectOpts:r}){if(void 0!==t){let e;e=t.session_id?t.session_id:r?.projectName?(await this.readProject({projectName:r?.projectName})).id:r?.projectId?r?.projectId:(await this.readProject({projectName:he("PROJECT")||"default"})).id;const a=await this._getTenantId();return`${this.getHostUrl()}/o/${a}/projects/p/${e}/r/${t.id}?poll=true`}if(void 0!==e){const t=await this.readRun(e);if(!t.app_path)throw new Error(`Run ${e} has no app_path`);return`${this.getHostUrl()}${t.app_path}`}throw new Error("Must provide either runId or run")}async _loadChildRuns(e){const t=await Pc(this.listRuns({isRoot:!1,projectId:e.session_id,traceId:e.trace_id})),r={},a={};t.sort(((e,t)=>(e?.dotted_order??"").localeCompare(t?.dotted_order??"")));for(const n of t){if(null===n.parent_run_id||void 0===n.parent_run_id)throw new Error(`Child run ${n.id} has no parent`);n.dotted_order?.startsWith(e.dotted_order??"")&&n.id!==e.id&&(n.parent_run_id in r||(r[n.parent_run_id]=[]),r[n.parent_run_id].push(n),a[n.id]=n)}e.child_runs=r[e.id]||[];for(const t in r)t!==e.id&&(a[t].child_runs=r[t]);return e}async*listRuns(e){const{projectId:t,projectName:r,parentRunId:a,traceId:n,referenceExampleId:i,startTime:s,executionOrder:o,isRoot:c,runType:u,error:l,id:d,query:h,filter:p,traceFilter:m,treeFilter:f,limit:g,select:y,order:_}=e;let b=[];if(t&&(b=Array.isArray(t)?t:[t]),r){const e=Array.isArray(r)?r:[r],t=await Promise.all(e.map((e=>this.readProject({projectName:e}).then((e=>e.id)))));b.push(...t)}const v={session:b.length?b:null,run_type:u,reference_example:i,query:h,filter:p,trace_filter:m,tree_filter:f,execution_order:o,parent_run:a,start_time:s?s.toISOString():null,error:l,id:d,limit:g,trace:n,select:y||["app_path","completion_cost","completion_tokens","dotted_order","end_time","error","events","extra","feedback_stats","first_token_time","id","inputs","name","outputs","parent_run_id","parent_run_ids","prompt_cost","prompt_tokens","reference_example_id","run_type","session_id","start_time","status","tags","total_cost","total_tokens","trace_id"],is_root:c,order:_};let w=0;for await(const e of this._getCursorPaginatedList("/runs/query",v))if(g){if(w>=g)break;if(e.length+w>g){yield*e.slice(0,g-w);break}w+=e.length,yield*e}else yield*e}async*listGroupRuns(e){const{projectId:t,projectName:r,groupBy:a,filter:n,startTime:i,endTime:s,limit:o,offset:c}=e,u={session_id:t||(await this.readProject({projectName:r})).id,group_by:a,filter:n,start_time:i?i.toISOString():null,end_time:s?s.toISOString():null,limit:Number(o)||100};let l=Number(c)||0;const d="/runs/group",h=`${this.apiUrl}${d}`;for(;;){const e={...u,offset:l},t=Object.fromEntries(Object.entries(e).filter((([e,t])=>void 0!==t))),r=JSON.stringify(t),a=await(await this.caller.call((async()=>{const e=await this._fetch(h,{method:"POST",headers:{...this.headers,"Content-Type":"application/json"},signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions,body:r});return await k(e,`Failed to fetch ${d}`),e}))).json(),{groups:n,total:i}=a;if(0===n.length)break;for(const e of n)yield e;if(l+=n.length,l>=i)break}}async getRunStats({id:e,trace:t,parentRun:r,runType:a,projectNames:n,projectIds:i,referenceExampleIds:s,startTime:o,endTime:c,error:u,query:l,filter:d,traceFilter:h,treeFilter:p,isRoot:m,dataSourceType:f}){let g=i||[];n&&(g=[...i||[],...await Promise.all(n.map((e=>this.readProject({projectName:e}).then((e=>e.id)))))]);const y=Object.fromEntries(Object.entries({id:e,trace:t,parent_run:r,run_type:a,session:g,reference_example:s,start_time:o,end_time:c,error:u,query:l,filter:d,trace_filter:h,tree_filter:p,is_root:m,data_source_type:f}).filter((([e,t])=>void 0!==t))),_=JSON.stringify(y);return await(await this.caller.call((async()=>{const e=await this._fetch(`${this.apiUrl}/runs/stats`,{method:"POST",headers:{...this.headers,"Content-Type":"application/json"},signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions,body:_});return await k(e,"get run stats"),e}))).json()}async shareRun(e,{shareId:t}={}){const r={run_id:e,share_token:t||oe()};D(e);const a=JSON.stringify(r),n=await(await this.caller.call((async()=>{const t=await this._fetch(`${this.apiUrl}/runs/${e}/share`,{method:"PUT",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions,body:a});return await k(t,"share run"),t}))).json();if(null===n||!("share_token"in n))throw new Error("Invalid response from server");return`${this.getHostUrl()}/public/${n.share_token}/r`}async unshareRun(e){D(e),await this.caller.call((async()=>{const t=await this._fetch(`${this.apiUrl}/runs/${e}/share`,{method:"DELETE",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await k(t,"unshare run",!0),t}))}async readRunSharedLink(e){D(e);const t=await(await this.caller.call((async()=>{const t=await this._fetch(`${this.apiUrl}/runs/${e}/share`,{method:"GET",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await k(t,"read run shared link"),t}))).json();if(null!==t&&"share_token"in t)return`${this.getHostUrl()}/public/${t.share_token}/r`}async listSharedRuns(e,{runIds:t}={}){const r=new URLSearchParams({share_token:e});if(void 0!==t)for(const e of t)r.append("id",e);return D(e),await(await this.caller.call((async()=>{const t=await this._fetch(`${this.apiUrl}/public/${e}/runs${r}`,{method:"GET",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await k(t,"list shared runs"),t}))).json()}async readDatasetSharedSchema(e,t){if(!e&&!t)throw new Error("Either datasetId or datasetName must be given");e||(e=(await this.readDataset({datasetName:t})).id),D(e);const r=await(await this.caller.call((async()=>{const t=await this._fetch(`${this.apiUrl}/datasets/${e}/share`,{method:"GET",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await k(t,"read dataset shared schema"),t}))).json();return r.url=`${this.getHostUrl()}/public/${r.share_token}/d`,r}async shareDataset(e,t){if(!e&&!t)throw new Error("Either datasetId or datasetName must be given");e||(e=(await this.readDataset({datasetName:t})).id);const r={dataset_id:e};D(e);const a=JSON.stringify(r),n=await(await this.caller.call((async()=>{const t=await this._fetch(`${this.apiUrl}/datasets/${e}/share`,{method:"PUT",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions,body:a});return await k(t,"share dataset"),t}))).json();return n.url=`${this.getHostUrl()}/public/${n.share_token}/d`,n}async unshareDataset(e){D(e),await this.caller.call((async()=>{const t=await this._fetch(`${this.apiUrl}/datasets/${e}/share`,{method:"DELETE",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await k(t,"unshare dataset",!0),t}))}async readSharedDataset(e){return D(e),await(await this.caller.call((async()=>{const t=await this._fetch(`${this.apiUrl}/public/${e}/datasets`,{method:"GET",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await k(t,"read shared dataset"),t}))).json()}async listSharedExamples(e,t){const r={};t?.exampleIds&&(r.id=t.exampleIds);const a=new URLSearchParams;Object.entries(r).forEach((([e,t])=>{Array.isArray(t)?t.forEach((t=>a.append(e,t))):a.append(e,t)}));const n=await this.caller.call((async()=>{const t=await this._fetch(`${this.apiUrl}/public/${e}/examples?${a.toString()}`,{method:"GET",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await k(t,"list shared examples"),t})),i=await n.json();if(!n.ok)throw"detail"in i?new Error(`Failed to list shared examples.\nStatus: ${n.status}\nMessage: ${Array.isArray(i.detail)?i.detail.join("\n"):"Unspecified error"}`):new Error(`Failed to list shared examples: ${n.status} ${n.statusText}`);return i.map((e=>({...e,_hostUrl:this.getHostUrl()})))}async createProject({projectName:e,description:t=null,metadata:r=null,upsert:a=!1,projectExtra:n=null,referenceDatasetId:i=null}){const s=a?"?upsert=true":"",o=`${this.apiUrl}/sessions${s}`,c=n||{};r&&(c.metadata=r);const u={name:e,extra:c,description:t};null!==i&&(u.reference_dataset_id=i);const l=JSON.stringify(u);return await(await this.caller.call((async()=>{const e=await this._fetch(o,{method:"POST",headers:{...this.headers,"Content-Type":"application/json"},signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions,body:l});return await k(e,"create project"),e}))).json()}async updateProject(e,{name:t=null,description:r=null,metadata:a=null,projectExtra:n=null,endTime:i=null}){const s=`${this.apiUrl}/sessions/${e}`;let o=n;a&&(o={...o||{},metadata:a});const c=JSON.stringify({name:t,extra:o,description:r,end_time:i?new Date(i).toISOString():null});return await(await this.caller.call((async()=>{const e=await this._fetch(s,{method:"PATCH",headers:{...this.headers,"Content-Type":"application/json"},signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions,body:c});return await k(e,"update project"),e}))).json()}async hasProject({projectId:e,projectName:t}){let r="/sessions";const a=new URLSearchParams;if(void 0!==e&&void 0!==t)throw new Error("Must provide either projectName or projectId, not both");if(void 0!==e)D(e),r+=`/${e}`;else{if(void 0===t)throw new Error("Must provide projectName or projectId");a.append("name",t)}const n=await this.caller.call((async()=>{const e=await this._fetch(`${this.apiUrl}${r}?${a}`,{method:"GET",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await k(e,"has project"),e}));try{const e=await n.json();return!!n.ok&&(!Array.isArray(e)||e.length>0)}catch{return!1}}async readProject({projectId:e,projectName:t,includeStats:r}){let a="/sessions";const n=new URLSearchParams;if(void 0!==e&&void 0!==t)throw new Error("Must provide either projectName or projectId, not both");if(void 0!==e)D(e),a+=`/${e}`;else{if(void 0===t)throw new Error("Must provide projectName or projectId");n.append("name",t)}void 0!==r&&n.append("include_stats",r.toString());const i=await this._get(a,n);let s;if(Array.isArray(i)){if(0===i.length)throw new Error(`Project[id=${e}, name=${t}] not found`);s=i[0]}else s=i;return s}async getProjectUrl({projectId:e,projectName:t}){if(void 0===e&&void 0===t)throw new Error("Must provide either projectName or projectId");const r=await this.readProject({projectId:e,projectName:t}),a=await this._getTenantId();return`${this.getHostUrl()}/o/${a}/projects/p/${r.id}`}async getDatasetUrl({datasetId:e,datasetName:t}){if(void 0===e&&void 0===t)throw new Error("Must provide either datasetName or datasetId");const r=await this.readDataset({datasetId:e,datasetName:t}),a=await this._getTenantId();return`${this.getHostUrl()}/o/${a}/datasets/${r.id}`}async _getTenantId(){if(null!==this._tenantId)return this._tenantId;const e=new URLSearchParams({limit:"1"});for await(const t of this._getPaginated("/sessions",e))return this._tenantId=t[0].tenant_id,t[0].tenant_id;throw new Error("No projects found to resolve tenant.")}async*listProjects({projectIds:e,name:t,nameContains:r,referenceDatasetId:a,referenceDatasetName:n,includeStats:i,datasetVersion:s,referenceFree:o,metadata:c}={}){const u=new URLSearchParams;if(void 0!==e)for(const t of e)u.append("id",t);if(void 0!==t&&u.append("name",t),void 0!==r&&u.append("name_contains",r),void 0!==a)u.append("reference_dataset",a);else if(void 0!==n){const e=await this.readDataset({datasetName:n});u.append("reference_dataset",e.id)}void 0!==i&&u.append("include_stats",i.toString()),void 0!==s&&u.append("dataset_version",s),void 0!==o&&u.append("reference_free",o.toString()),void 0!==c&&u.append("metadata",JSON.stringify(c));for await(const e of this._getPaginated("/sessions",u))yield*e}async deleteProject({projectId:e,projectName:t}){let r;if(void 0===e&&void 0===t)throw new Error("Must provide projectName or projectId");if(void 0!==e&&void 0!==t)throw new Error("Must provide either projectName or projectId, not both");r=void 0===e?(await this.readProject({projectName:t})).id:e,D(r),await this.caller.call((async()=>{const e=await this._fetch(`${this.apiUrl}/sessions/${r}`,{method:"DELETE",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await k(e,`delete session ${r} (${t})`,!0),e}))}async uploadCsv({csvFile:e,fileName:t,inputKeys:r,outputKeys:a,description:n,dataType:i,name:s}){const o=`${this.apiUrl}/datasets/upload`,c=new FormData;return c.append("file",e,t),r.forEach((e=>{c.append("input_keys",e)})),a.forEach((e=>{c.append("output_keys",e)})),n&&c.append("description",n),i&&c.append("data_type",i),s&&c.append("name",s),await(await this.caller.call((async()=>{const e=await this._fetch(o,{method:"POST",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions,body:c});return await k(e,"upload CSV"),e}))).json()}async createDataset(e,{description:t,dataType:r,inputsSchema:a,outputsSchema:n,metadata:i}={}){const s={name:e,description:t,extra:i?{metadata:i}:void 0};r&&(s.data_type=r),a&&(s.inputs_schema_definition=a),n&&(s.outputs_schema_definition=n);const o=JSON.stringify(s);return await(await this.caller.call((async()=>{const e=await this._fetch(`${this.apiUrl}/datasets`,{method:"POST",headers:{...this.headers,"Content-Type":"application/json"},signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions,body:o});return await k(e,"create dataset"),e}))).json()}async readDataset({datasetId:e,datasetName:t}){let r="/datasets";const a=new URLSearchParams({limit:"1"});if(e&&t)throw new Error("Must provide either datasetName or datasetId, not both");if(e)D(e),r+=`/${e}`;else{if(!t)throw new Error("Must provide datasetName or datasetId");a.append("name",t)}const n=await this._get(r,a);let i;if(Array.isArray(n)){if(0===n.length)throw new Error(`Dataset[id=${e}, name=${t}] not found`);i=n[0]}else i=n;return i}async hasDataset({datasetId:e,datasetName:t}){try{return await this.readDataset({datasetId:e,datasetName:t}),!0}catch(e){if(e instanceof Error&&e.message.toLocaleLowerCase().includes("not found"))return!1;throw e}}async diffDatasetVersions({datasetId:e,datasetName:t,fromVersion:r,toVersion:a}){let n=e;if(void 0===n&&void 0===t)throw new Error("Must provide either datasetName or datasetId");if(void 0!==n&&void 0!==t)throw new Error("Must provide either datasetName or datasetId, not both");void 0===n&&(n=(await this.readDataset({datasetName:t})).id);const i=new URLSearchParams({from_version:"string"==typeof r?r:r.toISOString(),to_version:"string"==typeof a?a:a.toISOString()});return await this._get(`/datasets/${n}/versions/diff`,i)}async readDatasetOpenaiFinetuning({datasetId:e,datasetName:t}){if(void 0===e){if(void 0===t)throw new Error("Must provide either datasetName or datasetId");e=(await this.readDataset({datasetName:t})).id}return(await(await this._getResponse(`/datasets/${e}/openai_ft`)).text()).trim().split("\n").map((e=>JSON.parse(e)))}async*listDatasets({limit:e=100,offset:t=0,datasetIds:r,datasetName:a,datasetNameContains:n,metadata:i}={}){const s=new URLSearchParams({limit:e.toString(),offset:t.toString()});if(void 0!==r)for(const e of r)s.append("id",e);void 0!==a&&s.append("name",a),void 0!==n&&s.append("name_contains",n),void 0!==i&&s.append("metadata",JSON.stringify(i));for await(const e of this._getPaginated("/datasets",s))yield*e}async updateDataset(e){const{datasetId:t,datasetName:r,...a}=e;if(!t&&!r)throw new Error("Must provide either datasetName or datasetId");const n=t??(await this.readDataset({datasetName:r})).id;D(n);const i=JSON.stringify(a);return await(await this.caller.call((async()=>{const e=await this._fetch(`${this.apiUrl}/datasets/${n}`,{method:"PATCH",headers:{...this.headers,"Content-Type":"application/json"},signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions,body:i});return await k(e,"update dataset"),e}))).json()}async updateDatasetTag(e){const{datasetId:t,datasetName:r,asOf:a,tag:n}=e;if(!t&&!r)throw new Error("Must provide either datasetName or datasetId");const i=t??(await this.readDataset({datasetName:r})).id;D(i);const s=JSON.stringify({as_of:"string"==typeof a?a:a.toISOString(),tag:n});await this.caller.call((async()=>{const e=await this._fetch(`${this.apiUrl}/datasets/${i}/tags`,{method:"PUT",headers:{...this.headers,"Content-Type":"application/json"},signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions,body:s});return await k(e,"update dataset tags",!0),e}))}async deleteDataset({datasetId:e,datasetName:t}){let r="/datasets",a=e;if(void 0!==e&&void 0!==t)throw new Error("Must provide either datasetName or datasetId, not both");if(void 0!==t&&(a=(await this.readDataset({datasetName:t})).id),void 0===a)throw new Error("Must provide datasetName or datasetId");D(a),r+=`/${a}`,await this.caller.call((async()=>{const e=await this._fetch(this.apiUrl+r,{method:"DELETE",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await k(e,`delete ${r}`,!0),e}))}async indexDataset({datasetId:e,datasetName:t,tag:r}){let a=e;if(!a&&!t)throw new Error("Must provide either datasetName or datasetId");if(a&&t)throw new Error("Must provide either datasetName or datasetId, not both");a||(a=(await this.readDataset({datasetName:t})).id),D(a);const n=JSON.stringify({tag:r});await(await this.caller.call((async()=>{const e=await this._fetch(`${this.apiUrl}/datasets/${a}/index`,{method:"POST",headers:{...this.headers,"Content-Type":"application/json"},signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions,body:n});return await k(e,"index dataset"),e}))).json()}async similarExamples(e,t,r,{filter:a}={}){const n={limit:r,inputs:e};void 0!==a&&(n.filter=a),D(t);const i=JSON.stringify(n);return(await(await this.caller.call((async()=>{const e=await this._fetch(`${this.apiUrl}/datasets/${t}/search`,{headers:{...this.headers,"Content-Type":"application/json"},signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions,method:"POST",body:i});return await k(e,"fetch similar examples"),e}))).json()).examples}async createExample(e,t,r){if(Li(e)&&(void 0!==t||void 0!==r))throw new Error("Cannot provide outputs or options when using ExampleCreate object");let a=t?r?.datasetId:e.dataset_id;const n=t?r?.datasetName:e.dataset_name;if(void 0===a&&void 0===n)throw new Error("Must provide either datasetName or datasetId");if(void 0!==a&&void 0!==n)throw new Error("Must provide either datasetName or datasetId, not both");void 0===a&&(a=(await this.readDataset({datasetName:n})).id);const i=(t?r?.createdAt:e.created_at)||new Date;let s;s=Li(e)?e:{inputs:e,outputs:t,created_at:i?.toISOString(),id:r?.exampleId,metadata:r?.metadata,split:r?.split,source_run_id:r?.sourceRunId,use_source_run_io:r?.useSourceRunIO,use_source_run_attachments:r?.useSourceRunAttachments,attachments:r?.attachments};const o=await this._uploadExamplesMultipart(a,[s]);return await this.readExample(o.example_ids?.[0]??oe())}async createExamples(e){if(Array.isArray(e)){if(0===e.length)return[];const t=e;let r=t[0].dataset_id;const a=t[0].dataset_name;if(void 0===r&&void 0===a)throw new Error("Must provide either datasetName or datasetId");if(void 0!==r&&void 0!==a)throw new Error("Must provide either datasetName or datasetId, not both");void 0===r&&(r=(await this.readDataset({datasetName:a})).id);const n=await this._uploadExamplesMultipart(r,t);return await Promise.all(n.example_ids.map((e=>this.readExample(e))))}const{inputs:t,outputs:r,metadata:a,splits:n,sourceRunIds:i,useSourceRunIOs:s,useSourceRunAttachments:o,attachments:c,exampleIds:u,datasetId:l,datasetName:d}=e;if(void 0===t)throw new Error("Must provide inputs when using legacy parameters");let h=l;const p=d;if(void 0===h&&void 0===p)throw new Error("Must provide either datasetName or datasetId");if(void 0!==h&&void 0!==p)throw new Error("Must provide either datasetName or datasetId, not both");void 0===h&&(h=(await this.readDataset({datasetName:p})).id);const m=t.map(((e,t)=>({dataset_id:h,inputs:e,outputs:r?.[t],metadata:a?.[t],split:n?.[t],id:u?.[t],attachments:c?.[t],source_run_id:i?.[t],use_source_run_io:s?.[t],use_source_run_attachments:o?.[t]}))),f=await this._uploadExamplesMultipart(h,m);return await Promise.all(f.example_ids.map((e=>this.readExample(e))))}async createLLMExample(e,t,r){return this.createExample({input:e},{output:t},r)}async createChatExample(e,t,r){const a=e.map((e=>Da(e)?Ua(e):e)),n=Da(t)?Ua(t):t;return this.createExample({input:a},{output:n},r)}async readExample(e){D(e);const t=`/examples/${e}`,r=await this._get(t),{attachment_urls:a,...n}=r,i=n;return a&&(i.attachments=Object.entries(a).reduce(((e,[t,r])=>(e[t.slice(11)]={presigned_url:r.presigned_url,mime_type:r.mime_type},e)),{})),i}async*listExamples({datasetId:e,datasetName:t,exampleIds:r,asOf:a,splits:n,inlineS3Urls:i,metadata:s,limit:o,offset:c,filter:u,includeAttachments:l}={}){let d;if(void 0!==e&&void 0!==t)throw new Error("Must provide either datasetName or datasetId, not both");if(void 0!==e)d=e;else{if(void 0===t)throw new Error("Must provide a datasetName or datasetId");d=(await this.readDataset({datasetName:t})).id}const h=new URLSearchParams({dataset:d}),p=a?"string"==typeof a?a:a?.toISOString():void 0;p&&h.append("as_of",p);const m=i??!0;if(h.append("inline_s3_urls",m.toString()),void 0!==r)for(const e of r)h.append("id",e);if(void 0!==n)for(const e of n)h.append("splits",e);if(void 0!==s){const e=JSON.stringify(s);h.append("metadata",e)}void 0!==o&&h.append("limit",o.toString()),void 0!==c&&h.append("offset",c.toString()),void 0!==u&&h.append("filter",u),!0===l&&["attachment_urls","outputs","metadata"].forEach((e=>h.append("select",e)));let f=0;for await(const e of this._getPaginated("/examples",h)){for(const t of e){const{attachment_urls:e,...r}=t,a=r;e&&(a.attachments=Object.entries(e).reduce(((e,[t,r])=>(e[t.slice(11)]={presigned_url:r.presigned_url,mime_type:r.mime_type||void 0},e)),{})),yield a,f++}if(void 0!==o&&f>=o)break}}async deleteExample(e){D(e);const t=`/examples/${e}`;await this.caller.call((async()=>{const e=await this._fetch(this.apiUrl+t,{method:"DELETE",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await k(e,`delete ${t}`,!0),e}))}async updateExample(e,t){let r,a,n;return r=t?e:e.id,D(r),a=t?{id:r,...t}:e,n=void 0!==a.dataset_id?a.dataset_id:(await this.readExample(r)).dataset_id,this._updateExamplesMultipart(n,[a])}async updateExamples(e){let t;return t=void 0===e[0].dataset_id?(await this.readExample(e[0].id)).dataset_id:e[0].dataset_id,this._updateExamplesMultipart(t,e)}async readDatasetVersion({datasetId:e,datasetName:t,asOf:r,tag:a}){let n;if(n=e||(await this.readDataset({datasetName:t})).id,D(n),r&&a||!r&&!a)throw new Error("Exactly one of asOf and tag must be specified.");const i=new URLSearchParams;return void 0!==r&&i.append("as_of","string"==typeof r?r:r.toISOString()),void 0!==a&&i.append("tag",a),await(await this.caller.call((async()=>{const e=await this._fetch(`${this.apiUrl}/datasets/${n}/version?${i.toString()}`,{method:"GET",headers:{...this.headers},signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await k(e,"read dataset version"),e}))).json()}async listDatasetSplits({datasetId:e,datasetName:t,asOf:r}){let a;if(void 0===e&&void 0===t)throw new Error("Must provide dataset name or ID");if(void 0!==e&&void 0!==t)throw new Error("Must provide either datasetName or datasetId, not both");a=void 0===e?(await this.readDataset({datasetName:t})).id:e,D(a);const n=new URLSearchParams,i=r?"string"==typeof r?r:r?.toISOString():void 0;return i&&n.append("as_of",i),await this._get(`/datasets/${a}/splits`,n)}async updateDatasetSplits({datasetId:e,datasetName:t,splitName:r,exampleIds:a,remove:n=!1}){let i;if(void 0===e&&void 0===t)throw new Error("Must provide dataset name or ID");if(void 0!==e&&void 0!==t)throw new Error("Must provide either datasetName or datasetId, not both");i=void 0===e?(await this.readDataset({datasetName:t})).id:e,D(i);const s={split_name:r,examples:a.map((e=>(D(e),e))),remove:n},o=JSON.stringify(s);await this.caller.call((async()=>{const e=await this._fetch(`${this.apiUrl}/datasets/${i}/splits`,{method:"PUT",headers:{...this.headers,"Content-Type":"application/json"},signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions,body:o});return await k(e,"update dataset splits",!0),e}))}async evaluateRun(e,t,{sourceInfo:r,loadChildRuns:a,referenceExample:n}={loadChildRuns:!1}){let i;if($s("This method is deprecated and will be removed in future LangSmith versions, use `evaluate` from `langsmith/evaluation` instead."),"string"==typeof e)i=await this.readRun(e,{loadChildRuns:a});else{if("object"!=typeof e||!("id"in e))throw new Error("Invalid run type: "+typeof e);i=e}null!==i.reference_example_id&&void 0!==i.reference_example_id&&(n=await this.readExample(i.reference_example_id));const s=await t.evaluateRun(i,n),[o,c]=await this._logEvaluationFeedback(s,i,r);return c[0]}async createFeedback(e,t,{score:r,value:a,correction:n,comment:i,sourceInfo:s,feedbackSourceType:o="api",sourceRunId:c,feedbackId:u,feedbackConfig:l,projectId:d,comparativeExperimentId:h}){if(!e&&!d)throw new Error("One of runId or projectId must be provided");if(e&&d)throw new Error("Only one of runId or projectId can be provided");const p={type:o??"api",metadata:s??{}};void 0!==c&&void 0!==p?.metadata&&!p.metadata.__run&&(p.metadata.__run={run_id:c}),void 0!==p?.metadata&&void 0!==p.metadata.__run?.run_id&&D(p.metadata.__run.run_id);const m={id:u??oe(),run_id:e,key:t,score:Ci(r),value:a,correction:n,comment:i,feedback_source:p,comparative_experiment_id:h,feedbackConfig:l,session_id:d},f=JSON.stringify(m),g=`${this.apiUrl}/feedback`;return await this.caller.call((async()=>{const e=await this._fetch(g,{method:"POST",headers:{...this.headers,"Content-Type":"application/json"},signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions,body:f});return await k(e,"create feedback",!0),e})),m}async updateFeedback(e,{score:t,value:r,correction:a,comment:n}){const i={};null!=t&&(i.score=Ci(t)),null!=r&&(i.value=r),null!=a&&(i.correction=a),null!=n&&(i.comment=n),D(e);const s=JSON.stringify(i);await this.caller.call((async()=>{const t=await this._fetch(`${this.apiUrl}/feedback/${e}`,{method:"PATCH",headers:{...this.headers,"Content-Type":"application/json"},signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions,body:s});return await k(t,"update feedback",!0),t}))}async readFeedback(e){D(e);const t=`/feedback/${e}`;return await this._get(t)}async deleteFeedback(e){D(e);const t=`/feedback/${e}`;await this.caller.call((async()=>{const e=await this._fetch(this.apiUrl+t,{method:"DELETE",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await k(e,`delete ${t}`,!0),e}))}async*listFeedback({runIds:e,feedbackKeys:t,feedbackSourceTypes:r}={}){const a=new URLSearchParams;if(e)for(const t of e)D(t),a.append("run",t);if(t)for(const e of t)a.append("key",e);if(r)for(const e of r)a.append("source",e);for await(const e of this._getPaginated("/feedback",a))yield*e}async createPresignedFeedbackToken(e,t,{expiration:r,feedbackConfig:a}={}){const n={run_id:e,feedback_key:t,feedback_config:a};r?"string"==typeof r?n.expires_at=r:(r?.hours||r?.minutes||r?.days)&&(n.expires_in=r):n.expires_in={hours:3};const i=JSON.stringify(n);return await(await this.caller.call((async()=>{const e=await this._fetch(`${this.apiUrl}/feedback/tokens`,{method:"POST",headers:{...this.headers,"Content-Type":"application/json"},signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions,body:i});return await k(e,"create presigned feedback token"),e}))).json()}async createComparativeExperiment({name:e,experimentIds:t,referenceDatasetId:r,createdAt:a,description:n,metadata:i,id:s}){if(0===t.length)throw new Error("At least one experiment is required");if(r||(r=(await this.readProject({projectId:t[0]})).reference_dataset_id),null==!r)throw new Error("A reference dataset is required");const o={id:s,name:e,experiment_ids:t,reference_dataset_id:r,description:n,created_at:(a??new Date)?.toISOString(),extra:{}};i&&(o.extra.metadata=i);const c=JSON.stringify(o);return(await this.caller.call((async()=>{const e=await this._fetch(`${this.apiUrl}/datasets/comparative`,{method:"POST",headers:{...this.headers,"Content-Type":"application/json"},signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions,body:c});return await k(e,"create comparative experiment"),e}))).json()}async*listPresignedFeedbackTokens(e){D(e);const t=new URLSearchParams({run_id:e});for await(const e of this._getPaginated("/feedback/tokens",t))yield*e}_selectEvalResults(e){let t;return t="results"in e?e.results:Array.isArray(e)?e:[e],t}async _logEvaluationFeedback(e,t,r){const a=this._selectEvalResults(e),n=[];for(const e of a){let a=r||{};e.evaluatorInfo&&(a={...e.evaluatorInfo,...a});let i=null;e.targetRunId?i=e.targetRunId:t&&(i=t.id),n.push(await this.createFeedback(i,e.key,{score:e.score,value:e.value,comment:e.comment,correction:e.correction,sourceInfo:a,sourceRunId:e.sourceRunId,feedbackConfig:e.feedbackConfig,feedbackSourceType:"model"}))}return[a,n]}async logEvaluationFeedback(e,t,r){const[a]=await this._logEvaluationFeedback(e,t,r);return a}async*listAnnotationQueues(e={}){const{queueIds:t,name:r,nameContains:a,limit:n}=e,i=new URLSearchParams;t&&t.forEach(((e,t)=>{D(e,`queueIds[${t}]`),i.append("ids",e)})),r&&i.append("name",r),a&&i.append("name_contains",a),i.append("limit",(void 0!==n?Math.min(n,100):100).toString());let s=0;for await(const e of this._getPaginated("/annotation-queues",i))if(yield*e,s++,void 0!==n&&s>=n)break}async createAnnotationQueue(e){const{name:t,description:r,queueId:a,rubricInstructions:n}=e,i={name:t,description:r,id:a||oe(),rubric_instructions:n},s=JSON.stringify(Object.fromEntries(Object.entries(i).filter((([e,t])=>void 0!==t))));return(await this.caller.call((async()=>{const e=await this._fetch(`${this.apiUrl}/annotation-queues`,{method:"POST",headers:{...this.headers,"Content-Type":"application/json"},signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions,body:s});return await k(e,"create annotation queue"),e}))).json()}async readAnnotationQueue(e){return(await this.caller.call((async()=>{const t=await this._fetch(`${this.apiUrl}/annotation-queues/${D(e,"queueId")}`,{method:"GET",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await k(t,"read annotation queue"),t}))).json()}async updateAnnotationQueue(e,t){const{name:r,description:a,rubricInstructions:n}=t,i=JSON.stringify({name:r,description:a,rubric_instructions:n});await this.caller.call((async()=>{const t=await this._fetch(`${this.apiUrl}/annotation-queues/${D(e,"queueId")}`,{method:"PATCH",headers:{...this.headers,"Content-Type":"application/json"},signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions,body:i});return await k(t,"update annotation queue",!0),t}))}async deleteAnnotationQueue(e){await this.caller.call((async()=>{const t=await this._fetch(`${this.apiUrl}/annotation-queues/${D(e,"queueId")}`,{method:"DELETE",headers:{...this.headers,Accept:"application/json"},signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await k(t,"delete annotation queue",!0),t}))}async addRunsToAnnotationQueue(e,t){const r=JSON.stringify(t.map(((e,t)=>D(e,`runIds[${t}]`).toString())));await this.caller.call((async()=>{const t=await this._fetch(`${this.apiUrl}/annotation-queues/${D(e,"queueId")}/runs`,{method:"POST",headers:{...this.headers,"Content-Type":"application/json"},signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions,body:r});return await k(t,"add runs to annotation queue",!0),t}))}async getRunFromAnnotationQueue(e,t){const r=`/annotation-queues/${D(e,"queueId")}/run`;return(await this.caller.call((async()=>{const e=await this._fetch(`${this.apiUrl}${r}/${t}`,{method:"GET",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await k(e,"get run from annotation queue"),e}))).json()}async deleteRunFromAnnotationQueue(e,t){await this.caller.call((async()=>{const r=await this._fetch(`${this.apiUrl}/annotation-queues/${D(e,"queueId")}/runs/${D(t,"queueRunId")}`,{method:"DELETE",headers:{...this.headers,Accept:"application/json"},signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await k(r,"delete run from annotation queue",!0),r}))}async getSizeFromAnnotationQueue(e){return(await this.caller.call((async()=>{const t=await this._fetch(`${this.apiUrl}/annotation-queues/${D(e,"queueId")}/size`,{method:"GET",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await k(t,"get size from annotation queue"),t}))).json()}async _currentTenantIsOwner(e){const t=await this._getSettings();return"-"==e||t.tenant_handle===e}async _ownerConflictError(e,t){const r=await this._getSettings();return new Error(`Cannot ${e} for another tenant.\n\n      Current tenant: ${r.tenant_handle}\n\n      Requested tenant: ${t}`)}async _getLatestCommitHash(e){const t=await(await this.caller.call((async()=>{const t=await this._fetch(`${this.apiUrl}/commits/${e}/?limit=1&offset=0`,{method:"GET",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await k(t,"get latest commit hash"),t}))).json();if(0!==t.commits.length)return t.commits[0].commit_hash}async _likeOrUnlikePrompt(e,t){const[r,a,n]=Ce(e),i=JSON.stringify({like:t});return(await this.caller.call((async()=>{const e=await this._fetch(`${this.apiUrl}/likes/${r}/${a}`,{method:"POST",headers:{...this.headers,"Content-Type":"application/json"},signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions,body:i});return await k(e,(t?"like":"unlike")+" prompt"),e}))).json()}async _getPromptUrl(e){const[t,r,a]=Ce(e);if(await this._currentTenantIsOwner(t)){const e=await this._getSettings();return"latest"!==a?`${this.getHostUrl()}/prompts/${r}/${a.substring(0,8)}?organizationId=${e.id}`:`${this.getHostUrl()}/prompts/${r}?organizationId=${e.id}`}return"latest"!==a?`${this.getHostUrl()}/hub/${t}/${r}/${a.substring(0,8)}`:`${this.getHostUrl()}/hub/${t}/${r}`}async promptExists(e){return!!await this.getPrompt(e)}async likePrompt(e){return this._likeOrUnlikePrompt(e,!0)}async unlikePrompt(e){return this._likeOrUnlikePrompt(e,!1)}async*listCommits(e){for await(const t of this._getPaginated(`/commits/${e}/`,new URLSearchParams,(e=>e.commits)))yield*t}async*listPrompts(e){const t=new URLSearchParams;t.append("sort_field",e?.sortField??"updated_at"),t.append("sort_direction","desc"),t.append("is_archived",(!!e?.isArchived).toString()),void 0!==e?.isPublic&&t.append("is_public",e.isPublic.toString()),e?.query&&t.append("query",e.query);for await(const e of this._getPaginated("/repos",t,(e=>e.repos)))yield*e}async getPrompt(e){const[t,r,a]=Ce(e),n=await((await this.caller.call((async()=>{const e=await this._fetch(`${this.apiUrl}/repos/${t}/${r}`,{method:"GET",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return 404===e?.status?null:(await k(e,"get prompt"),e)})))?.json());return n?.repo?n.repo:null}async createPrompt(e,t){const r=await this._getSettings();if(t?.isPublic&&!r.tenant_handle)throw new Error("Cannot create a public prompt without first\n\n        creating a LangChain Hub handle.\n        You can add a handle by creating a public prompt at:\n\n        https://smith.langchain.com/prompts");const[a,n,i]=Ce(e);if(!await this._currentTenantIsOwner(a))throw await this._ownerConflictError("create a prompt",a);const s={repo_handle:n,...t?.description&&{description:t.description},...t?.readme&&{readme:t.readme},...t?.tags&&{tags:t.tags},is_public:!!t?.isPublic},o=JSON.stringify(s),c=await this.caller.call((async()=>{const e=await this._fetch(`${this.apiUrl}/repos/`,{method:"POST",headers:{...this.headers,"Content-Type":"application/json"},signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions,body:o});return await k(e,"create prompt"),e})),{repo:u}=await c.json();return u}async createCommit(e,t,r){if(!await this.promptExists(e))throw new Error("Prompt does not exist, you must create it first.");const[a,n,i]=Ce(e),s="latest"!==r?.parentCommitHash&&r?.parentCommitHash?r?.parentCommitHash:await this._getLatestCommitHash(`${a}/${n}`),o={manifest:JSON.parse(JSON.stringify(t)),parent_commit:s},c=JSON.stringify(o),u=await(await this.caller.call((async()=>{const e=await this._fetch(`${this.apiUrl}/commits/${a}/${n}`,{method:"POST",headers:{...this.headers,"Content-Type":"application/json"},signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions,body:c});return await k(e,"create commit"),e}))).json();return this._getPromptUrl(`${a}/${n}${u.commit_hash?`:${u.commit_hash}`:""}`)}async updateExamplesMultipart(e,t=[]){return this._updateExamplesMultipart(e,t)}async _updateExamplesMultipart(e,t=[]){if(!await this._getDatasetExamplesMultiPartSupport())throw new Error("Your LangSmith deployment does not allow using the multipart examples endpoint, please upgrade your deployment to the latest version.");const r=new FormData;for(const e of t){const t=e.id,a=pe({...e.metadata&&{metadata:e.metadata},...e.split&&{split:e.split}},`Serializing body for example with id: ${t}`),n=new Blob([a],{type:"application/json"});if(r.append(t,n),e.inputs){const a=pe(e.inputs,`Serializing inputs for example with id: ${t}`),n=new Blob([a],{type:"application/json"});r.append(`${t}.inputs`,n)}if(e.outputs){const a=pe(e.outputs,`Serializing outputs whle updating example with id: ${t}`),n=new Blob([a],{type:"application/json"});r.append(`${t}.outputs`,n)}if(e.attachments)for(const[a,n]of Object.entries(e.attachments)){let e,i;Array.isArray(n)?[e,i]=n:(e=n.mimeType,i=n.data);const s=new Blob([i],{type:`${e}; length=${i.byteLength}`});r.append(`${t}.attachment.${a}`,s)}if(e.attachments_operations){const a=pe(e.attachments_operations,`Serializing attachments while updating example with id: ${t}`),n=new Blob([a],{type:"application/json"});r.append(`${t}.attachments_operations`,n)}}const a=e??t[0]?.dataset_id;return(await this.caller.call((async()=>{const e=await this._fetch(`${this.apiUrl}${this._getPlatformEndpointPath(`datasets/${a}/examples`)}`,{method:"PATCH",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions,body:r});return await k(e,"update examples"),e}))).json()}async uploadExamplesMultipart(e,t=[]){return this._uploadExamplesMultipart(e,t)}async _uploadExamplesMultipart(e,t=[]){if(!await this._getDatasetExamplesMultiPartSupport())throw new Error("Your LangSmith deployment does not allow using the multipart examples endpoint, please upgrade your deployment to the latest version.");const r=new FormData;for(const e of t){const t=(e.id??oe()).toString(),a=pe({created_at:e.created_at,...e.metadata&&{metadata:e.metadata},...e.split&&{split:e.split},...e.source_run_id&&{source_run_id:e.source_run_id},...e.use_source_run_io&&{use_source_run_io:e.use_source_run_io},...e.use_source_run_attachments&&{use_source_run_attachments:e.use_source_run_attachments}},`Serializing body for uploaded example with id: ${t}`),n=new Blob([a],{type:"application/json"});if(r.append(t,n),e.inputs){const a=pe(e.inputs,`Serializing inputs for uploaded example with id: ${t}`),n=new Blob([a],{type:"application/json"});r.append(`${t}.inputs`,n)}if(e.outputs){const a=pe(e.outputs,`Serializing outputs for uploaded example with id: ${t}`),n=new Blob([a],{type:"application/json"});r.append(`${t}.outputs`,n)}if(e.attachments)for(const[a,n]of Object.entries(e.attachments)){let e,i;Array.isArray(n)?[e,i]=n:(e=n.mimeType,i=n.data);const s=new Blob([i],{type:`${e}; length=${i.byteLength}`});r.append(`${t}.attachment.${a}`,s)}}return(await this.caller.call((async()=>{const t=await this._fetch(`${this.apiUrl}${this._getPlatformEndpointPath(`datasets/${e}/examples`)}`,{method:"POST",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions,body:r});return await k(t,"upload examples"),t}))).json()}async updatePrompt(e,t){if(!await this.promptExists(e))throw new Error("Prompt does not exist, you must create it first.");const[r,a]=Ce(e);if(!await this._currentTenantIsOwner(r))throw await this._ownerConflictError("update a prompt",r);const n={};if(void 0!==t?.description&&(n.description=t.description),void 0!==t?.readme&&(n.readme=t.readme),void 0!==t?.tags&&(n.tags=t.tags),void 0!==t?.isPublic&&(n.is_public=t.isPublic),void 0!==t?.isArchived&&(n.is_archived=t.isArchived),0===Object.keys(n).length)throw new Error("No valid update options provided");const i=JSON.stringify(n);return(await this.caller.call((async()=>{const e=await this._fetch(`${this.apiUrl}/repos/${r}/${a}`,{method:"PATCH",headers:{...this.headers,"Content-Type":"application/json"},signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions,body:i});return await k(e,"update prompt"),e}))).json()}async deletePrompt(e){if(!await this.promptExists(e))throw new Error("Prompt does not exist, you must create it first.");const[t,r,a]=Ce(e);if(!await this._currentTenantIsOwner(t))throw await this._ownerConflictError("delete a prompt",t);return(await this.caller.call((async()=>{const e=await this._fetch(`${this.apiUrl}/repos/${t}/${r}`,{method:"DELETE",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await k(e,"delete prompt"),e}))).json()}async pullPromptCommit(e,t){const[r,a,n]=Ce(e),i=await(await this.caller.call((async()=>{const e=await this._fetch(`${this.apiUrl}/commits/${r}/${a}/${n}${t?.includeModel?"?include_model=true":""}`,{method:"GET",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await k(e,"pull prompt commit"),e}))).json();return{owner:r,repo:a,commit_hash:i.commit_hash,manifest:i.manifest,examples:i.examples}}async _pullPrompt(e,t){const r=await this.pullPromptCommit(e,{includeModel:t?.includeModel});return JSON.stringify(r.manifest)}async pushPrompt(e,t){return await this.promptExists(e)?t&&Object.keys(t).some((e=>"object"!==e))&&await this.updatePrompt(e,{description:t?.description,readme:t?.readme,tags:t?.tags,isPublic:t?.isPublic}):await this.createPrompt(e,{description:t?.description,readme:t?.readme,tags:t?.tags,isPublic:t?.isPublic}),t?.object?await this.createCommit(e,t?.object,{parentCommitHash:t?.parentCommitHash}):await this._getPromptUrl(e)}async clonePublicDataset(e,t={}){const{sourceApiUrl:r=this.apiUrl,datasetName:a}=t,[n,i]=this.parseTokenOrUrl(e,r),s=new wt({apiUrl:n,apiKey:"placeholder"}),o=await s.readSharedDataset(i),c=a||o.name;try{if(await this.hasDataset({datasetId:c}))return void console.log(`Dataset ${c} already exists in your tenant. Skipping.`)}catch{}const u=await s.listSharedExamples(i),l=await this.createDataset(c,{description:o.description,dataType:o.data_type||"kv",inputsSchema:o.inputs_schema_definition??void 0,outputsSchema:o.outputs_schema_definition??void 0});try{await this.createExamples({inputs:u.map((e=>e.inputs)),outputs:u.flatMap((e=>e.outputs?[e.outputs]:[])),datasetId:l.id})}catch(e){throw console.error(`An error occurred while creating dataset ${c}. You should delete it manually.`),e}}parseTokenOrUrl(e,t,r=2,a="dataset"){try{return D(e),[t,e]}catch{}try{const n=new URL(e).pathname.split("/").filter((e=>""!==e));if(n.length>=r){return[t,n[n.length-r]]}throw new Error(`Invalid public ${a} URL: ${e}`)}catch{throw new Error(`Invalid public ${a} URL or token: ${e}`)}}async awaitPendingTraceBatches(){if(this.manualFlushMode)return console.warn("[WARNING]: When tracing in manual flush mode, you must call `await client.flush()` manually to submit trace batches."),Promise.resolve();await Promise.all([...this.autoBatchQueue.items.map((({itemPromise:e})=>e)),this.batchIngestCaller.queue.onIdle()]),void 0!==this.langSmithToOTELTranslator&&await(Gu()?.DEFAULT_LANGSMITH_SPAN_PROCESSOR?.forceFlush())}}function Li(e){return"dataset_id"in e||"dataset_name"in e}const Lc=e=>!!["TRACING_V2","TRACING"].find((e=>"true"===he(e))),Sn=Symbol.for("lc:context_variables");function Mc(e){return e.replace(/[-:.]/g,"")}function Fs(e,t,r=1){const a=r.toFixed(0).slice(0,3).padStart(3,"0"),n=`${new Date(e).toISOString().slice(0,-1)}${a}Z`;return{dottedOrder:Mc(n)+t,microsecondPrecisionDatestring:n}}class Ht{constructor(e,t,r,a){Object.defineProperty(this,"metadata",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"tags",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"project_name",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"replicas",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.metadata=e,this.tags=t,this.project_name=r,this.replicas=a}static fromHeader(e){const t=e.split(",");let r,a,n={},i=[];for(const e of t){const[t,s]=e.split("="),o=decodeURIComponent(s);"langsmith-metadata"===t?n=JSON.parse(o):"langsmith-tags"===t?i=o.split(","):"langsmith-project"===t?r=o:"langsmith-replicas"===t&&(a=JSON.parse(o))}return new Ht(n,i,r,a)}toHeader(){const e=[];return this.metadata&&Object.keys(this.metadata).length>0&&e.push(`langsmith-metadata=${encodeURIComponent(JSON.stringify(this.metadata))}`),this.tags&&this.tags.length>0&&e.push(`langsmith-tags=${encodeURIComponent(this.tags.join(","))}`),this.project_name&&e.push(`langsmith-project=${encodeURIComponent(this.project_name)}`),e.join(",")}}class de{constructor(e){if(Object.defineProperty(this,"id",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"run_type",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"project_name",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"parent_run",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"parent_run_id",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"child_runs",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"start_time",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"end_time",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"extra",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"tags",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"error",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"serialized",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"inputs",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"outputs",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"reference_example_id",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"client",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"events",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"trace_id",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"dotted_order",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"tracingEnabled",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"execution_order",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"child_execution_order",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"attachments",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"replicas",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"_serialized_start_time",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Dc(e))return void Object.assign(this,{...e});const t=de.getDefaultConfig(),{metadata:r,...a}=e,n=a.client??de.getSharedClient(),i={...r,...a?.extra?.metadata};if(a.extra={...a.extra,metadata:i},Object.assign(this,{...t,...a,client:n}),this.trace_id||(this.parent_run?this.trace_id=this.parent_run.trace_id??this.id:this.trace_id=this.id),this.replicas=qc(this.replicas),this.execution_order??=1,this.child_execution_order??=1,!this.dotted_order){const{dottedOrder:e,microsecondPrecisionDatestring:t}=Fs(this.start_time,this.id,this.execution_order);this.parent_run?this.dotted_order=this.parent_run.dotted_order+"."+e:this.dotted_order=e,this._serialized_start_time=t}}set metadata(e){this.extra={...this.extra,metadata:{...this.extra?.metadata,...e}}}get metadata(){return this.extra?.metadata}static getDefaultConfig(){return{id:oe(),run_type:"chain",project_name:Rs(),child_runs:[],api_url:Ae("LANGCHAIN_ENDPOINT")??"http://localhost:1984",api_key:Ae("LANGCHAIN_API_KEY"),caller_options:{},start_time:Date.now(),serialized:{},inputs:{},extra:{}}}static getSharedClient(){return de.sharedClient||(de.sharedClient=new wt),de.sharedClient}createChild(e){const t=this.child_execution_order+1,r=new de({...e,parent_run:this,project_name:this.project_name,replicas:this.replicas,client:this.client,tracingEnabled:this.tracingEnabled,execution_order:t,child_execution_order:t});Sn in this&&(r[Sn]=this[Sn]);const a=Symbol.for("lc:child_config"),n=e.extra?.[a]??this.extra[a];if(Fc(n)){const e={...n},t=Uc(e.callbacks)?e.callbacks.copy?.():void 0;t&&(Object.assign(t,{_parentRunId:r.id}),t.handlers?.find(zs)?.updateFromRunTree?.(r),e.callbacks=t),r.extra[a]=e}const i=new Set;let s=this;for(;null!=s&&!i.has(s.id);)i.add(s.id),s.child_execution_order=Math.max(s.child_execution_order,t),s=s.parent_run;return this.child_runs.push(r),r}async end(e,t,r=Date.now(),a){this.outputs=this.outputs??e,this.error=this.error??t,this.end_time=this.end_time??r,a&&Object.keys(a).length>0&&(this.extra=this.extra?{...this.extra,metadata:{...this.extra.metadata,...a}}:{metadata:a})}_convertToCreate(e,t,r=!0){const a=e.extra??{};if(void 0===a?.runtime?.library&&(a.runtime||(a.runtime={}),t))for(const[e,r]of Object.entries(t))a.runtime[e]||(a.runtime[e]=r);let n,i;return r?(i=e.parent_run?.id??e.parent_run_id,n=[]):(n=e.child_runs.map((e=>this._convertToCreate(e,t,r))),i=void 0),{id:e.id,name:e.name,start_time:e._serialized_start_time??e.start_time,end_time:e.end_time,run_type:e.run_type,reference_example_id:e.reference_example_id,extra:a,serialized:e.serialized,error:e.error,inputs:e.inputs,outputs:e.outputs,session_name:e.project_name,child_runs:n,parent_run_id:i,trace_id:e.trace_id,dotted_order:e.dotted_order,tags:e.tags,attachments:e.attachments,events:e.events}}_remapForProject(e,t,r=!0){const a=this._convertToCreate(this,t,r);if(e===this.project_name)return a;const n=t=>Ra(`${t}:${e}`,Ra.DNS),i=n(a.id),s=a.trace_id?n(a.trace_id):void 0,o=a.parent_run_id?n(a.parent_run_id):void 0;let c;if(a.dotted_order){const e=zc(a.dotted_order),t=[];for(let r=0;r<e.length-1;r++){const[a,i]=e[r],s=n(i);t.push(a.toISOString().replace(/[-:]/g,"").replace(".","")+s)}const[r]=e[e.length-1];t.push(r.toISOString().replace(/[-:]/g,"").replace(".","")+i),c=t.join(".")}else c=void 0;return{...a,id:i,trace_id:s,parent_run_id:o,dotted_order:c,session_name:e}}async postRun(e=!0){try{const t=ks();if(this.replicas&&this.replicas.length>0)for(const{projectName:e,apiKey:r,apiUrl:a,workspaceId:n}of this.replicas){const i=this._remapForProject(e??this.project_name,t,!0);await this.client.createRun(i,{apiKey:r,apiUrl:a,workspaceId:n})}else{const r=this._convertToCreate(this,t,e);await this.client.createRun(r)}if(!e){$s("Posting with excludeChildRuns=false is deprecated and will be removed in a future version.");for(const e of this.child_runs)await e.postRun(!1)}}catch(e){console.error(`Error in postRun for run ${this.id}:`,e)}}async patchRun(e){if(this.replicas&&this.replicas.length>0)for(const{projectName:t,apiKey:r,apiUrl:a,workspaceId:n,updates:i}of this.replicas){const s=this._remapForProject(t??this.project_name),o={id:s.id,outputs:s.outputs,error:s.error,parent_run_id:s.parent_run_id,session_name:s.session_name,reference_example_id:s.reference_example_id,end_time:s.end_time,dotted_order:s.dotted_order,trace_id:s.trace_id,events:s.events,tags:s.tags,extra:s.extra,attachments:this.attachments,...i};e?.excludeInputs||(o.inputs=s.inputs),await this.client.updateRun(s.id,o,{apiKey:r,apiUrl:a,workspaceId:n})}else try{const t={end_time:this.end_time,error:this.error,outputs:this.outputs,parent_run_id:this.parent_run?.id??this.parent_run_id,reference_example_id:this.reference_example_id,extra:this.extra,events:this.events,dotted_order:this.dotted_order,trace_id:this.trace_id,tags:this.tags,attachments:this.attachments,session_name:this.project_name};e?.excludeInputs||(t.inputs=this.inputs),await this.client.updateRun(this.id,t)}catch(e){console.error(`Error in patchRun for run ${this.id}`,e)}}toJSON(){return this._convertToCreate(this,void 0,!1)}addEvent(e){this.events||(this.events=[]),"string"==typeof e?this.events.push({name:"event",time:(new Date).toISOString(),message:e}):this.events.push({...e,time:e.time??(new Date).toISOString()})}static fromRunnableConfig(e,t){const r=e?.callbacks;let a,n,i,s=Lc();if(r){const e=r?.getParentRunId?.()??"",t=r?.handlers?.find((e=>"langchain_tracer"==e?.name));a=t?.getRun?.(e),n=t?.projectName,i=t?.client,s=s||!!t}return a?new de({name:a.name,id:a.id,trace_id:a.trace_id,dotted_order:a.dotted_order,client:i,tracingEnabled:s,project_name:n,tags:[...new Set((a?.tags??[]).concat(e?.tags??[]))],extra:{metadata:{...a?.extra?.metadata,...e?.metadata}}}).createChild(t):new de({...t,client:i,tracingEnabled:s,project_name:n})}static fromDottedOrder(e){return this.fromHeaders({"langsmith-trace":e})}static fromHeaders(e,t){const r="get"in e&&"function"==typeof e.get?{"langsmith-trace":e.get("langsmith-trace"),baggage:e.get("baggage")}:e,a=r["langsmith-trace"];if(!a||"string"!=typeof a)return;const n=a.trim(),i=n.split(".").map((e=>{const[t,r]=e.split("Z");return{strTime:t,time:Date.parse(t+"Z"),uuid:r}})),s=i[0].uuid,o={...t,name:t?.name??"parent",run_type:t?.run_type??"chain",start_time:t?.start_time??Date.now(),id:i.at(-1)?.uuid,trace_id:s,dotted_order:n};if(r.baggage&&"string"==typeof r.baggage){const e=Ht.fromHeader(r.baggage);o.metadata=e.metadata,o.tags=e.tags,o.project_name=e.project_name,o.replicas=e.replicas}return new de(o)}toHeaders(e){const t={"langsmith-trace":this.dotted_order,baggage:new Ht(this.extra?.metadata,this.tags,this.project_name,this.replicas).toHeader()};if(e)for(const[r,a]of Object.entries(t))e.set(r,a);return t}}function Dc(e){return null!=e&&"function"==typeof e.createChild&&"function"==typeof e.postRun}function zs(e){return"object"==typeof e&&null!=e&&"string"==typeof e.name&&"langchain_tracer"===e.name}function Mi(e){return Array.isArray(e)&&e.some((e=>zs(e)))}function Uc(e){return"object"==typeof e&&null!=e&&Array.isArray(e.handlers)}function Fc(e){return null!=e&&"object"==typeof e.callbacks&&(Mi(e.callbacks?.handlers)||Mi(e.callbacks))}function zc(e){return e.split(".").map((e=>{const t=e.slice(0,-36),r=e.slice(-36),a=parseInt(t.slice(0,4)),n=parseInt(t.slice(4,6))-1,i=parseInt(t.slice(6,8)),s=parseInt(t.slice(9,11)),o=parseInt(t.slice(11,13)),c=parseInt(t.slice(13,15)),u=parseInt(t.slice(15,21));return[new Date(a,n,i,s,o,c,u/1e3),r]}))}function Bc(){const e=Ae("LANGSMITH_RUNS_ENDPOINTS");if(!e)return[];try{const t=JSON.parse(e);if(Array.isArray(t)){const e=[];for(const r of t)"object"==typeof r&&null!==r?"string"==typeof r.api_url?"string"==typeof r.api_key?e.push({apiUrl:r.api_url.replace(/\/$/,""),apiKey:r.api_key}):console.warn("Invalid api_key type in LANGSMITH_RUNS_ENDPOINTS: expected string, got "+typeof r.api_key):console.warn("Invalid api_url type in LANGSMITH_RUNS_ENDPOINTS: expected string, got "+typeof r.api_url):console.warn("Invalid item type in LANGSMITH_RUNS_ENDPOINTS: expected object, got "+typeof r);return e}if("object"==typeof t&&null!==t){Gc(t);const e=[];for(const[r,a]of Object.entries(t)){const t=r.replace(/\/$/,"");"string"==typeof a?e.push({apiUrl:t,apiKey:a}):console.warn(`Invalid value type in LANGSMITH_RUNS_ENDPOINTS for URL ${r}: expected string, got ${typeof a}`)}return e}return console.warn("Invalid LANGSMITH_RUNS_ENDPOINTS – must be valid JSON array of objects with api_url and api_key properties, or object mapping url->apiKey, got "+typeof t),[]}catch(e){if(Sc(e))throw e;return console.warn("Invalid LANGSMITH_RUNS_ENDPOINTS – must be valid JSON array of objects with api_url and api_key properties, or object mapping url->apiKey"),[]}}function qc(e){return e?e.map((e=>Array.isArray(e)?{projectName:e[0],updates:e[1]}:e)):Bc()}function Gc(e){if(Object.keys(e).length>0&&he("ENDPOINT"))throw new Ec}Object.defineProperty(de,"sharedClient",{enumerable:!0,configurable:!0,writable:!0,value:null});const Hc=e=>{if(e)return e.events=e.events??[],e.child_runs=e.child_runs??[],e};function Dn(e,t){if(e)return new de({...e,start_time:e._serialized_start_time??e.start_time,parent_run:Dn(t),child_runs:e.child_runs.map((e=>Dn(e))).filter((e=>void 0!==e)),extra:{...e.extra,runtime:Jo()},tracingEnabled:!1})}function On(e,t){return e&&!Array.isArray(e)&&"object"==typeof e?e:{[t]:e}}function ht(e){return"function"==typeof e._addRunToRunMap}class At extends Rt{constructor(e){super(...arguments),Object.defineProperty(this,"runMap",{enumerable:!0,configurable:!0,writable:!0,value:new Map}),Object.defineProperty(this,"runTreeMap",{enumerable:!0,configurable:!0,writable:!0,value:new Map}),Object.defineProperty(this,"usesRunTreeMap",{enumerable:!0,configurable:!0,writable:!0,value:!1})}copy(){return this}getRunById(e){if(void 0!==e)return this.usesRunTreeMap?Hc(this.runTreeMap.get(e)):this.runMap.get(e)}stringifyError(e){return e instanceof Error?e.message+(e?.stack?`\n\n${e.stack}`:""):"string"==typeof e?e:`${e}`}_addChildRun(e,t){e.child_runs.push(t)}_addRunToRunMap(e){const{dottedOrder:t,microsecondPrecisionDatestring:r}=Fs(new Date(e.start_time).getTime(),e.id,e.execution_order),a={...e},n=this.getRunById(a.parent_run_id);if(void 0!==a.parent_run_id?n&&(this._addChildRun(n,a),n.child_execution_order=Math.max(n.child_execution_order,a.child_execution_order),a.trace_id=n.trace_id,void 0!==n.dotted_order&&(a.dotted_order=[n.dotted_order,t].join("."),a._serialized_start_time=r)):(a.trace_id=a.id,a.dotted_order=t,a._serialized_start_time=r),this.usesRunTreeMap){const e=Dn(a,n);void 0!==e&&this.runTreeMap.set(a.id,e)}else this.runMap.set(a.id,a);return a}async _endTrace(e){const t=void 0!==e.parent_run_id&&this.getRunById(e.parent_run_id);t?t.child_execution_order=Math.max(t.child_execution_order,e.child_execution_order):await this.persistRun(e),await(this.onRunUpdate?.(e)),this.usesRunTreeMap?this.runTreeMap.delete(e.id):this.runMap.delete(e.id)}_getExecutionOrder(e){const t=void 0!==e&&this.getRunById(e);return t?t.child_execution_order+1:1}_createRunForLLMStart(e,t,r,a,n,i,s,o){const c=this._getExecutionOrder(a),u=Date.now(),l=s?{...n,metadata:s}:n,d={id:r,name:o??e.id[e.id.length-1],parent_run_id:a,start_time:u,serialized:e,events:[{name:"start",time:new Date(u).toISOString()}],inputs:{prompts:t},execution_order:c,child_runs:[],child_execution_order:c,run_type:"llm",extra:l??{},tags:i||[]};return this._addRunToRunMap(d)}async handleLLMStart(e,t,r,a,n,i,s,o){const c=this.getRunById(r)??this._createRunForLLMStart(e,t,r,a,n,i,s,o);return await(this.onRunCreate?.(c)),await(this.onLLMStart?.(c)),c}_createRunForChatModelStart(e,t,r,a,n,i,s,o){const c=this._getExecutionOrder(a),u=Date.now(),l=s?{...n,metadata:s}:n,d={id:r,name:o??e.id[e.id.length-1],parent_run_id:a,start_time:u,serialized:e,events:[{name:"start",time:new Date(u).toISOString()}],inputs:{messages:t},execution_order:c,child_runs:[],child_execution_order:c,run_type:"llm",extra:l??{},tags:i||[]};return this._addRunToRunMap(d)}async handleChatModelStart(e,t,r,a,n,i,s,o){const c=this.getRunById(r)??this._createRunForChatModelStart(e,t,r,a,n,i,s,o);return await(this.onRunCreate?.(c)),await(this.onLLMStart?.(c)),c}async handleLLMEnd(e,t,r,a,n){const i=this.getRunById(t);if(!i||"llm"!==i?.run_type)throw new Error("No LLM run to end.");return i.end_time=Date.now(),i.outputs=e,i.events.push({name:"end",time:new Date(i.end_time).toISOString()}),i.extra={...i.extra,...n},await(this.onLLMEnd?.(i)),await this._endTrace(i),i}async handleLLMError(e,t,r,a,n){const i=this.getRunById(t);if(!i||"llm"!==i?.run_type)throw new Error("No LLM run to end.");return i.end_time=Date.now(),i.error=this.stringifyError(e),i.events.push({name:"error",time:new Date(i.end_time).toISOString()}),i.extra={...i.extra,...n},await(this.onLLMError?.(i)),await this._endTrace(i),i}_createRunForChainStart(e,t,r,a,n,i,s,o){const c=this._getExecutionOrder(a),u=Date.now(),l={id:r,name:o??e.id[e.id.length-1],parent_run_id:a,start_time:u,serialized:e,events:[{name:"start",time:new Date(u).toISOString()}],inputs:t,execution_order:c,child_execution_order:c,run_type:s??"chain",child_runs:[],extra:i?{metadata:i}:{},tags:n||[]};return this._addRunToRunMap(l)}async handleChainStart(e,t,r,a,n,i,s,o){const c=this.getRunById(r)??this._createRunForChainStart(e,t,r,a,n,i,s,o);return await(this.onRunCreate?.(c)),await(this.onChainStart?.(c)),c}async handleChainEnd(e,t,r,a,n){const i=this.getRunById(t);if(!i)throw new Error("No chain run to end.");return i.end_time=Date.now(),i.outputs=On(e,"output"),i.events.push({name:"end",time:new Date(i.end_time).toISOString()}),void 0!==n?.inputs&&(i.inputs=On(n.inputs,"input")),await(this.onChainEnd?.(i)),await this._endTrace(i),i}async handleChainError(e,t,r,a,n){const i=this.getRunById(t);if(!i)throw new Error("No chain run to end.");return i.end_time=Date.now(),i.error=this.stringifyError(e),i.events.push({name:"error",time:new Date(i.end_time).toISOString()}),void 0!==n?.inputs&&(i.inputs=On(n.inputs,"input")),await(this.onChainError?.(i)),await this._endTrace(i),i}_createRunForToolStart(e,t,r,a,n,i,s){const o=this._getExecutionOrder(a),c=Date.now(),u={id:r,name:s??e.id[e.id.length-1],parent_run_id:a,start_time:c,serialized:e,events:[{name:"start",time:new Date(c).toISOString()}],inputs:{input:t},execution_order:o,child_execution_order:o,run_type:"tool",child_runs:[],extra:i?{metadata:i}:{},tags:n||[]};return this._addRunToRunMap(u)}async handleToolStart(e,t,r,a,n,i,s){const o=this.getRunById(r)??this._createRunForToolStart(e,t,r,a,n,i,s);return await(this.onRunCreate?.(o)),await(this.onToolStart?.(o)),o}async handleToolEnd(e,t){const r=this.getRunById(t);if(!r||"tool"!==r?.run_type)throw new Error("No tool run to end");return r.end_time=Date.now(),r.outputs={output:e},r.events.push({name:"end",time:new Date(r.end_time).toISOString()}),await(this.onToolEnd?.(r)),await this._endTrace(r),r}async handleToolError(e,t){const r=this.getRunById(t);if(!r||"tool"!==r?.run_type)throw new Error("No tool run to end");return r.end_time=Date.now(),r.error=this.stringifyError(e),r.events.push({name:"error",time:new Date(r.end_time).toISOString()}),await(this.onToolError?.(r)),await this._endTrace(r),r}async handleAgentAction(e,t){const r=this.getRunById(t);if(!r||"chain"!==r?.run_type)return;const a=r;a.actions=a.actions||[],a.actions.push(e),a.events.push({name:"agent_action",time:(new Date).toISOString(),kwargs:{action:e}}),await(this.onAgentAction?.(r))}async handleAgentEnd(e,t){const r=this.getRunById(t);!r||"chain"!==r?.run_type||(r.events.push({name:"agent_end",time:(new Date).toISOString(),kwargs:{action:e}}),await(this.onAgentEnd?.(r)))}_createRunForRetrieverStart(e,t,r,a,n,i,s){const o=this._getExecutionOrder(a),c=Date.now(),u={id:r,name:s??e.id[e.id.length-1],parent_run_id:a,start_time:c,serialized:e,events:[{name:"start",time:new Date(c).toISOString()}],inputs:{query:t},execution_order:o,child_execution_order:o,run_type:"retriever",child_runs:[],extra:i?{metadata:i}:{},tags:n||[]};return this._addRunToRunMap(u)}async handleRetrieverStart(e,t,r,a,n,i,s){const o=this.getRunById(r)??this._createRunForRetrieverStart(e,t,r,a,n,i,s);return await(this.onRunCreate?.(o)),await(this.onRetrieverStart?.(o)),o}async handleRetrieverEnd(e,t){const r=this.getRunById(t);if(!r||"retriever"!==r?.run_type)throw new Error("No retriever run to end");return r.end_time=Date.now(),r.outputs={documents:e},r.events.push({name:"end",time:new Date(r.end_time).toISOString()}),await(this.onRetrieverEnd?.(r)),await this._endTrace(r),r}async handleRetrieverError(e,t){const r=this.getRunById(t);if(!r||"retriever"!==r?.run_type)throw new Error("No retriever run to end");return r.end_time=Date.now(),r.error=this.stringifyError(e),r.events.push({name:"error",time:new Date(r.end_time).toISOString()}),await(this.onRetrieverError?.(r)),await this._endTrace(r),r}async handleText(e,t){const r=this.getRunById(t);!r||"chain"!==r?.run_type||(r.events.push({name:"text",time:(new Date).toISOString(),kwargs:{text:e}}),await(this.onText?.(r)))}async handleLLMNewToken(e,t,r,a,n,i){const s=this.getRunById(r);if(!s||"llm"!==s?.run_type)throw new Error('Invalid "runId" provided to "handleLLMNewToken" callback.');return s.events.push({name:"new_token",time:(new Date).toISOString(),kwargs:{token:e,idx:t,chunk:i?.chunk}}),await(this.onLLMNewToken?.(s,e,{chunk:i?.chunk})),s}}function ie(e,t){return`${e.open}${t}${e.close}`}function _e(e,t){try{return JSON.stringify(e,null,2)}catch{return t}}function Di(e){return"string"==typeof e?e.trim():null==e?e:_e(e,e.toString())}function je(e){if(!e.end_time)return"";const t=e.end_time-e.start_time;return t<1e3?`${t}ms`:`${(t/1e3).toFixed(2)}s`}const{color:le}=Os;class Ui extends At{constructor(){super(...arguments),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:"console_callback_handler"})}persistRun(e){return Promise.resolve()}getParents(e){const t=[];let r=e;for(;r.parent_run_id;){const e=this.runMap.get(r.parent_run_id);if(!e)break;t.push(e),r=e}return t}getBreadcrumbs(e){const t=[...this.getParents(e).reverse(),e].map(((e,t,r)=>{const a=`${e.execution_order}:${e.run_type}:${e.name}`;return t===r.length-1?ie(Os.bold,a):a})).join(" > ");return ie(le.grey,t)}onChainStart(e){const t=this.getBreadcrumbs(e);console.log(`${ie(le.green,"[chain/start]")} [${t}] Entering Chain run with input: ${_e(e.inputs,"[inputs]")}`)}onChainEnd(e){const t=this.getBreadcrumbs(e);console.log(`${ie(le.cyan,"[chain/end]")} [${t}] [${je(e)}] Exiting Chain run with output: ${_e(e.outputs,"[outputs]")}`)}onChainError(e){const t=this.getBreadcrumbs(e);console.log(`${ie(le.red,"[chain/error]")} [${t}] [${je(e)}] Chain run errored with error: ${_e(e.error,"[error]")}`)}onLLMStart(e){const t=this.getBreadcrumbs(e),r="prompts"in e.inputs?{prompts:e.inputs.prompts.map((e=>e.trim()))}:e.inputs;console.log(`${ie(le.green,"[llm/start]")} [${t}] Entering LLM run with input: ${_e(r,"[inputs]")}`)}onLLMEnd(e){const t=this.getBreadcrumbs(e);console.log(`${ie(le.cyan,"[llm/end]")} [${t}] [${je(e)}] Exiting LLM run with output: ${_e(e.outputs,"[response]")}`)}onLLMError(e){const t=this.getBreadcrumbs(e);console.log(`${ie(le.red,"[llm/error]")} [${t}] [${je(e)}] LLM run errored with error: ${_e(e.error,"[error]")}`)}onToolStart(e){const t=this.getBreadcrumbs(e);console.log(`${ie(le.green,"[tool/start]")} [${t}] Entering Tool run with input: "${Di(e.inputs.input)}"`)}onToolEnd(e){const t=this.getBreadcrumbs(e);console.log(`${ie(le.cyan,"[tool/end]")} [${t}] [${je(e)}] Exiting Tool run with output: "${Di(e.outputs?.output)}"`)}onToolError(e){const t=this.getBreadcrumbs(e);console.log(`${ie(le.red,"[tool/error]")} [${t}] [${je(e)}] Tool run errored with error: ${_e(e.error,"[error]")}`)}onRetrieverStart(e){const t=this.getBreadcrumbs(e);console.log(`${ie(le.green,"[retriever/start]")} [${t}] Entering Retriever run with input: ${_e(e.inputs,"[inputs]")}`)}onRetrieverEnd(e){const t=this.getBreadcrumbs(e);console.log(`${ie(le.cyan,"[retriever/end]")} [${t}] [${je(e)}] Exiting Retriever run with output: ${_e(e.outputs,"[outputs]")}`)}onRetrieverError(e){const t=this.getBreadcrumbs(e);console.log(`${ie(le.red,"[retriever/error]")} [${t}] [${je(e)}] Retriever run errored with error: ${_e(e.error,"[error]")}`)}onAgentAction(e){const t=e,r=this.getBreadcrumbs(e);console.log(`${ie(le.blue,"[agent/action]")} [${r}] Agent selected action: ${_e(t.actions[t.actions.length-1],"[action]")}`)}}function Zc(e){return!(!e||"object"!=typeof e||!("type"in e)||"tool_call"!==e.type)}class Vc extends Error{constructor(e,t){super(e),Object.defineProperty(this,"output",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.output=t}}function Jc(e){if(typeof e>"u")return null;try{return JSON.parse(e)}catch{}let t="";const r=[];let a=!1,n=!1;for(let i of e){if(a)'"'!==i||n?"\n"!==i||n?n="\\"===i&&!n:i="\\n":a=!1;else if('"'===i)a=!0,n=!1;else if("{"===i)r.push("}");else if("["===i)r.push("]");else if("}"===i||"]"===i){if(!r||r[r.length-1]!==i)return null;r.pop()}t+=i}a&&(t+='"');for(let e=r.length-1;e>=0;e-=1)t+=r[e];try{return JSON.parse(t)}catch{return null}}function Fi(e){return"object"==typeof e&&null!==e&&"type"in e&&"string"==typeof e.type&&"source_type"in e&&("url"===e.source_type||"base64"===e.source_type||"text"===e.source_type||"id"===e.source_type)}function Wc(e,t){return"string"==typeof e?""===e?t:"string"==typeof t?e+t:Array.isArray(t)&&t.some((e=>Fi(e)))?[{type:"text",source_type:"text",text:e},...t]:[{type:"text",text:e},...t]:Array.isArray(t)?sa(e,t)??[...e,...t]:""===t?e:Array.isArray(e)&&e.some((e=>Fi(e)))?[...e,{type:"file",source_type:"text",text:t}]:[...e,{type:"text",text:t}]}function Kc(e,t){return JSON.stringify(function e(r,a){if("object"!=typeof r||null==r)return r;if(a>=t)return Array.isArray(r)?"[Array]":"[Object]";if(Array.isArray(r))return r.map((t=>e(t,a+1)));const n={};for(const t of Object.keys(r))n[t]=e(r[t],a+1);return n}(e,0),null,2)}class Qc extends We{get lc_aliases(){return{additional_kwargs:"additional_kwargs",response_metadata:"response_metadata"}}get text(){return"string"==typeof this.content?this.content:Array.isArray(this.content)?this.content.map((e=>"string"==typeof e?e:"text"===e.type?e.text:"")).join(""):""}getType(){return this._getType()}constructor(e,t){"string"==typeof e&&(e={content:e,additional_kwargs:t,response_metadata:{}}),e.additional_kwargs||(e.additional_kwargs={}),e.response_metadata||(e.response_metadata={}),super(e),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","messages"]}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"content",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"additional_kwargs",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"response_metadata",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"id",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.name=e.name,this.content=e.content,this.additional_kwargs=e.additional_kwargs,this.response_metadata=e.response_metadata,this.id=e.id}toDict(){return{type:this._getType(),data:this.toJSON().kwargs}}static lc_name(){return"BaseMessage"}get _printableFields(){return{id:this.id,content:this.content,name:this.name,additional_kwargs:this.additional_kwargs,response_metadata:this.response_metadata}}_updateId(e){this.id=e,this.lc_kwargs.id=e}get[Symbol.toStringTag](){return this.constructor.lc_name()}[Symbol.for("nodejs.util.inspect.custom")](e){if(null===e)return this;const t=Kc(this._printableFields,Math.max(4,e));return`${this.constructor.lc_name()} ${t}`}}function Zt(e,t){const r={...e};for(const[e,a]of Object.entries(t))if(null==r[e])r[e]=a;else{if(null==a)continue;if(typeof r[e]!=typeof a||Array.isArray(r[e])!==Array.isArray(a))throw new Error(`field[${e}] already exists in the message chunk, but with a different type.`);if("string"==typeof r[e]){if("type"===e)continue;r[e]+=a}else if("object"!=typeof r[e]||Array.isArray(r[e]))if(Array.isArray(r[e]))r[e]=sa(r[e],a);else{if(r[e]===a)continue;console.warn(`field[${e}] already exists in this message chunk and value has unsupported type.`)}else r[e]=Zt(r[e],a)}return r}function sa(e,t){if(void 0!==e||void 0!==t){if(void 0===e||void 0===t)return e||t;{const r=[...e];for(const e of t)if("object"==typeof e&&"index"in e&&"number"==typeof e.index){const t=r.findIndex((t=>t.index===e.index));-1!==t?r[t]=Zt(r[t],e):r.push(e)}else{if("object"==typeof e&&"text"in e&&""===e.text)continue;r.push(e)}return r}}}class Xc extends Qc{}class hr extends Xc{constructor(e){let t;if("string"==typeof e)t={content:e,tool_calls:[],invalid_tool_calls:[],tool_call_chunks:[]};else if(void 0===e.tool_call_chunks)t={...e,tool_calls:e.tool_calls??[],invalid_tool_calls:[],tool_call_chunks:[],usage_metadata:void 0!==e.usage_metadata?e.usage_metadata:void 0};else{const r=e.tool_call_chunks.reduce(((e,t)=>{const r=t.id||`fallback-${t.index||0}`;return e[r]=e[r]??[],e[r].push(t),e}),{}),a=[],n=[];for(const[e,t]of Object.entries(r)){let r={};const i=t[0]?.name??"",s=t.map((e=>e.args||"")).join(""),o=s.length?s:"{}",c=t[0]?.id||e;try{if(r=Jc(o),null===r||"object"!=typeof r||Array.isArray(r))throw new Error("Malformed tool call chunk args.");a.push({name:i,args:r,id:c,type:"tool_call"})}catch{n.push({name:i,args:o,id:c,error:"Malformed args.",type:"invalid_tool_call"})}}t={...e,tool_calls:a,invalid_tool_calls:n,usage_metadata:void 0!==e.usage_metadata?e.usage_metadata:void 0}}super(t),Object.defineProperty(this,"tool_calls",{enumerable:!0,configurable:!0,writable:!0,value:[]}),Object.defineProperty(this,"invalid_tool_calls",{enumerable:!0,configurable:!0,writable:!0,value:[]}),Object.defineProperty(this,"tool_call_chunks",{enumerable:!0,configurable:!0,writable:!0,value:[]}),Object.defineProperty(this,"usage_metadata",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.tool_call_chunks=t.tool_call_chunks??this.tool_call_chunks,this.tool_calls=t.tool_calls??this.tool_calls,this.invalid_tool_calls=t.invalid_tool_calls??this.invalid_tool_calls,this.usage_metadata=t.usage_metadata}get lc_aliases(){return{...super.lc_aliases,tool_calls:"tool_calls",invalid_tool_calls:"invalid_tool_calls",tool_call_chunks:"tool_call_chunks"}}static lc_name(){return"AIMessageChunk"}_getType(){return"ai"}get _printableFields(){return{...super._printableFields,tool_calls:this.tool_calls,tool_call_chunks:this.tool_call_chunks,invalid_tool_calls:this.invalid_tool_calls,usage_metadata:this.usage_metadata}}concat(e){const t={content:Wc(this.content,e.content),additional_kwargs:Zt(this.additional_kwargs,e.additional_kwargs),response_metadata:Zt(this.response_metadata,e.response_metadata),tool_call_chunks:[],id:this.id??e.id};if(void 0!==this.tool_call_chunks||void 0!==e.tool_call_chunks){const r=sa(this.tool_call_chunks,e.tool_call_chunks);void 0!==r&&r.length>0&&(t.tool_call_chunks=r)}if(void 0!==this.usage_metadata||void 0!==e.usage_metadata){const r={...(void 0!==this.usage_metadata?.input_token_details?.audio||void 0!==e.usage_metadata?.input_token_details?.audio)&&{audio:(this.usage_metadata?.input_token_details?.audio??0)+(e.usage_metadata?.input_token_details?.audio??0)},...(void 0!==this.usage_metadata?.input_token_details?.cache_read||void 0!==e.usage_metadata?.input_token_details?.cache_read)&&{cache_read:(this.usage_metadata?.input_token_details?.cache_read??0)+(e.usage_metadata?.input_token_details?.cache_read??0)},...(void 0!==this.usage_metadata?.input_token_details?.cache_creation||void 0!==e.usage_metadata?.input_token_details?.cache_creation)&&{cache_creation:(this.usage_metadata?.input_token_details?.cache_creation??0)+(e.usage_metadata?.input_token_details?.cache_creation??0)}},a={...(void 0!==this.usage_metadata?.output_token_details?.audio||void 0!==e.usage_metadata?.output_token_details?.audio)&&{audio:(this.usage_metadata?.output_token_details?.audio??0)+(e.usage_metadata?.output_token_details?.audio??0)},...(void 0!==this.usage_metadata?.output_token_details?.reasoning||void 0!==e.usage_metadata?.output_token_details?.reasoning)&&{reasoning:(this.usage_metadata?.output_token_details?.reasoning??0)+(e.usage_metadata?.output_token_details?.reasoning??0)}},n=this.usage_metadata??{input_tokens:0,output_tokens:0,total_tokens:0},i=e.usage_metadata??{input_tokens:0,output_tokens:0,total_tokens:0},s={input_tokens:n.input_tokens+i.input_tokens,output_tokens:n.output_tokens+i.output_tokens,total_tokens:n.total_tokens+i.total_tokens,...Object.keys(r).length>0&&{input_token_details:r},...Object.keys(a).length>0&&{output_token_details:a}};t.usage_metadata=s}return new hr(t)}}function Yc(e,t="Human",r="AI"){const a=[];for(const n of e){let e;if("human"===n._getType())e=t;else if("ai"===n._getType())e=r;else if("system"===n._getType())e="System";else if("function"===n._getType())e="Function";else if("tool"===n._getType())e="Tool";else{if("generic"!==n._getType())throw new Error(`Got unsupported message type: ${n._getType()}`);e=n.role}const i=n.name?`${n.name}, `:"",s="string"==typeof n.content?n.content:JSON.stringify(n.content,null,2);a.push(`${e}: ${i}${s}`)}return a.join("\n")}let el=class{getStore(){}run(e,t){return t()}};const Tn=Symbol.for("ls:tracing_async_local_storage"),tl=new el;let rl=class{getInstance(){return globalThis[Tn]??tl}initializeGlobalInstance(e){void 0===globalThis[Tn]&&(globalThis[Tn]=e)}};const nl=new rl;function al(e=!1){const t=nl.getInstance().getStore();if(!e&&void 0===t)throw new Error("Could not get the current run tree.\n\nPlease make sure you are calling this method within a traceable function and that tracing is enabled.");return t}function oa(e){return"function"==typeof e&&"langsmith:traceable"in e}let Rn;const il=()=>{if(void 0===Rn){const e="false"===et("LANGCHAIN_CALLBACKS_BACKGROUND")?{blockOnRootRunFinalization:!0}:{};Rn=new wt(e)}return Rn};class gt extends At{constructor(e={}){super(e),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:"langchain_tracer"}),Object.defineProperty(this,"projectName",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"exampleId",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"client",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"replicas",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"usesRunTreeMap",{enumerable:!0,configurable:!0,writable:!0,value:!0});const{exampleId:t,projectName:r,client:a,replicas:n}=e;this.projectName=r??Rs(),this.replicas=n,this.exampleId=t,this.client=a??il();const i=gt.getTraceableRunTree();i&&this.updateFromRunTree(i)}async persistRun(e){}async onRunCreate(e){await(this.getRunTreeWithTracingConfig(e.id)?.postRun())}async onRunUpdate(e){await(this.getRunTreeWithTracingConfig(e.id)?.patchRun())}getRun(e){return this.runTreeMap.get(e)}updateFromRunTree(e){this.runTreeMap.set(e.id,e);let t=e;const r=new Set;for(;t.parent_run&&!r.has(t.id)&&(r.add(t.id),t.parent_run);)t=t.parent_run;r.clear();const a=[t];for(;a.length>0;){const e=a.shift();!e||r.has(e.id)||(r.add(e.id),this.runTreeMap.set(e.id,e),e.child_runs&&a.push(...e.child_runs))}this.client=e.client??this.client,this.replicas=e.replicas??this.replicas,this.projectName=e.project_name??this.projectName,this.exampleId=e.reference_example_id??this.exampleId}getRunTreeWithTracingConfig(e){const t=this.runTreeMap.get(e);if(t)return new de({...t,client:this.client,project_name:this.projectName,replicas:this.replicas,reference_example_id:this.exampleId,tracingEnabled:!0})}static getTraceableRunTree(){try{return al(!0)}catch{return}}}const Bs=Symbol.for("ls:tracing_async_local_storage"),Bt=Symbol.for("lc:context_variables"),sl=e=>{globalThis[Bs]=e},vt=()=>globalThis[Bs];let yt;function ol(){return new("default"in ke?ke.default:ke)({autoStart:!0,concurrency:1})}function ul(){return typeof yt>"u"&&(yt=ol()),yt}async function Y(e,t){if(!0===t){const t=vt();void 0!==t?await t.run(void 0,(async()=>e())):await e()}else yt=ul(),yt.add((async()=>{const t=vt();void 0!==t?await t.run(void 0,(async()=>e())):await e()}))}const cl=e=>!!["LANGSMITH_TRACING_V2","LANGCHAIN_TRACING_V2","LANGSMITH_TRACING","LANGCHAIN_TRACING"].find((e=>"true"===et(e)));function qs(e){const t=vt();return void 0===t?void 0:t.getStore()?.[Bt]?.[e]}const ll=Symbol("lc:configure_hooks"),dl=()=>qs(ll)||[];function hl(e){return e?Array.isArray(e)||"name"in e?{callbacks:e}:e:{}}class fl{setHandler(e){return this.setHandlers([e])}}class fr{constructor(e,t,r,a,n,i,s,o){Object.defineProperty(this,"runId",{enumerable:!0,configurable:!0,writable:!0,value:e}),Object.defineProperty(this,"handlers",{enumerable:!0,configurable:!0,writable:!0,value:t}),Object.defineProperty(this,"inheritableHandlers",{enumerable:!0,configurable:!0,writable:!0,value:r}),Object.defineProperty(this,"tags",{enumerable:!0,configurable:!0,writable:!0,value:a}),Object.defineProperty(this,"inheritableTags",{enumerable:!0,configurable:!0,writable:!0,value:n}),Object.defineProperty(this,"metadata",{enumerable:!0,configurable:!0,writable:!0,value:i}),Object.defineProperty(this,"inheritableMetadata",{enumerable:!0,configurable:!0,writable:!0,value:s}),Object.defineProperty(this,"_parentRunId",{enumerable:!0,configurable:!0,writable:!0,value:o})}get parentRunId(){return this._parentRunId}async handleText(e){await Promise.all(this.handlers.map((t=>Y((async()=>{try{await(t.handleText?.(e,this.runId,this._parentRunId,this.tags))}catch(e){if((t.raiseError?console.error:console.warn)(`Error in handler ${t.constructor.name}, handleText: ${e}`),t.raiseError)throw e}}),t.awaitHandlers))))}async handleCustomEvent(e,t,r,a,n){await Promise.all(this.handlers.map((r=>Y((async()=>{try{await(r.handleCustomEvent?.(e,t,this.runId,this.tags,this.metadata))}catch(e){if((r.raiseError?console.error:console.warn)(`Error in handler ${r.constructor.name}, handleCustomEvent: ${e}`),r.raiseError)throw e}}),r.awaitHandlers))))}}class pl extends fr{getChild(e){const t=new be(this.runId);return t.setHandlers(this.inheritableHandlers),t.addTags(this.inheritableTags),t.addMetadata(this.inheritableMetadata),e&&t.addTags([e],!1),t}async handleRetrieverEnd(e){await Promise.all(this.handlers.map((t=>Y((async()=>{if(!t.ignoreRetriever)try{await(t.handleRetrieverEnd?.(e,this.runId,this._parentRunId,this.tags))}catch(e){if((t.raiseError?console.error:console.warn)(`Error in handler ${t.constructor.name}, handleRetriever`),t.raiseError)throw e}}),t.awaitHandlers))))}async handleRetrieverError(e){await Promise.all(this.handlers.map((t=>Y((async()=>{if(!t.ignoreRetriever)try{await(t.handleRetrieverError?.(e,this.runId,this._parentRunId,this.tags))}catch(r){if((t.raiseError?console.error:console.warn)(`Error in handler ${t.constructor.name}, handleRetrieverError: ${r}`),t.raiseError)throw e}}),t.awaitHandlers))))}}class zi extends fr{async handleLLMNewToken(e,t,r,a,n,i){await Promise.all(this.handlers.map((r=>Y((async()=>{if(!r.ignoreLLM)try{await(r.handleLLMNewToken?.(e,t??{prompt:0,completion:0},this.runId,this._parentRunId,this.tags,i))}catch(e){if((r.raiseError?console.error:console.warn)(`Error in handler ${r.constructor.name}, handleLLMNewToken: ${e}`),r.raiseError)throw e}}),r.awaitHandlers))))}async handleLLMError(e,t,r,a,n){await Promise.all(this.handlers.map((t=>Y((async()=>{if(!t.ignoreLLM)try{await(t.handleLLMError?.(e,this.runId,this._parentRunId,this.tags,n))}catch(e){if((t.raiseError?console.error:console.warn)(`Error in handler ${t.constructor.name}, handleLLMError: ${e}`),t.raiseError)throw e}}),t.awaitHandlers))))}async handleLLMEnd(e,t,r,a,n){await Promise.all(this.handlers.map((t=>Y((async()=>{if(!t.ignoreLLM)try{await(t.handleLLMEnd?.(e,this.runId,this._parentRunId,this.tags,n))}catch(e){if((t.raiseError?console.error:console.warn)(`Error in handler ${t.constructor.name}, handleLLMEnd: ${e}`),t.raiseError)throw e}}),t.awaitHandlers))))}}class ml extends fr{getChild(e){const t=new be(this.runId);return t.setHandlers(this.inheritableHandlers),t.addTags(this.inheritableTags),t.addMetadata(this.inheritableMetadata),e&&t.addTags([e],!1),t}async handleChainError(e,t,r,a,n){await Promise.all(this.handlers.map((t=>Y((async()=>{if(!t.ignoreChain)try{await(t.handleChainError?.(e,this.runId,this._parentRunId,this.tags,n))}catch(e){if((t.raiseError?console.error:console.warn)(`Error in handler ${t.constructor.name}, handleChainError: ${e}`),t.raiseError)throw e}}),t.awaitHandlers))))}async handleChainEnd(e,t,r,a,n){await Promise.all(this.handlers.map((t=>Y((async()=>{if(!t.ignoreChain)try{await(t.handleChainEnd?.(e,this.runId,this._parentRunId,this.tags,n))}catch(e){if((t.raiseError?console.error:console.warn)(`Error in handler ${t.constructor.name}, handleChainEnd: ${e}`),t.raiseError)throw e}}),t.awaitHandlers))))}async handleAgentAction(e){await Promise.all(this.handlers.map((t=>Y((async()=>{if(!t.ignoreAgent)try{await(t.handleAgentAction?.(e,this.runId,this._parentRunId,this.tags))}catch(e){if((t.raiseError?console.error:console.warn)(`Error in handler ${t.constructor.name}, handleAgentAction: ${e}`),t.raiseError)throw e}}),t.awaitHandlers))))}async handleAgentEnd(e){await Promise.all(this.handlers.map((t=>Y((async()=>{if(!t.ignoreAgent)try{await(t.handleAgentEnd?.(e,this.runId,this._parentRunId,this.tags))}catch(e){if((t.raiseError?console.error:console.warn)(`Error in handler ${t.constructor.name}, handleAgentEnd: ${e}`),t.raiseError)throw e}}),t.awaitHandlers))))}}class gl extends fr{getChild(e){const t=new be(this.runId);return t.setHandlers(this.inheritableHandlers),t.addTags(this.inheritableTags),t.addMetadata(this.inheritableMetadata),e&&t.addTags([e],!1),t}async handleToolError(e){await Promise.all(this.handlers.map((t=>Y((async()=>{if(!t.ignoreAgent)try{await(t.handleToolError?.(e,this.runId,this._parentRunId,this.tags))}catch(e){if((t.raiseError?console.error:console.warn)(`Error in handler ${t.constructor.name}, handleToolError: ${e}`),t.raiseError)throw e}}),t.awaitHandlers))))}async handleToolEnd(e){await Promise.all(this.handlers.map((t=>Y((async()=>{if(!t.ignoreAgent)try{await(t.handleToolEnd?.(e,this.runId,this._parentRunId,this.tags))}catch(e){if((t.raiseError?console.error:console.warn)(`Error in handler ${t.constructor.name}, handleToolEnd: ${e}`),t.raiseError)throw e}}),t.awaitHandlers))))}}class be extends fl{constructor(e,t){super(),Object.defineProperty(this,"handlers",{enumerable:!0,configurable:!0,writable:!0,value:[]}),Object.defineProperty(this,"inheritableHandlers",{enumerable:!0,configurable:!0,writable:!0,value:[]}),Object.defineProperty(this,"tags",{enumerable:!0,configurable:!0,writable:!0,value:[]}),Object.defineProperty(this,"inheritableTags",{enumerable:!0,configurable:!0,writable:!0,value:[]}),Object.defineProperty(this,"metadata",{enumerable:!0,configurable:!0,writable:!0,value:{}}),Object.defineProperty(this,"inheritableMetadata",{enumerable:!0,configurable:!0,writable:!0,value:{}}),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:"callback_manager"}),Object.defineProperty(this,"_parentRunId",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.handlers=t?.handlers??this.handlers,this.inheritableHandlers=t?.inheritableHandlers??this.inheritableHandlers,this.tags=t?.tags??this.tags,this.inheritableTags=t?.inheritableTags??this.inheritableTags,this.metadata=t?.metadata??this.metadata,this.inheritableMetadata=t?.inheritableMetadata??this.inheritableMetadata,this._parentRunId=e}getParentRunId(){return this._parentRunId}async handleLLMStart(e,t,r=void 0,a=void 0,n=void 0,i=void 0,s=void 0,o=void 0){return Promise.all(t.map((async(t,a)=>{const i=0===a&&r?r:oe();return await Promise.all(this.handlers.map((r=>{if(!r.ignoreLLM)return ht(r)&&r._createRunForLLMStart(e,[t],i,this._parentRunId,n,this.tags,this.metadata,o),Y((async()=>{try{await(r.handleLLMStart?.(e,[t],i,this._parentRunId,n,this.tags,this.metadata,o))}catch(e){if((r.raiseError?console.error:console.warn)(`Error in handler ${r.constructor.name}, handleLLMStart: ${e}`),r.raiseError)throw e}}),r.awaitHandlers)}))),new zi(i,this.handlers,this.inheritableHandlers,this.tags,this.inheritableTags,this.metadata,this.inheritableMetadata,this._parentRunId)})))}async handleChatModelStart(e,t,r=void 0,a=void 0,n=void 0,i=void 0,s=void 0,o=void 0){return Promise.all(t.map((async(t,a)=>{const i=0===a&&r?r:oe();return await Promise.all(this.handlers.map((r=>{if(!r.ignoreLLM)return ht(r)&&r._createRunForChatModelStart(e,[t],i,this._parentRunId,n,this.tags,this.metadata,o),Y((async()=>{try{if(r.handleChatModelStart)await(r.handleChatModelStart?.(e,[t],i,this._parentRunId,n,this.tags,this.metadata,o));else if(r.handleLLMStart){const a=Yc(t);await(r.handleLLMStart?.(e,[a],i,this._parentRunId,n,this.tags,this.metadata,o))}}catch(e){if((r.raiseError?console.error:console.warn)(`Error in handler ${r.constructor.name}, handleLLMStart: ${e}`),r.raiseError)throw e}}),r.awaitHandlers)}))),new zi(i,this.handlers,this.inheritableHandlers,this.tags,this.inheritableTags,this.metadata,this.inheritableMetadata,this._parentRunId)})))}async handleChainStart(e,t,r=oe(),a=void 0,n=void 0,i=void 0,s=void 0){return await Promise.all(this.handlers.map((n=>{if(!n.ignoreChain)return ht(n)&&n._createRunForChainStart(e,t,r,this._parentRunId,this.tags,this.metadata,a,s),Y((async()=>{try{await(n.handleChainStart?.(e,t,r,this._parentRunId,this.tags,this.metadata,a,s))}catch(e){if((n.raiseError?console.error:console.warn)(`Error in handler ${n.constructor.name}, handleChainStart: ${e}`),n.raiseError)throw e}}),n.awaitHandlers)}))),new ml(r,this.handlers,this.inheritableHandlers,this.tags,this.inheritableTags,this.metadata,this.inheritableMetadata,this._parentRunId)}async handleToolStart(e,t,r=oe(),a=void 0,n=void 0,i=void 0,s=void 0){return await Promise.all(this.handlers.map((a=>{if(!a.ignoreAgent)return ht(a)&&a._createRunForToolStart(e,t,r,this._parentRunId,this.tags,this.metadata,s),Y((async()=>{try{await(a.handleToolStart?.(e,t,r,this._parentRunId,this.tags,this.metadata,s))}catch(e){if((a.raiseError?console.error:console.warn)(`Error in handler ${a.constructor.name}, handleToolStart: ${e}`),a.raiseError)throw e}}),a.awaitHandlers)}))),new gl(r,this.handlers,this.inheritableHandlers,this.tags,this.inheritableTags,this.metadata,this.inheritableMetadata,this._parentRunId)}async handleRetrieverStart(e,t,r=oe(),a=void 0,n=void 0,i=void 0,s=void 0){return await Promise.all(this.handlers.map((a=>{if(!a.ignoreRetriever)return ht(a)&&a._createRunForRetrieverStart(e,t,r,this._parentRunId,this.tags,this.metadata,s),Y((async()=>{try{await(a.handleRetrieverStart?.(e,t,r,this._parentRunId,this.tags,this.metadata,s))}catch(e){if((a.raiseError?console.error:console.warn)(`Error in handler ${a.constructor.name}, handleRetrieverStart: ${e}`),a.raiseError)throw e}}),a.awaitHandlers)}))),new pl(r,this.handlers,this.inheritableHandlers,this.tags,this.inheritableTags,this.metadata,this.inheritableMetadata,this._parentRunId)}async handleCustomEvent(e,t,r,a,n){await Promise.all(this.handlers.map((a=>Y((async()=>{if(!a.ignoreCustomEvent)try{await(a.handleCustomEvent?.(e,t,r,this.tags,this.metadata))}catch(e){if((a.raiseError?console.error:console.warn)(`Error in handler ${a.constructor.name}, handleCustomEvent: ${e}`),a.raiseError)throw e}}),a.awaitHandlers))))}addHandler(e,t=!0){this.handlers.push(e),t&&this.inheritableHandlers.push(e)}removeHandler(e){this.handlers=this.handlers.filter((t=>t!==e)),this.inheritableHandlers=this.inheritableHandlers.filter((t=>t!==e))}setHandlers(e,t=!0){this.handlers=[],this.inheritableHandlers=[];for(const r of e)this.addHandler(r,t)}addTags(e,t=!0){this.removeTags(e),this.tags.push(...e),t&&this.inheritableTags.push(...e)}removeTags(e){this.tags=this.tags.filter((t=>!e.includes(t))),this.inheritableTags=this.inheritableTags.filter((t=>!e.includes(t)))}addMetadata(e,t=!0){this.metadata={...this.metadata,...e},t&&(this.inheritableMetadata={...this.inheritableMetadata,...e})}removeMetadata(e){for(const t of Object.keys(e))delete this.metadata[t],delete this.inheritableMetadata[t]}copy(e=[],t=!0){const r=new be(this._parentRunId);for(const e of this.handlers){const t=this.inheritableHandlers.includes(e);r.addHandler(e,t)}for(const e of this.tags){const t=this.inheritableTags.includes(e);r.addTags([e],t)}for(const e of Object.keys(this.metadata)){const t=Object.keys(this.inheritableMetadata).includes(e);r.addMetadata({[e]:this.metadata[e]},t)}for(const a of e)r.handlers.filter((e=>"console_callback_handler"===e.name)).some((e=>e.name===a.name))||r.addHandler(a,t);return r}static fromHandlers(e){const t=new this;return t.addHandler(new class extends Rt{constructor(){super(),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:oe()}),Object.assign(this,e)}}),t}static configure(e,t,r,a,n,i,s){return this._configureSync(e,t,r,a,n,i,s)}static _configureSync(e,t,r,a,n,i,s){let o;(e||t)&&(Array.isArray(e)||!e?(o=new be,o.setHandlers(e?.map(Vt)??[],!0)):o=e,o=o.copy(Array.isArray(t)?t.map(Vt):t?.handlers,!1));const c="true"===et("LANGCHAIN_VERBOSE")||s?.verbose,u=gt.getTraceableRunTree()?.tracingEnabled||cl(),l=u||(et("LANGCHAIN_TRACING")??!1);if(c||l){if(o||(o=new be),c&&!o.handlers.some((e=>e.name===Ui.prototype.name))){const e=new Ui;o.addHandler(e,!0)}if(l&&!o.handlers.some((e=>"langchain_tracer"===e.name))&&u){const e=new gt;o.addHandler(e,!0)}if(u){const e=gt.getTraceableRunTree();e&&void 0===o._parentRunId&&(o._parentRunId=e.id,o.handlers.find((e=>"langchain_tracer"===e.name))?.updateFromRunTree(e))}}for(const{contextVar:e,inheritable:t=!0,handlerClass:r,envVar:a}of dl()){const n=a&&"true"===et(a)&&r;let i;const s=void 0!==e?qs(e):void 0;s&&Ko(s)?i=s:n&&(i=new r({})),void 0!==i&&(o||(o=new be),o.handlers.some((e=>e.name===i.name))||o.addHandler(i,t))}return(r||a)&&o&&(o.addTags(r??[]),o.addTags(a??[],!1)),(n||i)&&o&&(o.addMetadata(n??{}),o.addMetadata(i??{},!1)),o}}function Vt(e){return"name"in e?e:Rt.fromMethods(e)}var q,Bi;!function(e){e.assertEqual=e=>{},e.assertIs=function(e){},e.assertNever=function(e){throw new Error},e.arrayToEnum=e=>{const t={};for(const r of e)t[r]=r;return t},e.getValidEnumValues=t=>{const r=e.objectKeys(t).filter((e=>"number"!=typeof t[t[e]])),a={};for(const e of r)a[e]=t[e];return e.objectValues(a)},e.objectValues=t=>e.objectKeys(t).map((function(e){return t[e]})),e.objectKeys="function"==typeof Object.keys?e=>Object.keys(e):e=>{const t=[];for(const r in e)Object.prototype.hasOwnProperty.call(e,r)&&t.push(r);return t},e.find=(e,t)=>{for(const r of e)if(t(r))return r},e.isInteger="function"==typeof Number.isInteger?e=>Number.isInteger(e):e=>"number"==typeof e&&Number.isFinite(e)&&Math.floor(e)===e,e.joinValues=function(e,t=" | "){return e.map((e=>"string"==typeof e?`'${e}'`:e)).join(t)},e.jsonStringifyReplacer=(e,t)=>"bigint"==typeof t?t.toString():t}(q||(q={})),(Bi||(Bi={})).mergeShapes=(e,t)=>({...e,...t});const I=q.arrayToEnum(["string","nan","number","integer","float","boolean","date","bigint","symbol","function","undefined","null","array","object","unknown","promise","void","never","map","set"]),Le=e=>{switch(typeof e){case"undefined":return I.undefined;case"string":return I.string;case"number":return Number.isNaN(e)?I.nan:I.number;case"boolean":return I.boolean;case"function":return I.function;case"bigint":return I.bigint;case"symbol":return I.symbol;case"object":return Array.isArray(e)?I.array:null===e?I.null:e.then&&"function"==typeof e.then&&e.catch&&"function"==typeof e.catch?I.promise:typeof Map<"u"&&e instanceof Map?I.map:typeof Set<"u"&&e instanceof Set?I.set:typeof Date<"u"&&e instanceof Date?I.date:I.object;default:return I.unknown}},w=q.arrayToEnum(["invalid_type","invalid_literal","custom","invalid_union","invalid_union_discriminator","invalid_enum_value","unrecognized_keys","invalid_arguments","invalid_return_type","invalid_date","invalid_string","too_small","too_big","invalid_intersection_types","not_multiple_of","not_finite"]);class Pe extends Error{get errors(){return this.issues}constructor(e){super(),this.issues=[],this.addIssue=e=>{this.issues=[...this.issues,e]},this.addIssues=(e=[])=>{this.issues=[...this.issues,...e]};const t=new.target.prototype;Object.setPrototypeOf?Object.setPrototypeOf(this,t):this.__proto__=t,this.name="ZodError",this.issues=e}format(e){const t=e||function(e){return e.message},r={_errors:[]},a=e=>{for(const n of e.issues)if("invalid_union"===n.code)n.unionErrors.map(a);else if("invalid_return_type"===n.code)a(n.returnTypeError);else if("invalid_arguments"===n.code)a(n.argumentsError);else if(0===n.path.length)r._errors.push(t(n));else{let e=r,a=0;for(;a<n.path.length;){const r=n.path[a];a===n.path.length-1?(e[r]=e[r]||{_errors:[]},e[r]._errors.push(t(n))):e[r]=e[r]||{_errors:[]},e=e[r],a++}}};return a(this),r}static assert(e){if(!(e instanceof Pe))throw new Error(`Not a ZodError: ${e}`)}toString(){return this.message}get message(){return JSON.stringify(this.issues,q.jsonStringifyReplacer,2)}get isEmpty(){return 0===this.issues.length}flatten(e=e=>e.message){const t={},r=[];for(const a of this.issues)if(a.path.length>0){const r=a.path[0];t[r]=t[r]||[],t[r].push(e(a))}else r.push(e(a));return{formErrors:r,fieldErrors:t}}get formErrors(){return this.flatten()}}Pe.create=e=>new Pe(e);const Un=(e,t)=>{let r;switch(e.code){case w.invalid_type:r=e.received===I.undefined?"Required":`Expected ${e.expected}, received ${e.received}`;break;case w.invalid_literal:r=`Invalid literal value, expected ${JSON.stringify(e.expected,q.jsonStringifyReplacer)}`;break;case w.unrecognized_keys:r=`Unrecognized key(s) in object: ${q.joinValues(e.keys,", ")}`;break;case w.invalid_union:r="Invalid input";break;case w.invalid_union_discriminator:r=`Invalid discriminator value. Expected ${q.joinValues(e.options)}`;break;case w.invalid_enum_value:r=`Invalid enum value. Expected ${q.joinValues(e.options)}, received '${e.received}'`;break;case w.invalid_arguments:r="Invalid function arguments";break;case w.invalid_return_type:r="Invalid function return type";break;case w.invalid_date:r="Invalid date";break;case w.invalid_string:"object"==typeof e.validation?"includes"in e.validation?(r=`Invalid input: must include "${e.validation.includes}"`,"number"==typeof e.validation.position&&(r=`${r} at one or more positions greater than or equal to ${e.validation.position}`)):"startsWith"in e.validation?r=`Invalid input: must start with "${e.validation.startsWith}"`:"endsWith"in e.validation?r=`Invalid input: must end with "${e.validation.endsWith}"`:q.assertNever(e.validation):r="regex"!==e.validation?`Invalid ${e.validation}`:"Invalid";break;case w.too_small:r="array"===e.type?`Array must contain ${e.exact?"exactly":e.inclusive?"at least":"more than"} ${e.minimum} element(s)`:"string"===e.type?`String must contain ${e.exact?"exactly":e.inclusive?"at least":"over"} ${e.minimum} character(s)`:"number"===e.type||"bigint"===e.type?`Number must be ${e.exact?"exactly equal to ":e.inclusive?"greater than or equal to ":"greater than "}${e.minimum}`:"date"===e.type?`Date must be ${e.exact?"exactly equal to ":e.inclusive?"greater than or equal to ":"greater than "}${new Date(Number(e.minimum))}`:"Invalid input";break;case w.too_big:r="array"===e.type?`Array must contain ${e.exact?"exactly":e.inclusive?"at most":"less than"} ${e.maximum} element(s)`:"string"===e.type?`String must contain ${e.exact?"exactly":e.inclusive?"at most":"under"} ${e.maximum} character(s)`:"number"===e.type?`Number must be ${e.exact?"exactly":e.inclusive?"less than or equal to":"less than"} ${e.maximum}`:"bigint"===e.type?`BigInt must be ${e.exact?"exactly":e.inclusive?"less than or equal to":"less than"} ${e.maximum}`:"date"===e.type?`Date must be ${e.exact?"exactly":e.inclusive?"smaller than or equal to":"smaller than"} ${new Date(Number(e.maximum))}`:"Invalid input";break;case w.custom:r="Invalid input";break;case w.invalid_intersection_types:r="Intersection results could not be merged";break;case w.not_multiple_of:r=`Number must be a multiple of ${e.multipleOf}`;break;case w.not_finite:r="Number must be finite";break;default:r=t.defaultError,q.assertNever(e)}return{message:r}};let yl=Un;function _l(){return yl}const bl=e=>{const{data:t,path:r,errorMaps:a,issueData:n}=e,i=[...r,...n.path||[]],s={...n,path:i};if(void 0!==n.message)return{...n,path:i,message:n.message};let o="";const c=a.filter((e=>!!e)).slice().reverse();for(const e of c)o=e(s,{data:t,defaultError:o}).message;return{...n,path:i,message:o}};function O(e,t){const r=_l(),a=bl({issueData:t,data:e.data,path:e.path,errorMaps:[e.common.contextualErrorMap,e.schemaErrorMap,r,r===Un?void 0:Un].filter((e=>!!e))});e.common.issues.push(a)}class me{constructor(){this.value="valid"}dirty(){"valid"===this.value&&(this.value="dirty")}abort(){"aborted"!==this.value&&(this.value="aborted")}static mergeArray(e,t){const r=[];for(const a of t){if("aborted"===a.status)return M;"dirty"===a.status&&e.dirty(),r.push(a.value)}return{status:e.value,value:r}}static async mergeObjectAsync(e,t){const r=[];for(const e of t){const t=await e.key,a=await e.value;r.push({key:t,value:a})}return me.mergeObjectSync(e,r)}static mergeObjectSync(e,t){const r={};for(const a of t){const{key:t,value:n}=a;if("aborted"===t.status||"aborted"===n.status)return M;"dirty"===t.status&&e.dirty(),"dirty"===n.status&&e.dirty(),"__proto__"!==t.value&&(typeof n.value<"u"||a.alwaysSet)&&(r[t.value]=n.value)}return{status:e.value,value:r}}}const M=Object.freeze({status:"aborted"}),ft=e=>({status:"dirty",value:e}),we=e=>({status:"valid",value:e}),qi=e=>"aborted"===e.status,Gi=e=>"dirty"===e.status,tt=e=>"valid"===e.status,Jt=e=>typeof Promise<"u"&&e instanceof Promise;var A;!function(e){e.errToObj=e=>"string"==typeof e?{message:e}:e||{},e.toString=e=>"string"==typeof e?e:e?.message}(A||(A={}));class ze{constructor(e,t,r,a){this._cachedPath=[],this.parent=e,this.data=t,this._path=r,this._key=a}get path(){return this._cachedPath.length||(Array.isArray(this._key)?this._cachedPath.push(...this._path,...this._key):this._cachedPath.push(...this._path,this._key)),this._cachedPath}}const Hi=(e,t)=>{if(tt(t))return{success:!0,data:t.value};if(!e.common.issues.length)throw new Error("Validation failed but no issues detected.");return{success:!1,get error(){if(this._error)return this._error;const t=new Pe(e.common.issues);return this._error=t,this._error}}};function z(e){if(!e)return{};const{errorMap:t,invalid_type_error:r,required_error:a,description:n}=e;if(t&&(r||a))throw new Error('Can\'t use "invalid_type_error" or "required_error" in conjunction with custom error map.');return t?{errorMap:t,description:n}:{errorMap:(t,n)=>{const{message:i}=e;return"invalid_enum_value"===t.code?{message:i??n.defaultError}:typeof n.data>"u"?{message:i??a??n.defaultError}:"invalid_type"!==t.code?{message:n.defaultError}:{message:i??r??n.defaultError}},description:n}}class B{get description(){return this._def.description}_getType(e){return Le(e.data)}_getOrReturnCtx(e,t){return t||{common:e.parent.common,data:e.data,parsedType:Le(e.data),schemaErrorMap:this._def.errorMap,path:e.path,parent:e.parent}}_processInputParams(e){return{status:new me,ctx:{common:e.parent.common,data:e.data,parsedType:Le(e.data),schemaErrorMap:this._def.errorMap,path:e.path,parent:e.parent}}}_parseSync(e){const t=this._parse(e);if(Jt(t))throw new Error("Synchronous parse encountered promise.");return t}_parseAsync(e){const t=this._parse(e);return Promise.resolve(t)}parse(e,t){const r=this.safeParse(e,t);if(r.success)return r.data;throw r.error}safeParse(e,t){const r={common:{issues:[],async:t?.async??!1,contextualErrorMap:t?.errorMap},path:t?.path||[],schemaErrorMap:this._def.errorMap,parent:null,data:e,parsedType:Le(e)},a=this._parseSync({data:e,path:r.path,parent:r});return Hi(r,a)}"~validate"(e){const t={common:{issues:[],async:!!this["~standard"].async},path:[],schemaErrorMap:this._def.errorMap,parent:null,data:e,parsedType:Le(e)};if(!this["~standard"].async)try{const r=this._parseSync({data:e,path:[],parent:t});return tt(r)?{value:r.value}:{issues:t.common.issues}}catch(e){e?.message?.toLowerCase()?.includes("encountered")&&(this["~standard"].async=!0),t.common={issues:[],async:!0}}return this._parseAsync({data:e,path:[],parent:t}).then((e=>tt(e)?{value:e.value}:{issues:t.common.issues}))}async parseAsync(e,t){const r=await this.safeParseAsync(e,t);if(r.success)return r.data;throw r.error}async safeParseAsync(e,t){const r={common:{issues:[],contextualErrorMap:t?.errorMap,async:!0},path:t?.path||[],schemaErrorMap:this._def.errorMap,parent:null,data:e,parsedType:Le(e)},a=this._parse({data:e,path:r.path,parent:r}),n=await(Jt(a)?a:Promise.resolve(a));return Hi(r,n)}refine(e,t){const r=e=>"string"==typeof t||typeof t>"u"?{message:t}:"function"==typeof t?t(e):t;return this._refinement(((t,a)=>{const n=e(t),i=()=>a.addIssue({code:w.custom,...r(t)});return typeof Promise<"u"&&n instanceof Promise?n.then((e=>!!e||(i(),!1))):!!n||(i(),!1)}))}refinement(e,t){return this._refinement(((r,a)=>!!e(r)||(a.addIssue("function"==typeof t?t(r,a):t),!1)))}_refinement(e){return new nt({schema:this,typeName:v.ZodEffects,effect:{type:"refinement",refinement:e}})}superRefine(e){return this._refinement(e)}constructor(e){this.spa=this.safeParseAsync,this._def=e,this.parse=this.parse.bind(this),this.safeParse=this.safeParse.bind(this),this.parseAsync=this.parseAsync.bind(this),this.safeParseAsync=this.safeParseAsync.bind(this),this.spa=this.spa.bind(this),this.refine=this.refine.bind(this),this.refinement=this.refinement.bind(this),this.superRefine=this.superRefine.bind(this),this.optional=this.optional.bind(this),this.nullable=this.nullable.bind(this),this.nullish=this.nullish.bind(this),this.array=this.array.bind(this),this.promise=this.promise.bind(this),this.or=this.or.bind(this),this.and=this.and.bind(this),this.transform=this.transform.bind(this),this.brand=this.brand.bind(this),this.default=this.default.bind(this),this.catch=this.catch.bind(this),this.describe=this.describe.bind(this),this.pipe=this.pipe.bind(this),this.readonly=this.readonly.bind(this),this.isNullable=this.isNullable.bind(this),this.isOptional=this.isOptional.bind(this),this["~standard"]={version:1,vendor:"zod",validate:e=>this["~validate"](e)}}optional(){return Fe.create(this,this._def)}nullable(){return at.create(this,this._def)}nullish(){return this.nullable().optional()}array(){return Ie.create(this)}promise(){return Xt.create(this,this._def)}or(e){return Kt.create([this,e],this._def)}and(e){return Qt.create(this,e,this._def)}transform(e){return new nt({...z(this._def),schema:this,typeName:v.ZodEffects,effect:{type:"transform",transform:e}})}default(e){const t="function"==typeof e?e:()=>e;return new Bn({...z(this._def),innerType:this,defaultValue:t,typeName:v.ZodDefault})}brand(){return new Bl({typeName:v.ZodBranded,type:this,...z(this._def)})}catch(e){const t="function"==typeof e?e:()=>e;return new qn({...z(this._def),innerType:this,catchValue:t,typeName:v.ZodCatch})}describe(e){return new(0,this.constructor)({...this._def,description:e})}pipe(e){return ua.create(this,e)}readonly(){return Gn.create(this)}isOptional(){return this.safeParse(void 0).success}isNullable(){return this.safeParse(null).success}}const wl=/^c[^\s-]{8,}$/i,vl=/^[0-9a-z]+$/,El=/^[0-9A-HJKMNP-TV-Z]{26}$/i,Sl=/^[0-9a-fA-F]{8}\b-[0-9a-fA-F]{4}\b-[0-9a-fA-F]{4}\b-[0-9a-fA-F]{4}\b-[0-9a-fA-F]{12}$/i,Ol=/^[a-z0-9_-]{21}$/i,Tl=/^[A-Za-z0-9-_]+\.[A-Za-z0-9-_]+\.[A-Za-z0-9-_]*$/,Rl=/^[-+]?P(?!$)(?:(?:[-+]?\d+Y)|(?:[-+]?\d+[.,]\d+Y$))?(?:(?:[-+]?\d+M)|(?:[-+]?\d+[.,]\d+M$))?(?:(?:[-+]?\d+W)|(?:[-+]?\d+[.,]\d+W$))?(?:(?:[-+]?\d+D)|(?:[-+]?\d+[.,]\d+D$))?(?:T(?=[\d+-])(?:(?:[-+]?\d+H)|(?:[-+]?\d+[.,]\d+H$))?(?:(?:[-+]?\d+M)|(?:[-+]?\d+[.,]\d+M$))?(?:[-+]?\d+(?:[.,]\d+)?S)?)??$/,Il=/^(?!\.)(?!.*\.\.)([A-Z0-9_'+\-\.]*)[A-Z0-9_+-]@([A-Z0-9][A-Z0-9\-]*\.)+[A-Z]{2,}$/i,Al="^(\\p{Extended_Pictographic}|\\p{Emoji_Component})+$";let In;const xl=/^(?:(?:25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9][0-9]|[0-9])\.){3}(?:25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9][0-9]|[0-9])$/,kl=/^(?:(?:25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9][0-9]|[0-9])\.){3}(?:25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9][0-9]|[0-9])\/(3[0-2]|[12]?[0-9])$/,Pl=/^(([0-9a-fA-F]{1,4}:){7,7}[0-9a-fA-F]{1,4}|([0-9a-fA-F]{1,4}:){1,7}:|([0-9a-fA-F]{1,4}:){1,6}:[0-9a-fA-F]{1,4}|([0-9a-fA-F]{1,4}:){1,5}(:[0-9a-fA-F]{1,4}){1,2}|([0-9a-fA-F]{1,4}:){1,4}(:[0-9a-fA-F]{1,4}){1,3}|([0-9a-fA-F]{1,4}:){1,3}(:[0-9a-fA-F]{1,4}){1,4}|([0-9a-fA-F]{1,4}:){1,2}(:[0-9a-fA-F]{1,4}){1,5}|[0-9a-fA-F]{1,4}:((:[0-9a-fA-F]{1,4}){1,6})|:((:[0-9a-fA-F]{1,4}){1,7}|:)|fe80:(:[0-9a-fA-F]{0,4}){0,4}%[0-9a-zA-Z]{1,}|::(ffff(:0{1,4}){0,1}:){0,1}((25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9])\.){3,3}(25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9])|([0-9a-fA-F]{1,4}:){1,4}:((25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9])\.){3,3}(25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9]))$/,Nl=/^(([0-9a-fA-F]{1,4}:){7,7}[0-9a-fA-F]{1,4}|([0-9a-fA-F]{1,4}:){1,7}:|([0-9a-fA-F]{1,4}:){1,6}:[0-9a-fA-F]{1,4}|([0-9a-fA-F]{1,4}:){1,5}(:[0-9a-fA-F]{1,4}){1,2}|([0-9a-fA-F]{1,4}:){1,4}(:[0-9a-fA-F]{1,4}){1,3}|([0-9a-fA-F]{1,4}:){1,3}(:[0-9a-fA-F]{1,4}){1,4}|([0-9a-fA-F]{1,4}:){1,2}(:[0-9a-fA-F]{1,4}){1,5}|[0-9a-fA-F]{1,4}:((:[0-9a-fA-F]{1,4}){1,6})|:((:[0-9a-fA-F]{1,4}){1,7}|:)|fe80:(:[0-9a-fA-F]{0,4}){0,4}%[0-9a-zA-Z]{1,}|::(ffff(:0{1,4}){0,1}:){0,1}((25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9])\.){3,3}(25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9])|([0-9a-fA-F]{1,4}:){1,4}:((25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9])\.){3,3}(25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9]))\/(12[0-8]|1[01][0-9]|[1-9]?[0-9])$/,$l=/^([0-9a-zA-Z+/]{4})*(([0-9a-zA-Z+/]{2}==)|([0-9a-zA-Z+/]{3}=))?$/,Cl=/^([0-9a-zA-Z-_]{4})*(([0-9a-zA-Z-_]{2}(==)?)|([0-9a-zA-Z-_]{3}(=)?))?$/,Gs="((\\d\\d[2468][048]|\\d\\d[13579][26]|\\d\\d0[48]|[02468][048]00|[13579][26]00)-02-29|\\d{4}-((0[13578]|1[02])-(0[1-9]|[12]\\d|3[01])|(0[469]|11)-(0[1-9]|[12]\\d|30)|(02)-(0[1-9]|1\\d|2[0-8])))",jl=new RegExp(`^${Gs}$`);function Hs(e){let t="[0-5]\\d";e.precision?t=`${t}\\.\\d{${e.precision}}`:null==e.precision&&(t=`${t}(\\.\\d+)?`);return`([01]\\d|2[0-3]):[0-5]\\d(:${t})${e.precision?"+":"?"}`}function Ll(e){return new RegExp(`^${Hs(e)}$`)}function Ml(e){let t=`${Gs}T${Hs(e)}`;const r=[];return r.push(e.local?"Z?":"Z"),e.offset&&r.push("([+-]\\d{2}:?\\d{2})"),t=`${t}(${r.join("|")})`,new RegExp(`^${t}$`)}function Dl(e,t){return!(("v4"!==t&&t||!xl.test(e))&&("v6"!==t&&t||!Pl.test(e)))}function Ul(e,t){if(!Tl.test(e))return!1;try{const[r]=e.split(".");if(!r)return!1;const a=r.replace(/-/g,"+").replace(/_/g,"/").padEnd(r.length+(4-r.length%4)%4,"="),n=JSON.parse(atob(a));return!("object"!=typeof n||null===n||"typ"in n&&"JWT"!==n?.typ||!n.alg||t&&n.alg!==t)}catch{return!1}}function Fl(e,t){return!(("v4"!==t&&t||!kl.test(e))&&("v6"!==t&&t||!Nl.test(e)))}class De extends B{_parse(e){if(this._def.coerce&&(e.data=String(e.data)),this._getType(e)!==I.string){const t=this._getOrReturnCtx(e);return O(t,{code:w.invalid_type,expected:I.string,received:t.parsedType}),M}const t=new me;let r;for(const a of this._def.checks)if("min"===a.kind)e.data.length<a.value&&(r=this._getOrReturnCtx(e,r),O(r,{code:w.too_small,minimum:a.value,type:"string",inclusive:!0,exact:!1,message:a.message}),t.dirty());else if("max"===a.kind)e.data.length>a.value&&(r=this._getOrReturnCtx(e,r),O(r,{code:w.too_big,maximum:a.value,type:"string",inclusive:!0,exact:!1,message:a.message}),t.dirty());else if("length"===a.kind){const n=e.data.length>a.value,i=e.data.length<a.value;(n||i)&&(r=this._getOrReturnCtx(e,r),n?O(r,{code:w.too_big,maximum:a.value,type:"string",inclusive:!0,exact:!0,message:a.message}):i&&O(r,{code:w.too_small,minimum:a.value,type:"string",inclusive:!0,exact:!0,message:a.message}),t.dirty())}else if("email"===a.kind)Il.test(e.data)||(r=this._getOrReturnCtx(e,r),O(r,{validation:"email",code:w.invalid_string,message:a.message}),t.dirty());else if("emoji"===a.kind)In||(In=new RegExp(Al,"u")),In.test(e.data)||(r=this._getOrReturnCtx(e,r),O(r,{validation:"emoji",code:w.invalid_string,message:a.message}),t.dirty());else if("uuid"===a.kind)Sl.test(e.data)||(r=this._getOrReturnCtx(e,r),O(r,{validation:"uuid",code:w.invalid_string,message:a.message}),t.dirty());else if("nanoid"===a.kind)Ol.test(e.data)||(r=this._getOrReturnCtx(e,r),O(r,{validation:"nanoid",code:w.invalid_string,message:a.message}),t.dirty());else if("cuid"===a.kind)wl.test(e.data)||(r=this._getOrReturnCtx(e,r),O(r,{validation:"cuid",code:w.invalid_string,message:a.message}),t.dirty());else if("cuid2"===a.kind)vl.test(e.data)||(r=this._getOrReturnCtx(e,r),O(r,{validation:"cuid2",code:w.invalid_string,message:a.message}),t.dirty());else if("ulid"===a.kind)El.test(e.data)||(r=this._getOrReturnCtx(e,r),O(r,{validation:"ulid",code:w.invalid_string,message:a.message}),t.dirty());else if("url"===a.kind)try{new URL(e.data)}catch{r=this._getOrReturnCtx(e,r),O(r,{validation:"url",code:w.invalid_string,message:a.message}),t.dirty()}else"regex"===a.kind?(a.regex.lastIndex=0,a.regex.test(e.data)||(r=this._getOrReturnCtx(e,r),O(r,{validation:"regex",code:w.invalid_string,message:a.message}),t.dirty())):"trim"===a.kind?e.data=e.data.trim():"includes"===a.kind?e.data.includes(a.value,a.position)||(r=this._getOrReturnCtx(e,r),O(r,{code:w.invalid_string,validation:{includes:a.value,position:a.position},message:a.message}),t.dirty()):"toLowerCase"===a.kind?e.data=e.data.toLowerCase():"toUpperCase"===a.kind?e.data=e.data.toUpperCase():"startsWith"===a.kind?e.data.startsWith(a.value)||(r=this._getOrReturnCtx(e,r),O(r,{code:w.invalid_string,validation:{startsWith:a.value},message:a.message}),t.dirty()):"endsWith"===a.kind?e.data.endsWith(a.value)||(r=this._getOrReturnCtx(e,r),O(r,{code:w.invalid_string,validation:{endsWith:a.value},message:a.message}),t.dirty()):"datetime"===a.kind?Ml(a).test(e.data)||(r=this._getOrReturnCtx(e,r),O(r,{code:w.invalid_string,validation:"datetime",message:a.message}),t.dirty()):"date"===a.kind?jl.test(e.data)||(r=this._getOrReturnCtx(e,r),O(r,{code:w.invalid_string,validation:"date",message:a.message}),t.dirty()):"time"===a.kind?Ll(a).test(e.data)||(r=this._getOrReturnCtx(e,r),O(r,{code:w.invalid_string,validation:"time",message:a.message}),t.dirty()):"duration"===a.kind?Rl.test(e.data)||(r=this._getOrReturnCtx(e,r),O(r,{validation:"duration",code:w.invalid_string,message:a.message}),t.dirty()):"ip"===a.kind?Dl(e.data,a.version)||(r=this._getOrReturnCtx(e,r),O(r,{validation:"ip",code:w.invalid_string,message:a.message}),t.dirty()):"jwt"===a.kind?Ul(e.data,a.alg)||(r=this._getOrReturnCtx(e,r),O(r,{validation:"jwt",code:w.invalid_string,message:a.message}),t.dirty()):"cidr"===a.kind?Fl(e.data,a.version)||(r=this._getOrReturnCtx(e,r),O(r,{validation:"cidr",code:w.invalid_string,message:a.message}),t.dirty()):"base64"===a.kind?$l.test(e.data)||(r=this._getOrReturnCtx(e,r),O(r,{validation:"base64",code:w.invalid_string,message:a.message}),t.dirty()):"base64url"===a.kind?Cl.test(e.data)||(r=this._getOrReturnCtx(e,r),O(r,{validation:"base64url",code:w.invalid_string,message:a.message}),t.dirty()):q.assertNever(a);return{status:t.value,value:e.data}}_regex(e,t,r){return this.refinement((t=>e.test(t)),{validation:t,code:w.invalid_string,...A.errToObj(r)})}_addCheck(e){return new De({...this._def,checks:[...this._def.checks,e]})}email(e){return this._addCheck({kind:"email",...A.errToObj(e)})}url(e){return this._addCheck({kind:"url",...A.errToObj(e)})}emoji(e){return this._addCheck({kind:"emoji",...A.errToObj(e)})}uuid(e){return this._addCheck({kind:"uuid",...A.errToObj(e)})}nanoid(e){return this._addCheck({kind:"nanoid",...A.errToObj(e)})}cuid(e){return this._addCheck({kind:"cuid",...A.errToObj(e)})}cuid2(e){return this._addCheck({kind:"cuid2",...A.errToObj(e)})}ulid(e){return this._addCheck({kind:"ulid",...A.errToObj(e)})}base64(e){return this._addCheck({kind:"base64",...A.errToObj(e)})}base64url(e){return this._addCheck({kind:"base64url",...A.errToObj(e)})}jwt(e){return this._addCheck({kind:"jwt",...A.errToObj(e)})}ip(e){return this._addCheck({kind:"ip",...A.errToObj(e)})}cidr(e){return this._addCheck({kind:"cidr",...A.errToObj(e)})}datetime(e){return"string"==typeof e?this._addCheck({kind:"datetime",precision:null,offset:!1,local:!1,message:e}):this._addCheck({kind:"datetime",precision:typeof e?.precision>"u"?null:e?.precision,offset:e?.offset??!1,local:e?.local??!1,...A.errToObj(e?.message)})}date(e){return this._addCheck({kind:"date",message:e})}time(e){return"string"==typeof e?this._addCheck({kind:"time",precision:null,message:e}):this._addCheck({kind:"time",precision:typeof e?.precision>"u"?null:e?.precision,...A.errToObj(e?.message)})}duration(e){return this._addCheck({kind:"duration",...A.errToObj(e)})}regex(e,t){return this._addCheck({kind:"regex",regex:e,...A.errToObj(t)})}includes(e,t){return this._addCheck({kind:"includes",value:e,position:t?.position,...A.errToObj(t?.message)})}startsWith(e,t){return this._addCheck({kind:"startsWith",value:e,...A.errToObj(t)})}endsWith(e,t){return this._addCheck({kind:"endsWith",value:e,...A.errToObj(t)})}min(e,t){return this._addCheck({kind:"min",value:e,...A.errToObj(t)})}max(e,t){return this._addCheck({kind:"max",value:e,...A.errToObj(t)})}length(e,t){return this._addCheck({kind:"length",value:e,...A.errToObj(t)})}nonempty(e){return this.min(1,A.errToObj(e))}trim(){return new De({...this._def,checks:[...this._def.checks,{kind:"trim"}]})}toLowerCase(){return new De({...this._def,checks:[...this._def.checks,{kind:"toLowerCase"}]})}toUpperCase(){return new De({...this._def,checks:[...this._def.checks,{kind:"toUpperCase"}]})}get isDatetime(){return!!this._def.checks.find((e=>"datetime"===e.kind))}get isDate(){return!!this._def.checks.find((e=>"date"===e.kind))}get isTime(){return!!this._def.checks.find((e=>"time"===e.kind))}get isDuration(){return!!this._def.checks.find((e=>"duration"===e.kind))}get isEmail(){return!!this._def.checks.find((e=>"email"===e.kind))}get isURL(){return!!this._def.checks.find((e=>"url"===e.kind))}get isEmoji(){return!!this._def.checks.find((e=>"emoji"===e.kind))}get isUUID(){return!!this._def.checks.find((e=>"uuid"===e.kind))}get isNANOID(){return!!this._def.checks.find((e=>"nanoid"===e.kind))}get isCUID(){return!!this._def.checks.find((e=>"cuid"===e.kind))}get isCUID2(){return!!this._def.checks.find((e=>"cuid2"===e.kind))}get isULID(){return!!this._def.checks.find((e=>"ulid"===e.kind))}get isIP(){return!!this._def.checks.find((e=>"ip"===e.kind))}get isCIDR(){return!!this._def.checks.find((e=>"cidr"===e.kind))}get isBase64(){return!!this._def.checks.find((e=>"base64"===e.kind))}get isBase64url(){return!!this._def.checks.find((e=>"base64url"===e.kind))}get minLength(){let e=null;for(const t of this._def.checks)"min"===t.kind&&(null===e||t.value>e)&&(e=t.value);return e}get maxLength(){let e=null;for(const t of this._def.checks)"max"===t.kind&&(null===e||t.value<e)&&(e=t.value);return e}}function zl(e,t){const r=(e.toString().split(".")[1]||"").length,a=(t.toString().split(".")[1]||"").length,n=r>a?r:a;return Number.parseInt(e.toFixed(n).replace(".",""))%Number.parseInt(t.toFixed(n).replace(".",""))/10**n}De.create=e=>new De({checks:[],typeName:v.ZodString,coerce:e?.coerce??!1,...z(e)});class Et extends B{constructor(){super(...arguments),this.min=this.gte,this.max=this.lte,this.step=this.multipleOf}_parse(e){if(this._def.coerce&&(e.data=Number(e.data)),this._getType(e)!==I.number){const t=this._getOrReturnCtx(e);return O(t,{code:w.invalid_type,expected:I.number,received:t.parsedType}),M}let t;const r=new me;for(const a of this._def.checks)"int"===a.kind?q.isInteger(e.data)||(t=this._getOrReturnCtx(e,t),O(t,{code:w.invalid_type,expected:"integer",received:"float",message:a.message}),r.dirty()):"min"===a.kind?(a.inclusive?e.data<a.value:e.data<=a.value)&&(t=this._getOrReturnCtx(e,t),O(t,{code:w.too_small,minimum:a.value,type:"number",inclusive:a.inclusive,exact:!1,message:a.message}),r.dirty()):"max"===a.kind?(a.inclusive?e.data>a.value:e.data>=a.value)&&(t=this._getOrReturnCtx(e,t),O(t,{code:w.too_big,maximum:a.value,type:"number",inclusive:a.inclusive,exact:!1,message:a.message}),r.dirty()):"multipleOf"===a.kind?0!==zl(e.data,a.value)&&(t=this._getOrReturnCtx(e,t),O(t,{code:w.not_multiple_of,multipleOf:a.value,message:a.message}),r.dirty()):"finite"===a.kind?Number.isFinite(e.data)||(t=this._getOrReturnCtx(e,t),O(t,{code:w.not_finite,message:a.message}),r.dirty()):q.assertNever(a);return{status:r.value,value:e.data}}gte(e,t){return this.setLimit("min",e,!0,A.toString(t))}gt(e,t){return this.setLimit("min",e,!1,A.toString(t))}lte(e,t){return this.setLimit("max",e,!0,A.toString(t))}lt(e,t){return this.setLimit("max",e,!1,A.toString(t))}setLimit(e,t,r,a){return new Et({...this._def,checks:[...this._def.checks,{kind:e,value:t,inclusive:r,message:A.toString(a)}]})}_addCheck(e){return new Et({...this._def,checks:[...this._def.checks,e]})}int(e){return this._addCheck({kind:"int",message:A.toString(e)})}positive(e){return this._addCheck({kind:"min",value:0,inclusive:!1,message:A.toString(e)})}negative(e){return this._addCheck({kind:"max",value:0,inclusive:!1,message:A.toString(e)})}nonpositive(e){return this._addCheck({kind:"max",value:0,inclusive:!0,message:A.toString(e)})}nonnegative(e){return this._addCheck({kind:"min",value:0,inclusive:!0,message:A.toString(e)})}multipleOf(e,t){return this._addCheck({kind:"multipleOf",value:e,message:A.toString(t)})}finite(e){return this._addCheck({kind:"finite",message:A.toString(e)})}safe(e){return this._addCheck({kind:"min",inclusive:!0,value:Number.MIN_SAFE_INTEGER,message:A.toString(e)})._addCheck({kind:"max",inclusive:!0,value:Number.MAX_SAFE_INTEGER,message:A.toString(e)})}get minValue(){let e=null;for(const t of this._def.checks)"min"===t.kind&&(null===e||t.value>e)&&(e=t.value);return e}get maxValue(){let e=null;for(const t of this._def.checks)"max"===t.kind&&(null===e||t.value<e)&&(e=t.value);return e}get isInt(){return!!this._def.checks.find((e=>"int"===e.kind||"multipleOf"===e.kind&&q.isInteger(e.value)))}get isFinite(){let e=null,t=null;for(const r of this._def.checks){if("finite"===r.kind||"int"===r.kind||"multipleOf"===r.kind)return!0;"min"===r.kind?(null===t||r.value>t)&&(t=r.value):"max"===r.kind&&(null===e||r.value<e)&&(e=r.value)}return Number.isFinite(t)&&Number.isFinite(e)}}Et.create=e=>new Et({checks:[],typeName:v.ZodNumber,coerce:e?.coerce||!1,...z(e)});class St extends B{constructor(){super(...arguments),this.min=this.gte,this.max=this.lte}_parse(e){if(this._def.coerce)try{e.data=BigInt(e.data)}catch{return this._getInvalidInput(e)}if(this._getType(e)!==I.bigint)return this._getInvalidInput(e);let t;const r=new me;for(const a of this._def.checks)"min"===a.kind?(a.inclusive?e.data<a.value:e.data<=a.value)&&(t=this._getOrReturnCtx(e,t),O(t,{code:w.too_small,type:"bigint",minimum:a.value,inclusive:a.inclusive,message:a.message}),r.dirty()):"max"===a.kind?(a.inclusive?e.data>a.value:e.data>=a.value)&&(t=this._getOrReturnCtx(e,t),O(t,{code:w.too_big,type:"bigint",maximum:a.value,inclusive:a.inclusive,message:a.message}),r.dirty()):"multipleOf"===a.kind?e.data%a.value!==BigInt(0)&&(t=this._getOrReturnCtx(e,t),O(t,{code:w.not_multiple_of,multipleOf:a.value,message:a.message}),r.dirty()):q.assertNever(a);return{status:r.value,value:e.data}}_getInvalidInput(e){const t=this._getOrReturnCtx(e);return O(t,{code:w.invalid_type,expected:I.bigint,received:t.parsedType}),M}gte(e,t){return this.setLimit("min",e,!0,A.toString(t))}gt(e,t){return this.setLimit("min",e,!1,A.toString(t))}lte(e,t){return this.setLimit("max",e,!0,A.toString(t))}lt(e,t){return this.setLimit("max",e,!1,A.toString(t))}setLimit(e,t,r,a){return new St({...this._def,checks:[...this._def.checks,{kind:e,value:t,inclusive:r,message:A.toString(a)}]})}_addCheck(e){return new St({...this._def,checks:[...this._def.checks,e]})}positive(e){return this._addCheck({kind:"min",value:BigInt(0),inclusive:!1,message:A.toString(e)})}negative(e){return this._addCheck({kind:"max",value:BigInt(0),inclusive:!1,message:A.toString(e)})}nonpositive(e){return this._addCheck({kind:"max",value:BigInt(0),inclusive:!0,message:A.toString(e)})}nonnegative(e){return this._addCheck({kind:"min",value:BigInt(0),inclusive:!0,message:A.toString(e)})}multipleOf(e,t){return this._addCheck({kind:"multipleOf",value:e,message:A.toString(t)})}get minValue(){let e=null;for(const t of this._def.checks)"min"===t.kind&&(null===e||t.value>e)&&(e=t.value);return e}get maxValue(){let e=null;for(const t of this._def.checks)"max"===t.kind&&(null===e||t.value<e)&&(e=t.value);return e}}St.create=e=>new St({checks:[],typeName:v.ZodBigInt,coerce:e?.coerce??!1,...z(e)});class Zi extends B{_parse(e){if(this._def.coerce&&(e.data=!!e.data),this._getType(e)!==I.boolean){const t=this._getOrReturnCtx(e);return O(t,{code:w.invalid_type,expected:I.boolean,received:t.parsedType}),M}return we(e.data)}}Zi.create=e=>new Zi({typeName:v.ZodBoolean,coerce:e?.coerce||!1,...z(e)});class Wt extends B{_parse(e){if(this._def.coerce&&(e.data=new Date(e.data)),this._getType(e)!==I.date){const t=this._getOrReturnCtx(e);return O(t,{code:w.invalid_type,expected:I.date,received:t.parsedType}),M}if(Number.isNaN(e.data.getTime())){return O(this._getOrReturnCtx(e),{code:w.invalid_date}),M}const t=new me;let r;for(const a of this._def.checks)"min"===a.kind?e.data.getTime()<a.value&&(r=this._getOrReturnCtx(e,r),O(r,{code:w.too_small,message:a.message,inclusive:!0,exact:!1,minimum:a.value,type:"date"}),t.dirty()):"max"===a.kind?e.data.getTime()>a.value&&(r=this._getOrReturnCtx(e,r),O(r,{code:w.too_big,message:a.message,inclusive:!0,exact:!1,maximum:a.value,type:"date"}),t.dirty()):q.assertNever(a);return{status:t.value,value:new Date(e.data.getTime())}}_addCheck(e){return new Wt({...this._def,checks:[...this._def.checks,e]})}min(e,t){return this._addCheck({kind:"min",value:e.getTime(),message:A.toString(t)})}max(e,t){return this._addCheck({kind:"max",value:e.getTime(),message:A.toString(t)})}get minDate(){let e=null;for(const t of this._def.checks)"min"===t.kind&&(null===e||t.value>e)&&(e=t.value);return null!=e?new Date(e):null}get maxDate(){let e=null;for(const t of this._def.checks)"max"===t.kind&&(null===e||t.value<e)&&(e=t.value);return null!=e?new Date(e):null}}Wt.create=e=>new Wt({checks:[],coerce:e?.coerce||!1,typeName:v.ZodDate,...z(e)});class Vi extends B{_parse(e){if(this._getType(e)!==I.symbol){const t=this._getOrReturnCtx(e);return O(t,{code:w.invalid_type,expected:I.symbol,received:t.parsedType}),M}return we(e.data)}}Vi.create=e=>new Vi({typeName:v.ZodSymbol,...z(e)});class Ji extends B{_parse(e){if(this._getType(e)!==I.undefined){const t=this._getOrReturnCtx(e);return O(t,{code:w.invalid_type,expected:I.undefined,received:t.parsedType}),M}return we(e.data)}}Ji.create=e=>new Ji({typeName:v.ZodUndefined,...z(e)});class Wi extends B{_parse(e){if(this._getType(e)!==I.null){const t=this._getOrReturnCtx(e);return O(t,{code:w.invalid_type,expected:I.null,received:t.parsedType}),M}return we(e.data)}}Wi.create=e=>new Wi({typeName:v.ZodNull,...z(e)});class Fn extends B{constructor(){super(...arguments),this._any=!0}_parse(e){return we(e.data)}}Fn.create=e=>new Fn({typeName:v.ZodAny,...z(e)});class Ki extends B{constructor(){super(...arguments),this._unknown=!0}_parse(e){return we(e.data)}}Ki.create=e=>new Ki({typeName:v.ZodUnknown,...z(e)});class Be extends B{_parse(e){const t=this._getOrReturnCtx(e);return O(t,{code:w.invalid_type,expected:I.never,received:t.parsedType}),M}}Be.create=e=>new Be({typeName:v.ZodNever,...z(e)});class Qi extends B{_parse(e){if(this._getType(e)!==I.undefined){const t=this._getOrReturnCtx(e);return O(t,{code:w.invalid_type,expected:I.void,received:t.parsedType}),M}return we(e.data)}}Qi.create=e=>new Qi({typeName:v.ZodVoid,...z(e)});class Ie extends B{_parse(e){const{ctx:t,status:r}=this._processInputParams(e),a=this._def;if(t.parsedType!==I.array)return O(t,{code:w.invalid_type,expected:I.array,received:t.parsedType}),M;if(null!==a.exactLength){const e=t.data.length>a.exactLength.value,n=t.data.length<a.exactLength.value;(e||n)&&(O(t,{code:e?w.too_big:w.too_small,minimum:n?a.exactLength.value:void 0,maximum:e?a.exactLength.value:void 0,type:"array",inclusive:!0,exact:!0,message:a.exactLength.message}),r.dirty())}if(null!==a.minLength&&t.data.length<a.minLength.value&&(O(t,{code:w.too_small,minimum:a.minLength.value,type:"array",inclusive:!0,exact:!1,message:a.minLength.message}),r.dirty()),null!==a.maxLength&&t.data.length>a.maxLength.value&&(O(t,{code:w.too_big,maximum:a.maxLength.value,type:"array",inclusive:!0,exact:!1,message:a.maxLength.message}),r.dirty()),t.common.async)return Promise.all([...t.data].map(((e,r)=>a.type._parseAsync(new ze(t,e,t.path,r))))).then((e=>me.mergeArray(r,e)));const n=[...t.data].map(((e,r)=>a.type._parseSync(new ze(t,e,t.path,r))));return me.mergeArray(r,n)}get element(){return this._def.type}min(e,t){return new Ie({...this._def,minLength:{value:e,message:A.toString(t)}})}max(e,t){return new Ie({...this._def,maxLength:{value:e,message:A.toString(t)}})}length(e,t){return new Ie({...this._def,exactLength:{value:e,message:A.toString(t)}})}nonempty(e){return this.min(1,e)}}function Qe(e){if(e instanceof K){const t={};for(const r in e.shape){const a=e.shape[r];t[r]=Fe.create(Qe(a))}return new K({...e._def,shape:()=>t})}return e instanceof Ie?new Ie({...e._def,type:Qe(e.element)}):e instanceof Fe?Fe.create(Qe(e.unwrap())):e instanceof at?at.create(Qe(e.unwrap())):e instanceof Ke?Ke.create(e.items.map((e=>Qe(e)))):e}Ie.create=(e,t)=>new Ie({type:e,minLength:null,maxLength:null,exactLength:null,typeName:v.ZodArray,...z(t)});class K extends B{constructor(){super(...arguments),this._cached=null,this.nonstrict=this.passthrough,this.augment=this.extend}_getCached(){if(null!==this._cached)return this._cached;const e=this._def.shape(),t=q.objectKeys(e);return this._cached={shape:e,keys:t},this._cached}_parse(e){if(this._getType(e)!==I.object){const t=this._getOrReturnCtx(e);return O(t,{code:w.invalid_type,expected:I.object,received:t.parsedType}),M}const{status:t,ctx:r}=this._processInputParams(e),{shape:a,keys:n}=this._getCached(),i=[];if(!(this._def.catchall instanceof Be&&"strip"===this._def.unknownKeys))for(const e in r.data)n.includes(e)||i.push(e);const s=[];for(const e of n){const t=a[e],n=r.data[e];s.push({key:{status:"valid",value:e},value:t._parse(new ze(r,n,r.path,e)),alwaysSet:e in r.data})}if(this._def.catchall instanceof Be){const e=this._def.unknownKeys;if("passthrough"===e)for(const e of i)s.push({key:{status:"valid",value:e},value:{status:"valid",value:r.data[e]}});else if("strict"===e)i.length>0&&(O(r,{code:w.unrecognized_keys,keys:i}),t.dirty());else if("strip"!==e)throw new Error("Internal ZodObject error: invalid unknownKeys value.")}else{const e=this._def.catchall;for(const t of i){const a=r.data[t];s.push({key:{status:"valid",value:t},value:e._parse(new ze(r,a,r.path,t)),alwaysSet:t in r.data})}}return r.common.async?Promise.resolve().then((async()=>{const e=[];for(const t of s){const r=await t.key,a=await t.value;e.push({key:r,value:a,alwaysSet:t.alwaysSet})}return e})).then((e=>me.mergeObjectSync(t,e))):me.mergeObjectSync(t,s)}get shape(){return this._def.shape()}strict(e){return A.errToObj,new K({...this._def,unknownKeys:"strict",...void 0!==e?{errorMap:(t,r)=>{const a=this._def.errorMap?.(t,r).message??r.defaultError;return"unrecognized_keys"===t.code?{message:A.errToObj(e).message??a}:{message:a}}}:{}})}strip(){return new K({...this._def,unknownKeys:"strip"})}passthrough(){return new K({...this._def,unknownKeys:"passthrough"})}extend(e){return new K({...this._def,shape:()=>({...this._def.shape(),...e})})}merge(e){return new K({unknownKeys:e._def.unknownKeys,catchall:e._def.catchall,shape:()=>({...this._def.shape(),...e._def.shape()}),typeName:v.ZodObject})}setKey(e,t){return this.augment({[e]:t})}catchall(e){return new K({...this._def,catchall:e})}pick(e){const t={};for(const r of q.objectKeys(e))e[r]&&this.shape[r]&&(t[r]=this.shape[r]);return new K({...this._def,shape:()=>t})}omit(e){const t={};for(const r of q.objectKeys(this.shape))e[r]||(t[r]=this.shape[r]);return new K({...this._def,shape:()=>t})}deepPartial(){return Qe(this)}partial(e){const t={};for(const r of q.objectKeys(this.shape)){const a=this.shape[r];e&&!e[r]?t[r]=a:t[r]=a.optional()}return new K({...this._def,shape:()=>t})}required(e){const t={};for(const r of q.objectKeys(this.shape))if(e&&!e[r])t[r]=this.shape[r];else{let e=this.shape[r];for(;e instanceof Fe;)e=e._def.innerType;t[r]=e}return new K({...this._def,shape:()=>t})}keyof(){return Zs(q.objectKeys(this.shape))}}K.create=(e,t)=>new K({shape:()=>e,unknownKeys:"strip",catchall:Be.create(),typeName:v.ZodObject,...z(t)}),K.strictCreate=(e,t)=>new K({shape:()=>e,unknownKeys:"strict",catchall:Be.create(),typeName:v.ZodObject,...z(t)}),K.lazycreate=(e,t)=>new K({shape:e,unknownKeys:"strip",catchall:Be.create(),typeName:v.ZodObject,...z(t)});class Kt extends B{_parse(e){const{ctx:t}=this._processInputParams(e),r=this._def.options;if(t.common.async)return Promise.all(r.map((async e=>{const r={...t,common:{...t.common,issues:[]},parent:null};return{result:await e._parseAsync({data:t.data,path:t.path,parent:r}),ctx:r}}))).then((function(e){for(const t of e)if("valid"===t.result.status)return t.result;for(const r of e)if("dirty"===r.result.status)return t.common.issues.push(...r.ctx.common.issues),r.result;const r=e.map((e=>new Pe(e.ctx.common.issues)));return O(t,{code:w.invalid_union,unionErrors:r}),M}));{let e;const a=[];for(const n of r){const r={...t,common:{...t.common,issues:[]},parent:null},i=n._parseSync({data:t.data,path:t.path,parent:r});if("valid"===i.status)return i;"dirty"===i.status&&!e&&(e={result:i,ctx:r}),r.common.issues.length&&a.push(r.common.issues)}if(e)return t.common.issues.push(...e.ctx.common.issues),e.result;const n=a.map((e=>new Pe(e)));return O(t,{code:w.invalid_union,unionErrors:n}),M}}get options(){return this._def.options}}function zn(e,t){const r=Le(e),a=Le(t);if(e===t)return{valid:!0,data:e};if(r===I.object&&a===I.object){const r=q.objectKeys(t),a=q.objectKeys(e).filter((e=>-1!==r.indexOf(e))),n={...e,...t};for(const r of a){const a=zn(e[r],t[r]);if(!a.valid)return{valid:!1};n[r]=a.data}return{valid:!0,data:n}}if(r===I.array&&a===I.array){if(e.length!==t.length)return{valid:!1};const r=[];for(let a=0;a<e.length;a++){const n=zn(e[a],t[a]);if(!n.valid)return{valid:!1};r.push(n.data)}return{valid:!0,data:r}}return r===I.date&&a===I.date&&+e==+t?{valid:!0,data:e}:{valid:!1}}Kt.create=(e,t)=>new Kt({options:e,typeName:v.ZodUnion,...z(t)});class Qt extends B{_parse(e){const{status:t,ctx:r}=this._processInputParams(e),a=(e,a)=>{if(qi(e)||qi(a))return M;const n=zn(e.value,a.value);return n.valid?((Gi(e)||Gi(a))&&t.dirty(),{status:t.value,value:n.data}):(O(r,{code:w.invalid_intersection_types}),M)};return r.common.async?Promise.all([this._def.left._parseAsync({data:r.data,path:r.path,parent:r}),this._def.right._parseAsync({data:r.data,path:r.path,parent:r})]).then((([e,t])=>a(e,t))):a(this._def.left._parseSync({data:r.data,path:r.path,parent:r}),this._def.right._parseSync({data:r.data,path:r.path,parent:r}))}}Qt.create=(e,t,r)=>new Qt({left:e,right:t,typeName:v.ZodIntersection,...z(r)});class Ke extends B{_parse(e){const{status:t,ctx:r}=this._processInputParams(e);if(r.parsedType!==I.array)return O(r,{code:w.invalid_type,expected:I.array,received:r.parsedType}),M;if(r.data.length<this._def.items.length)return O(r,{code:w.too_small,minimum:this._def.items.length,inclusive:!0,exact:!1,type:"array"}),M;!this._def.rest&&r.data.length>this._def.items.length&&(O(r,{code:w.too_big,maximum:this._def.items.length,inclusive:!0,exact:!1,type:"array"}),t.dirty());const a=[...r.data].map(((e,t)=>{const a=this._def.items[t]||this._def.rest;return a?a._parse(new ze(r,e,r.path,t)):null})).filter((e=>!!e));return r.common.async?Promise.all(a).then((e=>me.mergeArray(t,e))):me.mergeArray(t,a)}get items(){return this._def.items}rest(e){return new Ke({...this._def,rest:e})}}Ke.create=(e,t)=>{if(!Array.isArray(e))throw new Error("You must pass an array of schemas to z.tuple([ ... ])");return new Ke({items:e,typeName:v.ZodTuple,rest:null,...z(t)})};class Xi extends B{get keySchema(){return this._def.keyType}get valueSchema(){return this._def.valueType}_parse(e){const{status:t,ctx:r}=this._processInputParams(e);if(r.parsedType!==I.map)return O(r,{code:w.invalid_type,expected:I.map,received:r.parsedType}),M;const a=this._def.keyType,n=this._def.valueType,i=[...r.data.entries()].map((([e,t],i)=>({key:a._parse(new ze(r,e,r.path,[i,"key"])),value:n._parse(new ze(r,t,r.path,[i,"value"]))})));if(r.common.async){const e=new Map;return Promise.resolve().then((async()=>{for(const r of i){const a=await r.key,n=await r.value;if("aborted"===a.status||"aborted"===n.status)return M;("dirty"===a.status||"dirty"===n.status)&&t.dirty(),e.set(a.value,n.value)}return{status:t.value,value:e}}))}{const e=new Map;for(const r of i){const a=r.key,n=r.value;if("aborted"===a.status||"aborted"===n.status)return M;("dirty"===a.status||"dirty"===n.status)&&t.dirty(),e.set(a.value,n.value)}return{status:t.value,value:e}}}}Xi.create=(e,t,r)=>new Xi({valueType:t,keyType:e,typeName:v.ZodMap,...z(r)});class Ot extends B{_parse(e){const{status:t,ctx:r}=this._processInputParams(e);if(r.parsedType!==I.set)return O(r,{code:w.invalid_type,expected:I.set,received:r.parsedType}),M;const a=this._def;null!==a.minSize&&r.data.size<a.minSize.value&&(O(r,{code:w.too_small,minimum:a.minSize.value,type:"set",inclusive:!0,exact:!1,message:a.minSize.message}),t.dirty()),null!==a.maxSize&&r.data.size>a.maxSize.value&&(O(r,{code:w.too_big,maximum:a.maxSize.value,type:"set",inclusive:!0,exact:!1,message:a.maxSize.message}),t.dirty());const n=this._def.valueType;function i(e){const r=new Set;for(const a of e){if("aborted"===a.status)return M;"dirty"===a.status&&t.dirty(),r.add(a.value)}return{status:t.value,value:r}}const s=[...r.data.values()].map(((e,t)=>n._parse(new ze(r,e,r.path,t))));return r.common.async?Promise.all(s).then((e=>i(e))):i(s)}min(e,t){return new Ot({...this._def,minSize:{value:e,message:A.toString(t)}})}max(e,t){return new Ot({...this._def,maxSize:{value:e,message:A.toString(t)}})}size(e,t){return this.min(e,t).max(e,t)}nonempty(e){return this.min(1,e)}}Ot.create=(e,t)=>new Ot({valueType:e,minSize:null,maxSize:null,typeName:v.ZodSet,...z(t)});class Yi extends B{get schema(){return this._def.getter()}_parse(e){const{ctx:t}=this._processInputParams(e);return this._def.getter()._parse({data:t.data,path:t.path,parent:t})}}Yi.create=(e,t)=>new Yi({getter:e,typeName:v.ZodLazy,...z(t)});class es extends B{_parse(e){if(e.data!==this._def.value){const t=this._getOrReturnCtx(e);return O(t,{received:t.data,code:w.invalid_literal,expected:this._def.value}),M}return{status:"valid",value:e.data}}get value(){return this._def.value}}function Zs(e,t){return new rt({values:e,typeName:v.ZodEnum,...z(t)})}es.create=(e,t)=>new es({value:e,typeName:v.ZodLiteral,...z(t)});class rt extends B{_parse(e){if("string"!=typeof e.data){const t=this._getOrReturnCtx(e),r=this._def.values;return O(t,{expected:q.joinValues(r),received:t.parsedType,code:w.invalid_type}),M}if(this._cache||(this._cache=new Set(this._def.values)),!this._cache.has(e.data)){const t=this._getOrReturnCtx(e),r=this._def.values;return O(t,{received:t.data,code:w.invalid_enum_value,options:r}),M}return we(e.data)}get options(){return this._def.values}get enum(){const e={};for(const t of this._def.values)e[t]=t;return e}get Values(){const e={};for(const t of this._def.values)e[t]=t;return e}get Enum(){const e={};for(const t of this._def.values)e[t]=t;return e}extract(e,t=this._def){return rt.create(e,{...this._def,...t})}exclude(e,t=this._def){return rt.create(this.options.filter((t=>!e.includes(t))),{...this._def,...t})}}rt.create=Zs;class ts extends B{_parse(e){const t=q.getValidEnumValues(this._def.values),r=this._getOrReturnCtx(e);if(r.parsedType!==I.string&&r.parsedType!==I.number){const e=q.objectValues(t);return O(r,{expected:q.joinValues(e),received:r.parsedType,code:w.invalid_type}),M}if(this._cache||(this._cache=new Set(q.getValidEnumValues(this._def.values))),!this._cache.has(e.data)){const e=q.objectValues(t);return O(r,{received:r.data,code:w.invalid_enum_value,options:e}),M}return we(e.data)}get enum(){return this._def.values}}ts.create=(e,t)=>new ts({values:e,typeName:v.ZodNativeEnum,...z(t)});class Xt extends B{unwrap(){return this._def.type}_parse(e){const{ctx:t}=this._processInputParams(e);if(t.parsedType!==I.promise&&!1===t.common.async)return O(t,{code:w.invalid_type,expected:I.promise,received:t.parsedType}),M;const r=t.parsedType===I.promise?t.data:Promise.resolve(t.data);return we(r.then((e=>this._def.type.parseAsync(e,{path:t.path,errorMap:t.common.contextualErrorMap}))))}}Xt.create=(e,t)=>new Xt({type:e,typeName:v.ZodPromise,...z(t)});class nt extends B{innerType(){return this._def.schema}sourceType(){return this._def.schema._def.typeName===v.ZodEffects?this._def.schema.sourceType():this._def.schema}_parse(e){const{status:t,ctx:r}=this._processInputParams(e),a=this._def.effect||null,n={addIssue:e=>{O(r,e),e.fatal?t.abort():t.dirty()},get path(){return r.path}};if(n.addIssue=n.addIssue.bind(n),"preprocess"===a.type){const e=a.transform(r.data,n);if(r.common.async)return Promise.resolve(e).then((async e=>{if("aborted"===t.value)return M;const a=await this._def.schema._parseAsync({data:e,path:r.path,parent:r});return"aborted"===a.status?M:"dirty"===a.status||"dirty"===t.value?ft(a.value):a}));{if("aborted"===t.value)return M;const a=this._def.schema._parseSync({data:e,path:r.path,parent:r});return"aborted"===a.status?M:"dirty"===a.status||"dirty"===t.value?ft(a.value):a}}if("refinement"===a.type){const e=e=>{const t=a.refinement(e,n);if(r.common.async)return Promise.resolve(t);if(t instanceof Promise)throw new Error("Async refinement encountered during synchronous parse operation. Use .parseAsync instead.");return e};if(!1===r.common.async){const a=this._def.schema._parseSync({data:r.data,path:r.path,parent:r});return"aborted"===a.status?M:("dirty"===a.status&&t.dirty(),e(a.value),{status:t.value,value:a.value})}return this._def.schema._parseAsync({data:r.data,path:r.path,parent:r}).then((r=>"aborted"===r.status?M:("dirty"===r.status&&t.dirty(),e(r.value).then((()=>({status:t.value,value:r.value}))))))}if("transform"===a.type){if(!1===r.common.async){const e=this._def.schema._parseSync({data:r.data,path:r.path,parent:r});if(!tt(e))return M;const i=a.transform(e.value,n);if(i instanceof Promise)throw new Error("Asynchronous transform encountered during synchronous parse operation. Use .parseAsync instead.");return{status:t.value,value:i}}return this._def.schema._parseAsync({data:r.data,path:r.path,parent:r}).then((e=>tt(e)?Promise.resolve(a.transform(e.value,n)).then((e=>({status:t.value,value:e}))):M))}q.assertNever(a)}}nt.create=(e,t,r)=>new nt({schema:e,typeName:v.ZodEffects,effect:t,...z(r)}),nt.createWithPreprocess=(e,t,r)=>new nt({schema:t,effect:{type:"preprocess",transform:e},typeName:v.ZodEffects,...z(r)});class Fe extends B{_parse(e){return this._getType(e)===I.undefined?we(void 0):this._def.innerType._parse(e)}unwrap(){return this._def.innerType}}Fe.create=(e,t)=>new Fe({innerType:e,typeName:v.ZodOptional,...z(t)});class at extends B{_parse(e){return this._getType(e)===I.null?we(null):this._def.innerType._parse(e)}unwrap(){return this._def.innerType}}at.create=(e,t)=>new at({innerType:e,typeName:v.ZodNullable,...z(t)});class Bn extends B{_parse(e){const{ctx:t}=this._processInputParams(e);let r=t.data;return t.parsedType===I.undefined&&(r=this._def.defaultValue()),this._def.innerType._parse({data:r,path:t.path,parent:t})}removeDefault(){return this._def.innerType}}Bn.create=(e,t)=>new Bn({innerType:e,typeName:v.ZodDefault,defaultValue:"function"==typeof t.default?t.default:()=>t.default,...z(t)});class qn extends B{_parse(e){const{ctx:t}=this._processInputParams(e),r={...t,common:{...t.common,issues:[]}},a=this._def.innerType._parse({data:r.data,path:r.path,parent:{...r}});return Jt(a)?a.then((e=>({status:"valid",value:"valid"===e.status?e.value:this._def.catchValue({get error(){return new Pe(r.common.issues)},input:r.data})}))):{status:"valid",value:"valid"===a.status?a.value:this._def.catchValue({get error(){return new Pe(r.common.issues)},input:r.data})}}removeCatch(){return this._def.innerType}}qn.create=(e,t)=>new qn({innerType:e,typeName:v.ZodCatch,catchValue:"function"==typeof t.catch?t.catch:()=>t.catch,...z(t)});class rs extends B{_parse(e){if(this._getType(e)!==I.nan){const t=this._getOrReturnCtx(e);return O(t,{code:w.invalid_type,expected:I.nan,received:t.parsedType}),M}return{status:"valid",value:e.data}}}rs.create=e=>new rs({typeName:v.ZodNaN,...z(e)});class Bl extends B{_parse(e){const{ctx:t}=this._processInputParams(e),r=t.data;return this._def.type._parse({data:r,path:t.path,parent:t})}unwrap(){return this._def.type}}class ua extends B{_parse(e){const{status:t,ctx:r}=this._processInputParams(e);if(r.common.async)return(async()=>{const e=await this._def.in._parseAsync({data:r.data,path:r.path,parent:r});return"aborted"===e.status?M:"dirty"===e.status?(t.dirty(),ft(e.value)):this._def.out._parseAsync({data:e.value,path:r.path,parent:r})})();{const e=this._def.in._parseSync({data:r.data,path:r.path,parent:r});return"aborted"===e.status?M:"dirty"===e.status?(t.dirty(),{status:"dirty",value:e.value}):this._def.out._parseSync({data:e.value,path:r.path,parent:r})}}static create(e,t){return new ua({in:e,out:t,typeName:v.ZodPipeline})}}class Gn extends B{_parse(e){const t=this._def.innerType._parse(e),r=e=>(tt(e)&&(e.value=Object.freeze(e.value)),e);return Jt(t)?t.then((e=>r(e))):r(t)}unwrap(){return this._def.innerType}}var v;Gn.create=(e,t)=>new Gn({innerType:e,typeName:v.ZodReadonly,...z(t)}),function(e){e.ZodString="ZodString",e.ZodNumber="ZodNumber",e.ZodNaN="ZodNaN",e.ZodBigInt="ZodBigInt",e.ZodBoolean="ZodBoolean",e.ZodDate="ZodDate",e.ZodSymbol="ZodSymbol",e.ZodUndefined="ZodUndefined",e.ZodNull="ZodNull",e.ZodAny="ZodAny",e.ZodUnknown="ZodUnknown",e.ZodNever="ZodNever",e.ZodVoid="ZodVoid",e.ZodArray="ZodArray",e.ZodObject="ZodObject",e.ZodUnion="ZodUnion",e.ZodDiscriminatedUnion="ZodDiscriminatedUnion",e.ZodIntersection="ZodIntersection",e.ZodTuple="ZodTuple",e.ZodRecord="ZodRecord",e.ZodMap="ZodMap",e.ZodSet="ZodSet",e.ZodFunction="ZodFunction",e.ZodLazy="ZodLazy",e.ZodLiteral="ZodLiteral",e.ZodEnum="ZodEnum",e.ZodEffects="ZodEffects",e.ZodNativeEnum="ZodNativeEnum",e.ZodOptional="ZodOptional",e.ZodNullable="ZodNullable",e.ZodDefault="ZodDefault",e.ZodCatch="ZodCatch",e.ZodPromise="ZodPromise",e.ZodBranded="ZodBranded",e.ZodPipeline="ZodPipeline",e.ZodReadonly="ZodReadonly"}(v||(v={}));const ql=De.create,ns=Fn.create;Be.create,Ie.create;const Gl=K.create;Kt.create,Qt.create,Ke.create,rt.create,Xt.create,Fe.create,at.create;const Hl=Object.prototype.hasOwnProperty;function Zl(e,t){return Hl.call(e,t)}function Vl(e){if(Array.isArray(e)){const t=new Array(e.length);for(let e=0;e<t.length;e++)t[e]=""+e;return t}if(Object.keys)return Object.keys(e);let t=[];for(let r in e)Zl(e,r)&&t.push(r);return t}function it(e){switch(typeof e){case"object":return JSON.parse(JSON.stringify(e));case"undefined":return null;default:return e}}function Hn(e){let t=0;const r=e.length;let a;for(;t<r;){if(a=e.charCodeAt(t),!(a>=48&&a<=57))return!1;t++}return!0}function Jl(e){return e.replace(/~1/g,"/").replace(/~0/g,"~")}function Zn(e){if(void 0===e)return!0;if(e)if(Array.isArray(e)){for(let t=0,r=e.length;t<r;t++)if(Zn(e[t]))return!0}else if("object"==typeof e){const r=Vl(e),a=r.length;for(var t=0;t<a;t++)if(Zn(e[r[t]]))return!0}return!1}function as(e,t){const r=[e];for(const e in t){const a="object"==typeof t[e]?JSON.stringify(t[e],null,2):t[e];typeof a<"u"&&r.push(`${e}: ${a}`)}return r.join("\n")}class Wl extends Error{constructor(e,t,r,a,n){super(as(e,{name:t,index:r,operation:a,tree:n})),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:t}),Object.defineProperty(this,"index",{enumerable:!0,configurable:!0,writable:!0,value:r}),Object.defineProperty(this,"operation",{enumerable:!0,configurable:!0,writable:!0,value:a}),Object.defineProperty(this,"tree",{enumerable:!0,configurable:!0,writable:!0,value:n}),Object.setPrototypeOf(this,new.target.prototype),this.message=as(e,{name:t,index:r,operation:a,tree:n})}}const Q=Wl,Ye={add:function(e,t,r){return e[t]=this.value,{newDocument:r}},remove:function(e,t,r){var a=e[t];return delete e[t],{newDocument:r,removed:a}},replace:function(e,t,r){var a=e[t];return e[t]=this.value,{newDocument:r,removed:a}},move:function(e,t,r){let a=Vn(r,this.path);a&&(a=it(a));const n=_t(r,{op:"remove",path:this.from}).removed;return _t(r,{op:"add",path:this.path,value:n}),{newDocument:r,removed:a}},copy:function(e,t,r){const a=Vn(r,this.from);return _t(r,{op:"add",path:this.path,value:it(a)}),{newDocument:r}},test:function(e,t,r){return{newDocument:r,test:er(e[t],this.value)}},_get:function(e,t,r){return this.value=e[t],{newDocument:r}}};var Kl={add:function(e,t,r){return Hn(t)?e.splice(t,0,this.value):e[t]=this.value,{newDocument:r,index:t}},remove:function(e,t,r){return{newDocument:r,removed:e.splice(t,1)[0]}},replace:function(e,t,r){var a=e[t];return e[t]=this.value,{newDocument:r,removed:a}},move:Ye.move,copy:Ye.copy,test:Ye.test,_get:Ye._get};function Vn(e,t){if(""==t)return e;var r={op:"_get",path:t};return _t(e,r),r.value}function _t(e,t,r=!1,a=!0,n=!0,i=0){if(r&&("function"==typeof r?r(t,0,e,t.path):Jn(t,0)),""===t.path){let a={newDocument:e};if("add"===t.op)return a.newDocument=t.value,a;if("replace"===t.op)return a.newDocument=t.value,a.removed=e,a;if("move"===t.op||"copy"===t.op)return a.newDocument=Vn(e,t.from),"move"===t.op&&(a.removed=e),a;if("test"===t.op){if(a.test=er(e,t.value),!1===a.test)throw new Q("Test operation failed","TEST_OPERATION_FAILED",i,t,e);return a.newDocument=e,a}if("remove"===t.op)return a.removed=e,a.newDocument=null,a;if("_get"===t.op)return t.value=e,a;if(r)throw new Q("Operation `op` property is not one of operations defined in RFC-6902","OPERATION_OP_INVALID",i,t,e);return a}{a||(e=it(e));const s=(t.path||"").split("/");let o,c,u,l=e,d=1,h=s.length;for(u="function"==typeof r?r:Jn;;){if(c=s[d],c&&-1!=c.indexOf("~")&&(c=Jl(c)),n&&("__proto__"==c||"prototype"==c&&d>0&&"constructor"==s[d-1]))throw new TypeError("JSON-Patch: modifying `__proto__` or `constructor/prototype` prop is banned for security reasons, if this was on purpose, please set `banPrototypeModifications` flag false and pass it to this function. More info in fast-json-patch README");if(r&&void 0===o&&(void 0===l[c]?o=s.slice(0,d).join("/"):d==h-1&&(o=t.path),void 0!==o&&u(t,0,e,o)),d++,Array.isArray(l)){if("-"===c)c=l.length;else{if(r&&!Hn(c))throw new Q("Expected an unsigned base-10 integer value, making the new referenced value the array element with the zero-based index","OPERATION_PATH_ILLEGAL_ARRAY_INDEX",i,t,e);Hn(c)&&(c=~~c)}if(d>=h){if(r&&"add"===t.op&&c>l.length)throw new Q("The specified index MUST NOT be greater than the number of elements in the array","OPERATION_VALUE_OUT_OF_BOUNDS",i,t,e);const a=Kl[t.op].call(t,l,c,e);if(!1===a.test)throw new Q("Test operation failed","TEST_OPERATION_FAILED",i,t,e);return a}}else if(d>=h){const r=Ye[t.op].call(t,l,c,e);if(!1===r.test)throw new Q("Test operation failed","TEST_OPERATION_FAILED",i,t,e);return r}if(l=l[c],r&&d<h&&(!l||"object"!=typeof l))throw new Q("Cannot perform operation at the desired path","OPERATION_PATH_UNRESOLVABLE",i,t,e)}}}function Yt(e,t,r,a=!0,n=!0){if(r&&!Array.isArray(t))throw new Q("Patch sequence must be an array","SEQUENCE_NOT_AN_ARRAY");a||(e=it(e));const i=new Array(t.length);for(let a=0,s=t.length;a<s;a++)i[a]=_t(e,t[a],r,!0,n,a),e=i[a].newDocument;return i.newDocument=e,i}function Jn(e,t,r,a){if("object"!=typeof e||null===e||Array.isArray(e))throw new Q("Operation is not an object","OPERATION_NOT_AN_OBJECT",t,e,r);if(!Ye[e.op])throw new Q("Operation `op` property is not one of operations defined in RFC-6902","OPERATION_OP_INVALID",t,e,r);if("string"!=typeof e.path)throw new Q("Operation `path` property is not a string","OPERATION_PATH_INVALID",t,e,r);if(0!==e.path.indexOf("/")&&e.path.length>0)throw new Q('Operation `path` property must start with "/"',"OPERATION_PATH_INVALID",t,e,r);if(("move"===e.op||"copy"===e.op)&&"string"!=typeof e.from)throw new Q("Operation `from` property is not present (applicable in `move` and `copy` operations)","OPERATION_FROM_REQUIRED",t,e,r);if(("add"===e.op||"replace"===e.op||"test"===e.op)&&void 0===e.value)throw new Q("Operation `value` property is not present (applicable in `add`, `replace` and `test` operations)","OPERATION_VALUE_REQUIRED",t,e,r);if(("add"===e.op||"replace"===e.op||"test"===e.op)&&Zn(e.value))throw new Q("Operation `value` property is not present (applicable in `add`, `replace` and `test` operations)","OPERATION_VALUE_CANNOT_CONTAIN_UNDEFINED",t,e,r);if(r)if("add"==e.op){var n=e.path.split("/").length,i=a.split("/").length;if(n!==i+1&&n!==i)throw new Q("Cannot perform an `add` operation at the desired path","OPERATION_PATH_CANNOT_ADD",t,e,r)}else if("replace"===e.op||"remove"===e.op||"_get"===e.op){if(e.path!==a)throw new Q("Cannot perform the operation at a path that does not exist","OPERATION_PATH_UNRESOLVABLE",t,e,r)}else if("move"===e.op||"copy"===e.op){var s=Ql([{op:"_get",path:e.from,value:void 0}],r);if(s&&"OPERATION_PATH_UNRESOLVABLE"===s.name)throw new Q("Cannot perform the operation from a path that does not exist","OPERATION_FROM_UNRESOLVABLE",t,e,r)}}function Ql(e,t,r){try{if(!Array.isArray(e))throw new Q("Patch sequence must be an array","SEQUENCE_NOT_AN_ARRAY");if(t)Yt(it(t),it(e),r||!0);else{r=r||Jn;for(var a=0;a<e.length;a++)r(e[a],a,t,void 0)}}catch(e){if(e instanceof Q)return e;throw e}}function er(e,t){if(e===t)return!0;if(e&&t&&"object"==typeof e&&"object"==typeof t){var r,a,n,i=Array.isArray(e),s=Array.isArray(t);if(i&&s){if((a=e.length)!=t.length)return!1;for(r=a;0!=r--;)if(!er(e[r],t[r]))return!1;return!0}if(i!=s)return!1;var o=Object.keys(e);if((a=o.length)!==Object.keys(t).length)return!1;for(r=a;0!=r--;)if(!t.hasOwnProperty(o[r]))return!1;for(r=a;0!=r--;)if(!er(e[n=o[r]],t[n]))return!1;return!0}return e!=e&&t!=t}class Xl{getStore(){}run(e,t){return t()}enterWith(e){}}const Yl=new Xl,is=Symbol.for("lc:child_config");class ed{getInstance(){return vt()??Yl}getRunnableConfig(){return this.getInstance().getStore()?.extra?.[is]}runWithConfig(e,t,r){const a=be._configureSync(e?.callbacks,void 0,e?.tags,void 0,e?.metadata),n=this.getInstance(),i=n.getStore(),s=a?.getParentRunId(),o=a?.handlers?.find((e=>"langchain_tracer"===e?.name));let c;return o&&s?c=o.getRunTreeWithTracingConfig(s):r||(c=new de({name:"<runnable_lambda>",tracingEnabled:!1})),c&&(c.extra={...c.extra,[is]:e}),void 0!==i&&void 0!==i[Bt]&&(void 0===c&&(c={}),c[Bt]=i[Bt]),n.run(c,t)}initializeGlobalInstance(e){void 0===vt()&&sl(e)}}const qe=new ed,An=25;async function Se(e){return be._configureSync(e?.callbacks,void 0,e?.tags,void 0,e?.metadata)}function ss(...e){const t={};for(const r of e.filter((e=>!!e)))for(const e of Object.keys(r))if("metadata"===e)t[e]={...t[e],...r[e]};else if("tags"===e){const a=t[e]??[];t[e]=[...new Set(a.concat(r[e]??[]))]}else if("configurable"===e)t[e]={...t[e],...r[e]};else if("timeout"===e)void 0===t.timeout?t.timeout=r.timeout:void 0!==r.timeout&&(t.timeout=Math.min(t.timeout,r.timeout));else if("signal"===e)void 0===t.signal?t.signal=r.signal:void 0!==r.signal&&("any"in AbortSignal?t.signal=AbortSignal.any([t.signal,r.signal]):t.signal=r.signal);else if("callbacks"===e){const e=t.callbacks,a=r.callbacks;if(Array.isArray(a))if(e)if(Array.isArray(e))t.callbacks=e.concat(a);else{const r=e.copy();for(const e of a)r.addHandler(Vt(e),!0);t.callbacks=r}else t.callbacks=a;else if(a)if(e)if(Array.isArray(e)){const r=a.copy();for(const t of e)r.addHandler(Vt(t),!0);t.callbacks=r}else t.callbacks=new be(a._parentRunId,{handlers:e.handlers.concat(a.handlers),inheritableHandlers:e.inheritableHandlers.concat(a.inheritableHandlers),tags:Array.from(new Set(e.tags.concat(a.tags))),inheritableTags:Array.from(new Set(e.inheritableTags.concat(a.inheritableTags))),metadata:{...e.metadata,...a.metadata}});else t.callbacks=a}else{const a=e;t[a]=r[a]??t[a]}return t}const td=new Set(["string","number","boolean"]);function H(e){const t=qe.getRunnableConfig();let r={tags:[],metadata:{},recursionLimit:25,runId:void 0};if(t){const{runId:e,runName:a,...n}=t;r=Object.entries(n).reduce(((e,[t,r])=>(void 0!==r&&(e[t]=r),e)),r)}if(e&&(r=Object.entries(e).reduce(((e,[t,r])=>(void 0!==r&&(e[t]=r),e)),r)),r?.configurable)for(const e of Object.keys(r.configurable))td.has(typeof r.configurable[e])&&!r.metadata?.[e]&&(r.metadata||(r.metadata={}),r.metadata[e]=r.configurable[e]);if(void 0!==r.timeout){if(r.timeout<=0)throw new Error("Timeout must be a positive number");const e=AbortSignal.timeout(r.timeout);void 0!==r.signal?"any"in AbortSignal&&(r.signal=AbortSignal.any([r.signal,e])):r.signal=e,delete r.timeout}return r}function ne(e={},{callbacks:t,maxConcurrency:r,recursionLimit:a,runName:n,configurable:i,runId:s}={}){const o=H(e);return void 0!==t&&(delete o.runName,o.callbacks=t),void 0!==a&&(o.recursionLimit=a),void 0!==r&&(o.maxConcurrency=r),void 0!==n&&(o.runName=n),void 0!==i&&(o.configurable={...o.configurable,...i}),void 0!==s&&delete o.runId,o}function st(e){return e?{configurable:e.configurable,recursionLimit:e.recursionLimit,callbacks:e.callbacks,tags:e.tags,metadata:e.metadata,maxConcurrency:e.maxConcurrency,timeout:e.timeout,signal:e.signal}:void 0}async function Ge(e,t){if(void 0===t)return e;let r;return Promise.race([e.catch((e=>{if(!t?.aborted)throw e})),new Promise(((e,a)=>{r=()=>{a(new Error("Aborted"))},t.addEventListener("abort",r),t.aborted&&a(new Error("Aborted"))}))]).finally((()=>t.removeEventListener("abort",r)))}class ge extends ReadableStream{constructor(){super(...arguments),Object.defineProperty(this,"reader",{enumerable:!0,configurable:!0,writable:!0,value:void 0})}ensureReader(){this.reader||(this.reader=this.getReader())}async next(){this.ensureReader();try{const e=await this.reader.read();return e.done?(this.reader.releaseLock(),{done:!0,value:void 0}):{done:!1,value:e.value}}catch(e){throw this.reader.releaseLock(),e}}async return(){if(this.ensureReader(),this.locked){const e=this.reader.cancel();this.reader.releaseLock(),await e}return{done:!0,value:void 0}}async throw(e){if(this.ensureReader(),this.locked){const e=this.reader.cancel();this.reader.releaseLock(),await e}throw e}[Symbol.asyncIterator](){return this}async[Symbol.asyncDispose](){await this.return()}static fromReadableStream(e){const t=e.getReader();return new ge({start:e=>function r(){return t.read().then((({done:t,value:a})=>{if(!t)return e.enqueue(a),r();e.close()}))}(),cancel(){t.releaseLock()}})}static fromAsyncGenerator(e){return new ge({async pull(t){const{value:r,done:a}=await e.next();a&&t.close(),t.enqueue(r)},async cancel(t){await e.return(t)}})}}function Vs(e,t=2){const r=Array.from({length:t},(()=>[]));return r.map((async function*(t){for(;;)if(0===t.length){const t=await e.next();for(const e of r)e.push(t)}else{if(t[0].done)return;yield t.shift().value}}))}function Js(e,t){if(Array.isArray(e)&&Array.isArray(t))return e.concat(t);if("string"==typeof e&&"string"==typeof t)return e+t;if("number"==typeof e&&"number"==typeof t)return e+t;if("concat"in e&&"function"==typeof e.concat)return e.concat(t);if("object"==typeof e&&"object"==typeof t){const r={...e};for(const[e,a]of Object.entries(t))e in r&&!Array.isArray(r[e])?r[e]=Js(r[e],a):r[e]=a;return r}throw new Error(`Cannot concat ${typeof e} and ${typeof t}`)}class ut{constructor(e){Object.defineProperty(this,"generator",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"setup",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"config",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"signal",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"firstResult",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"firstResultUsed",{enumerable:!0,configurable:!0,writable:!0,value:!1}),this.generator=e.generator,this.config=e.config,this.signal=e.signal??this.config?.signal,this.setup=new Promise(((t,r)=>{qe.runWithConfig(st(e.config),(async()=>{this.firstResult=e.generator.next(),e.startSetup?this.firstResult.then(e.startSetup).then(t,r):this.firstResult.then((e=>t(void 0)),r)}),!0)}))}async next(...e){return this.signal?.throwIfAborted(),this.firstResultUsed?qe.runWithConfig(st(this.config),this.signal?async()=>Ge(this.generator.next(...e),this.signal):async()=>this.generator.next(...e),!0):(this.firstResultUsed=!0,this.firstResult)}async return(e){return this.generator.return(e)}async throw(e){return this.generator.throw(e)}[Symbol.asyncIterator](){return this}async[Symbol.asyncDispose](){await this.return()}}async function rd(e,t,r,a,...n){const i=new ut({generator:t,startSetup:r,signal:a}),s=await i.setup;return{output:e(i,s,...n),setup:s}}class Me{constructor(e){Object.defineProperty(this,"ops",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.ops=e.ops??[]}concat(e){const t=this.ops.concat(e.ops),r=Yt({},t);return new Tt({ops:t,state:r[r.length-1].newDocument})}}class Tt extends Me{constructor(e){super(e),Object.defineProperty(this,"state",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.state=e.state}concat(e){const t=this.ops.concat(e.ops),r=Yt(this.state,e.ops);return new Tt({ops:t,state:r[r.length-1].newDocument})}static fromRunLogPatch(e){const t=Yt({},e.ops);return new Tt({ops:e.ops,state:t[t.length-1].newDocument})}}const nd=e=>"log_stream_tracer"===e.name;async function os(e,t){if("original"===t)throw new Error("Do not assign inputs with original schema drop the key for now. When inputs are added to streamLog they should be added with standardized schema for streaming events.");const{inputs:r}=e;return["retriever","llm","prompt"].includes(e.run_type)?r:1!==Object.keys(r).length||""!==r?.input?r.input:void 0}async function us(e,t){const{outputs:r}=e;return"original"===t||["retriever","llm","prompt"].includes(e.run_type)?r:void 0!==r&&1===Object.keys(r).length&&void 0!==r?.output?r.output:r}function ad(e){return void 0!==e&&void 0!==e.message}class cs extends At{constructor(e){super({_awaitHandler:!0,...e}),Object.defineProperty(this,"autoClose",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"includeNames",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"includeTypes",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"includeTags",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"excludeNames",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"excludeTypes",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"excludeTags",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"_schemaFormat",{enumerable:!0,configurable:!0,writable:!0,value:"original"}),Object.defineProperty(this,"rootId",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"keyMapByRunId",{enumerable:!0,configurable:!0,writable:!0,value:{}}),Object.defineProperty(this,"counterMapByRunName",{enumerable:!0,configurable:!0,writable:!0,value:{}}),Object.defineProperty(this,"transformStream",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"writer",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"receiveStream",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:"log_stream_tracer"}),Object.defineProperty(this,"lc_prefer_streaming",{enumerable:!0,configurable:!0,writable:!0,value:!0}),this.autoClose=e?.autoClose??!0,this.includeNames=e?.includeNames,this.includeTypes=e?.includeTypes,this.includeTags=e?.includeTags,this.excludeNames=e?.excludeNames,this.excludeTypes=e?.excludeTypes,this.excludeTags=e?.excludeTags,this._schemaFormat=e?._schemaFormat??this._schemaFormat,this.transformStream=new TransformStream,this.writer=this.transformStream.writable.getWriter(),this.receiveStream=ge.fromReadableStream(this.transformStream.readable)}[Symbol.asyncIterator](){return this.receiveStream}async persistRun(e){}_includeRun(e){if(e.id===this.rootId)return!1;const t=e.tags??[];let r=void 0===this.includeNames&&void 0===this.includeTags&&void 0===this.includeTypes;return void 0!==this.includeNames&&(r=r||this.includeNames.includes(e.name)),void 0!==this.includeTypes&&(r=r||this.includeTypes.includes(e.run_type)),void 0!==this.includeTags&&(r=r||void 0!==t.find((e=>this.includeTags?.includes(e)))),void 0!==this.excludeNames&&(r=r&&!this.excludeNames.includes(e.name)),void 0!==this.excludeTypes&&(r=r&&!this.excludeTypes.includes(e.run_type)),void 0!==this.excludeTags&&(r=r&&t.every((e=>!this.excludeTags?.includes(e)))),r}async*tapOutputIterable(e,t){for await(const r of t){if(e!==this.rootId){const t=this.keyMapByRunId[e];t&&await this.writer.write(new Me({ops:[{op:"add",path:`/logs/${t}/streamed_output/-`,value:r}]}))}yield r}}async onRunCreate(e){if(void 0===this.rootId&&(this.rootId=e.id,await this.writer.write(new Me({ops:[{op:"replace",path:"",value:{id:e.id,name:e.name,type:e.run_type,streamed_output:[],final_output:void 0,logs:{}}}]}))),!this._includeRun(e))return;void 0===this.counterMapByRunName[e.name]&&(this.counterMapByRunName[e.name]=0),this.counterMapByRunName[e.name]+=1;const t=this.counterMapByRunName[e.name];this.keyMapByRunId[e.id]=1===t?e.name:`${e.name}:${t}`;const r={id:e.id,name:e.name,type:e.run_type,tags:e.tags??[],metadata:e.extra?.metadata??{},start_time:new Date(e.start_time).toISOString(),streamed_output:[],streamed_output_str:[],final_output:void 0,end_time:void 0};"streaming_events"===this._schemaFormat&&(r.inputs=await os(e,this._schemaFormat)),await this.writer.write(new Me({ops:[{op:"add",path:`/logs/${this.keyMapByRunId[e.id]}`,value:r}]}))}async onRunUpdate(e){try{const t=this.keyMapByRunId[e.id];if(void 0===t)return;const r=[];"streaming_events"===this._schemaFormat&&r.push({op:"replace",path:`/logs/${t}/inputs`,value:await os(e,this._schemaFormat)}),r.push({op:"add",path:`/logs/${t}/final_output`,value:await us(e,this._schemaFormat)}),void 0!==e.end_time&&r.push({op:"add",path:`/logs/${t}/end_time`,value:new Date(e.end_time).toISOString()});const a=new Me({ops:r});await this.writer.write(a)}finally{if(e.id===this.rootId){const t=new Me({ops:[{op:"replace",path:"/final_output",value:await us(e,this._schemaFormat)}]});await this.writer.write(t),this.autoClose&&await this.writer.close()}}}async onLLMNewToken(e,t,r){const a=this.keyMapByRunId[e.id];if(void 0===a)return;let n;n=void 0!==e.inputs.messages?ad(r?.chunk)?r?.chunk:new hr({id:`run-${e.id}`,content:t}):t;const i=new Me({ops:[{op:"add",path:`/logs/${a}/streamed_output_str/-`,value:t},{op:"add",path:`/logs/${a}/streamed_output/-`,value:n}]});await this.writer.write(i)}}class tr{constructor(e){Object.defineProperty(this,"text",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"generationInfo",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.text=e.text,this.generationInfo=e.generationInfo}concat(e){return new tr({text:this.text+e.text,generationInfo:{...this.generationInfo,...e.generationInfo}})}}function Dt({name:e,serialized:t}){return void 0!==e?e:void 0!==t?.name?t.name:void 0!==t?.id&&Array.isArray(t?.id)?t.id[t.id.length-1]:"Unnamed"}const id=e=>"event_stream_tracer"===e.name;class sd extends At{constructor(e){super({_awaitHandler:!0,...e}),Object.defineProperty(this,"autoClose",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"includeNames",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"includeTypes",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"includeTags",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"excludeNames",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"excludeTypes",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"excludeTags",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"runInfoMap",{enumerable:!0,configurable:!0,writable:!0,value:new Map}),Object.defineProperty(this,"tappedPromises",{enumerable:!0,configurable:!0,writable:!0,value:new Map}),Object.defineProperty(this,"transformStream",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"writer",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"receiveStream",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:"event_stream_tracer"}),Object.defineProperty(this,"lc_prefer_streaming",{enumerable:!0,configurable:!0,writable:!0,value:!0}),this.autoClose=e?.autoClose??!0,this.includeNames=e?.includeNames,this.includeTypes=e?.includeTypes,this.includeTags=e?.includeTags,this.excludeNames=e?.excludeNames,this.excludeTypes=e?.excludeTypes,this.excludeTags=e?.excludeTags,this.transformStream=new TransformStream,this.writer=this.transformStream.writable.getWriter(),this.receiveStream=ge.fromReadableStream(this.transformStream.readable)}[Symbol.asyncIterator](){return this.receiveStream}async persistRun(e){}_includeRun(e){const t=e.tags??[];let r=void 0===this.includeNames&&void 0===this.includeTags&&void 0===this.includeTypes;return void 0!==this.includeNames&&(r=r||this.includeNames.includes(e.name)),void 0!==this.includeTypes&&(r=r||this.includeTypes.includes(e.runType)),void 0!==this.includeTags&&(r=r||void 0!==t.find((e=>this.includeTags?.includes(e)))),void 0!==this.excludeNames&&(r=r&&!this.excludeNames.includes(e.name)),void 0!==this.excludeTypes&&(r=r&&!this.excludeTypes.includes(e.runType)),void 0!==this.excludeTags&&(r=r&&t.every((e=>!this.excludeTags?.includes(e)))),r}async*tapOutputIterable(e,t){const r=await t.next();if(r.done)return;const a=this.runInfoMap.get(e);if(void 0===a)return void(yield r.value);function n(e,t){return"llm"===e&&"string"==typeof t?new tr({text:t}):t}let i=this.tappedPromises.get(e);if(void 0===i){let s;i=new Promise((e=>{s=e})),this.tappedPromises.set(e,i);try{const i={event:`on_${a.runType}_stream`,run_id:e,name:a.name,tags:a.tags,metadata:a.metadata,data:{}};await this.send({...i,data:{chunk:n(a.runType,r.value)}},a),yield r.value;for await(const e of t)"tool"!==a.runType&&"retriever"!==a.runType&&await this.send({...i,data:{chunk:n(a.runType,e)}},a),yield e}finally{s()}}else{yield r.value;for await(const e of t)yield e}}async send(e,t){this._includeRun(t)&&await this.writer.write(e)}async sendEndEvent(e,t){const r=this.tappedPromises.get(e.run_id);void 0!==r?r.then((()=>{this.send(e,t)})):await this.send(e,t)}async onLLMStart(e){const t=Dt(e),r=void 0!==e.inputs.messages?"chat_model":"llm",a={tags:e.tags??[],metadata:e.extra?.metadata??{},name:t,runType:r,inputs:e.inputs};this.runInfoMap.set(e.id,a);const n=`on_${r}_start`;await this.send({event:n,data:{input:e.inputs},name:t,tags:e.tags??[],run_id:e.id,metadata:e.extra?.metadata??{}},a)}async onLLMNewToken(e,t,r){const a=this.runInfoMap.get(e.id);let n,i;if(void 0===a)throw new Error(`onLLMNewToken: Run ID ${e.id} not found in run map.`);if(1!==this.runInfoMap.size){if("chat_model"===a.runType)i="on_chat_model_stream",n=void 0===r?.chunk?new hr({content:t,id:`run-${e.id}`}):r.chunk.message;else{if("llm"!==a.runType)throw new Error(`Unexpected run type ${a.runType}`);i="on_llm_stream",n=void 0===r?.chunk?new tr({text:t}):r.chunk}await this.send({event:i,data:{chunk:n},run_id:e.id,name:a.name,tags:a.tags,metadata:a.metadata},a)}}async onLLMEnd(e){const t=this.runInfoMap.get(e.id);let r;if(this.runInfoMap.delete(e.id),void 0===t)throw new Error(`onLLMEnd: Run ID ${e.id} not found in run map.`);const a=e.outputs?.generations;let n;if("chat_model"===t.runType){for(const e of a??[]){if(void 0!==n)break;n=e[0]?.message}r="on_chat_model_end"}else{if("llm"!==t.runType)throw new Error(`onLLMEnd: Unexpected run type: ${t.runType}`);n={generations:a?.map((e=>e.map((e=>({text:e.text,generationInfo:e.generationInfo}))))),llmOutput:e.outputs?.llmOutput??{}},r="on_llm_end"}await this.sendEndEvent({event:r,data:{output:n,input:t.inputs},run_id:e.id,name:t.name,tags:t.tags,metadata:t.metadata},t)}async onChainStart(e){const t=Dt(e),r=e.run_type??"chain",a={tags:e.tags??[],metadata:e.extra?.metadata??{},name:t,runType:e.run_type};let n={};""===e.inputs.input&&1===Object.keys(e.inputs).length?(n={},a.inputs={}):void 0!==e.inputs.input?(n.input=e.inputs.input,a.inputs=e.inputs.input):(n.input=e.inputs,a.inputs=e.inputs),this.runInfoMap.set(e.id,a),await this.send({event:`on_${r}_start`,data:n,name:t,tags:e.tags??[],run_id:e.id,metadata:e.extra?.metadata??{}},a)}async onChainEnd(e){const t=this.runInfoMap.get(e.id);if(this.runInfoMap.delete(e.id),void 0===t)throw new Error(`onChainEnd: Run ID ${e.id} not found in run map.`);const r=`on_${e.run_type}_end`,a=e.inputs??t.inputs??{},n={output:e.outputs?.output??e.outputs,input:a};a.input&&1===Object.keys(a).length&&(n.input=a.input,t.inputs=a.input),await this.sendEndEvent({event:r,data:n,run_id:e.id,name:t.name,tags:t.tags,metadata:t.metadata??{}},t)}async onToolStart(e){const t=Dt(e),r={tags:e.tags??[],metadata:e.extra?.metadata??{},name:t,runType:"tool",inputs:e.inputs??{}};this.runInfoMap.set(e.id,r),await this.send({event:"on_tool_start",data:{input:e.inputs??{}},name:t,run_id:e.id,tags:e.tags??[],metadata:e.extra?.metadata??{}},r)}async onToolEnd(e){const t=this.runInfoMap.get(e.id);if(this.runInfoMap.delete(e.id),void 0===t)throw new Error(`onToolEnd: Run ID ${e.id} not found in run map.`);if(void 0===t.inputs)throw new Error(`onToolEnd: Run ID ${e.id} is a tool call, and is expected to have traced inputs.`);const r=void 0===e.outputs?.output?e.outputs:e.outputs.output;await this.sendEndEvent({event:"on_tool_end",data:{output:r,input:t.inputs},run_id:e.id,name:t.name,tags:t.tags,metadata:t.metadata},t)}async onRetrieverStart(e){const t=Dt(e),r={tags:e.tags??[],metadata:e.extra?.metadata??{},name:t,runType:"retriever",inputs:{query:e.inputs.query}};this.runInfoMap.set(e.id,r),await this.send({event:"on_retriever_start",data:{input:{query:e.inputs.query}},name:t,tags:e.tags??[],run_id:e.id,metadata:e.extra?.metadata??{}},r)}async onRetrieverEnd(e){const t=this.runInfoMap.get(e.id);if(this.runInfoMap.delete(e.id),void 0===t)throw new Error(`onRetrieverEnd: Run ID ${e.id} not found in run map.`);await this.sendEndEvent({event:"on_retriever_end",data:{output:e.outputs?.documents??e.outputs,input:t.inputs},run_id:e.id,name:t.name,tags:t.tags,metadata:t.metadata},t)}async handleCustomEvent(e,t,r){const a=this.runInfoMap.get(r);if(void 0===a)throw new Error(`handleCustomEvent: Run ID ${r} not found in run map.`);await this.send({event:"on_custom_event",run_id:r,name:e,tags:a.tags,metadata:a.metadata,data:t},a)}async finish(){const e=[...this.tappedPromises.values()];Promise.all(e).finally((()=>{this.writer.close()}))}}class Ws extends At{constructor({config:e,onStart:t,onEnd:r,onError:a}){super({_awaitHandler:!0}),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:"RootListenersTracer"}),Object.defineProperty(this,"rootId",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"config",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"argOnStart",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"argOnEnd",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"argOnError",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.config=e,this.argOnStart=t,this.argOnEnd=r,this.argOnError=a}persistRun(e){return Promise.resolve()}async onRunCreate(e){this.rootId||(this.rootId=e.id,this.argOnStart&&await this.argOnStart(e,this.config))}async onRunUpdate(e){e.id===this.rootId&&(e.error?this.argOnError&&await this.argOnError(e,this.config):this.argOnEnd&&await this.argOnEnd(e,this.config))}}function ca(e){return!!e&&e.lc_runnable}class od{constructor(e){Object.defineProperty(this,"includeNames",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"includeTypes",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"includeTags",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"excludeNames",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"excludeTypes",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"excludeTags",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.includeNames=e.includeNames,this.includeTypes=e.includeTypes,this.includeTags=e.includeTags,this.excludeNames=e.excludeNames,this.excludeTypes=e.excludeTypes,this.excludeTags=e.excludeTags}includeEvent(e,t){let r=void 0===this.includeNames&&void 0===this.includeTypes&&void 0===this.includeTags;const a=e.tags??[];return void 0!==this.includeNames&&(r=r||this.includeNames.includes(e.name)),void 0!==this.includeTypes&&(r=r||this.includeTypes.includes(t)),void 0!==this.includeTags&&(r=r||a.some((e=>this.includeTags?.includes(e)))),void 0!==this.excludeNames&&(r=r&&!this.excludeNames.includes(e.name)),void 0!==this.excludeTypes&&(r=r&&!this.excludeTypes.includes(t)),void 0!==this.excludeTags&&(r=r&&a.every((e=>!this.excludeTags?.includes(e)))),r}}function xn(e){return e.replace(/[^a-zA-Z-_0-9]/g,"_")}const ud=["*","_","`"];function cd(e){let t="";for(const[r,a]of Object.entries(e))t+=`\tclassDef ${r} ${a};\n`;return t}function ld(e,t,r){const{firstNode:a,lastNode:n,nodeColors:i,withStyles:s=!0,curveStyle:o="linear",wrapLabelNWords:c=9}=r??{};let u=s?`%%{init: {'flowchart': {'curve': '${o}'}}}%%\ngraph TD;\n`:"graph TD;\n";if(s){const t="default",r={[t]:"{0}({1})"};void 0!==a&&(r[a]="{0}([{1}]):::first"),void 0!==n&&(r[n]="{0}([{1}]):::last");for(const[a,n]of Object.entries(e)){const e=n.name.split(":").pop()??"";let i=ud.some((t=>e.startsWith(t)&&e.endsWith(t)))?`<p>${e}</p>`:e;Object.keys(n.metadata??{}).length&&(i+=`<hr/><small><em>${Object.entries(n.metadata??{}).map((([e,t])=>`${e} = ${t}`)).join("\n")}</em></small>`);const s=(r[a]??r[t]).replace("{0}",xn(a)).replace("{1}",i);u+=`\t${s}\n`}}const l={};for(const e of t){const t=e.source.split(":"),r=e.target.split(":"),a=t.filter(((e,t)=>e===r[t])).join(":");l[a]||(l[a]=[]),l[a].push(e)}const d=new Set;function h(e,t){const r=1===e.length&&e[0].source===e[0].target;if(t&&!r){const e=t.split(":").pop();if(d.has(e))throw new Error(`Found duplicate subgraph '${e}' -- this likely means that you're reusing a subgraph node with the same name. Please adjust your graph to have subgraph nodes with unique names.`);d.add(e),u+=`\tsubgraph ${e}\n`}for(const t of e){const{source:e,target:r,data:a,conditional:n}=t;let i="";if(void 0!==a){let e=a;const t=e.split(" ");t.length>c&&(e=Array.from({length:Math.ceil(t.length/c)},((e,r)=>t.slice(r*c,(r+1)*c).join(" "))).join("&nbsp;<br>&nbsp;")),i=n?` -. &nbsp;${e}&nbsp; .-> `:` -- &nbsp;${e}&nbsp; --\x3e `}else i=n?" -.-> ":" --\x3e ";u+=`\t${xn(e)}${i}${xn(r)};\n`}for(const e in l)e.startsWith(`${t}:`)&&e!==t&&h(l[e],e);t&&!r&&(u+="\tend\n")}h(l[""]??[],"");for(const e in l)!e.includes(":")&&""!==e&&h(l[e],e);return s&&(u+=cd(i??{})),u}async function dd(e,t){let{backgroundColor:r="white"}=t??{};const a=btoa(e);void 0!==r&&(/^#(?:[0-9a-fA-F]{3}){1,2}$/.test(r)||(r=`!${r}`));const n=`https://mermaid.ink/img/${a}?bgColor=${r}`,i=await fetch(n);if(!i.ok)throw new Error(["Failed to render the graph using the Mermaid.INK API.",`Status code: ${i.status}`,`Status text: ${i.statusText}`].join("\n"));return await i.blob()}function pr(e,t,r){function a(r,a){var n;Object.defineProperty(r,"_zod",{value:r._zod??{},enumerable:!1}),(n=r._zod).traits??(n.traits=new Set),r._zod.traits.add(e),t(r,a);for(const e in s.prototype)e in r||Object.defineProperty(r,e,{value:s.prototype[e].bind(r)});r._zod.constr=s,r._zod.def=a}const n=r?.Parent??Object;class i extends n{}function s(e){var t;const n=r?.Parent?new i:this;a(n,e),(t=n._zod).deferred??(t.deferred=[]);for(const e of n._zod.deferred)e();return n}return Object.defineProperty(i,"name",{value:e}),Object.defineProperty(s,"init",{value:a}),Object.defineProperty(s,Symbol.hasInstance,{value:t=>!!(r?.Parent&&t instanceof r.Parent)||t?._zod?.traits?.has(e)}),Object.defineProperty(s,"name",{value:e}),s}class rr extends Error{constructor(){super("Encountered Promise during synchronous parse. Use .parseAsync() instead.")}}const hd={};function la(e){return hd}function fd(e){const t=Object.values(e).filter((e=>"number"==typeof e));return Object.entries(e).filter((([e,r])=>-1===t.indexOf(+e))).map((([e,t])=>t))}function pd(e,t){return"bigint"==typeof t?t.toString():t}const md=Error.captureStackTrace?Error.captureStackTrace:(...e)=>{};function nr(e,t,r){const a=new e._zod.constr(t??e._zod.def);return(!t||r?.parent)&&(a._zod.parent=e),a}function gd(e){return{}}function kn(e,t=0){for(let r=t;r<e.issues.length;r++)if(!0!==e.issues[r]?.continue)return!0;return!1}function Ut(e){return"string"==typeof e?e:e?.message}function da(e,t,r){const a={...e,path:e.path??[]};if(!e.message){const n=Ut(e.inst?._zod.def?.error?.(e))??Ut(t?.error?.(e))??Ut(r.customError?.(e))??Ut(r.localeError?.(e))??"Invalid input";a.message=n}return delete a.inst,delete a.continue,t?.reportInput||delete a.input,a}const Ks=(e,t)=>{e.name="$ZodError",Object.defineProperty(e,"_zod",{value:e._zod,enumerable:!1}),Object.defineProperty(e,"issues",{value:t,enumerable:!1}),Object.defineProperty(e,"message",{get:()=>JSON.stringify(t,pd,2),enumerable:!0}),Object.defineProperty(e,"toString",{value:()=>e.message,enumerable:!1})},yd=pr("$ZodError",Ks),ha=pr("$ZodError",Ks,{Parent:Error}),_d=e=>(t,r,a,n)=>{const i=a?Object.assign(a,{async:!1}):{async:!1},s=t._zod.run({value:r,issues:[]},i);if(s instanceof Promise)throw new rr;if(s.issues.length){const t=new(n?.Err??e)(s.issues.map((e=>da(e,i,la()))));throw md(t,n?.callee),t}return s.value},bd=_d(ha),wd=e=>(t,r,a)=>{const n=a?{...a,async:!1}:{async:!1},i=t._zod.run({value:r,issues:[]},n);if(i instanceof Promise)throw new rr;return i.issues.length?{success:!1,error:new(e??yd)(i.issues.map((e=>da(e,n,la()))))}:{success:!0,data:i.value}},vd=wd(ha),Ed=e=>async(t,r,a)=>{const n=a?Object.assign(a,{async:!0}):{async:!0};let i=t._zod.run({value:r,issues:[]},n);return i instanceof Promise&&(i=await i),i.issues.length?{success:!1,error:new e(i.issues.map((e=>da(e,n,la()))))}:{success:!0,data:i.value}},Sd=Ed(ha),Od={major:4,minor:0,patch:0},Td=pr("$ZodType",((e,t)=>{var r;e??(e={}),e._zod.def=t,e._zod.bag=e._zod.bag||{},e._zod.version=Od;const a=[...e._zod.def.checks??[]];e._zod.traits.has("$ZodCheck")&&a.unshift(e);for(const t of a)for(const r of t._zod.onattach)r(e);if(0===a.length)(r=e._zod).deferred??(r.deferred=[]),e._zod.deferred?.push((()=>{e._zod.run=e._zod.parse}));else{const t=(e,t,r)=>{let a,n=kn(e);for(const i of t){if(i._zod.def.when){if(!i._zod.def.when(e))continue}else if(n)continue;const t=e.issues.length,s=i._zod.check(e);if(s instanceof Promise&&!1===r?.async)throw new rr;if(a||s instanceof Promise)a=(a??Promise.resolve()).then((async()=>{await s,e.issues.length!==t&&(n||(n=kn(e,t)))}));else{if(e.issues.length===t)continue;n||(n=kn(e,t))}}return a?a.then((()=>e)):e};e._zod.run=(r,n)=>{const i=e._zod.parse(r,n);if(i instanceof Promise){if(!1===n.async)throw new rr;return i.then((e=>t(e,a,n)))}return t(i,a,n)}}e["~standard"]={validate:t=>{try{const r=vd(e,t);return r.success?{value:r.data}:{issues:r.error?.issues}}catch{return Sd(e,t).then((e=>e.success?{value:e.data}:{issues:e.error?.issues}))}},vendor:"zod",version:1}})),Rd=pr("$ZodNever",((e,t)=>{Td.init(e,t),e._zod.parse=(t,r)=>(t.issues.push({expected:"never",code:"invalid_type",input:t.value,inst:e}),t)}));class Qs{constructor(){this._map=new Map,this._idmap=new Map}add(e,...t){const r=t[0];if(this._map.set(e,r),r&&"object"==typeof r&&"id"in r){if(this._idmap.has(r.id))throw new Error(`ID ${r.id} already exists in the registry`);this._idmap.set(r.id,e)}return this}clear(){return this._map=new Map,this._idmap=new Map,this}remove(e){const t=this._map.get(e);return t&&"object"==typeof t&&"id"in t&&this._idmap.delete(t.id),this._map.delete(e),this}get(e){const t=e._zod.parent;if(t){const r={...this.get(t)??{}};return delete r.id,{...r,...this._map.get(e)}}return this._map.get(e)}has(e){return this._map.has(e)}}function Id(){return new Qs}const Ue=Id();function Ad(e,t){return new e({type:"never",...gd()})}class ls{constructor(e){this.counter=0,this.metadataRegistry=e?.metadata??Ue,this.target=e?.target??"draft-2020-12",this.unrepresentable=e?.unrepresentable??"throw",this.override=e?.override??(()=>{}),this.io=e?.io??"output",this.seen=new Map}process(e,t={path:[],schemaPath:[]}){var r;const a=e._zod.def,n={guid:"uuid",url:"uri",datetime:"date-time",json_string:"json-string",regex:""},i=this.seen.get(e);if(i)return i.count++,t.schemaPath.includes(e)&&(i.cycle=t.path),i.schema;const s={schema:{},count:1,cycle:void 0,path:t.path};this.seen.set(e,s);const o=e._zod.toJSONSchema?.();if(o)s.schema=o;else{const r={...t,schemaPath:[...t.schemaPath,e],path:t.path},i=e._zod.parent;if(i)s.ref=i,this.process(i,r),this.seen.get(i).isParent=!0;else{const t=s.schema;switch(a.type){case"string":{const r=t;r.type="string";const{minimum:a,maximum:i,format:o,patterns:c,contentEncoding:u}=e._zod.bag;if("number"==typeof a&&(r.minLength=a),"number"==typeof i&&(r.maxLength=i),o&&(r.format=n[o]??o,""===r.format&&delete r.format),u&&(r.contentEncoding=u),c&&c.size>0){const e=[...c];1===e.length?r.pattern=e[0].source:e.length>1&&(s.schema.allOf=[...e.map((e=>({..."draft-7"===this.target?{type:"string"}:{},pattern:e.source})))])}break}case"number":{const r=t,{minimum:a,maximum:n,format:i,multipleOf:s,exclusiveMaximum:o,exclusiveMinimum:c}=e._zod.bag;"string"==typeof i&&i.includes("int")?r.type="integer":r.type="number","number"==typeof c&&(r.exclusiveMinimum=c),"number"==typeof a&&(r.minimum=a,"number"==typeof c&&(c>=a?delete r.minimum:delete r.exclusiveMinimum)),"number"==typeof o&&(r.exclusiveMaximum=o),"number"==typeof n&&(r.maximum=n,"number"==typeof o&&(o<=n?delete r.maximum:delete r.exclusiveMaximum)),"number"==typeof s&&(r.multipleOf=s);break}case"boolean":t.type="boolean";break;case"bigint":if("throw"===this.unrepresentable)throw new Error("BigInt cannot be represented in JSON Schema");break;case"symbol":if("throw"===this.unrepresentable)throw new Error("Symbols cannot be represented in JSON Schema");break;case"null":t.type="null";break;case"any":case"unknown":break;case"undefined":if("throw"===this.unrepresentable)throw new Error("Undefined cannot be represented in JSON Schema");break;case"void":if("throw"===this.unrepresentable)throw new Error("Void cannot be represented in JSON Schema");break;case"never":t.not={};break;case"date":if("throw"===this.unrepresentable)throw new Error("Date cannot be represented in JSON Schema");break;case"array":{const n=t,{minimum:i,maximum:s}=e._zod.bag;"number"==typeof i&&(n.minItems=i),"number"==typeof s&&(n.maxItems=s),n.type="array",n.items=this.process(a.element,{...r,path:[...r.path,"items"]});break}case"object":{const e=t;e.type="object",e.properties={};const n=a.shape;for(const t in n)e.properties[t]=this.process(n[t],{...r,path:[...r.path,"properties",t]});const i=new Set(Object.keys(n)),s=new Set([...i].filter((e=>{const t=a.shape[e]._zod;return"input"===this.io?void 0===t.optin:void 0===t.optout})));s.size>0&&(e.required=Array.from(s)),"never"===a.catchall?._zod.def.type?e.additionalProperties=!1:a.catchall?a.catchall&&(e.additionalProperties=this.process(a.catchall,{...r,path:[...r.path,"additionalProperties"]})):"output"===this.io&&(e.additionalProperties=!1);break}case"union":t.anyOf=a.options.map(((e,t)=>this.process(e,{...r,path:[...r.path,"anyOf",t]})));break;case"intersection":{const e=t,n=this.process(a.left,{...r,path:[...r.path,"allOf",0]}),i=this.process(a.right,{...r,path:[...r.path,"allOf",1]}),s=e=>"allOf"in e&&1===Object.keys(e).length,o=[...s(n)?n.allOf:[n],...s(i)?i.allOf:[i]];e.allOf=o;break}case"tuple":{const n=t;n.type="array";const i=a.items.map(((e,t)=>this.process(e,{...r,path:[...r.path,"prefixItems",t]})));if("draft-2020-12"===this.target?n.prefixItems=i:n.items=i,a.rest){const e=this.process(a.rest,{...r,path:[...r.path,"items"]});"draft-2020-12"===this.target?n.items=e:n.additionalItems=e}a.rest&&(n.items=this.process(a.rest,{...r,path:[...r.path,"items"]}));const{minimum:s,maximum:o}=e._zod.bag;"number"==typeof s&&(n.minItems=s),"number"==typeof o&&(n.maxItems=o);break}case"record":{const e=t;e.type="object",e.propertyNames=this.process(a.keyType,{...r,path:[...r.path,"propertyNames"]}),e.additionalProperties=this.process(a.valueType,{...r,path:[...r.path,"additionalProperties"]});break}case"map":if("throw"===this.unrepresentable)throw new Error("Map cannot be represented in JSON Schema");break;case"set":if("throw"===this.unrepresentable)throw new Error("Set cannot be represented in JSON Schema");break;case"enum":{const e=t,r=fd(a.entries);r.every((e=>"number"==typeof e))&&(e.type="number"),r.every((e=>"string"==typeof e))&&(e.type="string"),e.enum=r;break}case"literal":{const e=t,r=[];for(const e of a.values)if(void 0===e){if("throw"===this.unrepresentable)throw new Error("Literal `undefined` cannot be represented in JSON Schema")}else if("bigint"==typeof e){if("throw"===this.unrepresentable)throw new Error("BigInt literals cannot be represented in JSON Schema");r.push(Number(e))}else r.push(e);if(0!==r.length)if(1===r.length){const t=r[0];e.type=null===t?"null":typeof t,e.const=t}else r.every((e=>"number"==typeof e))&&(e.type="number"),r.every((e=>"string"==typeof e))&&(e.type="string"),r.every((e=>"boolean"==typeof e))&&(e.type="string"),r.every((e=>null===e))&&(e.type="null"),e.enum=r;break}case"file":{const r=t,a={type:"string",format:"binary",contentEncoding:"binary"},{minimum:n,maximum:i,mime:s}=e._zod.bag;void 0!==n&&(a.minLength=n),void 0!==i&&(a.maxLength=i),s?1===s.length?(a.contentMediaType=s[0],Object.assign(r,a)):r.anyOf=s.map((e=>({...a,contentMediaType:e}))):Object.assign(r,a);break}case"transform":if("throw"===this.unrepresentable)throw new Error("Transforms cannot be represented in JSON Schema");break;case"nullable":{const e=this.process(a.innerType,r);t.anyOf=[e,{type:"null"}];break}case"nonoptional":case"promise":case"optional":this.process(a.innerType,r),s.ref=a.innerType;break;case"success":t.type="boolean";break;case"default":this.process(a.innerType,r),s.ref=a.innerType,t.default=JSON.parse(JSON.stringify(a.defaultValue));break;case"prefault":this.process(a.innerType,r),s.ref=a.innerType,"input"===this.io&&(t._prefault=JSON.parse(JSON.stringify(a.defaultValue)));break;case"catch":{let e;this.process(a.innerType,r),s.ref=a.innerType;try{e=a.catchValue(void 0)}catch{throw new Error("Dynamic catch values are not supported in JSON Schema")}t.default=e;break}case"nan":if("throw"===this.unrepresentable)throw new Error("NaN cannot be represented in JSON Schema");break;case"template_literal":{const r=t,a=e._zod.pattern;if(!a)throw new Error("Pattern not found in template literal");r.type="string",r.pattern=a.source;break}case"pipe":{const e="input"===this.io?"transform"===a.in._zod.def.type?a.out:a.in:a.out;this.process(e,r),s.ref=e;break}case"readonly":this.process(a.innerType,r),s.ref=a.innerType,t.readOnly=!0;break;case"lazy":{const t=e._zod.innerType;this.process(t,r),s.ref=t;break}case"custom":if("throw"===this.unrepresentable)throw new Error("Custom types cannot be represented in JSON Schema")}}}const c=this.metadataRegistry.get(e);return c&&Object.assign(s.schema,c),"input"===this.io&&X(e)&&(delete s.schema.examples,delete s.schema.default),"input"===this.io&&s.schema._prefault&&((r=s.schema).default??(r.default=s.schema._prefault)),delete s.schema._prefault,this.seen.get(e).schema}emit(e,t){const r={cycles:t?.cycles??"ref",reused:t?.reused??"inline",external:t?.external??void 0},a=this.seen.get(e);if(!a)throw new Error("Unprocessed schema. This is a bug in Zod.");const n=e=>{const t="draft-2020-12"===this.target?"$defs":"definitions";if(r.external){const a=r.external.registry.get(e[0])?.id,n=r.external.uri??(e=>e);if(a)return{ref:n(a)};const i=e[1].defId??e[1].schema.id??"schema"+this.counter++;return e[1].defId=i,{defId:i,ref:`${n("__shared")}#/${t}/${i}`}}if(e[1]===a)return{ref:"#"};const n=`#/${t}/`,i=e[1].schema.id??"__schema"+this.counter++;return{defId:i,ref:n+i}},i=e=>{if(e[1].schema.$ref)return;const t=e[1],{ref:r,defId:a}=n(e);t.def={...t.schema},a&&(t.defId=a);const i=t.schema;for(const e in i)delete i[e];i.$ref=r};if("throw"===r.cycles)for(const e of this.seen.entries()){const t=e[1];if(t.cycle)throw new Error(`Cycle detected: #/${t.cycle?.join("/")}/<root>\n\nSet the \`cycles\` parameter to \`"ref"\` to resolve cyclical schemas with defs.`)}for(const t of this.seen.entries()){const a=t[1];if(e!==t[0]){if(r.external){const a=r.external.registry.get(t[0])?.id;if(e!==t[0]&&a){i(t);continue}}(this.metadataRegistry.get(t[0])?.id||a.cycle||a.count>1&&"ref"===r.reused)&&i(t)}else i(t)}const s=(e,t)=>{const r=this.seen.get(e),a=r.def??r.schema,n={...a};if(null===r.ref)return;const i=r.ref;if(r.ref=null,i){s(i,t);const e=this.seen.get(i).schema;e.$ref&&"draft-7"===t.target?(a.allOf=a.allOf??[],a.allOf.push(e)):(Object.assign(a,e),Object.assign(a,n))}r.isParent||this.override({zodSchema:e,jsonSchema:a,path:r.path??[]})};for(const e of[...this.seen.entries()].reverse())s(e[0],{target:this.target});const o={};if("draft-2020-12"===this.target?o.$schema="https://json-schema.org/draft/2020-12/schema":"draft-7"===this.target?o.$schema="http://json-schema.org/draft-07/schema#":console.warn(`Invalid target: ${this.target}`),r.external?.uri){const t=r.external.registry.get(e)?.id;if(!t)throw new Error("Schema is missing an `id` property");o.$id=r.external.uri(t)}Object.assign(o,a.def);const c=r.external?.defs??{};for(const e of this.seen.entries()){const t=e[1];t.def&&t.defId&&(c[t.defId]=t.def)}r.external||Object.keys(c).length>0&&("draft-2020-12"===this.target?o.$defs=c:o.definitions=c);try{return JSON.parse(JSON.stringify(o))}catch{throw new Error("Error converting schema to JSON.")}}}function ds(e,t){if(e instanceof Qs){const r=new ls(t),a={};for(const t of e._idmap.entries()){const[e,a]=t;r.process(a)}const n={},i={registry:e,uri:t?.uri,defs:a};for(const a of e._idmap.entries()){const[e,s]=a;n[e]=r.emit(s,{...t,external:i})}if(Object.keys(a).length>0){const e="draft-2020-12"===r.target?"$defs":"definitions";n.__shared={[e]:a}}return{schemas:n}}const r=new ls(t);return r.process(e),r.emit(e,t)}function X(e,t){const r=t??{seen:new Set};if(r.seen.has(e))return!1;r.seen.add(e);const a=e._zod.def;switch(a.type){case"string":case"number":case"bigint":case"boolean":case"date":case"symbol":case"undefined":case"null":case"any":case"unknown":case"never":case"void":case"literal":case"enum":case"nan":case"file":case"template_literal":case"custom":case"success":case"catch":return!1;case"array":return X(a.element,r);case"object":for(const e in a.shape)if(X(a.shape[e],r))return!0;return!1;case"union":for(const e of a.options)if(X(e,r))return!0;return!1;case"intersection":return X(a.left,r)||X(a.right,r);case"tuple":for(const e of a.items)if(X(e,r))return!0;return!(!a.rest||!X(a.rest,r));case"record":case"map":return X(a.keyType,r)||X(a.valueType,r);case"set":return X(a.valueType,r);case"promise":case"optional":case"nonoptional":case"nullable":case"readonly":case"default":case"prefault":return X(a.innerType,r);case"lazy":return X(a.getter(),r);case"transform":return!0;case"pipe":return X(a.in,r)||X(a.out,r)}throw new Error(`Unknown schema type: ${a.type}`)}const xd=Symbol("Let zodToJsonSchema decide on which parser to use"),kd={name:void 0,$refStrategy:"root",basePath:["#"],effectStrategy:"input",pipeStrategy:"all",dateStrategy:"format:date-time",mapStrategy:"entries",removeAdditionalStrategy:"passthrough",allowedAdditionalProperties:!0,rejectedAdditionalProperties:!1,definitionPath:"definitions",target:"jsonSchema7",strictUnions:!1,definitions:{},errorMessages:!1,markdownDescription:!1,patternStrategy:"escape",applyRegexFlags:!1,emailStrategy:"format:email",base64Strategy:"contentEncoding:base64",nameStrategy:"ref",openAiAnyTypeName:"OpenAiAnyType"},Pd=e=>({...kd,...e}),Nd=e=>{const t=Pd(e),r=void 0!==t.name?[...t.basePath,t.definitionPath,t.name]:t.basePath;return{...t,flags:{hasReferencedOpenAiAnyType:!1},currentPath:r,propertyPath:void 0,seen:new Map(Object.entries(t.definitions).map((([e,r])=>[r._def,{def:r._def,path:[...t.basePath,t.definitionPath,e],jsonSchema:void 0}])))}};function Xs(e,t,r,a){a?.errorMessages&&r&&(e.errorMessage={...e.errorMessage,[t]:r})}function V(e,t,r,a,n){e[t]=r,Xs(e,t,a,n)}const Ys=(e,t)=>{let r=0;for(;r<e.length&&r<t.length&&e[r]===t[r];r++);return[(e.length-r).toString(),...t.slice(r)].join("/")};function ye(e){if("openAi"!==e.target)return{};const t=[...e.basePath,e.definitionPath,e.openAiAnyTypeName];return e.flags.hasReferencedOpenAiAnyType=!0,{$ref:"relative"===e.$refStrategy?Ys(t,e.currentPath):t.join("/")}}function $d(e,t){const r={type:"array"};return e.type?._def&&e.type?._def?.typeName!==v.ZodAny&&(r.items=Z(e.type._def,{...t,currentPath:[...t.currentPath,"items"]})),e.minLength&&V(r,"minItems",e.minLength.value,e.minLength.message,t),e.maxLength&&V(r,"maxItems",e.maxLength.value,e.maxLength.message,t),e.exactLength&&(V(r,"minItems",e.exactLength.value,e.exactLength.message,t),V(r,"maxItems",e.exactLength.value,e.exactLength.message,t)),r}function Cd(e,t){const r={type:"integer",format:"int64"};if(!e.checks)return r;for(const a of e.checks)switch(a.kind){case"min":"jsonSchema7"===t.target?a.inclusive?V(r,"minimum",a.value,a.message,t):V(r,"exclusiveMinimum",a.value,a.message,t):(a.inclusive||(r.exclusiveMinimum=!0),V(r,"minimum",a.value,a.message,t));break;case"max":"jsonSchema7"===t.target?a.inclusive?V(r,"maximum",a.value,a.message,t):V(r,"exclusiveMaximum",a.value,a.message,t):(a.inclusive||(r.exclusiveMaximum=!0),V(r,"maximum",a.value,a.message,t));break;case"multipleOf":V(r,"multipleOf",a.value,a.message,t)}return r}function jd(){return{type:"boolean"}}function eo(e,t){return Z(e.type._def,t)}const Ld=(e,t)=>Z(e.innerType._def,t);function to(e,t,r){const a=r??t.dateStrategy;if(Array.isArray(a))return{anyOf:a.map(((r,a)=>to(e,t,r)))};switch(a){case"string":case"format:date-time":return{type:"string",format:"date-time"};case"format:date":return{type:"string",format:"date"};case"integer":return Md(e,t)}}const Md=(e,t)=>{const r={type:"integer",format:"unix-time"};if("openApi3"===t.target)return r;for(const a of e.checks)switch(a.kind){case"min":V(r,"minimum",a.value,a.message,t);break;case"max":V(r,"maximum",a.value,a.message,t)}return r};function Dd(e,t){return{...Z(e.innerType._def,t),default:e.defaultValue()}}function Ud(e,t){return"input"===t.effectStrategy?Z(e.schema._def,t):ye(t)}function Fd(e){return{type:"string",enum:Array.from(e.values)}}const zd=e=>(!("type"in e)||"string"!==e.type)&&"allOf"in e;function Bd(e,t){const r=[Z(e.left._def,{...t,currentPath:[...t.currentPath,"allOf","0"]}),Z(e.right._def,{...t,currentPath:[...t.currentPath,"allOf","1"]})].filter((e=>!!e));let a="jsonSchema2019-09"===t.target?{unevaluatedProperties:!1}:void 0;const n=[];return r.forEach((e=>{if(zd(e))n.push(...e.allOf),void 0===e.unevaluatedProperties&&(a=void 0);else{let t=e;if("additionalProperties"in e&&!1===e.additionalProperties){const{additionalProperties:r,...a}=e;t=a}else a=void 0;n.push(t)}})),n.length?{allOf:n,...a}:void 0}function qd(e,t){const r=typeof e.value;return"bigint"!==r&&"number"!==r&&"boolean"!==r&&"string"!==r?{type:Array.isArray(e.value)?"array":"object"}:"openApi3"===t.target?{type:"bigint"===r?"integer":r,enum:[e.value]}:{type:"bigint"===r?"integer":r,const:e.value}}let Pn;const ve={cuid:/^[cC][^\s-]{8,}$/,cuid2:/^[0-9a-z]+$/,ulid:/^[0-9A-HJKMNP-TV-Z]{26}$/,email:/^(?!\.)(?!.*\.\.)([a-zA-Z0-9_'+\-\.]*)[a-zA-Z0-9_+-]@([a-zA-Z0-9][a-zA-Z0-9\-]*\.)+[a-zA-Z]{2,}$/,emoji:()=>(void 0===Pn&&(Pn=RegExp("^(\\p{Extended_Pictographic}|\\p{Emoji_Component})+$","u")),Pn),uuid:/^[0-9a-fA-F]{8}\b-[0-9a-fA-F]{4}\b-[0-9a-fA-F]{4}\b-[0-9a-fA-F]{4}\b-[0-9a-fA-F]{12}$/,ipv4:/^(?:(?:25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9][0-9]|[0-9])\.){3}(?:25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9][0-9]|[0-9])$/,ipv4Cidr:/^(?:(?:25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9][0-9]|[0-9])\.){3}(?:25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9][0-9]|[0-9])\/(3[0-2]|[12]?[0-9])$/,ipv6:/^(([a-f0-9]{1,4}:){7}|::([a-f0-9]{1,4}:){0,6}|([a-f0-9]{1,4}:){1}:([a-f0-9]{1,4}:){0,5}|([a-f0-9]{1,4}:){2}:([a-f0-9]{1,4}:){0,4}|([a-f0-9]{1,4}:){3}:([a-f0-9]{1,4}:){0,3}|([a-f0-9]{1,4}:){4}:([a-f0-9]{1,4}:){0,2}|([a-f0-9]{1,4}:){5}:([a-f0-9]{1,4}:){0,1})([a-f0-9]{1,4}|(((25[0-5])|(2[0-4][0-9])|(1[0-9]{2})|([0-9]{1,2}))\.){3}((25[0-5])|(2[0-4][0-9])|(1[0-9]{2})|([0-9]{1,2})))$/,ipv6Cidr:/^(([0-9a-fA-F]{1,4}:){7,7}[0-9a-fA-F]{1,4}|([0-9a-fA-F]{1,4}:){1,7}:|([0-9a-fA-F]{1,4}:){1,6}:[0-9a-fA-F]{1,4}|([0-9a-fA-F]{1,4}:){1,5}(:[0-9a-fA-F]{1,4}){1,2}|([0-9a-fA-F]{1,4}:){1,4}(:[0-9a-fA-F]{1,4}){1,3}|([0-9a-fA-F]{1,4}:){1,3}(:[0-9a-fA-F]{1,4}){1,4}|([0-9a-fA-F]{1,4}:){1,2}(:[0-9a-fA-F]{1,4}){1,5}|[0-9a-fA-F]{1,4}:((:[0-9a-fA-F]{1,4}){1,6})|:((:[0-9a-fA-F]{1,4}){1,7}|:)|fe80:(:[0-9a-fA-F]{0,4}){0,4}%[0-9a-zA-Z]{1,}|::(ffff(:0{1,4}){0,1}:){0,1}((25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9])\.){3,3}(25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9])|([0-9a-fA-F]{1,4}:){1,4}:((25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9])\.){3,3}(25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9]))\/(12[0-8]|1[01][0-9]|[1-9]?[0-9])$/,base64:/^([0-9a-zA-Z+/]{4})*(([0-9a-zA-Z+/]{2}==)|([0-9a-zA-Z+/]{3}=))?$/,base64url:/^([0-9a-zA-Z-_]{4})*(([0-9a-zA-Z-_]{2}(==)?)|([0-9a-zA-Z-_]{3}(=)?))?$/,nanoid:/^[a-zA-Z0-9_-]{21}$/,jwt:/^[A-Za-z0-9-_]+\.[A-Za-z0-9-_]+\.[A-Za-z0-9-_]*$/};function ro(e,t){const r={type:"string"};if(e.checks)for(const a of e.checks)switch(a.kind){case"min":V(r,"minLength","number"==typeof r.minLength?Math.max(r.minLength,a.value):a.value,a.message,t);break;case"max":V(r,"maxLength","number"==typeof r.maxLength?Math.min(r.maxLength,a.value):a.value,a.message,t);break;case"email":switch(t.emailStrategy){case"format:email":Ee(r,"email",a.message,t);break;case"format:idn-email":Ee(r,"idn-email",a.message,t);break;case"pattern:zod":se(r,ve.email,a.message,t)}break;case"url":Ee(r,"uri",a.message,t);break;case"uuid":Ee(r,"uuid",a.message,t);break;case"regex":se(r,a.regex,a.message,t);break;case"cuid":se(r,ve.cuid,a.message,t);break;case"cuid2":se(r,ve.cuid2,a.message,t);break;case"startsWith":se(r,RegExp(`^${Nn(a.value,t)}`),a.message,t);break;case"endsWith":se(r,RegExp(`${Nn(a.value,t)}$`),a.message,t);break;case"datetime":Ee(r,"date-time",a.message,t);break;case"date":Ee(r,"date",a.message,t);break;case"time":Ee(r,"time",a.message,t);break;case"duration":Ee(r,"duration",a.message,t);break;case"length":V(r,"minLength","number"==typeof r.minLength?Math.max(r.minLength,a.value):a.value,a.message,t),V(r,"maxLength","number"==typeof r.maxLength?Math.min(r.maxLength,a.value):a.value,a.message,t);break;case"includes":se(r,RegExp(Nn(a.value,t)),a.message,t);break;case"ip":"v6"!==a.version&&Ee(r,"ipv4",a.message,t),"v4"!==a.version&&Ee(r,"ipv6",a.message,t);break;case"base64url":se(r,ve.base64url,a.message,t);break;case"jwt":se(r,ve.jwt,a.message,t);break;case"cidr":"v6"!==a.version&&se(r,ve.ipv4Cidr,a.message,t),"v4"!==a.version&&se(r,ve.ipv6Cidr,a.message,t);break;case"emoji":se(r,ve.emoji(),a.message,t);break;case"ulid":se(r,ve.ulid,a.message,t);break;case"base64":switch(t.base64Strategy){case"format:binary":Ee(r,"binary",a.message,t);break;case"contentEncoding:base64":V(r,"contentEncoding","base64",a.message,t);break;case"pattern:zod":se(r,ve.base64,a.message,t)}break;case"nanoid":se(r,ve.nanoid,a.message,t)}return r}function Nn(e,t){return"escape"===t.patternStrategy?Hd(e):e}const Gd=new Set("ABCDEFGHIJKLMNOPQRSTUVXYZabcdefghijklmnopqrstuvxyz0123456789");function Hd(e){let t="";for(let r=0;r<e.length;r++)Gd.has(e[r])||(t+="\\"),t+=e[r];return t}function Ee(e,t,r,a){e.format||e.anyOf?.some((e=>e.format))?(e.anyOf||(e.anyOf=[]),e.format&&(e.anyOf.push({format:e.format,...e.errorMessage&&a.errorMessages&&{errorMessage:{format:e.errorMessage.format}}}),delete e.format,e.errorMessage&&(delete e.errorMessage.format,0===Object.keys(e.errorMessage).length&&delete e.errorMessage)),e.anyOf.push({format:t,...r&&a.errorMessages&&{errorMessage:{format:r}}})):V(e,"format",t,r,a)}function se(e,t,r,a){e.pattern||e.allOf?.some((e=>e.pattern))?(e.allOf||(e.allOf=[]),e.pattern&&(e.allOf.push({pattern:e.pattern,...e.errorMessage&&a.errorMessages&&{errorMessage:{pattern:e.errorMessage.pattern}}}),delete e.pattern,e.errorMessage&&(delete e.errorMessage.pattern,0===Object.keys(e.errorMessage).length&&delete e.errorMessage)),e.allOf.push({pattern:hs(t,a),...r&&a.errorMessages&&{errorMessage:{pattern:r}}})):V(e,"pattern",hs(t,a),r,a)}function hs(e,t){if(!t.applyRegexFlags||!e.flags)return e.source;const r=e.flags.includes("i"),a=e.flags.includes("m"),n=e.flags.includes("s"),i=r?e.source.toLowerCase():e.source;let s="",o=!1,c=!1,u=!1;for(let e=0;e<i.length;e++)if(o)s+=i[e],o=!1;else{if(r)if(c){if(i[e].match(/[a-z]/)){u?(s+=i[e],s+=`${i[e-2]}-${i[e]}`.toUpperCase(),u=!1):"-"===i[e+1]&&i[e+2]?.match(/[a-z]/)?(s+=i[e],u=!0):s+=`${i[e]}${i[e].toUpperCase()}`;continue}}else if(i[e].match(/[a-z]/)){s+=`[${i[e]}${i[e].toUpperCase()}]`;continue}if(a){if("^"===i[e]){s+="(^|(?<=[\r\n]))";continue}if("$"===i[e]){s+="($|(?=[\r\n]))";continue}}n&&"."===i[e]?s+=c?`${i[e]}\r\n`:`[${i[e]}\r\n]`:(s+=i[e],"\\"===i[e]?o=!0:c&&"]"===i[e]?c=!1:!c&&"["===i[e]&&(c=!0))}try{new RegExp(s)}catch{return console.warn(`Could not convert regex pattern at ${t.currentPath.join("/")} to a flag-independent form! Falling back to the flag-ignorant source`),e.source}return s}function no(e,t){if("openAi"===t.target&&console.warn("Warning: OpenAI may not support records in schemas! Try an array of key-value pairs instead."),"openApi3"===t.target&&e.keyType?._def.typeName===v.ZodEnum)return{type:"object",required:e.keyType._def.values,properties:e.keyType._def.values.reduce(((r,a)=>({...r,[a]:Z(e.valueType._def,{...t,currentPath:[...t.currentPath,"properties",a]})??ye(t)})),{}),additionalProperties:t.rejectedAdditionalProperties};const r={type:"object",additionalProperties:Z(e.valueType._def,{...t,currentPath:[...t.currentPath,"additionalProperties"]})??t.allowedAdditionalProperties};if("openApi3"===t.target)return r;if(e.keyType?._def.typeName===v.ZodString&&e.keyType._def.checks?.length){const{type:a,...n}=ro(e.keyType._def,t);return{...r,propertyNames:n}}if(e.keyType?._def.typeName===v.ZodEnum)return{...r,propertyNames:{enum:e.keyType._def.values}};if(e.keyType?._def.typeName===v.ZodBranded&&e.keyType._def.type._def.typeName===v.ZodString&&e.keyType._def.type._def.checks?.length){const{type:a,...n}=eo(e.keyType._def,t);return{...r,propertyNames:n}}return r}function Zd(e,t){if("record"===t.mapStrategy)return no(e,t);return{type:"array",maxItems:125,items:{type:"array",items:[Z(e.keyType._def,{...t,currentPath:[...t.currentPath,"items","items","0"]})||ye(t),Z(e.valueType._def,{...t,currentPath:[...t.currentPath,"items","items","1"]})||ye(t)],minItems:2,maxItems:2}}}function Vd(e){const t=e.values,r=Object.keys(e.values).filter((e=>"number"!=typeof t[t[e]])).map((e=>t[e])),a=Array.from(new Set(r.map((e=>typeof e))));return{type:1===a.length?"string"===a[0]?"string":"number":["string","number"],enum:r}}function Jd(e){return"openAi"===e.target?void 0:{not:ye({...e,currentPath:[...e.currentPath,"not"]})}}function Wd(e){return"openApi3"===e.target?{enum:["null"],nullable:!0}:{type:"null"}}const ar={ZodString:"string",ZodNumber:"number",ZodBigInt:"integer",ZodBoolean:"boolean",ZodNull:"null"};function Kd(e,t){if("openApi3"===t.target)return fs(e,t);const r=e.options instanceof Map?Array.from(e.options.values()):e.options;if(r.every((e=>e._def.typeName in ar&&(!e._def.checks||!e._def.checks.length)))){const e=r.reduce(((e,t)=>{const r=ar[t._def.typeName];return r&&!e.includes(r)?[...e,r]:e}),[]);return{type:e.length>1?e:e[0]}}if(r.every((e=>"ZodLiteral"===e._def.typeName&&!e.description))){const e=r.reduce(((e,t)=>{const r=typeof t._def.value;switch(r){case"string":case"number":case"boolean":return[...e,r];case"bigint":return[...e,"integer"];case"object":if(null===t._def.value)return[...e,"null"];default:return e}}),[]);if(e.length===r.length){const t=e.filter(((e,t,r)=>r.indexOf(e)===t));return{type:t.length>1?t:t[0],enum:r.reduce(((e,t)=>e.includes(t._def.value)?e:[...e,t._def.value]),[])}}}else if(r.every((e=>"ZodEnum"===e._def.typeName)))return{type:"string",enum:r.reduce(((e,t)=>[...e,...t._def.values.filter((t=>!e.includes(t)))]),[])};return fs(e,t)}const fs=(e,t)=>{const r=(e.options instanceof Map?Array.from(e.options.values()):e.options).map(((e,r)=>Z(e._def,{...t,currentPath:[...t.currentPath,"anyOf",`${r}`]}))).filter((e=>!!e&&(!t.strictUnions||"object"==typeof e&&Object.keys(e).length>0)));return r.length?{anyOf:r}:void 0};function Qd(e,t){if(["ZodString","ZodNumber","ZodBigInt","ZodBoolean","ZodNull"].includes(e.innerType._def.typeName)&&(!e.innerType._def.checks||!e.innerType._def.checks.length))return"openApi3"===t.target?{type:ar[e.innerType._def.typeName],nullable:!0}:{type:[ar[e.innerType._def.typeName],"null"]};if("openApi3"===t.target){const r=Z(e.innerType._def,{...t,currentPath:[...t.currentPath]});return r&&"$ref"in r?{allOf:[r],nullable:!0}:r&&{...r,nullable:!0}}const r=Z(e.innerType._def,{...t,currentPath:[...t.currentPath,"anyOf","0"]});return r&&{anyOf:[r,{type:"null"}]}}function Xd(e,t){const r={type:"number"};if(!e.checks)return r;for(const a of e.checks)switch(a.kind){case"int":r.type="integer",Xs(r,"type",a.message,t);break;case"min":"jsonSchema7"===t.target?a.inclusive?V(r,"minimum",a.value,a.message,t):V(r,"exclusiveMinimum",a.value,a.message,t):(a.inclusive||(r.exclusiveMinimum=!0),V(r,"minimum",a.value,a.message,t));break;case"max":"jsonSchema7"===t.target?a.inclusive?V(r,"maximum",a.value,a.message,t):V(r,"exclusiveMaximum",a.value,a.message,t):(a.inclusive||(r.exclusiveMaximum=!0),V(r,"maximum",a.value,a.message,t));break;case"multipleOf":V(r,"multipleOf",a.value,a.message,t)}return r}function Yd(e,t){const r="openAi"===t.target,a={type:"object",properties:{}},n=[],i=e.shape();for(const e in i){let s=i[e];if(void 0===s||void 0===s._def)continue;let o=th(s);o&&r&&("ZodOptional"===s._def.typeName&&(s=s._def.innerType),s.isNullable()||(s=s.nullable()),o=!1);const c=Z(s._def,{...t,currentPath:[...t.currentPath,"properties",e],propertyPath:[...t.currentPath,"properties",e]});void 0!==c&&(a.properties[e]=c,o||n.push(e))}n.length&&(a.required=n);const s=eh(e,t);return void 0!==s&&(a.additionalProperties=s),a}function eh(e,t){if("ZodNever"!==e.catchall._def.typeName)return Z(e.catchall._def,{...t,currentPath:[...t.currentPath,"additionalProperties"]});switch(e.unknownKeys){case"passthrough":return t.allowedAdditionalProperties;case"strict":return t.rejectedAdditionalProperties;case"strip":return"strict"===t.removeAdditionalStrategy?t.allowedAdditionalProperties:t.rejectedAdditionalProperties}}function th(e){try{return e.isOptional()}catch{return!0}}const rh=(e,t)=>{if(t.currentPath.toString()===t.propertyPath?.toString())return Z(e.innerType._def,t);const r=Z(e.innerType._def,{...t,currentPath:[...t.currentPath,"anyOf","1"]});return r?{anyOf:[{not:ye(t)},r]}:ye(t)},nh=(e,t)=>{if("input"===t.pipeStrategy)return Z(e.in._def,t);if("output"===t.pipeStrategy)return Z(e.out._def,t);const r=Z(e.in._def,{...t,currentPath:[...t.currentPath,"allOf","0"]});return{allOf:[r,Z(e.out._def,{...t,currentPath:[...t.currentPath,"allOf",r?"1":"0"]})].filter((e=>void 0!==e))}};function ah(e,t){return Z(e.type._def,t)}function ih(e,t){const r={type:"array",uniqueItems:!0,items:Z(e.valueType._def,{...t,currentPath:[...t.currentPath,"items"]})};return e.minSize&&V(r,"minItems",e.minSize.value,e.minSize.message,t),e.maxSize&&V(r,"maxItems",e.maxSize.value,e.maxSize.message,t),r}function sh(e,t){return e.rest?{type:"array",minItems:e.items.length,items:e.items.map(((e,r)=>Z(e._def,{...t,currentPath:[...t.currentPath,"items",`${r}`]}))).reduce(((e,t)=>void 0===t?e:[...e,t]),[]),additionalItems:Z(e.rest._def,{...t,currentPath:[...t.currentPath,"additionalItems"]})}:{type:"array",minItems:e.items.length,maxItems:e.items.length,items:e.items.map(((e,r)=>Z(e._def,{...t,currentPath:[...t.currentPath,"items",`${r}`]}))).reduce(((e,t)=>void 0===t?e:[...e,t]),[])}}function oh(e){return{not:ye(e)}}function uh(e){return ye(e)}const ch=(e,t)=>Z(e.innerType._def,t),lh=(e,t,r)=>{switch(t){case v.ZodString:return ro(e,r);case v.ZodNumber:return Xd(e,r);case v.ZodObject:return Yd(e,r);case v.ZodBigInt:return Cd(e,r);case v.ZodBoolean:return jd();case v.ZodDate:return to(e,r);case v.ZodUndefined:return oh(r);case v.ZodNull:return Wd(r);case v.ZodArray:return $d(e,r);case v.ZodUnion:case v.ZodDiscriminatedUnion:return Kd(e,r);case v.ZodIntersection:return Bd(e,r);case v.ZodTuple:return sh(e,r);case v.ZodRecord:return no(e,r);case v.ZodLiteral:return qd(e,r);case v.ZodEnum:return Fd(e);case v.ZodNativeEnum:return Vd(e);case v.ZodNullable:return Qd(e,r);case v.ZodOptional:return rh(e,r);case v.ZodMap:return Zd(e,r);case v.ZodSet:return ih(e,r);case v.ZodLazy:return()=>e.getter()._def;case v.ZodPromise:return ah(e,r);case v.ZodNaN:case v.ZodNever:return Jd(r);case v.ZodEffects:return Ud(e,r);case v.ZodAny:return ye(r);case v.ZodUnknown:return uh(r);case v.ZodDefault:return Dd(e,r);case v.ZodBranded:return eo(e,r);case v.ZodReadonly:return ch(e,r);case v.ZodCatch:return Ld(e,r);case v.ZodPipeline:return nh(e,r);case v.ZodFunction:case v.ZodVoid:case v.ZodSymbol:default:return}};function Z(e,t,r=!1){const a=t.seen.get(e);if(t.override){const n=t.override?.(e,t,a,r);if(n!==xd)return n}if(a&&!r){const e=dh(a,t);if(void 0!==e)return e}const n={def:e,path:t.currentPath,jsonSchema:void 0};t.seen.set(e,n);const i=lh(e,e.typeName,t),s="function"==typeof i?Z(i(),t):i;if(s&&hh(e,t,s),t.postProcess){const r=t.postProcess(s,e,t);return n.jsonSchema=s,r}return n.jsonSchema=s,s}const dh=(e,t)=>{switch(t.$refStrategy){case"root":return{$ref:e.path.join("/")};case"relative":return{$ref:Ys(t.currentPath,e.path)};case"none":case"seen":return e.path.length<t.currentPath.length&&e.path.every(((e,r)=>t.currentPath[r]===e))?(console.warn(`Recursive reference detected at ${t.currentPath.join("/")}! Defaulting to any`),ye(t)):"seen"===t.$refStrategy?ye(t):void 0}},hh=(e,t,r)=>(e.description&&(r.description=e.description,t.markdownDescription&&(r.markdownDescription=e.description)),r),fh=(e,t)=>{const r=Nd(t);let a;const n=t?.name,i=Z(e._def,r,!1)??ye(r);r.flags.hasReferencedOpenAiAnyType&&(a||(a={}),a[r.openAiAnyTypeName]||(a[r.openAiAnyTypeName]={type:["string","number","integer","boolean","array","null"],items:{$ref:"relative"===r.$refStrategy?"1":[...r.basePath,r.definitionPath,r.openAiAnyTypeName].join("/")}}));const s=void 0===n?a?{...i,[r.definitionPath]:a}:i:{$ref:[..."relative"===r.$refStrategy?[]:r.basePath,r.definitionPath,n].join("/"),[r.definitionPath]:{...a,[n]:i}};return"jsonSchema7"===r.target?s.$schema="http://json-schema.org/draft-07/schema#":("jsonSchema2019-09"===r.target||"openAi"===r.target)&&(s.$schema="https://json-schema.org/draft/2019-09/schema#"),"openAi"===r.target&&("anyOf"in s||"oneOf"in s||"allOf"in s||"type"in s&&Array.isArray(s.type))&&console.warn("Warning: OpenAI may not support schemas with unions as roots! Try wrapping it in an object property."),s};function Ne(e){if("object"!=typeof e||null===e)return!1;if(!("_zod"in e))return!1;const t=e._zod;return"object"==typeof t&&null!==t&&"def"in t}function He(e){if("object"!=typeof e||null===e)return!1;if(!("_def"in e)||"_zod"in e)return!1;const t=e._def;return"object"==typeof t&&null!=t&&"typeName"in t}function ph(e){return!(!e||"object"!=typeof e||Array.isArray(e))&&!(!Ne(e)&&!He(e))}async function mh(e,t){if(Ne(e))return bd(e,t);if(He(e))return e.parse(t);throw new Error("Schema must be an instance of z3.ZodType or z4.$ZodType")}function gh(e){return Ne(e)?Ue.get(e)?.description:He(e)||"description"in e&&"string"==typeof e.description?e.description:void 0}function yh(e){return!!ph(e)&&(He(e)?"ZodString"===e._def.typeName:!!Ne(e)&&"string"===e._zod.def.type)}function bt(e){return!!Ne(e)&&("object"==typeof e&&null!==e&&"_zod"in e&&"object"==typeof e._zod&&null!==e._zod&&"def"in e._zod&&"object"==typeof e._zod.def&&null!==e._zod.def&&"type"in e._zod.def&&"object"===e._zod.def.type)}function ao(e){return!!Ne(e)&&("object"==typeof e&&null!==e&&"_zod"in e&&"object"==typeof e._zod&&null!==e._zod&&"def"in e._zod&&"object"==typeof e._zod.def&&null!==e._zod.def&&"type"in e._zod.def&&"array"===e._zod.def.type)}function Wn(e,t=!1){if(He(e))return e.strict();if(bt(e)){const r=e._zod.def.shape;if(t)for(const[a,n]of Object.entries(e._zod.def.shape)){if(bt(n)){const e=Wn(n,t);r[a]=e}else if(ao(n)){let e=n._zod.def.element;bt(e)&&(e=Wn(e,t)),r[a]=nr(n,{...n._zod.def,element:e})}else r[a]=n;const e=Ue.get(n);e&&Ue.add(r[a],e)}const a=nr(e,{...e._zod.def,shape:r,catchall:Ad(Rd)}),n=Ue.get(e);return n&&Ue.add(a,n),a}throw new Error("Schema must be an instance of z3.ZodObject or z4.$ZodObject")}function _h(e){return He(e)&&"typeName"in e._def&&"ZodEffects"===e._def.typeName}function bh(e){return Ne(e)&&"pipe"===e._zod.def.type}function pt(e,t=!1){if(He(e))return _h(e)?pt(e._def.schema,t):e;if(Ne(e)){let r=e;if(bh(e)&&(r=pt(e._zod.def.in,t)),t)if(bt(r)){const e=r._zod.def.shape;for(const[a,n]of Object.entries(r._zod.def.shape))e[a]=pt(n,t);r=nr(r,{...r._zod.def,shape:e})}else if(ao(r)){const e=pt(r._zod.def.element,t);r=nr(r,{...r._zod.def,element:e})}const a=Ue.get(e);return a&&Ue.add(r,a),r}throw new Error("Schema must be an instance of z3.ZodType or z4.$ZodType")}function wh(e){if(Ne(e)){const t=pt(e,!0);if(bt(t)){return ds(Wn(t,!0))}return ds(e)}return He(e)?fh(e):e}function vh(e,t){if(void 0!==e&&!mt(e))return e;if(!ca(t))return t.name??"UnknownSchema";try{let e=t.getName();return e=e.startsWith("Runnable")?e.slice(8):e,e}catch{return t.getName()}}function Eh(e){return ca(e.data)?{type:"runnable",data:{id:e.data.lc_id,name:e.data.getName()}}:{type:"schema",data:{...wh(e.data.schema),title:e.data.name}}}class mr{constructor(e){Object.defineProperty(this,"nodes",{enumerable:!0,configurable:!0,writable:!0,value:{}}),Object.defineProperty(this,"edges",{enumerable:!0,configurable:!0,writable:!0,value:[]}),this.nodes=e?.nodes??this.nodes,this.edges=e?.edges??this.edges}toJSON(){const e={};return Object.values(this.nodes).forEach(((t,r)=>{e[t.id]=mt(t.id)?r:t.id})),{nodes:Object.values(this.nodes).map((t=>({id:e[t.id],...Eh(t)}))),edges:this.edges.map((t=>{const r={source:e[t.source],target:e[t.target]};return typeof t.data<"u"&&(r.data=t.data),typeof t.conditional<"u"&&(r.conditional=t.conditional),r}))}}addNode(e,t,r){if(void 0!==t&&void 0!==this.nodes[t])throw new Error(`Node with id ${t} already exists`);const a=t??oe(),n={id:a,data:e,name:vh(t,e),metadata:r};return this.nodes[a]=n,n}removeNode(e){delete this.nodes[e.id],this.edges=this.edges.filter((t=>t.source!==e.id&&t.target!==e.id))}addEdge(e,t,r,a){if(void 0===this.nodes[e.id])throw new Error(`Source node ${e.id} not in graph`);if(void 0===this.nodes[t.id])throw new Error(`Target node ${t.id} not in graph`);const n={source:e.id,target:t.id,data:r,conditional:a};return this.edges.push(n),n}firstNode(){return ps(this)}lastNode(){return ms(this)}extend(e,t=""){let r=t;Object.values(e.nodes).map((e=>e.id)).every(mt)&&(r="");const a=e=>r?`${r}:${e}`:e;Object.entries(e.nodes).forEach((([e,t])=>{this.nodes[a(e)]={...t,id:a(e)}}));const n=e.edges.map((e=>({...e,source:a(e.source),target:a(e.target)})));this.edges=[...this.edges,...n];const i=e.firstNode(),s=e.lastNode();return[i?{id:a(i.id),data:i.data}:void 0,s?{id:a(s.id),data:s.data}:void 0]}trimFirstNode(){const e=this.firstNode();e&&ps(this,[e.id])&&this.removeNode(e)}trimLastNode(){const e=this.lastNode();e&&ms(this,[e.id])&&this.removeNode(e)}reid(){const e=Object.fromEntries(Object.values(this.nodes).map((e=>[e.id,e.name]))),t=new Map;Object.values(e).forEach((e=>{t.set(e,(t.get(e)||0)+1)}));const r=r=>{const a=e[r];return mt(r)&&1===t.get(a)?a:r};return new mr({nodes:Object.fromEntries(Object.entries(this.nodes).map((([e,t])=>[r(e),{...t,id:r(e)}]))),edges:this.edges.map((e=>({...e,source:r(e.source),target:r(e.target)})))})}drawMermaid(e){const{withStyles:t,curveStyle:r,nodeColors:a={default:"fill:#f2f0ff,line-height:1.2",first:"fill-opacity:0",last:"fill:#bfb6fc"},wrapLabelNWords:n}=e??{},i=this.reid(),s=i.firstNode(),o=i.lastNode();return ld(i.nodes,i.edges,{firstNode:s?.id,lastNode:o?.id,withStyles:t,curveStyle:r,nodeColors:a,wrapLabelNWords:n})}async drawMermaidPng(e){return dd(this.drawMermaid(e),{backgroundColor:e?.backgroundColor})}}function ps(e,t=[]){const r=new Set(e.edges.filter((e=>!t.includes(e.source))).map((e=>e.target))),a=[];for(const n of Object.values(e.nodes))!t.includes(n.id)&&!r.has(n.id)&&a.push(n);return 1===a.length?a[0]:void 0}function ms(e,t=[]){const r=new Set(e.edges.filter((e=>!t.includes(e.target))).map((e=>e.source))),a=[];for(const n of Object.values(e.nodes))!t.includes(n.id)&&!r.has(n.id)&&a.push(n);return 1===a.length?a[0]:void 0}function Sh(e){const t=new TextEncoder,r=new ReadableStream({async start(r){for await(const a of e)r.enqueue(t.encode(`event: data\ndata: ${JSON.stringify(a)}\n\n`));r.enqueue(t.encode("event: end\n\n")),r.close()}});return ge.fromReadableStream(r)}function gs(e){return"object"==typeof e&&null!==e&&"function"==typeof e[Symbol.iterator]&&"function"==typeof e.next}const Oh=e=>null!=e&&"object"==typeof e&&"next"in e&&"function"==typeof e.next;function Kn(e){return"object"==typeof e&&null!==e&&"function"==typeof e[Symbol.asyncIterator]}function*ys(e,t){for(;;){const{value:r,done:a}=qe.runWithConfig(st(e),t.next.bind(t),!0);if(a)break;yield r}}async function*Qn(e,t){const r=t[Symbol.asyncIterator]();for(;;){const{value:a,done:n}=await qe.runWithConfig(st(e),r.next.bind(t),!0);if(n)break;yield a}}function te(e,t){return!e||Array.isArray(e)||e instanceof Date||"object"!=typeof e?{[t]:e}:e}class ue extends We{constructor(){super(...arguments),Object.defineProperty(this,"lc_runnable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:void 0})}getName(e){const t=this.name??this.constructor.lc_name()??this.constructor.name;return e?`${t}${e}`:t}bind(e){return new Je({bound:this,kwargs:e,config:{}})}map(){return new ir({bound:this})}withRetry(e){return new io({bound:this,kwargs:{},config:{},maxAttemptNumber:e?.stopAfterAttempt,...e})}withConfig(e){return new Je({bound:this,config:e,kwargs:{}})}withFallbacks(e){const t=Array.isArray(e)?e:e.fallbacks;return new Rh({runnable:this,fallbacks:t})}_getOptionsList(e,t=0){if(Array.isArray(e)&&e.length!==t)throw new Error(`Passed "options" must be an array with the same length as the inputs, but got ${e.length} options for ${t} inputs`);if(Array.isArray(e))return e.map(H);if(t>1&&!Array.isArray(e)&&e.runId){console.warn("Provided runId will be used only for the first element of the batch.");const r=Object.fromEntries(Object.entries(e).filter((([e])=>"runId"!==e)));return Array.from({length:t},((t,a)=>H(0===a?e:r)))}return Array.from({length:t},(()=>H(e)))}async batch(e,t,r){const a=this._getOptionsList(t??{},e.length),n=a[0]?.maxConcurrency??r?.maxConcurrency,i=new vs({maxConcurrency:n,onFailedAttempt:e=>{throw e}}),s=e.map(((e,t)=>i.call((async()=>{try{return await this.invoke(e,a[t])}catch(e){if(r?.returnExceptions)return e;throw e}}))));return Promise.all(s)}async*_streamIterator(e,t){yield this.invoke(e,t)}async stream(e,t){const r=H(t),a=new ut({generator:this._streamIterator(e,r),config:r});return await a.setup,ge.fromAsyncGenerator(a)}_separateRunnableConfigFromCallOptions(e){let t;t=H(void 0===e?e:{callbacks:e.callbacks,tags:e.tags,metadata:e.metadata,runName:e.runName,configurable:e.configurable,recursionLimit:e.recursionLimit,maxConcurrency:e.maxConcurrency,runId:e.runId,timeout:e.timeout,signal:e.signal});const r={...e};return delete r.callbacks,delete r.tags,delete r.metadata,delete r.runName,delete r.configurable,delete r.recursionLimit,delete r.maxConcurrency,delete r.runId,delete r.timeout,delete r.signal,[t,r]}async _callWithConfig(e,t,r){const a=H(r),n=await((await Se(a))?.handleChainStart(this.toJSON(),te(t,"input"),a.runId,a?.runType,void 0,void 0,a?.runName??this.getName()));let i;delete a.runId;try{const s=e.call(this,t,a,n);i=await Ge(s,r?.signal)}catch(e){throw await(n?.handleChainError(e)),e}return await(n?.handleChainEnd(te(i,"output"))),i}async _batchWithConfig(e,t,r,a){const n=this._getOptionsList(r??{},t.length),i=await Promise.all(n.map(Se)),s=await Promise.all(i.map((async(e,r)=>{const a=await(e?.handleChainStart(this.toJSON(),te(t[r],"input"),n[r].runId,n[r].runType,void 0,void 0,n[r].runName??this.getName()));return delete n[r].runId,a})));let o;try{const r=e.call(this,t,n,s,a);o=await Ge(r,n?.[0]?.signal)}catch(e){throw await Promise.all(s.map((t=>t?.handleChainError(e)))),e}return await Promise.all(s.map((e=>e?.handleChainEnd(te(o,"output"))))),o}_concatOutputChunks(e,t){return Js(e,t)}async*_transformStreamWithConfig(e,t,r){let a,n,i=!0,s=!0;const o=H(r),c=await Se(o),u=this;let l;try{const d=await rd(t.bind(this),async function*(){for await(const t of e){if(i)if(void 0===a)a=t;else try{a=u._concatOutputChunks(a,t)}catch{a=void 0,i=!1}yield t}}(),(async()=>c?.handleChainStart(this.toJSON(),{input:""},o.runId,o.runType,void 0,void 0,o.runName??this.getName())),r?.signal,o);delete o.runId,l=d.setup;const h=l?.handlers.find(id);let p=d.output;void 0!==h&&void 0!==l&&(p=h.tapOutputIterable(l.runId,p));const m=l?.handlers.find(nd);void 0!==m&&void 0!==l&&(p=m.tapOutputIterable(l.runId,p));for await(const e of p)if(yield e,s)if(void 0===n)n=e;else try{n=this._concatOutputChunks(n,e)}catch{n=void 0,s=!1}}catch(e){throw await(l?.handleChainError(e,void 0,void 0,void 0,{inputs:te(a,"input")})),e}await(l?.handleChainEnd(n??{},void 0,void 0,void 0,{inputs:te(a,"input")}))}getGraph(e){const t=new mr,r=t.addNode({name:`${this.getName()}Input`,schema:ns()}),a=t.addNode(this),n=t.addNode({name:`${this.getName()}Output`,schema:ns()});return t.addEdge(r,a),t.addEdge(a,n),t}pipe(e){return new Ze({first:this,last:Ve(e)})}pick(e){return this.pipe(new Ah(e))}assign(e){return this.pipe(new Ih(new xt({steps:e})))}async*transform(e,t){let r;for await(const t of e)r=void 0===r?t:this._concatOutputChunks(r,t);yield*this._streamIterator(r,H(t))}async*streamLog(e,t,r){const a=new cs({...r,autoClose:!1,_schemaFormat:"original"}),n=H(t);yield*this._streamLog(e,a,n)}async*_streamLog(e,t,r){const{callbacks:a}=r;if(void 0===a)r.callbacks=[t];else if(Array.isArray(a))r.callbacks=a.concat([t]);else{const e=a.copy();e.addHandler(t,!0),r.callbacks=e}const n=this.stream(e,r);const i=async function(){try{const e=await n;for await(const r of e){const e=new Me({ops:[{op:"add",path:"/streamed_output/-",value:r}]});await t.writer.write(e)}}finally{await t.writer.close()}}();try{for await(const e of t)yield e}finally{await i}}streamEvents(e,t,r){let a;if("v1"===t.version)a=this._streamEventsV1(e,t,r);else{if("v2"!==t.version)throw new Error('Only versions "v1" and "v2" of the schema are currently supported.');a=this._streamEventsV2(e,t,r)}return"text/event-stream"===t.encoding?Sh(a):ge.fromAsyncGenerator(a)}async*_streamEventsV2(e,t,r){const a=new sd({...r,autoClose:!1}),n=H(t),i=n.runId??oe();n.runId=i;const s=n.callbacks;if(void 0===s)n.callbacks=[a];else if(Array.isArray(s))n.callbacks=s.concat(a);else{const e=s.copy();e.addHandler(a,!0),n.callbacks=e}const o=new AbortController,c=this;const u=async function(){let r,s=null;try{t?.signal?"any"in AbortSignal?r=AbortSignal.any([o.signal,t.signal]):(r=t.signal,s=()=>{o.abort()},t.signal.addEventListener("abort",s,{once:!0})):r=o.signal;const u=await c.stream(e,{...n,signal:r}),l=a.tapOutputIterable(i,u);for await(const e of l)if(o.signal.aborted)break}finally{await a.finish(),r&&s&&r.removeEventListener("abort",s)}}();let l,d=!1;try{for await(const t of a)d?(t.run_id===l&&t.event.endsWith("_end")&&t.data?.input&&delete t.data.input,yield t):(t.data.input=e,d=!0,l=t.run_id,yield t)}finally{o.abort(),await u}}async*_streamEventsV1(e,t,r){let a,n=!1;const i=H(t),s=i.tags??[],o=i.metadata??{},c=i.runName??this.getName(),u=new cs({...r,autoClose:!1,_schemaFormat:"streaming_events"}),l=new od({...r}),d=this._streamLog(e,u,i);for await(const t of d){if(a=a?a.concat(t):Tt.fromRunLogPatch(t),void 0===a.state)throw new Error('Internal error: "streamEvents" state is missing. Please open a bug report.');if(!n){n=!0;const t={...a.state},r={run_id:t.id,event:`on_${t.type}_start`,name:c,tags:s,metadata:o,data:{input:e}};l.includeEvent(r,t.type)&&(yield r)}const r=t.ops.filter((e=>e.path.startsWith("/logs/"))).map((e=>e.path.split("/")[2])),i=[...new Set(r)];for(const e of i){let t,r={};const n=a.state.logs[e];if(t=void 0===n.end_time?n.streamed_output.length>0?"stream":"start":"end","start"===t)void 0!==n.inputs&&(r.input=n.inputs);else if("end"===t)void 0!==n.inputs&&(r.input=n.inputs),r.output=n.final_output;else if("stream"===t){const e=n.streamed_output.length;if(1!==e)throw new Error(`Expected exactly one chunk of streamed output, got ${e} instead. Encountered in: "${n.name}"`);r={chunk:n.streamed_output[0]},n.streamed_output=[]}yield{event:`on_${n.type}_${t}`,name:n.name,run_id:n.id,tags:n.tags,metadata:n.metadata,data:r}}const{state:u}=a;if(u.streamed_output.length>0){const e=u.streamed_output.length;if(1!==e)throw new Error(`Expected exactly one chunk of streamed output, got ${e} instead. Encountered in: "${u.name}"`);const t={chunk:u.streamed_output[0]};u.streamed_output=[];const r={event:`on_${u.type}_stream`,run_id:u.id,tags:s,metadata:o,name:c,data:t};l.includeEvent(r,u.type)&&(yield r)}}const h=a?.state;if(void 0!==h){const e={event:`on_${h.type}_end`,name:c,run_id:h.id,tags:s,metadata:o,data:{output:h.final_output}};l.includeEvent(e,h.type)&&(yield e)}}static isRunnable(e){return ca(e)}withListeners({onStart:e,onEnd:t,onError:r}){return new Je({bound:this,config:{},configFactories:[a=>({callbacks:[new Ws({config:a,onStart:e,onEnd:t,onError:r})]})]})}asTool(e){return xh(this,e)}}class Je extends ue{static lc_name(){return"RunnableBinding"}constructor(e){super(e),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","runnables"]}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"bound",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"config",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"kwargs",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"configFactories",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.bound=e.bound,this.kwargs=e.kwargs,this.config=e.config,this.configFactories=e.configFactories}getName(e){return this.bound.getName(e)}async _mergeConfig(...e){const t=ss(this.config,...e);return ss(t,...this.configFactories?await Promise.all(this.configFactories.map((async e=>await e(t)))):[])}bind(e){return new this.constructor({bound:this.bound,kwargs:{...this.kwargs,...e},config:this.config})}withConfig(e){return new this.constructor({bound:this.bound,kwargs:this.kwargs,config:{...this.config,...e}})}withRetry(e){return new io({bound:this.bound,kwargs:this.kwargs,config:this.config,maxAttemptNumber:e?.stopAfterAttempt,...e})}async invoke(e,t){return this.bound.invoke(e,await this._mergeConfig(H(t),this.kwargs))}async batch(e,t,r){const a=Array.isArray(t)?await Promise.all(t.map((async e=>this._mergeConfig(H(e),this.kwargs)))):await this._mergeConfig(H(t),this.kwargs);return this.bound.batch(e,a,r)}_concatOutputChunks(e,t){return this.bound._concatOutputChunks(e,t)}async*_streamIterator(e,t){yield*this.bound._streamIterator(e,await this._mergeConfig(H(t),this.kwargs))}async stream(e,t){return this.bound.stream(e,await this._mergeConfig(H(t),this.kwargs))}async*transform(e,t){yield*this.bound.transform(e,await this._mergeConfig(H(t),this.kwargs))}streamEvents(e,t,r){const a=this;return ge.fromAsyncGenerator(async function*(){yield*a.bound.streamEvents(e,{...await a._mergeConfig(H(t),a.kwargs),version:t.version},r)}())}static isRunnableBinding(e){return e.bound&&ue.isRunnable(e.bound)}withListeners({onStart:e,onEnd:t,onError:r}){return new Je({bound:this.bound,kwargs:this.kwargs,config:this.config,configFactories:[a=>({callbacks:[new Ws({config:a,onStart:e,onEnd:t,onError:r})]})]})}}class ir extends ue{static lc_name(){return"RunnableEach"}constructor(e){super(e),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","runnables"]}),Object.defineProperty(this,"bound",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.bound=e.bound}bind(e){return new ir({bound:this.bound.bind(e)})}async invoke(e,t){return this._callWithConfig(this._invoke.bind(this),e,t)}async _invoke(e,t,r){return this.bound.batch(e,ne(t,{callbacks:r?.getChild()}))}withListeners({onStart:e,onEnd:t,onError:r}){return new ir({bound:this.bound.withListeners({onStart:e,onEnd:t,onError:r})})}}class io extends Je{static lc_name(){return"RunnableRetry"}constructor(e){super(e),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","runnables"]}),Object.defineProperty(this,"maxAttemptNumber",{enumerable:!0,configurable:!0,writable:!0,value:3}),Object.defineProperty(this,"onFailedAttempt",{enumerable:!0,configurable:!0,writable:!0,value:()=>{}}),this.maxAttemptNumber=e.maxAttemptNumber??this.maxAttemptNumber,this.onFailedAttempt=e.onFailedAttempt??this.onFailedAttempt}_patchConfigForRetry(e,t,r){const a=e>1?`retry:attempt:${e}`:void 0;return ne(t,{callbacks:r?.getChild(a)})}async _invoke(e,t,r){return qt((a=>super.invoke(e,this._patchConfigForRetry(a,t,r))),{onFailedAttempt:t=>this.onFailedAttempt(t,e),retries:Math.max(this.maxAttemptNumber-1,0),randomize:!0})}async invoke(e,t){return this._callWithConfig(this._invoke.bind(this),e,t)}async _batch(e,t,r,a){const n={};try{await qt((async i=>{const s=e.map(((e,t)=>t)).filter((e=>void 0===n[e.toString()]||n[e.toString()]instanceof Error)),o=s.map((t=>e[t])),c=s.map((e=>this._patchConfigForRetry(i,t?.[e],r?.[e]))),u=await super.batch(o,c,{...a,returnExceptions:!0});let l;for(let e=0;e<u.length;e+=1){const t=u[e],r=s[e];t instanceof Error&&void 0===l&&(l=t,l.input=o[e]),n[r.toString()]=t}if(l)throw l;return u}),{onFailedAttempt:e=>this.onFailedAttempt(e,e.input),retries:Math.max(this.maxAttemptNumber-1,0),randomize:!0})}catch(e){if(!0!==a?.returnExceptions)throw e}return Object.keys(n).sort(((e,t)=>parseInt(e,10)-parseInt(t,10))).map((e=>n[parseInt(e,10)]))}async batch(e,t,r){return this._batchWithConfig(this._batch.bind(this),e,t,r)}}class Ze extends ue{static lc_name(){return"RunnableSequence"}constructor(e){super(e),Object.defineProperty(this,"first",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"middle",{enumerable:!0,configurable:!0,writable:!0,value:[]}),Object.defineProperty(this,"last",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"omitSequenceTags",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","runnables"]}),this.first=e.first,this.middle=e.middle??this.middle,this.last=e.last,this.name=e.name,this.omitSequenceTags=e.omitSequenceTags??this.omitSequenceTags}get steps(){return[this.first,...this.middle,this.last]}async invoke(e,t){const r=H(t),a=await((await Se(r))?.handleChainStart(this.toJSON(),te(e,"input"),r.runId,void 0,void 0,void 0,r?.runName));delete r.runId;let n,i=e;try{const e=[this.first,...this.middle];for(let n=0;n<e.length;n+=1){const s=e[n].invoke(i,ne(r,{callbacks:a?.getChild(this.omitSequenceTags?void 0:`seq:step:${n+1}`)}));i=await Ge(s,t?.signal)}if(t?.signal?.aborted)throw new Error("Aborted");n=await this.last.invoke(i,ne(r,{callbacks:a?.getChild(this.omitSequenceTags?void 0:`seq:step:${this.steps.length}`)}))}catch(e){throw await(a?.handleChainError(e)),e}return await(a?.handleChainEnd(te(n,"output"))),n}async batch(e,t,r){const a=this._getOptionsList(t??{},e.length),n=await Promise.all(a.map(Se)),i=await Promise.all(n.map((async(t,r)=>{const n=await(t?.handleChainStart(this.toJSON(),te(e[r],"input"),a[r].runId,void 0,void 0,void 0,a[r].runName));return delete a[r].runId,n})));let s=e;try{for(let e=0;e<this.steps.length;e+=1){const t=this.steps[e].batch(s,i.map(((t,r)=>{const n=t?.getChild(this.omitSequenceTags?void 0:`seq:step:${e+1}`);return ne(a[r],{callbacks:n})})),r);s=await Ge(t,a[0]?.signal)}}catch(e){throw await Promise.all(i.map((t=>t?.handleChainError(e)))),e}return await Promise.all(i.map((e=>e?.handleChainEnd(te(s,"output"))))),s}_concatOutputChunks(e,t){return this.last._concatOutputChunks(e,t)}async*_streamIterator(e,t){const r=await Se(t),{runId:a,...n}=t??{},i=await(r?.handleChainStart(this.toJSON(),te(e,"input"),a,void 0,void 0,void 0,n?.runName)),s=[this.first,...this.middle,this.last];let o,c=!0;try{let r=s[0].transform(async function*(){yield e}(),ne(n,{callbacks:i?.getChild(this.omitSequenceTags?void 0:"seq:step:1")}));for(let e=1;e<s.length;e+=1)r=await s[e].transform(r,ne(n,{callbacks:i?.getChild(this.omitSequenceTags?void 0:`seq:step:${e+1}`)}));for await(const e of r)if(t?.signal?.throwIfAborted(),yield e,c)if(void 0===o)o=e;else try{o=this._concatOutputChunks(o,e)}catch{o=void 0,c=!1}}catch(e){throw await(i?.handleChainError(e)),e}await(i?.handleChainEnd(te(o,"output")))}getGraph(e){const t=new mr;let r=null;return this.steps.forEach(((a,n)=>{const i=a.getGraph(e);0!==n&&i.trimFirstNode(),n!==this.steps.length-1&&i.trimLastNode(),t.extend(i);const s=i.firstNode();if(!s)throw new Error(`Runnable ${a} has no first node`);r&&t.addEdge(r,s),r=i.lastNode()})),t}pipe(e){return Ze.isRunnableSequence(e)?new Ze({first:this.first,middle:this.middle.concat([this.last,e.first,...e.middle]),last:e.last,name:this.name??e.name}):new Ze({first:this.first,middle:[...this.middle,this.last],last:Ve(e),name:this.name})}static isRunnableSequence(e){return Array.isArray(e.middle)&&ue.isRunnable(e)}static from([e,...t],r){let a={};return"string"==typeof r?a.name=r:void 0!==r&&(a=r),new Ze({...a,first:Ve(e),middle:t.slice(0,-1).map(Ve),last:Ve(t[t.length-1])})}}class xt extends ue{static lc_name(){return"RunnableMap"}getStepsKeys(){return Object.keys(this.steps)}constructor(e){super(e),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","runnables"]}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"steps",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.steps={};for(const[t,r]of Object.entries(e.steps))this.steps[t]=Ve(r)}static from(e){return new xt({steps:e})}async invoke(e,t){const r=H(t),a=await((await Se(r))?.handleChainStart(this.toJSON(),{input:e},r.runId,void 0,void 0,void 0,r?.runName));delete r.runId;const n={};try{const i=Object.entries(this.steps).map((async([t,i])=>{n[t]=await i.invoke(e,ne(r,{callbacks:a?.getChild(`map:key:${t}`)}))}));await Ge(Promise.all(i),t?.signal)}catch(e){throw await(a?.handleChainError(e)),e}return await(a?.handleChainEnd(n)),n}async*_transform(e,t,r){const a={...this.steps},n=Vs(e,Object.keys(a).length),i=new Map(Object.entries(a).map((([e,a],i)=>{const s=a.transform(n[i],ne(r,{callbacks:t?.getChild(`map:key:${e}`)}));return[e,s.next().then((t=>({key:e,gen:s,result:t})))]})));for(;i.size;){const e=Promise.race(i.values()),{key:t,result:a,gen:n}=await Ge(e,r?.signal);i.delete(t),a.done||(yield{[t]:a.value},i.set(t,n.next().then((e=>({key:t,gen:n,result:e})))))}}transform(e,t){return this._transformStreamWithConfig(e,this._transform.bind(this),t)}async stream(e,t){const r=H(t),a=new ut({generator:this.transform(async function*(){yield e}(),r),config:r});return await a.setup,ge.fromAsyncGenerator(a)}}class fa extends ue{constructor(e){if(super(e),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","runnables"]}),Object.defineProperty(this,"func",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),!oa(e.func))throw new Error("RunnableTraceable requires a function that is wrapped in traceable higher-order function");this.func=e.func}async invoke(e,t){const[r]=this._getOptionsList(t??{},1),a=await Se(r);return Ge(this.func(ne(r,{callbacks:a}),e),r?.signal)}async*_streamIterator(e,t){const[r]=this._getOptionsList(t??{},1),a=await this.invoke(e,t);if(Kn(a))for await(const e of a)r?.signal?.throwIfAborted(),yield e;else if(Oh(a))for(;;){r?.signal?.throwIfAborted();const e=a.next();if(e.done)break;yield e.value}else yield a}static from(e){return new fa({func:e})}}function Th(e){if(oa(e))throw new Error("RunnableLambda requires a function that is not wrapped in traceable higher-order function. This shouldn't happen.")}class gr extends ue{static lc_name(){return"RunnableLambda"}constructor(e){if(oa(e.func))return fa.from(e.func);super(e),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","runnables"]}),Object.defineProperty(this,"func",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Th(e.func),this.func=e.func}static from(e){return new gr({func:e})}async _invoke(e,t,r){return new Promise(((a,n)=>{const i=ne(t,{callbacks:r?.getChild(),recursionLimit:(t?.recursionLimit??25)-1});qe.runWithConfig(st(i),(async()=>{try{let r=await this.func(e,{...i});if(r&&ue.isRunnable(r)){if(0===t?.recursionLimit)throw new Error("Recursion limit reached.");r=await r.invoke(e,{...i,recursionLimit:(i.recursionLimit??25)-1})}else if(Kn(r)){let e;for await(const a of Qn(i,r))if(t?.signal?.throwIfAborted(),void 0===e)e=a;else try{e=this._concatOutputChunks(e,a)}catch{e=a}r=e}else if(gs(r)){let e;for(const a of ys(i,r))if(t?.signal?.throwIfAborted(),void 0===e)e=a;else try{e=this._concatOutputChunks(e,a)}catch{e=a}r=e}a(r)}catch(e){n(e)}}))}))}async invoke(e,t){return this._callWithConfig(this._invoke.bind(this),e,t)}async*_transform(e,t,r){let a;for await(const t of e)if(void 0===a)a=t;else try{a=this._concatOutputChunks(a,t)}catch{a=t}const n=ne(r,{callbacks:t?.getChild(),recursionLimit:(r?.recursionLimit??25)-1}),i=await new Promise(((e,t)=>{qe.runWithConfig(st(n),(async()=>{try{const t=await this.func(a,{...n,config:n});e(t)}catch(e){t(e)}}))}));if(i&&ue.isRunnable(i)){if(0===r?.recursionLimit)throw new Error("Recursion limit reached.");const e=await i.stream(a,n);for await(const t of e)yield t}else if(Kn(i))for await(const e of Qn(n,i))r?.signal?.throwIfAborted(),yield e;else if(gs(i))for(const e of ys(n,i))r?.signal?.throwIfAborted(),yield e;else yield i}transform(e,t){return this._transformStreamWithConfig(e,this._transform.bind(this),t)}async stream(e,t){const r=H(t),a=new ut({generator:this.transform(async function*(){yield e}(),r),config:r});return await a.setup,ge.fromAsyncGenerator(a)}}class Rh extends ue{static lc_name(){return"RunnableWithFallbacks"}constructor(e){super(e),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","runnables"]}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"runnable",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"fallbacks",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.runnable=e.runnable,this.fallbacks=e.fallbacks}*runnables(){yield this.runnable;for(const e of this.fallbacks)yield e}async invoke(e,t){const r=H(t),a=await Se(r),{runId:n,...i}=r,s=await(a?.handleChainStart(this.toJSON(),te(e,"input"),n,void 0,void 0,void 0,i?.runName)),o=ne(i,{callbacks:s?.getChild()});return await qe.runWithConfig(o,(async()=>{let t;for(const a of this.runnables()){r?.signal?.throwIfAborted();try{const t=await a.invoke(e,o);return await(s?.handleChainEnd(te(t,"output"))),t}catch(e){void 0===t&&(t=e)}}throw void 0===t?new Error("No error stored at end of fallback."):(await(s?.handleChainError(t)),t)}))}async*_streamIterator(e,t){const r=H(t),a=await Se(r),{runId:n,...i}=r,s=await(a?.handleChainStart(this.toJSON(),te(e,"input"),n,void 0,void 0,void 0,i?.runName));let o,c,u;for(const t of this.runnables()){r?.signal?.throwIfAborted();const a=ne(i,{callbacks:s?.getChild()});try{c=Qn(a,await t.stream(e,a));break}catch(e){void 0===o&&(o=e)}}if(void 0===c){const e=o??new Error("No error stored at end of fallback.");throw await(s?.handleChainError(e)),e}try{for await(const e of c){yield e;try{u=void 0===u?u:this._concatOutputChunks(u,e)}catch{u=void 0}}}catch(e){throw await(s?.handleChainError(e)),e}await(s?.handleChainEnd(te(u,"output")))}async batch(e,t,r){if(r?.returnExceptions)throw new Error("Not implemented.");const a=this._getOptionsList(t??{},e.length),n=await Promise.all(a.map((e=>Se(e)))),i=await Promise.all(n.map((async(t,r)=>{const n=await(t?.handleChainStart(this.toJSON(),te(e[r],"input"),a[r].runId,void 0,void 0,void 0,a[r].runName));return delete a[r].runId,n})));let s;for(const t of this.runnables()){a[0].signal?.throwIfAborted();try{const n=await t.batch(e,i.map(((e,t)=>ne(a[t],{callbacks:e?.getChild()}))),r);return await Promise.all(i.map(((e,t)=>e?.handleChainEnd(te(n[t],"output"))))),n}catch(e){void 0===s&&(s=e)}}throw s?(await Promise.all(i.map((e=>e?.handleChainError(s)))),s):new Error("No error stored at end of fallbacks.")}}function Ve(e){if("function"==typeof e)return new gr({func:e});if(ue.isRunnable(e))return e;if(Array.isArray(e)||"object"!=typeof e)throw new Error("Expected a Runnable, function or object.\nInstead got an unsupported type.");{const t={};for(const[r,a]of Object.entries(e))t[r]=Ve(a);return new xt({steps:t})}}class Ih extends ue{static lc_name(){return"RunnableAssign"}constructor(e){e instanceof xt&&(e={mapper:e}),super(e),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","runnables"]}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"mapper",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.mapper=e.mapper}async invoke(e,t){const r=await this.mapper.invoke(e,t);return{...e,...r}}async*_transform(e,t,r){const a=this.mapper.getStepsKeys(),[n,i]=Vs(e),s=this.mapper.transform(i,ne(r,{callbacks:t?.getChild()})),o=s.next();for await(const e of n){if("object"!=typeof e||Array.isArray(e))throw new Error("RunnableAssign can only be used with objects as input, got "+typeof e);const t=Object.fromEntries(Object.entries(e).filter((([e])=>!a.includes(e))));Object.keys(t).length>0&&(yield t)}yield(await o).value;for await(const e of s)yield e}transform(e,t){return this._transformStreamWithConfig(e,this._transform.bind(this),t)}async stream(e,t){const r=H(t),a=new ut({generator:this.transform(async function*(){yield e}(),r),config:r});return await a.setup,ge.fromAsyncGenerator(a)}}class Ah extends ue{static lc_name(){return"RunnablePick"}constructor(e){("string"==typeof e||Array.isArray(e))&&(e={keys:e}),super(e),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","runnables"]}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"keys",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.keys=e.keys}async _pick(e){if("string"==typeof this.keys)return e[this.keys];{const t=this.keys.map((t=>[t,e[t]])).filter((e=>void 0!==e[1]));return 0===t.length?void 0:Object.fromEntries(t)}}async invoke(e,t){return this._callWithConfig(this._pick.bind(this),e,t)}async*_transform(e){for await(const t of e){const e=await this._pick(t);void 0!==e&&(yield e)}}transform(e,t){return this._transformStreamWithConfig(e,this._transform.bind(this),t)}async stream(e,t){const r=H(t),a=new ut({generator:this.transform(async function*(){yield e}(),r),config:r});return await a.setup,ge.fromAsyncGenerator(a)}}class _s extends Je{constructor(e){super({bound:Ze.from([gr.from((async e=>{let t;if(Zc(e))try{t=await mh(this.schema,e.args)}catch{throw new Vc("Received tool input did not match expected schema",JSON.stringify(e.args))}else t=e;return t})).withConfig({runName:`${e.name}:parse_input`}),e.bound]).withConfig({runName:e.name}),config:e.config??{}}),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"description",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"schema",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.name=e.name,this.description=e.description,this.schema=e.schema}static lc_name(){return"RunnableToolLike"}}function xh(e,t){const r=t.name??e.getName(),a=t.description??gh(t.schema);return yh(t.schema)?new _s({name:r,description:a,schema:Gl({input:ql()}).transform((e=>e.input)),bound:e}):new _s({name:r,description:a,schema:t.schema,bound:e})}class kh extends ue{constructor(e){super(e),Object.defineProperty(this,"callbacks",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"tags",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"metadata",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"verbose",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.callbacks=e?.callbacks,this.tags=e?.tags??[],this.metadata=e?.metadata??{},this.verbose=e?.verbose??!1}_getRelevantDocuments(e,t){throw new Error("Not implemented!")}async invoke(e,t){return this.getRelevantDocuments(e,H(t))}async getRelevantDocuments(e,t){const r=H(hl(t)),a=await((await be.configure(r.callbacks,this.callbacks,r.tags,this.tags,r.metadata,this.metadata,{verbose:this.verbose}))?.handleRetrieverStart(this.toJSON(),e,r.runId,void 0,void 0,void 0,r.runName));try{const t=await this._getRelevantDocuments(e,a);return await(a?.handleRetrieverEnd(t)),t}catch(e){throw await(a?.handleRetrieverError(e)),e}}}class $n extends kh{static lc_name(){return"VectorStoreRetriever"}get lc_namespace(){return["langchain_core","vectorstores"]}_vectorstoreType(){return this.vectorStore._vectorstoreType()}constructor(e){super(e),Object.defineProperty(this,"vectorStore",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"k",{enumerable:!0,configurable:!0,writable:!0,value:4}),Object.defineProperty(this,"searchType",{enumerable:!0,configurable:!0,writable:!0,value:"similarity"}),Object.defineProperty(this,"searchKwargs",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"filter",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.vectorStore=e.vectorStore,this.k=e.k??this.k,this.searchType=e.searchType??this.searchType,this.filter=e.filter,"mmr"===e.searchType&&(this.searchKwargs=e.searchKwargs)}async _getRelevantDocuments(e,t){if("mmr"===this.searchType){if("function"!=typeof this.vectorStore.maxMarginalRelevanceSearch)throw new Error(`The vector store backing this retriever, ${this._vectorstoreType()} does not support max marginal relevance search.`);return this.vectorStore.maxMarginalRelevanceSearch(e,{k:this.k,filter:this.filter,...this.searchKwargs},t?.getChild("vectorstore"))}return this.vectorStore.similaritySearch(e,this.k,this.filter,t?.getChild("vectorstore"))}async addDocuments(e,t){return this.vectorStore.addDocuments(e,t)}}class Ph extends We{constructor(e,t){super(t),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain","vectorstores",this._vectorstoreType()]}),Object.defineProperty(this,"embeddings",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.embeddings=e}async delete(e){throw new Error("Not implemented.")}async similaritySearch(e,t=4,r=void 0,a=void 0){return(await this.similaritySearchVectorWithScore(await this.embeddings.embedQuery(e),t,r)).map((e=>e[0]))}async similaritySearchWithScore(e,t=4,r=void 0,a=void 0){return this.similaritySearchVectorWithScore(await this.embeddings.embedQuery(e),t,r)}static fromTexts(e,t,r,a){throw new Error("the Langchain vectorstore implementation you are using forgot to override this, please report a bug")}static fromDocuments(e,t,r){throw new Error("the Langchain vectorstore implementation you are using forgot to override this, please report a bug")}asRetriever(e,t,r,a,n,i){if("number"==typeof e)return new $n({vectorStore:this,k:e,filter:t,tags:[...a??[],this._vectorstoreType()],metadata:n,verbose:i,callbacks:r});{const t={vectorStore:this,k:e?.k,filter:e?.filter,tags:[...e?.tags??[],this._vectorstoreType()],metadata:e?.metadata,verbose:e?.verbose,callbacks:e?.callbacks,searchType:e?.searchType};return new $n("mmr"===e?.searchType?{...t,searchKwargs:e.searchKwargs}:{...t})}}}class Ft{constructor(e){Object.defineProperty(this,"pageContent",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"metadata",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"id",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.pageContent=void 0!==e.pageContent?e.pageContent.toString():"",this.metadata=e.metadata??{},this.id=e.id}}function Nh(e,t){let r=0,a=0,n=0;for(let i=0;i<e.length;i++)r+=e[i]*t[i],a+=e[i]*e[i],n+=t[i]*t[i];return r/(Math.sqrt(a)*Math.sqrt(n))}function $h(e,t){let r=0,a=0,n=0;for(let i=0;i<e.length;i++)r+=e[i]*t[i],a+=e[i]*e[i],n+=t[i]*t[i];return r/(Math.sqrt(a)*Math.sqrt(n))}function Ch(e,t,r){if(0===e.length||0===e[0].length||0===t.length||0===t[0].length)return[[]];if(e[0].length!==t[0].length)throw new Error(`Number of columns in X and Y must be the same. X has shape ${[e.length,e[0].length]} and Y has shape ${[t.length,t[0].length]}.`);return e.map((e=>t.map((t=>r(e,t))).map((e=>Number.isNaN(e)?0:e))))}function bs(e,t){return Ch(e,t,$h)}function jh(e,t,r=.5,a=4){if(Math.min(a,t.length)<=0)return[];const n=bs(Array.isArray(e[0])?e:[e],t)[0],i=Lh(n).maxIndex,s=[t[i]],o=[i];for(;o.length<Math.min(a,t.length);){let e=-1/0,a=-1;const i=bs(t,s);n.forEach(((t,n)=>{if(o.includes(n))return;const s=Math.max(...i[n]),c=r*t-(1-r)*s;c>e&&(e=c,a=n)})),s.push(t[a]),o.push(a)}return o}function Lh(e){if(0===e.length)return{maxIndex:-1,maxValue:NaN};let t=e[0],r=0;for(let a=1;a<e.length;a+=1)e[a]>t&&(r=a,t=e[a]);return{maxIndex:r,maxValue:t}}class pa extends Ph{_vectorstoreType(){return"memory"}constructor(e,{similarity:t,...r}={}){super(e,r),Object.defineProperty(this,"memoryVectors",{enumerable:!0,configurable:!0,writable:!0,value:[]}),Object.defineProperty(this,"similarity",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.similarity=t??Nh}async addDocuments(e){const t=e.map((({pageContent:e})=>e));return this.addVectors(await this.embeddings.embedDocuments(t),e)}async addVectors(e,t){const r=e.map(((e,r)=>({content:t[r].pageContent,embedding:e,metadata:t[r].metadata,id:t[r].id})));this.memoryVectors=this.memoryVectors.concat(r)}async _queryVectors(e,t,r){return this.memoryVectors.filter((e=>{if(!r)return!0;const t=new Ft({metadata:e.metadata,pageContent:e.content,id:e.id});return r(t)})).map(((t,r)=>({similarity:this.similarity(e,t.embedding),index:r,metadata:t.metadata,content:t.content,embedding:t.embedding,id:t.id}))).sort(((e,t)=>e.similarity>t.similarity?-1:0)).slice(0,t)}async similaritySearchVectorWithScore(e,t,r){return(await this._queryVectors(e,t,r)).map((e=>[new Ft({metadata:e.metadata,pageContent:e.content,id:e.id}),e.similarity]))}async maxMarginalRelevanceSearch(e,t){const r=await this.embeddings.embedQuery(e),a=await this._queryVectors(r,t.fetchK??20,t.filter);return jh(r,a.map((e=>e.embedding)),t.lambda,t.k).map((e=>new Ft({metadata:a[e].metadata,pageContent:a[e].content,id:a[e].id})))}static async fromTexts(e,t,r,a){const n=[];for(let r=0;r<e.length;r+=1){const a=Array.isArray(t)?t[r]:t,i=new Ft({pageContent:e[r],metadata:a});n.push(i)}return pa.fromDocuments(n,r,a)}static async fromDocuments(e,t,r){const a=new this(t,r);return await a.addDocuments(e),a}static async fromExistingIndex(e,t){return new this(e,t)}}const Mh=new So({model:"Xenova/all-MiniLM-L6-v2"}),ws=new pa(Mh);let Cn,jn;self.onmessage=async e=>{try{if(e?.data?.init&&!Cn&&!jn){const e=await fetch("/ai/documents.json"),t=await fetch("/ai/embeddings.json");Cn=await e.json(),jn=await t.json(),await ws.addVectors(jn,Cn)}if(!e?.data?.input)return;const t=(await ws.similaritySearchWithScore(e.data.input,e?.data?.similarityResults||10)).filter((e=>e[1]>.1));postMessage({results:t,action:"search-results"})}catch(e){console.log(e),self.postMessage({error:e.message})}};